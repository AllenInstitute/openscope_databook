

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Replicating OpenScope Credit Assignment project figures &#8212; OpenScope Databook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-TJPN1M4PDX"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-TJPN1M4PDX');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'replication/cred_assign_figures';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Aligning Data across Modalities" href="../embargoed/modality_alignment.html" />
    <link rel="prev" title="Using CEBRA-Time to Identify Latent Embeddings" href="../higher-order/cebra_time.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    OpenScope Databook
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../basics/background.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/download_nwb.html">Downloading an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/read_nwb.html">Reading an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/use_nwbwidgets.html">Exploring an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/stream_nwb.html">Streaming an NWB File with fsspec</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/get_dandiset_metadata.html">Getting Experimental Metadata from DANDI</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Visualizing NWB Files</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_2p_raw.html">Visualizing Raw 2-Photon Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_neuropixel_probes.html">Visualizing Neuropixel Probe Locations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_metrics.html">Visualizing Unit Quality Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_lfp_responses.html">Visualizing LFP Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_responses.html">Visualizing Neuronal Unit Responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_2p_responses.html">Visualizing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_spikes.html">Visualizing Unit Spikes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">First-Order Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../first-order/receptive_fields.html">Showing Receptive Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/optotagging.html">Identifying Optotagged Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/current_source_density.html">Current Source Density Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/test_2p_responses.html">Statistically Testing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/test_spike_responses.html">Statistically Testing Spike Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/suite2p.html">Identifying Regions of Interest with Segmentation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Higher-Order Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../higher-order/cebra_time.html">Using CEBRA-Time to Identify Latent Embeddings</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Replicating Figures</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Replicating OpenScope Credit Assignment project figures</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Embargoed Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../embargoed/modality_alignment.html">Aligning Data across Modalities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/visualize_behavior.html">Visualizing Behavioral Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/test_2p_responses_embargoed.html">Statistically Testing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/cell_matching.html">Cell Matching Across Days</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Methods</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../methods/jupyter_book.html">Jupyter/Jupyter Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods/github.html">Git/Github</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods/environments.html">Managing Environments on Multiple Platforms</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Bibliography and FAQ</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html">FAQ</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/AllenInstitute/openscope_databook/main?urlpath=tree/docs/replication/cred_assign_figures.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://hub.dandiarchive.org/hub/user-redirect/git-pull?repo=https%3A//github.com/AllenInstitute/openscope_databook&urlpath=tree/openscope_databook/docs/replication/cred_assign_figures.ipynb&branch=main" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onJupyterHub"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_jupyterhub.svg">
  </span>
<span class="btn__text-container">JupyterHub</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/AllenInstitute/openscope_databook/blob/main/docs/replication/cred_assign_figures.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/AllenInstitute/openscope_databook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/AllenInstitute/openscope_databook/issues/new?title=Issue%20on%20page%20%2Freplication/cred_assign_figures.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/replication/cred_assign_figures.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Replicating OpenScope Credit Assignment project figures</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-of-experiments">Summary of experiments</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">Environment Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-plotting-defaults">Setting plotting defaults</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-additional-plotting-hyperparameters">Setting additional plotting hyperparameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-data-dictionaries-for-plotting">Loading data dictionaries for plotting</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#replications">Replications</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replication-1-tracked-roi-examples-dataset-descriptor-paper-fig-2b">Replication 1. Tracked ROI examples (Dataset descriptor paper, Fig. 2B)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replication-2-example-roi-responses-to-inconsistent-gabor-sequences-dataset-descriptor-paper-fig-5b">Replication 2. Example ROI responses to inconsistent Gabor sequences (Dataset descriptor paper, Fig. 5B)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replication-3-example-roi-responses-to-inconsistent-gabor-sequences-dataset-descriptor-paper-fig-6a">Replication 3. Example ROI responses to inconsistent Gabor sequences (Dataset descriptor paper, Fig. 6A)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replication-4-mean-gabor-sequence-responses-for-example-rois-analysis-paper-fig-3a">Replication 4. Mean Gabor sequence responses for example ROIs (Analysis paper, Fig. 3A)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#going-further">Going further</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="replicating-openscope-credit-assignment-project-figures">
<h1>Replicating OpenScope Credit Assignment project figures<a class="headerlink" href="#replicating-openscope-credit-assignment-project-figures" title="Permalink to this heading">#</a></h1>
<p>In this notebook, we will replicate figures from the OpenScope Credit Assignment project. All of these figures were published in the dataset descriptor paper <span id="id1">[<a class="reference internal" href="../bibliography.html#id19" title="Colleen J. Gillon, Jérôme A. Lecoq, Jason E. Pina, Ruweida Ahmed, Yazan N. Billeh, Shiella Caldejon, Peter Groblewski, Timothy M. Henley, India Kato, Eric Lee, Jennifer Luviano, Kyla Mace, Chelsea Nayan, Thuyanh V. Nguyen, Kat North, Jed Perkins, Sam Seid, Matthew T. Valley, Ali Williford, Yoshua Bengio, Timothy P. Lillicrap, Joel Zylberberg, and Blake A. Richards. Responses of pyramidal cell somata and apical dendrites in mouse visual cortex over multiple days. Scientific Data, 2023. URL: https://www.nature.com/articles/s41597-023-02214-y.">Gillon <em>et al.</em>, 2023</a>]</span>, except for the final figure which is from the preprint analysis paper <span id="id2">[<a class="reference internal" href="../bibliography.html#id18" title="Colleen J. Gillon, Jason E. Pina, Jérôme A. Lecoq, Ruweida Ahmed, Yazan N. Billeh, Shiella Caldejon, Peter Groblewski, Timothy M. Henley, India Kato, Eric Lee, Jennifer Luviano, Kyla Mace, Chelsea Nayan, Thuyanh V. Nguyen, Kat North, Jed Perkins, Sam Seid, Matthew T. Valley, Ali Williford, Yoshua Bengio, Timothy P. Lillicrap, Blake A. Richards, and Joel Zylberberg. Learning from unexpected events in the neocortical microcircuit. BioRxiv, 2021. URL: https://www.biorxiv.org/content/10.1101/2021.01.15.426915v3.full.pdf.">Gillon <em>et al.</em>, 2021</a>]</span>. See these papers for full details on the project and dataset.</p>
<p>The objective of collecting and sharing this dataset was to enable users to study how different compartments of visual cortex pyramidal neurons respond when inconsistent (i.e., unexpected or pattern-violating) features are introduced into the stimuli that mice are viewing. To achieve this, we first habituated mice to stimuli with consistent features, before introducing inconsistent features while recording neuronal activity in the somata (i.e., cell bodies) or distal apical dendrites of layer 2/3 or layer 5 pyramidal neurons in primary visual cortex.</p>
<p>Since the full analyses performed on this dataset require a larger codebase (and in some cases, longer compute time) than is convenient for a notebook, this notebook focuses on replicating a few figures from data dictionaries. These data dictionaries were generated using the full analysis pipeline, and contain all the information needed to plot the associated figures.</p>
<p>To work with the full analysis pipeline, from NWB data files to final plots, see the <a class="reference external" href="https://github.com/colleenjg/OpenScope_CA_Analysis">OpenScope_CA_Analysis</a> GitHub repository.</p>
<section id="summary-of-experiments">
<h2>Summary of experiments<a class="headerlink" href="#summary-of-experiments" title="Permalink to this heading">#</a></h2>
<p>In brief, for this project, mice were head-fixed on a running disc and underwent 3 two-photon calcium imaging sessions in primary visual cortex (VisP) while passively viewing a visual stimulus (described below). In each mouse, imaging was performed in one of four cortical planes: layer 2/3 distal apical dendrites (<strong>L2/3-D</strong>), layer 2/3 somata (<strong>L2/3-S</strong>), layer 5 distal apical dendrites (<strong>L5-D</strong>) or layer 5 somata (<strong>L5-S</strong>).</p>
<p>Figure 1 from <span id="id3">[<a class="reference internal" href="../bibliography.html#id19" title="Colleen J. Gillon, Jérôme A. Lecoq, Jason E. Pina, Ruweida Ahmed, Yazan N. Billeh, Shiella Caldejon, Peter Groblewski, Timothy M. Henley, India Kato, Eric Lee, Jennifer Luviano, Kyla Mace, Chelsea Nayan, Thuyanh V. Nguyen, Kat North, Jed Perkins, Sam Seid, Matthew T. Valley, Ali Williford, Yoshua Bengio, Timothy P. Lillicrap, Joel Zylberberg, and Blake A. Richards. Responses of pyramidal cell somata and apical dendrites in mouse visual cortex over multiple days. Scientific Data, 2023. URL: https://www.nature.com/articles/s41597-023-02214-y.">Gillon <em>et al.</em>, 2023</a>]</span>.</p>
<p><img alt="title" src="https://media.springernature.com/full/springer-static/image/art%3A10.1038%2Fs41597-023-02214-y/MediaObjects/41597_2023_2214_Fig1_HTML.png?as=webp" /></p>
<p>Previous to the imaging sessions, mice had been habituated over 6 days to stimuli with consistent features: (1) a Gabor sequence stimulus, and (2) a visual flow stimulus.</p>
<p>The Gabor sequence stimulus was presented for 34 minutes. Each sequence lasted 1.5 seconds and consisted of 5 consecutive images (A-B-C-D-G) presented for 300 ms each. Images A, B, C and D comprised 30 Gabor patches each with positions and sizes fixed within a single session, while image G was simply a grayscreen image. For each sequence, a mean orientation was randomly sampled from {0, 45, 90, 135}°. This mean orientation was used to sample the orientation of each Gabor patch for all images in the sequence.</p>
<p>The visual flow stimulus consisted of white squares moving together at a consistent speed in one direction (17 min) and then the other (17 min) (directions: nasal-to-temporal and temporal-to-nasal).</p>
<p>Figure 3 from <span id="id4">[<a class="reference internal" href="../bibliography.html#id19" title="Colleen J. Gillon, Jérôme A. Lecoq, Jason E. Pina, Ruweida Ahmed, Yazan N. Billeh, Shiella Caldejon, Peter Groblewski, Timothy M. Henley, India Kato, Eric Lee, Jennifer Luviano, Kyla Mace, Chelsea Nayan, Thuyanh V. Nguyen, Kat North, Jed Perkins, Sam Seid, Matthew T. Valley, Ali Williford, Yoshua Bengio, Timothy P. Lillicrap, Joel Zylberberg, and Blake A. Richards. Responses of pyramidal cell somata and apical dendrites in mouse visual cortex over multiple days. Scientific Data, 2023. URL: https://www.nature.com/articles/s41597-023-02214-y.">Gillon <em>et al.</em>, 2023</a>]</span>.</p>
<p><img alt="title" src="https://media.springernature.com/full/springer-static/image/art%3A10.1038%2Fs41597-023-02214-y/MediaObjects/41597_2023_2214_Fig3_HTML.png?as=webp" /></p>
<p>As mentioned above, once the mice had been habituated to these stimuli, inconsistent stimulus features were introduced into the Gabor sequence stimulus and the visual flow stimulus during the 3 two-photon calcium imaging sessions which were performed on different days.</p>
<p>For the Gabor sequence stimulus, inconsistent sequences were randomly introduced, accounting for about 7% of all sequences. In these inconsistent sequences, D images were replaced with U images. The Gabor patches in U images had their own positions and sizes, and in addition, their orientations were rotated by 90° with respect to the rest of the sequence they were in.</p>
<p>For the visual flow stimulus, inconsistent flow was introduced randomly, accounting for around 5% of the total duration of the stimulus. During inconsistent flow, 25% of the squares randomly flipped their direction of flow for 2-4 seconds, before resuming consistent flow.</p>
<p>Full series of 3 sessions were obtained for 11 mice, in total.</p>
</section>
<section id="environment-setup">
<h2>Environment Setup<a class="headerlink" href="#environment-setup" title="Permalink to this heading">#</a></h2>
<p>⚠️<strong>Note: If running on a new environment, run this cell once and then restart the kernel</strong>⚠️</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cred_assign_utils</span>
<span class="k">except</span><span class="p">:</span>
    <span class="o">!</span>git clone https://github.com/AllenInstitute/openscope_databook.git
    <span class="o">%</span><span class="k">cd</span> openscope_databook
    <span class="o">%</span><span class="k">pip</span> install -e .
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">patches</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
</section>
<section id="setting-plotting-defaults">
<h2>Setting plotting defaults<a class="headerlink" href="#setting-plotting-defaults" title="Permalink to this heading">#</a></h2>
<p>When using a plotting package like <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>, it can be convenient to adjust a set of plotting defaults ahead of time, instead of applying individual changes to each plot. When called, the function below updates the defaults for the <code class="docutils literal notranslate"><span class="pre">pyplot</span></code> module of <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>, used in this notebook. Specifically, it adjusts fontsizes for labels and titles, as well as line widths, and sets the format to be used if any figures are saved.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">set_plt_defaults</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    set_plt_defaults()</span>

<span class="sd">    Sets pyplot defaults.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># set pyplot params</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;axes.labelsize&quot;</span>       <span class="p">:</span> <span class="s2">&quot;x-large&quot;</span><span class="p">,</span>  <span class="c1"># x-large axis labels</span>
        <span class="s2">&quot;axes.linewidth&quot;</span>       <span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>        <span class="c1"># thicker axis lines</span>
        <span class="s2">&quot;axes.spines.right&quot;</span>    <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>      <span class="c1"># no axis spine on right</span>
        <span class="s2">&quot;axes.spines.top&quot;</span>      <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>      <span class="c1"># no axis spine at top</span>
        <span class="s2">&quot;axes.titlesize&quot;</span>       <span class="p">:</span> <span class="s2">&quot;x-large&quot;</span><span class="p">,</span>  <span class="c1"># x-large axis title</span>
        <span class="s2">&quot;errorbar.capsize&quot;</span>     <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>          <span class="c1"># errorbar cap length</span>
        <span class="s2">&quot;figure.titlesize&quot;</span>     <span class="p">:</span> <span class="s2">&quot;x-large&quot;</span><span class="p">,</span>  <span class="c1"># x-large figure title</span>
        <span class="s2">&quot;figure.autolayout&quot;</span>    <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>       <span class="c1"># adjusts layout</span>
        <span class="s2">&quot;figure.facecolor&quot;</span>     <span class="p">:</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span>        <span class="c1"># figure facecolor</span>
        <span class="s2">&quot;font.size&quot;</span>            <span class="p">:</span> <span class="mi">12</span><span class="p">,</span>         <span class="c1"># basic font size value</span>
        <span class="s2">&quot;legend.fontsize&quot;</span>      <span class="p">:</span> <span class="s2">&quot;large&quot;</span><span class="p">,</span>    <span class="c1"># large legend text</span>
        <span class="s2">&quot;lines.linewidth&quot;</span>      <span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>        <span class="c1"># thicker lines</span>
        <span class="s2">&quot;patch.linewidth&quot;</span>      <span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>        <span class="c1"># thicker lines for patches</span>
        <span class="s2">&quot;savefig.format&quot;</span>       <span class="p">:</span> <span class="s2">&quot;svg&quot;</span><span class="p">,</span>      <span class="c1"># figure save format</span>
        <span class="s2">&quot;savefig.bbox&quot;</span>         <span class="p">:</span> <span class="s2">&quot;tight&quot;</span><span class="p">,</span>    <span class="c1"># tight cropping of figure</span>
        <span class="s2">&quot;savefig.transparent&quot;</span>  <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>      <span class="c1"># background transparency</span>
        <span class="s2">&quot;xtick.labelsize&quot;</span>      <span class="p">:</span> <span class="s2">&quot;large&quot;</span><span class="p">,</span>    <span class="c1"># large x-tick labels</span>
        <span class="s2">&quot;xtick.major.size&quot;</span>     <span class="p">:</span> <span class="mf">8.0</span><span class="p">,</span>        <span class="c1"># longer x-ticks</span>
        <span class="s2">&quot;xtick.major.width&quot;</span>    <span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>        <span class="c1"># thicker x-ticks</span>
        <span class="s2">&quot;ytick.labelsize&quot;</span>      <span class="p">:</span> <span class="s2">&quot;large&quot;</span><span class="p">,</span>    <span class="c1"># large y-tick labels</span>
        <span class="s2">&quot;ytick.major.size&quot;</span>     <span class="p">:</span> <span class="mf">8.0</span><span class="p">,</span>        <span class="c1"># longer y-ticks</span>
        <span class="s2">&quot;ytick.major.width&quot;</span>    <span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>        <span class="c1"># thicker y-ticks</span>
        <span class="p">}</span>

    <span class="c1"># update pyplot parameters</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    
<span class="c1"># update defaults</span>
<span class="n">set_plt_defaults</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="setting-additional-plotting-hyperparameters">
<h2>Setting additional plotting hyperparameters<a class="headerlink" href="#setting-additional-plotting-hyperparameters" title="Permalink to this heading">#</a></h2>
<p>The hyperparameters defined below are used to set the basic stylistic scheme for all the figures (in particular, the color scheme), ensuring consistency across figures.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># colors for sessions 1, 2 and 3</span>
<span class="n">ORDERED_COLORS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="s2">&quot;crimson&quot;</span><span class="p">,</span> <span class="s2">&quot;mediumblue&quot;</span><span class="p">]</span>

<span class="c1"># abbreviated name, color and quadrant index for each imaging plane</span>
<span class="n">LINPLA_INFO</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;L23-Cux2&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;dend&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;L2/3-D&quot;</span><span class="p">,</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;#76bb4b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;idx&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">},</span> 
        <span class="s2">&quot;soma&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;L2/3-S&quot;</span><span class="p">,</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;#50a2d5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;idx&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="s2">&quot;L5-Rbp4&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;dend&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;L5-D&quot;</span><span class="p">,</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;#488a21&quot;</span><span class="p">,</span>
            <span class="s2">&quot;idx&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">},</span> 
        <span class="s2">&quot;soma&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;L5-S&quot;</span><span class="p">,</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;#22567a&quot;</span><span class="p">,</span>
            <span class="s2">&quot;idx&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">},</span>   
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># line dash pattern for different pyramidal neuron types</span>
<span class="n">DASH</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;L23-Cux2&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;L5-Rbp4&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="loading-data-dictionaries-for-plotting">
<h2>Loading data dictionaries for plotting<a class="headerlink" href="#loading-data-dictionaries-for-plotting" title="Permalink to this heading">#</a></h2>
<p>The function below, <code class="docutils literal notranslate"><span class="pre">load_data_dict()</span></code>, loads the data dictionaries, stored as <code class="docutils literal notranslate"><span class="pre">json</span></code> files, in which analysis results were saved for plotting. The data dictionaries used in this notebook can be found two directories up, under <code class="docutils literal notranslate"><span class="pre">data/cred_assign_data</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_data_dict</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">panel</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">paper</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="n">direc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">direc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">direc</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;cred_assign_data&quot;</span><span class="p">)</span>
        
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">paper</span><span class="si">}</span><span class="s2">_fig</span><span class="si">{</span><span class="n">fig</span><span class="si">}{</span><span class="n">panel</span><span class="si">}</span><span class="s2">.json&quot;</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">direc</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filepath</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading data for </span><span class="si">{</span><span class="n">paper</span><span class="si">}</span><span class="s2"> paper Fig. </span><span class="si">{</span><span class="n">fig</span><span class="si">}{</span><span class="n">panel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_df&quot;</span><span class="p">):</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        
    <span class="k">return</span> <span class="n">data_dict</span>
</pre></div>
</div>
</div>
</div>
<p>This function, <code class="docutils literal notranslate"><span class="pre">print_data_dict_contents(data_dict)</span></code>, prints out the contents of a data dictionary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">print_data_dict_contents</span><span class="p">(</span><span class="n">data_dict</span><span class="p">):</span>
    <span class="n">df_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="s2">&quot;_df&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">df_key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    `</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">` dictionary:&quot;</span><span class="p">)</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    `</span><span class="si">{</span><span class="n">df_key</span><span class="si">}</span><span class="s2">` dictionary (first few lines):&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">df_key</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The data dictionary for each figure panel contain records of a variety of parameters used during the analysis, each stored as their own dictionary. These include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sesspar</span></code>: parameters used to select the sections to be analyzed,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stimpar</span></code>: parameters used to select the specific stimulus sequences to be analyzed, within a session,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">analyspar</span></code>: parameters used to select the type of data to be analyzed, within each session, and the statistics to use,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">basepar</span></code>: parameters used to baseline the data, if applicable,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">extrapar</span></code>: any additional parameters used, specific to this analysis,</p></li>
</ul>
<p>In addition, each data dictionary contains a dataframe-structured dictionary, e.g., <code class="docutils literal notranslate"><span class="pre">ex_traces_df</span></code>, in which the analysis results are stored, typically with one line per session analyzed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_dict</span> <span class="o">=</span> <span class="n">load_data_dict</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="n">panel</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">paper</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">)</span>
<span class="n">print_data_dict_contents</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading data for dataset paper Fig. 5B

    `analyspar` dictionary:
{&#39;dend&#39;: &#39;extr&#39;,
 &#39;error&#39;: &#39;sem&#39;,
 &#39;fluor&#39;: &#39;dff&#39;,
 &#39;rem_bad&#39;: True,
 &#39;scale&#39;: True,
 &#39;stats&#39;: &#39;mean&#39;,
 &#39;tracked&#39;: False}

    `basepar` dictionary:
{&#39;baseline&#39;: 0}

    `extrapar` dictionary:
{&#39;n_ex&#39;: 6, &#39;rolling_win&#39;: 4, &#39;seed&#39;: 905, &#39;unexp&#39;: 1}

    `sesspar` dictionary:
{&#39;closest&#39;: False,
 &#39;incl&#39;: &#39;all&#39;,
 &#39;line&#39;: &#39;all&#39;,
 &#39;min_rois&#39;: 1,
 &#39;mouse_n&#39;: &#39;any&#39;,
 &#39;pass_fail&#39;: &#39;P&#39;,
 &#39;plane&#39;: &#39;all&#39;,
 &#39;runtype&#39;: &#39;prod&#39;,
 &#39;sess_n&#39;: [1]}

    `stimpar` dictionary:
{&#39;gab_ori&#39;: [0, 45, 90, 135, 180, 225],
 &#39;gabfr&#39;: 3,
 &#39;gabk&#39;: 16,
 &#39;post&#39;: 0.6,
 &#39;pre&#39;: 0.9,
 &#39;stimtype&#39;: &#39;gabors&#39;,
 &#39;visflow_dir&#39;: &#39;none&#39;,
 &#39;visflow_size&#39;: &#39;none&#39;}

    `ex_traces_df` dictionary (first few lines):
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lines</th>
      <th>mouse_ns</th>
      <th>mouseids</th>
      <th>nrois</th>
      <th>planes</th>
      <th>roi_ns</th>
      <th>sess_ns</th>
      <th>sessids</th>
      <th>time_values</th>
      <th>trace_stats</th>
      <th>traces_sm</th>
      <th>twop_fps</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>L23-Cux2</td>
      <td>6</td>
      <td>413663</td>
      <td>628</td>
      <td>dend</td>
      <td>122</td>
      <td>1</td>
      <td>764704289</td>
      <td>[-0.9, -0.865909090909091, -0.8318181818181818...</td>
      <td>[0.10573407299391707, 0.19241825125624992, 0.2...</td>
      <td>[[-0.16625845433722208, -0.15440365392455874, ...</td>
      <td>30.078739</td>
    </tr>
    <tr>
      <th>1</th>
      <td>L23-Cux2</td>
      <td>6</td>
      <td>413663</td>
      <td>628</td>
      <td>dend</td>
      <td>414</td>
      <td>1</td>
      <td>764704289</td>
      <td>[-0.9, -0.865909090909091, -0.8318181818181818...</td>
      <td>[0.18760472809531015, 0.20952567461814608, 0.2...</td>
      <td>[[0.24947229694546555, 0.16931314778601272, -0...</td>
      <td>30.078739</td>
    </tr>
    <tr>
      <th>2</th>
      <td>L23-Cux2</td>
      <td>6</td>
      <td>413663</td>
      <td>628</td>
      <td>dend</td>
      <td>492</td>
      <td>1</td>
      <td>764704289</td>
      <td>[-0.9, -0.865909090909091, -0.8318181818181818...</td>
      <td>[0.004832788360818673, -0.0338477988971241, -0...</td>
      <td>[[-0.10672006721834928, -0.04959881255541772, ...</td>
      <td>30.078739</td>
    </tr>
    <tr>
      <th>3</th>
      <td>L23-Cux2</td>
      <td>9</td>
      <td>433414</td>
      <td>727</td>
      <td>dend</td>
      <td>39</td>
      <td>1</td>
      <td>826187862</td>
      <td>[-0.9, -0.865909090909091, -0.8318181818181818...</td>
      <td>[-0.019534519382456747, -0.012189079949137373,...</td>
      <td>[[-0.1736838482063191, -0.13571991076396228, -...</td>
      <td>30.145366</td>
    </tr>
    <tr>
      <th>4</th>
      <td>L23-Cux2</td>
      <td>9</td>
      <td>433414</td>
      <td>727</td>
      <td>dend</td>
      <td>409</td>
      <td>1</td>
      <td>826187862</td>
      <td>[-0.9, -0.865909090909091, -0.8318181818181818...</td>
      <td>[0.04581271141583216, 0.034367225059258044, 0....</td>
      <td>[[0.037667924536534614, 0.0378937337125492, 0....</td>
      <td>30.145366</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="replications">
<h2>Replications<a class="headerlink" href="#replications" title="Permalink to this heading">#</a></h2>
<p>The functions used to replicate the figures below have been specifically written to work with the data dictionaries generated for these paper analyses. As a result, they are not directly applicable to other datasets or analyses. Instead, these functions can be seen as helpful examples for how to store the parameters and results of an analysis in minimal, portal files, and directly plot informative figures in <code class="docutils literal notranslate"><span class="pre">Python</span></code> from the stored data.</p>
<p>Note that the functions may call some additional functions from the <code class="docutils literal notranslate"><span class="pre">cred_assign_utils</span></code> module. The functions in this extra module mostly handle aesthetic details in the plots, and were left out of the notebook for brevity.</p>
<section id="replication-1-tracked-roi-examples-dataset-descriptor-paper-fig-2b">
<h3>Replication 1. Tracked ROI examples (Dataset descriptor paper, Fig. 2B)<a class="headerlink" href="#replication-1-tracked-roi-examples-dataset-descriptor-paper-fig-2b" title="Permalink to this heading">#</a></h3>
<p>As described above, for this dataset, two-photon calcium imaging was performed in each mouse across three sessions, in the same imaging plane. Since the imaging planes were carefully aligned between sessions, it was possible to track the individual somata or distal apical dendrite segments across sessions for each mouse. First, individual somata or distal apical dendrite segments were identified in each session as <strong>R</strong>egions <strong>O</strong>f <strong>I</strong>nterest (ROIs). Then, the ROIs that could be reliably identified in all three sessions were included in the subset of “tracked” ROIs.</p>
<p>The following function, <code class="docutils literal notranslate"><span class="pre">plot_roi_masks_overlayed_with_proj(roi_mask_df)</span></code>, plots tracked ROI contours for all three imaging sessions, as well as their overlays, for two example mice.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_roi_masks_overlayed_with_proj</span><span class="p">(</span><span class="n">roi_mask_df</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rasterize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    plot_roi_masks_overlayed_with_proj(roi_mask_df)</span>

<span class="sd">    Plots ROI mask contours overlayed over imaging planes, and ROI masks </span>
<span class="sd">    overlayed over each other across sessions.</span>

<span class="sd">    Required args:</span>
<span class="sd">        - roi_mask_df (pd.DataFrame in dict format):</span>
<span class="sd">            dataframe with a row for each mouse, and the following </span>
<span class="sd">            columns, in addition to the basic sess_df columns: </span>

<span class="sd">            - &quot;max_projections&quot; (list): pixel intensities of maximum projection </span>
<span class="sd">                for the plane (hei x wid)</span>
<span class="sd">            - &quot;registered_roi_mask_idxs&quot; (list): list of mask indices, </span>
<span class="sd">                registered across sessions, for each session </span>
<span class="sd">                (flattened across ROIs) ((sess, hei, wid) x val)</span>
<span class="sd">            - &quot;roi_mask_idxs&quot; (list): list of mask indices for each session, </span>
<span class="sd">                and each ROI (sess x (ROI, hei, wid) x val) (not registered)</span>
<span class="sd">            - &quot;roi_mask_shapes&quot; (list): shape into which ROI mask indices index </span>
<span class="sd">                (sess x hei x wid)</span>
<span class="sd">            - &quot;crop_fact&quot; (num): factor by which to crop masks (&gt; 1) </span>
<span class="sd">            - &quot;shift_prop_hei&quot; (float): proportion by which to shift cropped </span>
<span class="sd">                mask center vertically from left edge [0, 1]</span>
<span class="sd">            - &quot;shift_prop_wid&quot; (float): proportion by which to shift cropped </span>
<span class="sd">                mask center horizontally from left edge [0, 1]</span>

<span class="sd">    Optional args:</span>
<span class="sd">        - title (str):</span>
<span class="sd">            plot title</span>
<span class="sd">            default: None</span>
<span class="sd">        - rasterize (bool):</span>
<span class="sd">            if True, individual grey lines are rasterized (reduces save time)</span>
<span class="sd">            default: False</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get all unique session numbers</span>
    <span class="n">all_sess_ns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">roi_mask_df</span><span class="p">[</span><span class="s2">&quot;sess_ns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">all_sess_ns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_sess_ns</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>    
    
    <span class="c1"># map session numbers to colors</span>
    <span class="n">sess_cols</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">sess_n</span><span class="p">:</span> <span class="n">col</span> <span class="k">for</span> <span class="n">sess_n</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_sess_ns</span><span class="p">,</span> <span class="n">ORDERED_COLORS</span><span class="p">)</span>
        <span class="p">}</span>
    
    <span class="c1"># aggregate plotting info</span>
    <span class="n">n_lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roi_mask_df</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">n_planes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">roi_mask_df</span><span class="p">[</span><span class="s2">&quot;planes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">n_sess</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sess_cols</span><span class="p">)</span>

    <span class="n">n_cols</span> <span class="o">=</span> <span class="n">n_sess</span> <span class="o">*</span> <span class="n">n_lines</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="n">n_planes</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">figpar</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;figsize&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">n_cols</span> <span class="o">*</span> <span class="mf">2.3</span><span class="p">,</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="mf">2.3</span><span class="p">),</span>
        <span class="s2">&quot;gridspec_kw&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;wspace&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s2">&quot;hspace&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
        <span class="s2">&quot;ncols&quot;</span><span class="p">:</span> <span class="n">n_cols</span><span class="p">,</span>
        <span class="s2">&quot;nrows&quot;</span><span class="p">:</span> <span class="n">n_rows</span><span class="p">,</span>
        <span class="s2">&quot;squeeze&quot;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">}</span>
    
    <span class="c1"># initialize figure</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="o">**</span><span class="n">figpar</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Tracked ROI examples&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.93</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
    
    <span class="c1"># plot each set of ROI traces</span>
    <span class="n">alpha</span><span class="p">,</span> <span class="n">raster_zorder</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">plane</span><span class="p">),</span> <span class="n">lp_mask_df</span> <span class="ow">in</span> <span class="n">roi_mask_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="s2">&quot;planes&quot;</span><span class="p">]):</span>
        <span class="n">li</span><span class="p">,</span> <span class="n">pl</span> <span class="o">=</span> <span class="n">LINPLA_INFO</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">plane</span><span class="p">][</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span>
        <span class="n">lp_col</span> <span class="o">=</span> <span class="n">LINPLA_INFO</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">plane</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
        <span class="n">lp_name</span> <span class="o">=</span> <span class="n">LINPLA_INFO</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">plane</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lp_mask_df</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Expected only one row per line/plane.&quot;</span><span class="p">)</span>
        <span class="n">lp_row</span> <span class="o">=</span> <span class="n">lp_mask_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lp_mask_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="c1"># identify subplots</span>
        <span class="n">base_row</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl</span> <span class="o">%</span> <span class="n">n_planes</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_planes</span>
        <span class="n">base_col</span> <span class="o">=</span> <span class="p">(</span><span class="n">li</span> <span class="o">%</span> <span class="n">n_lines</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_lines</span>

        <span class="n">ax_grp</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">base_row</span> <span class="p">:</span> <span class="n">base_row</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">base_col</span> <span class="p">:</span> <span class="n">base_col</span> <span class="o">+</span> <span class="n">n_sess</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># add imaging planes and masks</span>
        <span class="n">imaging_planes</span> <span class="o">=</span> <span class="n">cred_assign_utils</span><span class="o">.</span><span class="n">add_proj_and_roi_masks</span><span class="p">(</span>
            <span class="n">ax_grp</span><span class="p">,</span> <span class="n">lp_row</span><span class="p">,</span> <span class="n">sess_cols</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">proj_zorder</span><span class="o">=</span><span class="n">raster_zorder</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">)</span>

        <span class="c1"># add markings</span>
        <span class="n">shared_row</span> <span class="o">=</span> <span class="n">base_row</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">shared_col</span> <span class="o">=</span> <span class="n">base_col</span> <span class="o">+</span> <span class="nb">int</span><span class="p">((</span><span class="n">n_sess</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">shared_sub_ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">shared_row</span><span class="p">,</span> <span class="n">shared_col</span><span class="p">]</span>

        <span class="c1"># add labels</span>
        <span class="k">if</span> <span class="n">shared_col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shared_sub_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">lp_name</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">lp_col</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lp_sub_ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">shared_row</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">lp_sub_ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">lp_sub_ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">lp_sub_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">lp_name</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">lp_col</span><span class="p">,</span> 
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;x-large&quot;</span>
                <span class="p">)</span>

        <span class="c1"># add scale bar</span>
        <span class="k">if</span> <span class="n">n_sess</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Scale bar placement not implemented for fewer than 2 &quot;</span>
                <span class="s2">&quot;sessions.&quot;</span>
                <span class="p">)</span>
        <span class="n">scale_ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">shared_row</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">wid_len</span> <span class="o">=</span> <span class="n">imaging_planes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cred_assign_utils</span><span class="o">.</span><span class="n">add_scale_marker</span><span class="p">(</span><span class="n">scale_ax</span><span class="p">,</span> <span class="n">side_len</span><span class="o">=</span><span class="n">wid_len</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    
    <span class="c1"># rasterize imaging planes, if applicable</span>
    <span class="k">if</span> <span class="n">rasterize</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Rasterizing imaging plane images...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">sub_ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">sub_ax</span><span class="o">.</span><span class="n">set_rasterization_zorder</span><span class="p">(</span><span class="n">raster_zorder</span><span class="p">)</span>

    <span class="c1"># minor aesthetic tweaks</span>
    <span class="k">for</span> <span class="n">sub_ax</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
        <span class="n">sub_ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">sub_ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">]:</span>
            <span class="n">sub_ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">spine</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                
    <span class="c1"># add legend</span>
    <span class="n">leg_handles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sess_n</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">sess_cols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">leg_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;sess </span><span class="si">{</span><span class="n">sess_n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
        <span class="n">handles</span><span class="o">=</span><span class="n">leg_handles</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;small&quot;</span><span class="p">,</span> <span class="n">borderpad</span><span class="o">=</span><span class="mf">0.75</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Specifically, examples are shown for one L5-D mouse and one L5-S mouse. In each case, at the top, the two-photon calcium imaging projections are shown for each recording session (1-3, left to right). Dendritic segments (top) and somata (bottom) can be seen as white blobs over a black background. Over the projections, the contours of tracked ROIs have been drawn in different colors for each section. Below these images, the ROI masks for all three imaging sessions are shown realigned and overlayed.</p>
<p>Note that in each case, the images do not reflect the full field of view. Instead, a cropped-in section is shown, for better visibility. Scale bars show actual size of each image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_dict</span> <span class="o">=</span> <span class="n">load_data_dict</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">panel</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">paper</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">)</span>

<span class="n">plot_roi_masks_overlayed_with_proj</span><span class="p">(</span><span class="n">roi_mask_df</span><span class="o">=</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;roi_mask_df&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading data for dataset paper Fig. 2B
</pre></div>
</div>
<img alt="../_images/c75e36f97aa556d82c981bfe36bd3db6f426845a190d6a569ac0cb958495be57.png" src="../_images/c75e36f97aa556d82c981bfe36bd3db6f426845a190d6a569ac0cb958495be57.png" />
</div>
</div>
</section>
<section id="replication-2-example-roi-responses-to-inconsistent-gabor-sequences-dataset-descriptor-paper-fig-5b">
<h3>Replication 2. Example ROI responses to inconsistent Gabor sequences (Dataset descriptor paper, Fig. 5B)<a class="headerlink" href="#replication-2-example-roi-responses-to-inconsistent-gabor-sequences-dataset-descriptor-paper-fig-5b" title="Permalink to this heading">#</a></h3>
<p>The following general function, <code class="docutils literal notranslate"><span class="pre">plot_ex_traces(ex_traces_df)</span></code>, plots example ROI responses to inconsistent Gabor sequences. It calls the function defined right below, <code class="docutils literal notranslate"><span class="pre">add_subplot_roi_traces(sub_ax,</span> <span class="pre">df_row)</span></code>, to plot traces in each individual plot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_ex_traces</span><span class="p">(</span><span class="n">ex_traces_df</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rasterize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    plot_ex_traces(ex_traces_df)</span>

<span class="sd">    Plots example traces.</span>

<span class="sd">    Required args:</span>
<span class="sd">        - ex_traces_df (pd.DataFrame):</span>
<span class="sd">            dataframe with a row for each ROI, and the following columns, </span>
<span class="sd">            in addition to the basic sess_df columns: </span>
<span class="sd">            - time_values (list): values for each frame, in seconds</span>
<span class="sd">            - roi_ns (list): selected ROI number</span>
<span class="sd">             - traces_sm (list): selected ROI sequence traces, smoothed, with </span>
<span class="sd">                dims: seq x frames</span>
<span class="sd">            - trace_stat (list): selected ROI trace mean or median</span>
<span class="sd">    </span>
<span class="sd">    Optional args:</span>
<span class="sd">        - title (str):</span>
<span class="sd">            plot title</span>
<span class="sd">            default: None</span>
<span class="sd">        - rasterize (bool):</span>
<span class="sd">            if True, individual grey lines are rasterized (if saving figure, reduces save time and file size)</span>
<span class="sd">            default: False</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># aggregate plotting info</span>
    <span class="n">group_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="s2">&quot;planes&quot;</span><span class="p">]</span>
    <span class="n">n_per</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
        <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">lp_df</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">lp_df</span> <span class="ow">in</span> <span class="n">ex_traces_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_columns</span><span class="p">)]</span>
        <span class="p">)</span>
    <span class="n">per_rows</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">per_cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_per</span> <span class="o">/</span> <span class="n">per_rows</span><span class="p">))</span>
    
    <span class="n">figpar</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ncols&quot;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">per_cols</span><span class="p">,</span>
        <span class="s2">&quot;nrows&quot;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">per_rows</span><span class="p">,</span>
        <span class="s2">&quot;figsize&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">per_cols</span> <span class="o">*</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">per_rows</span> <span class="o">*</span> <span class="mf">1.25</span><span class="p">),</span>
        <span class="s2">&quot;sharex&quot;</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">}</span>
    
    <span class="c1"># initialize figure</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="o">**</span><span class="n">figpar</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Example ROI responses to inconsistent Gabor sequences&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.03</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

    <span class="c1"># plot traces</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Plotting individual traces...&quot;</span><span class="p">)</span>
    <span class="n">raster_zorder</span> <span class="o">=</span> <span class="o">-</span><span class="mi">12</span>
    <span class="n">ylims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">plane</span><span class="p">),</span> <span class="n">lp_df</span> <span class="ow">in</span> <span class="n">ex_traces_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="s2">&quot;planes&quot;</span><span class="p">]):</span>
        <span class="n">li</span><span class="p">,</span> <span class="n">pl</span> <span class="o">=</span> <span class="n">LINPLA_INFO</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">plane</span><span class="p">][</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">LINPLA_INFO</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">plane</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
        <span class="n">dash</span> <span class="o">=</span> <span class="n">DASH</span><span class="p">[</span><span class="n">line</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lp_df</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
            <span class="n">row_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pl</span> <span class="o">*</span> <span class="n">per_rows</span> <span class="o">+</span> <span class="n">i</span> <span class="o">%</span> <span class="n">per_rows</span><span class="p">)</span>
            <span class="n">col_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">li</span> <span class="o">*</span> <span class="n">per_cols</span> <span class="o">+</span> <span class="n">i</span> <span class="o">//</span> <span class="n">per_rows</span><span class="p">)</span>
            <span class="n">sub_ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span>

            <span class="n">ylims</span><span class="p">[</span><span class="n">row_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">add_subplot_roi_traces</span><span class="p">(</span>
                <span class="n">sub_ax</span><span class="p">,</span> <span class="n">lp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="n">dash</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="n">raster_zorder</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">)</span>

        <span class="n">time_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lp_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;time_values&quot;</span><span class="p">])</span>
    
    <span class="c1"># label and adjust subplots</span>
    <span class="n">cred_assign_utils</span><span class="o">.</span><span class="n">format_linpla_subaxes</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

    <span class="c1"># set x ticks</span>
    <span class="n">xvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">xval</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">xval</span> <span class="ow">in</span> <span class="p">[</span><span class="n">time_values</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">time_values</span><span class="o">.</span><span class="n">max</span><span class="p">()]]</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">xvals</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">xvals</span><span class="p">))</span>
    <span class="n">xticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">xvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">xvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">sub_ax</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">sub_ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
        <span class="n">sub_ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>  

    <span class="c1"># rasterize the gray lines, if applicable (if saving figure, reduces save time and file size substantially)</span>
    <span class="k">if</span> <span class="n">rasterize</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Rasterizing individual traces...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sub_ax</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">sub_ax</span><span class="o">.</span><span class="n">set_rasterization_zorder</span><span class="p">(</span><span class="n">raster_zorder</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_subplot_roi_traces</span><span class="p">(</span><span class="n">sub_ax</span><span class="p">,</span> <span class="n">df_row</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">13</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    add_subplot_roi_traces(sub_ax, df_row)</span>

<span class="sd">    Plots example traces in a subplot.</span>

<span class="sd">    Required args:</span>
<span class="sd">        - sub_ax (plt subplot):</span>
<span class="sd">            subplot</span>
<span class="sd">        - df_row (pd.Series): </span>
<span class="sd">            pandas DataFrame row to plot from</span>

<span class="sd">    Optional args:</span>
<span class="sd">        - col (str):</span>
<span class="sd">            trace statistic color</span>
<span class="sd">            default: &quot;k&quot;</span>
<span class="sd">        - dash (tuple or None):</span>
<span class="sd">            dash pattern to use for trace statistic</span>
<span class="sd">            default: None</span>
<span class="sd">        - zorder (int):</span>
<span class="sd">            zorder for the individual traces </span>
<span class="sd">            (zorder + 1 used for vertical dash line at 0)</span>
<span class="sd">            default: -13</span>

<span class="sd">    Returns:</span>
<span class="sd">        - ylims (list): </span>
<span class="sd">            rounded y limits to use for the subplot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sub_ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> 
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">time_values</span> <span class="o">=</span> <span class="n">df_row</span><span class="p">[</span><span class="s2">&quot;time_values&quot;</span><span class="p">]</span>
    <span class="n">traces_sm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">df_row</span><span class="p">[</span><span class="s2">&quot;traces_sm&quot;</span><span class="p">])</span>
    <span class="n">trace_stat</span> <span class="o">=</span> <span class="n">df_row</span><span class="p">[</span><span class="s2">&quot;trace_stats&quot;</span><span class="p">]</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">traces_sm</span><span class="p">))</span>

    <span class="n">sub_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">time_values</span><span class="p">,</span> <span class="n">traces_sm</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> 
        <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span>
        <span class="p">)</span>

    <span class="n">sub_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_values</span><span class="p">,</span> <span class="n">trace_stat</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="n">dash</span><span class="p">)</span>
    
    <span class="c1"># use percentiles to set bounds, asymmetrically</span>
    <span class="n">ymin_near</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">trace_stat</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">traces_sm</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)])</span>
    <span class="n">ymax_near</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">trace_stat</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">traces_sm</span><span class="p">,</span> <span class="mf">99.99</span><span class="p">)])</span>

    <span class="n">yrange_near</span> <span class="o">=</span> <span class="n">ymax_near</span> <span class="o">-</span> <span class="n">ymin_near</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">ymin_near</span> <span class="o">-</span> <span class="n">yrange_near</span> <span class="o">*</span> <span class="mf">0.05</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">ymax_near</span> <span class="o">+</span> <span class="n">yrange_near</span> <span class="o">*</span> <span class="mf">0.05</span>

    <span class="n">ylims</span> <span class="o">=</span> <span class="p">[</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ylims</span>
</pre></div>
</div>
</div>
</div>
<p>Specifically, for each of the four imaging planes, 6 example ROIs were selected for each imaging plane, from all the session 1 recordings (aggregated across mice). These ROIs were selected if they showed consistent responses to the Gabor sequences across sequence presentations. The fluorescence responses (ΔF/F) of the ROIs to each inconsistent sequence presentation are plotted in light gray. The mean response across inconsistent sequences is plotted in color.</p>
<p>The ROI responses for each imaging plane are arranged in a 2 column x 3 row quadrant (top left: L2/3-D, bottom left: L2/3-S, top right: L5-D, bottom right: L5-S). The vertical gray dashed lines at 0 seconds mark the onset of U images in the A-B-C-U-G sequences (-0.9 to 0.3 seconds). Additional gray dashed lines were plotted horizontal at 0, but are largely hidden by the gray traces.</p>
<p>Time, as a function of Gabor sequence image:</p>
<ul class="simple">
<li><p>A: -0.9 to -0.6 seconds</p></li>
<li><p>B: -0.6 to -0.3 seconds</p></li>
<li><p>C: -0.3 to  0.0 seconds</p></li>
<li><p>U:  0.0 to  0.3 seconds</p></li>
<li><p>G:  0.0 to  0.6 seconds</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_dict</span> <span class="o">=</span> <span class="n">load_data_dict</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">panel</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">paper</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">)</span>

<span class="n">plot_ex_traces</span><span class="p">(</span><span class="n">ex_traces_df</span><span class="o">=</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;ex_traces_df&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading data for dataset paper Fig. 5B
    Plotting individual traces...
</pre></div>
</div>
<img alt="../_images/f5e3b28ff05ce9219e278e9a1940e922c1ea4795cf25db92e19f2fa74d3c394b.png" src="../_images/f5e3b28ff05ce9219e278e9a1940e922c1ea4795cf25db92e19f2fa74d3c394b.png" />
</div>
</div>
</section>
<section id="replication-3-example-roi-responses-to-inconsistent-gabor-sequences-dataset-descriptor-paper-fig-6a">
<h3>Replication 3. Example ROI responses to inconsistent Gabor sequences (Dataset descriptor paper, Fig. 6A)<a class="headerlink" href="#replication-3-example-roi-responses-to-inconsistent-gabor-sequences-dataset-descriptor-paper-fig-6a" title="Permalink to this heading">#</a></h3>
<p>For each session, in addition to neuronal activity, pupil diameter and running velocity were recorded for each mouse.</p>
<p>The following function, <code class="docutils literal notranslate"><span class="pre">plot_pupil_run_full(sess_df)</span></code>, plots the pupil diameter and running traces for an example session.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_pupil_run_full</span><span class="p">(</span><span class="n">sess_df</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    plot_pupil_run_full(sess_df)</span>

<span class="sd">    Plots pupil and running data for a full session.</span>

<span class="sd">    Required args:</span>
<span class="sd">        - sess_df (pd.DataFrame):</span>
<span class="sd">            dataframe with one row per session, and the following columns, in </span>
<span class="sd">            addition to the basic sess_df columns:</span>
<span class="sd">            - duration_sec (float):</span>
<span class="sd">                duration of the session in seconds</span>
<span class="sd">            - pup_data (list):</span>
<span class="sd">                pupil data</span>
<span class="sd">            - pup_frames (list):</span>
<span class="sd">                start and stop pupil frame numbers for each stimulus type</span>
<span class="sd">            - run_data (list):</span>
<span class="sd">                running velocity data</span>
<span class="sd">            - run_frames (list):</span>
<span class="sd">                start and stop running frame numbers for each stimulus type</span>
<span class="sd">            - stims (list):</span>
<span class="sd">                stimulus types</span>

<span class="sd">    Optional args:</span>
<span class="sd">        - title (str):</span>
<span class="sd">            plot title</span>
<span class="sd">            default: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">datatypes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="s2">&quot;pupil&quot;</span><span class="p">]</span>
    <span class="n">datatype_strs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Running velocity (cm/s)&quot;</span><span class="p">,</span> <span class="s2">&quot;Pupil diameter (mm)&quot;</span><span class="p">]</span>
    <span class="n">n_datatypes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datatypes</span><span class="p">)</span>
    
    <span class="c1"># initialize figure</span>
    <span class="n">height_ratios</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.12</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.83</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">datatypes</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">datatypes</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="n">n_datatypes</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
        <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;height_ratios&quot;</span><span class="p">:</span> <span class="n">height_ratios</span><span class="p">},</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    
    <span class="c1"># add title</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Full session running and pupil responses&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

    <span class="c1"># retrieve data</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sess_df</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected sess_df to have one row.&quot;</span><span class="p">)</span>
    <span class="n">sess_row</span> <span class="o">=</span> <span class="n">sess_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sess_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">duration_sec</span> <span class="o">=</span> <span class="n">sess_row</span><span class="p">[</span><span class="s2">&quot;duration_sec&quot;</span><span class="p">]</span>

    <span class="c1"># plot traces for the session</span>
    <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">datatype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datatypes</span><span class="p">):</span>
        <span class="n">sub_ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sess_row</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datatype</span><span class="si">}</span><span class="s2">_data&quot;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">duration_sec</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">sub_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="n">sub_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
            <span class="n">datatype_strs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span>
            <span class="p">)</span>
        <span class="n">sub_ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">sub_ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">():</span>
            <span class="n">label</span><span class="o">.</span><span class="n">set_fontweight</span><span class="p">(</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
            <span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="s2">&quot;x-large&quot;</span><span class="p">)</span>

    <span class="c1"># minor aesthetic tweaks</span>
    <span class="k">for</span> <span class="n">sub_ax</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
        <span class="n">sub_ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">sub_ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="n">duration_sec</span> <span class="o">/</span> <span class="mi">50</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="n">pad</span><span class="p">,</span> <span class="n">duration_sec</span> <span class="o">+</span> <span class="n">pad</span><span class="p">)</span>

    <span class="c1"># add stimulus info</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">sess_row</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datatype</span><span class="si">}</span><span class="s2">_data&quot;</span><span class="p">]</span>
    <span class="n">fr_ranges</span> <span class="o">=</span> <span class="n">sess_row</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datatype</span><span class="si">}</span><span class="s2">_frames&quot;</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">duration_sec</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">stim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sess_row</span><span class="p">[</span><span class="s2">&quot;stims&quot;</span><span class="p">]):</span>
        <span class="n">sec_ranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">fr</span><span class="p">]</span> <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">fr_ranges</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sec_ranges</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
        <span class="n">stim_str</span> <span class="o">=</span> <span class="n">stim</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;right &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;left &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">stim_str</span> <span class="o">=</span> <span class="n">stim_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; (&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;))&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sec_ranges</span><span class="p">),</span> <span class="mf">0.45</span><span class="p">,</span> <span class="n">stim_str</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span> 
            <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;x-large&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span>
            <span class="p">)</span>

    <span class="c1"># add scale bar</span>
    <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;5 min&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;x-large&quot;</span><span class="p">,</span> 
        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Specifically, running velocity is plotted in the top row in cm/s, and pupil diameter is plotted in the bottom row, in mm. Sessions lasted 70 min in total, and the scale bar here represents 5 min. Above the plotted traces, the lines show the period during which each stimulus was presented. Left to right, these are the Gabor sequence stimulus, the nasal-to-temporal visual flow stimulus, and the temporal-to-nasal visual flow stimulus. The small gaps between the stimulus presentation lines represent the fact that each stimulus was preceeded and followed by 30 seconds of grayscreen.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_dict</span> <span class="o">=</span> <span class="n">load_data_dict</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">panel</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">paper</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">)</span>

<span class="n">plot_pupil_run_full</span><span class="p">(</span><span class="n">sess_df</span><span class="o">=</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;sess_df&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading data for dataset paper Fig. 6A
</pre></div>
</div>
<img alt="../_images/8972dc7156699e41402f14882a8039e6b9c4bb9a57dec6880efff3ca02942241.png" src="../_images/8972dc7156699e41402f14882a8039e6b9c4bb9a57dec6880efff3ca02942241.png" />
</div>
</div>
</section>
<section id="replication-4-mean-gabor-sequence-responses-for-example-rois-analysis-paper-fig-3a">
<h3>Replication 4. Mean Gabor sequence responses for example ROIs (Analysis paper, Fig. 3A)<a class="headerlink" href="#replication-4-mean-gabor-sequence-responses-for-example-rois-analysis-paper-fig-3a" title="Permalink to this heading">#</a></h3>
<p>Unlike the previous figures, this figure is drawn from the analysis preprint paper. In this paper, one of the metrics used to study the responses in the different imaging planes to consistent vs inconsistent stimuli was a selectivity index (USI), explained below. This plot shows responses of example ROIs from different imaging planes, with differing USIs.</p>
<p>The following general function, <code class="docutils literal notranslate"><span class="pre">plot_chosen_roi_traces(chosen_rois_df)</span></code>, plots mean fluorescence responses (ΔF/F) to consistent and inconsistent Gabor sequences for example ROIs. It calls the function defined right below, <code class="docutils literal notranslate"><span class="pre">add_USI_boxes(ax,</span> <span class="pre">chosen_rois_df,</span> <span class="pre">sorted_target_idxs)</span></code>, to label each plot with its ROI’s USI value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_chosen_roi_traces</span><span class="p">(</span><span class="n">chosen_rois_df</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    plot_chosen_roi_traces(chosen_rois_df) </span>
<span class="sd">    </span>
<span class="sd">    Plots traces for chosen ROIs from dataframe.</span>

<span class="sd">    Required args:</span>
<span class="sd">        - chosen_rois_df (pd.DataFrame):</span>
<span class="sd">            traces data frame with, in addition to the basic sess_df columns, </span>
<span class="sd">            columns &quot;trace_stats&quot;, &quot;target_idxs&quot;, and a &quot;time_values&quot; column</span>

<span class="sd">    Optional args:</span>
<span class="sd">        - title (str):</span>
<span class="sd">            plot title</span>
<span class="sd">            default: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">target_idxs</span> <span class="o">=</span> <span class="n">chosen_rois_df</span><span class="p">[</span><span class="s2">&quot;target_idxs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">target_idx_vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">target_idxs</span><span class="p">]</span>
    <span class="n">sorted_target_idxs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">target_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">target_idx_vals</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">]</span>
    
    <span class="c1"># aggregate plotting info</span>
    <span class="n">per_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_target_idxs</span><span class="p">)</span>
    <span class="n">figpar</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ncols&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;nrows&quot;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">per_rows</span><span class="p">,</span>
        <span class="s2">&quot;figsize&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mf">3.7</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">per_rows</span> <span class="o">*</span> <span class="mf">1.51</span><span class="p">),</span>
        <span class="s2">&quot;sharex&quot;</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">}</span>

    <span class="c1"># initialize figure</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="o">**</span><span class="n">figpar</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Gabor sequences (example ROIs)&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.03</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

    <span class="c1"># plot traces</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">plane</span><span class="p">),</span> <span class="n">lp_df</span> <span class="ow">in</span> <span class="n">chosen_rois_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="s2">&quot;planes&quot;</span><span class="p">]):</span>
        <span class="n">li</span><span class="p">,</span> <span class="n">pl</span> <span class="o">=</span> <span class="n">LINPLA_INFO</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">plane</span><span class="p">][</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">LINPLA_INFO</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">plane</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
        <span class="n">dash</span> <span class="o">=</span> <span class="n">DASH</span><span class="p">[</span><span class="n">line</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">row_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_target_idxs</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">lp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lp_df</span><span class="p">[</span><span class="s2">&quot;target_idxs&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row_val</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Expected row_order instances to be unique per line/plane.&quot;</span>
                    <span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">sub_ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">r</span> <span class="o">+</span> <span class="n">pl</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_target_idxs</span><span class="p">),</span> <span class="n">li</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;L2/3-Cux2&quot;</span><span class="p">:</span>
                <span class="n">exp_col</span> <span class="o">=</span> <span class="s2">&quot;darkgray&quot;</span> <span class="c1"># oddly, lighter than gray</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exp_col</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span>

            <span class="c1"># horizontal 0 line</span>
            <span class="n">sub_ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">13</span><span class="p">)</span>
            <span class="n">sub_ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">13</span><span class="p">)</span>

            <span class="c1"># plot data</span>
            <span class="n">time_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;time_values&quot;</span><span class="p">])</span>
            <span class="n">trace_st</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;roi_trace_stats&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="n">exp_col</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">,</span> <span class="s2">&quot;unexp&quot;</span><span class="p">])):</span>
                <span class="n">sub_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">time_values</span><span class="p">,</span> <span class="n">trace_st</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="n">dash</span>
                    <span class="p">)</span>
                <span class="n">up</span> <span class="o">=</span> <span class="n">trace_st</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">trace_st</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">down</span> <span class="o">=</span> <span class="n">trace_st</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">trace_st</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">sub_ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_values</span><span class="p">,</span> <span class="n">down</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># set y ticks</span>
    <span class="k">for</span> <span class="n">sub_ax</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">sub_ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">()</span>
        <span class="n">ylims</span> <span class="o">=</span> <span class="n">sub_ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">ylims</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="c1"># get the rounding order</span>
        <span class="n">o</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">ylim</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
        <span class="n">new_lims</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ylims</span><span class="p">]</span>
        <span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="n">ylim</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ylim</span><span class="p">]</span> <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="n">new_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="n">new_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="n">sub_ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
        <span class="n">sub_ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">new_lims</span><span class="p">)</span>

    <span class="c1"># label and adjust subplots</span>
    <span class="n">cred_assign_utils</span><span class="o">.</span><span class="n">format_linpla_subaxes</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

    <span class="c1"># set x ticks</span>
    <span class="n">xvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">xval</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">xval</span> <span class="ow">in</span> <span class="p">[</span><span class="n">time_values</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">time_values</span><span class="o">.</span><span class="n">max</span><span class="p">()]]</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">xvals</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">xvals</span><span class="p">))</span>
    <span class="n">xticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">xvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">xvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">sub_ax</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">sub_ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
        <span class="n">sub_ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>  
        
    <span class="c1"># add USI values</span>
    <span class="n">add_USI_boxes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">chosen_rois_df</span><span class="p">,</span> <span class="n">sorted_target_idxs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_USI_boxes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">chosen_rois_df</span><span class="p">,</span> <span class="n">sorted_target_idxs</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    add_USI_boxes(ax, chosen_rois_df, sorted_target_idxs)</span>

<span class="sd">    Adds boxes with USI values to individual plots (e.g., trace plots).</span>

<span class="sd">    Required args:</span>
<span class="sd">        - ax (subplot array):</span>
<span class="sd">            pyplot axis array</span>
<span class="sd">        - chosen_rois_df (pd.DataFrame):</span>
<span class="sd">            chosen ROIs dataframe with, in addition to the basic sess_df </span>
<span class="sd">            columns, &quot;target_idxs&quot;.</span>
<span class="sd">        - sorted_target_idxs (list): </span>
<span class="sd">            order in which different target_idxs should be added to subplots</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
        <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">plane</span><span class="p">),</span> <span class="n">lp_df</span> <span class="ow">in</span> <span class="n">chosen_rois_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="s2">&quot;planes&quot;</span><span class="p">]):</span>
        <span class="n">li</span><span class="p">,</span> <span class="n">pl</span> <span class="o">=</span> <span class="n">LINPLA_INFO</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">plane</span><span class="p">][</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">row_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_target_idxs</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">lp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lp_df</span><span class="p">[</span><span class="s2">&quot;target_idxs&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row_val</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Expected row_order instances to be unique per line/plane.&quot;</span>
                    <span class="p">)</span>

            <span class="n">row</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rows</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">sub_ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">r</span> <span class="o">+</span> <span class="n">pl</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_target_idxs</span><span class="p">),</span> <span class="n">li</span><span class="p">]</span>

            <span class="c1"># place a text box in upper left in axes coords</span>
            <span class="n">sub_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;USI = </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;roi_idxs&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                <span class="n">transform</span><span class="o">=</span><span class="n">sub_ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> 
                <span class="n">bbox</span><span class="o">=</span><span class="n">props</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Specifically, for each ROI in each recording session a Gabor sequence selectivity index (USI) was calculated. This selectivity index reflects the degree to which an ROI selectively responds to inconsistent (positive USI) or consistent (negative USI) sequences. Null USIs (i.e., USIs around 0) reflect no selectivity to either consistent or inconsistent sequences.</p>
<p>To provide examples of the fluorescence responses of ROIs with differing USIs, three example ROIs were selected for each imaging plane: one with a USI significantly above 0 (top), one with a USI significantly below 0 (bottom) and one with a USI close to 0 (middle). For each ROI, the mean fluorescence response (°) is plotted in gray for consistent sequences and in color for inconsistent sequences.</p>
<p>The same quadrant and color scheme is used for the imaging planes as in Replication 2. In addition, vertical gray dashed lines mark the onset of D/U images at 0 seconds in the A-B-C-U-G sequences (-0.9 to 0.3 seconds), while horizontal gray dashed lines mark 0. Each plot is labeled with its ROI’s USI value.</p>
<p>Since USIs were computed on the D-G / U-G part of the sequences, where the stimulus patterns diverge, the differences between the mean traces plotted largely occur after the gray line at 0 seconds.</p>
<p>Time, as a function of Gabor sequence image:</p>
<ul class="simple">
<li><p>A  : -0.9 to -0.6 seconds</p></li>
<li><p>B  : -0.6 to -0.3 seconds</p></li>
<li><p>C  : -0.3 to  0.0 seconds</p></li>
<li><p>D/U:  0.0 to  0.3 seconds</p></li>
<li><p>G  :  0.0 to  0.6 seconds</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_dict</span> <span class="o">=</span> <span class="n">load_data_dict</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">panel</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">paper</span><span class="o">=</span><span class="s2">&quot;analysis&quot;</span><span class="p">)</span>

<span class="n">plot_chosen_roi_traces</span><span class="p">(</span><span class="n">chosen_rois_df</span><span class="o">=</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;chosen_rois_df&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading data for analysis paper Fig. 3A
</pre></div>
</div>
<img alt="../_images/618dea4ce553fd5d931052d50415ce0b16950c50ba7dd5ab766c59a4b7229318.png" src="../_images/618dea4ce553fd5d931052d50415ce0b16950c50ba7dd5ab766c59a4b7229318.png" />
</div>
</div>
</section>
</section>
<section id="going-further">
<h2>Going further<a class="headerlink" href="#going-further" title="Permalink to this heading">#</a></h2>
<p>As mentioned above, these examples show how to plot a few sample figures from the dataset descriptor paper <span id="id5">[<a class="reference internal" href="../bibliography.html#id19" title="Colleen J. Gillon, Jérôme A. Lecoq, Jason E. Pina, Ruweida Ahmed, Yazan N. Billeh, Shiella Caldejon, Peter Groblewski, Timothy M. Henley, India Kato, Eric Lee, Jennifer Luviano, Kyla Mace, Chelsea Nayan, Thuyanh V. Nguyen, Kat North, Jed Perkins, Sam Seid, Matthew T. Valley, Ali Williford, Yoshua Bengio, Timothy P. Lillicrap, Joel Zylberberg, and Blake A. Richards. Responses of pyramidal cell somata and apical dendrites in mouse visual cortex over multiple days. Scientific Data, 2023. URL: https://www.nature.com/articles/s41597-023-02214-y.">Gillon <em>et al.</em>, 2023</a>]</span>, and one figure from the preprint analysis paper <span id="id6">[<a class="reference internal" href="../bibliography.html#id18" title="Colleen J. Gillon, Jason E. Pina, Jérôme A. Lecoq, Ruweida Ahmed, Yazan N. Billeh, Shiella Caldejon, Peter Groblewski, Timothy M. Henley, India Kato, Eric Lee, Jennifer Luviano, Kyla Mace, Chelsea Nayan, Thuyanh V. Nguyen, Kat North, Jed Perkins, Sam Seid, Matthew T. Valley, Ali Williford, Yoshua Bengio, Timothy P. Lillicrap, Blake A. Richards, and Joel Zylberberg. Learning from unexpected events in the neocortical microcircuit. BioRxiv, 2021. URL: https://www.biorxiv.org/content/10.1101/2021.01.15.426915v3.full.pdf.">Gillon <em>et al.</em>, 2021</a>]</span> using presaved data dictionaries.</p>
<p>To understand the full scope of the dataset and analyses, please consult these papers. To work with the full analysis pipeline for this dataset, from NWB data files to final plots, see the <a class="reference external" href="https://github.com/colleenjg/OpenScope_CA_Analysis">OpenScope_CA_Analysis</a> GitHub repository.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "AllenInstitute/openscope_databook",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./replication"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../higher-order/cebra_time.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Using CEBRA-Time to Identify Latent Embeddings</p>
      </div>
    </a>
    <a class="right-next"
       href="../embargoed/modality_alignment.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Aligning Data across Modalities</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-of-experiments">Summary of experiments</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">Environment Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-plotting-defaults">Setting plotting defaults</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-additional-plotting-hyperparameters">Setting additional plotting hyperparameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-data-dictionaries-for-plotting">Loading data dictionaries for plotting</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#replications">Replications</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replication-1-tracked-roi-examples-dataset-descriptor-paper-fig-2b">Replication 1. Tracked ROI examples (Dataset descriptor paper, Fig. 2B)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replication-2-example-roi-responses-to-inconsistent-gabor-sequences-dataset-descriptor-paper-fig-5b">Replication 2. Example ROI responses to inconsistent Gabor sequences (Dataset descriptor paper, Fig. 5B)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replication-3-example-roi-responses-to-inconsistent-gabor-sequences-dataset-descriptor-paper-fig-6a">Replication 3. Example ROI responses to inconsistent Gabor sequences (Dataset descriptor paper, Fig. 6A)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replication-4-mean-gabor-sequence-responses-for-example-rois-analysis-paper-fig-3a">Replication 4. Mean Gabor sequence responses for example ROIs (Analysis paper, Fig. 3A)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#going-further">Going further</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Carter Peene
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>