
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Introduction to the Temporal Barcode Dataset &#8212; OpenScope Databook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-TJPN1M4PDX"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-TJPN1M4PDX');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-TJPN1M4PDX');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'projects/barcoding';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="OpenScope’s Vision2Hippocampus Dataset" href="vippo.html" />
    <link rel="prev" title="OpenScope’s Sequence Learning Dataset" href="sequence_learning.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="OpenScope Databook - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="OpenScope Databook - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    OpenScope Databook
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../basics/background.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/download_nwb.html">Downloading an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/stream_nwb.html">Streaming an NWB File with remfile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/read_nwb.html">Reading an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/use_nwbwidgets.html">Exploring an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/get_dandiset_metadata.html">Getting Experimental Metadata from DANDI</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Visualizing NWB Files</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_2p_raw.html">Visualizing Raw 2-Photon Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_metrics.html">Visualizing Unit Quality Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_lfp_responses.html">Visualizing LFP Responses to Stimuli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_responses.html">Visualizing Neuronal Unit Responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_2p_responses.html">Visualizing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_spikes.html">Visualizing Neuronal Unit Spikes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_neuropixels_probes.html">Visualizing Neuropixels Probe Locations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_templates.html">Visualizing Stimulus Templates</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">First-Order Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../first-order/receptive_fields.html">Showing Receptive Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/optotagging.html">Identifying Optotagged Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/current_source_density.html">Current Source Density Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/classify_waveforms.html">Classifying Fast-Spiking and Regular-Spiking Neurons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/test_2p_responses.html">Statistically Testing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/test_unit_responses.html">Statistically Testing Spike Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/suite2p.html">Identifying Regions of Interest with Segmentation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Higher-Order Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../higher-order/cebra_time.html">Using CEBRA-Time to Identify Latent Embeddings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../higher-order/tca.html">Tensor Decomposition of Spiking Activity Through Trials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../higher-order/glm.html">Generalized Linear Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../higher-order/behavioral_state.html">Behavioral State from Trial Outcomes</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Openscope Experimental Projects</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="cred_assign_figures.html">Replicating OpenScope Credit Assignment project figures</a></li>
<li class="toctree-l1"><a class="reference internal" href="glo.html">OpenScope’s Global/Local Oddball Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="illusion.html">OpenScope’s Illusion Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="dendritic_coupling.html">OpenScope’s Dendritic Coupling Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="sequence_learning.html">OpenScope’s Sequence Learning Dataset</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Introduction to the Temporal Barcode Dataset</a></li>


<li class="toctree-l1"><a class="reference internal" href="vippo.html">OpenScope’s Vision2Hippocampus Dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Embargoed Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../embargoed/modality_alignment.html">Aligning Data across Modalities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/visualize_behavior.html">Visualizing Behavioral Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/test_2p_responses_embargoed.html">Statistically Testing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/cell_matching.html">Cell Matching Across Days</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Methods</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../methods/jupyter_book.html">Jupyter/Jupyter Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods/github.html">Git/GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods/environments.html">Managing Environments on Multiple Platforms</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../contribution.html">Contributing to the Databook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors_index.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html">FAQ</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/AllenInstitute/openscope_databook/main?urlpath=lab/tree/docs/projects/barcoding.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://hub.dandiarchive.org/hub/user-redirect/git-pull?repo=https%3A//github.com/AllenInstitute/openscope_databook&urlpath=lab/tree/openscope_databook/docs/projects/barcoding.ipynb&branch=main" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on JupyterHub"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="JupyterHub logo" src="../_static/images/logo_jupyterhub.svg">
  </span>
<span class="btn__text-container">JupyterHub</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/AllenInstitute/openscope_databook/blob/main/docs/projects/barcoding.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/AllenInstitute/openscope_databook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/AllenInstitute/openscope_databook/issues/new?title=Issue%20on%20page%20%2Fprojects/barcoding.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/projects/barcoding.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Introduction to the Temporal Barcode Dataset</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Introduction to the Temporal Barcode Dataset</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-1-white-noise-stimuli-evoke-temporally-precise-neural-responses-a-recording-of-a-salamander-retinal-ganglion-cell-in-a-dish-in-response-to-repeated-white-noise-full-field-flicker-from-berry-and-meister-1998-see-also-pillow-et-al-2005-b-recording-of-an-anesthetized-cat-lgn-cell-in-response-to-repeated-white-noise-fullfield-flicker-from-reinagel-and-reid-2000-c-response-of-an-alert-macaque-cortical-area-mt-neuron-in-response-to-a-grating-stimulus-whose-drift-direction-was-modulated-with-repeated-white-noise-from-buracas-et-al-1998">Figure 1. White noise stimuli evoke temporally precise neural responses. A. Recording of a salamander retinal ganglion cell in a dish in response to repeated white noise full-field flicker (from Berry and Meister 1998). See also: Pillow et al 2005, B. Recording of an anesthetized cat LGN cell in response to repeated white noise fullfield flicker (from Reinagel and Reid, 2000). C. Response of an alert macaque cortical area MT neuron in response to a grating stimulus whose drift direction was modulated with repeated white noise (from Buracas et al, 1998).</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-2-temporal-barcodes-define-reproducible-and-stable-types-a-recording-of-lgn-cells-in-two-different-anesthetized-cats-in-response-to-the-same-repeated-white-noise-full-field-flicker-from-reinagel-and-reid-2002-b-recordings-from-a-salamander-retinal-ganglion-cell-vs-a-rabbit-retinal-ganglion-cell-in-response-to-the-same-repeated-white-noise-full-field-flicker-from-berry-et-al-1997-c-recording-of-a-cat-lgn-cell-to-the-same-repeated-white-noise-full-field-flicker-shown-at-different-contrasts-from-gaudry-and-reinagel-2007">Figure 2. Temporal barcodes define reproducible and stable types. A. Recording of LGN cells in two different anesthetized cats in response to the same repeated white noise full-field flicker (from Reinagel and Reid, 2002). B. Recordings from a salamander retinal ganglion cell vs. a rabbit retinal ganglion cell in response to the same repeated white noise full-field flicker (from Berry et al, 1997). C. recording of a cat LGN cell to the same repeated white noise full-field flicker shown at different contrasts (from Gaudry and Reinagel, 2007).*</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-experiment">The Experiment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-ecephys-file">Downloading Ecephys File</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#showing-probe-tracks">Showing Probe Tracks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#find-out-about-the-units-recorded-in-the-experiment">Find out about the units recorded in the experiment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-stimulus-times">Loading Stimulus Times</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-trial-aligned-event-times">Getting Trial-Aligned Event Times</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-rasters">Plotting rasters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-psths">Plotting PSTHs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#statistical-criterion-for-psth-peaks">Statistical criterion for PSTH peaks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-barcodes">Extracting barcodes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spike-distance-metric">5. Spike Distance Metric</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-distances-between-barcodes">Computing Distances Between Barcodes</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#to-illustrate-the-spike-distance-metric-let-s-compare-two-fictional-barcodes">To illustrate the spike distance metric let’s compare two fictional barcodes</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#now-compute-the-distance-between-the-barcodes-of-the-two-example-neurons-above-that-had-barcodes">Now compute the distance between the barcodes of the two example neurons above that had barcodes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-does-the-distance-between-two-barcodes-mean">What does the distance between two barcodes mean?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#circular-permutation-explained">Circular permutation explained</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises-for-the-reader">Exercises for the reader</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#other-things-you-can-find-in-this-dataset">Other things you can find in this dataset</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#session-timeline">Session Timeline</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-receptive-fields">Visualizing Receptive Fields</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="introduction-to-the-temporal-barcode-dataset">
<h1>Introduction to the Temporal Barcode Dataset<a class="headerlink" href="#introduction-to-the-temporal-barcode-dataset" title="Link to this heading">#</a></h1>
<p>When cortical neurons are injected with white noise current in a slice, the elicited spike
times are highly reproducible (Mainen and Sejnowski, 1995). Visual neurons also respond to white
noise flicker visual stimuli with high temporal precision, for example in retinal ganglion cells
(Fig1A), LGN (Fig1B), or cortical area MT (Fig1C), to name just a few. Similar results are
reported in other sensory modalities (e.g. Kayser et al, 2010; Jarocka et al, 2021). When such
stimuli are presented repeatedly and the neural responses displayed as spike rasters (Figure 1)
the rasters look remarkably like UPC codes or bar codes. The Temporal Barcode Dataset provides
these barcodes for visually responsive neurons throughout the brain of an awake mouse.</p>
<p><img alt="barcoding_fig1.png" src="../_images/barcoding_fig1.png" /></p>
<section id="figure-1-white-noise-stimuli-evoke-temporally-precise-neural-responses-a-recording-of-a-salamander-retinal-ganglion-cell-in-a-dish-in-response-to-repeated-white-noise-full-field-flicker-from-berry-and-meister-1998-see-also-pillow-et-al-2005-b-recording-of-an-anesthetized-cat-lgn-cell-in-response-to-repeated-white-noise-fullfield-flicker-from-reinagel-and-reid-2000-c-response-of-an-alert-macaque-cortical-area-mt-neuron-in-response-to-a-grating-stimulus-whose-drift-direction-was-modulated-with-repeated-white-noise-from-buracas-et-al-1998">
<h2>Figure 1. White noise stimuli evoke temporally precise neural responses. A. Recording of a salamander retinal ganglion cell in a dish in response to repeated white noise full-field flicker (from Berry and Meister 1998). See also: Pillow et al 2005, B. Recording of an anesthetized cat LGN cell in response to repeated white noise fullfield flicker (from Reinagel and Reid, 2000). C. Response of an alert macaque cortical area MT neuron in response to a grating stimulus whose drift direction was modulated with repeated white noise (from Buracas et al, 1998).<a class="headerlink" href="#figure-1-white-noise-stimuli-evoke-temporally-precise-neural-responses-a-recording-of-a-salamander-retinal-ganglion-cell-in-a-dish-in-response-to-repeated-white-noise-full-field-flicker-from-berry-and-meister-1998-see-also-pillow-et-al-2005-b-recording-of-an-anesthetized-cat-lgn-cell-in-response-to-repeated-white-noise-fullfield-flicker-from-reinagel-and-reid-2000-c-response-of-an-alert-macaque-cortical-area-mt-neuron-in-response-to-a-grating-stimulus-whose-drift-direction-was-modulated-with-repeated-white-noise-from-buracas-et-al-1998" title="Link to this heading">#</a></h2>
<p>Astonishingly, the same bar-code-like patterns have been found in neurons recorded in different individual animals (Fig 2A), and even neurons in different species (Fig 2B). The temporal pattern of one neuron’s response to the same visual stimulus sequence at different contrasts are systematically related (Fig 2C), as are responses of the same neuron to the same visual stimulus sequence at different luminance (Lewen et al., 2001). These findings have implications for dynamical models of neural spike coding (Fellous et al, 2004, Wang et al 2019). We speculated that these barcodes could be used as identifiers of discrete cell types.</p>
<p><img alt="barcoding_fig2.png" src="../_images/barcoding_fig2.png" /></p>
</section>
<section id="figure-2-temporal-barcodes-define-reproducible-and-stable-types-a-recording-of-lgn-cells-in-two-different-anesthetized-cats-in-response-to-the-same-repeated-white-noise-full-field-flicker-from-reinagel-and-reid-2002-b-recordings-from-a-salamander-retinal-ganglion-cell-vs-a-rabbit-retinal-ganglion-cell-in-response-to-the-same-repeated-white-noise-full-field-flicker-from-berry-et-al-1997-c-recording-of-a-cat-lgn-cell-to-the-same-repeated-white-noise-full-field-flicker-shown-at-different-contrasts-from-gaudry-and-reinagel-2007">
<h2>Figure 2. Temporal barcodes define reproducible and stable types. A. Recording of LGN cells in two different anesthetized cats in response to the same repeated white noise full-field flicker (from Reinagel and Reid, 2002). B. Recordings from a salamander retinal ganglion cell vs. a rabbit retinal ganglion cell in response to the same repeated white noise full-field flicker (from Berry et al, 1997). C. recording of a cat LGN cell to the same repeated white noise full-field flicker shown at different contrasts (from Gaudry and Reinagel, 2007).*<a class="headerlink" href="#figure-2-temporal-barcodes-define-reproducible-and-stable-types-a-recording-of-lgn-cells-in-two-different-anesthetized-cats-in-response-to-the-same-repeated-white-noise-full-field-flicker-from-reinagel-and-reid-2002-b-recordings-from-a-salamander-retinal-ganglion-cell-vs-a-rabbit-retinal-ganglion-cell-in-response-to-the-same-repeated-white-noise-full-field-flicker-from-berry-et-al-1997-c-recording-of-a-cat-lgn-cell-to-the-same-repeated-white-noise-full-field-flicker-shown-at-different-contrasts-from-gaudry-and-reinagel-2007" title="Link to this heading">#</a></h2>
<p>This experiment used the OpenScope Neuropixels passive viewing protocol, and displayed visual stimuli modulated in time by a short, repeated white noise sequence. The visual stimulus was either a spatially uniform field whose luminance was modulated in time (Full Field Flicker), or a standing sinusoidal grating whose contrast was modulated in time (Static Gratings). The best evidence for temporal barcodes has come from early visual areas (retina and LGN). Therefore, to obtain large populations of neurons in subcortical areas, roughly half of the mice were recorded in a novel electrode configuration. To our surprise, a majority of neurons in visual cortical areas responded to full field flicker with clear temporal barcodes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">databook_utils.dandi_utils</span> <span class="kn">import</span> <span class="n">dandi_download_open</span>
<span class="k">except</span><span class="p">:</span>
    <span class="o">!</span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/AllenInstitute/openscope_databook.git
    <span class="o">%</span><span class="k">cd</span> openscope_databook
    <span class="o">%</span><span class="k">pip</span> install -e .
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>            <span class="c1"># various numerical utilities</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">poisson</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">floor</span><span class="p">,</span> <span class="n">ceil</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-experiment">
<h2>The Experiment<a class="headerlink" href="#the-experiment" title="Link to this heading">#</a></h2>
<p>Shown in the metadata table below, Openscope’s Temporal Barcoding Experiment has produced 37 main files on the <a class="reference external" href="http://dandiarchive.org">DANDI Archive</a>, with 20 males and 17 females. There are 8 sst, 6 pval, and 23 wt genotypes. This table was generated from <a class="reference internal" href="../basics/get_dandiset_metadata.html"><span class="std std-doc">Getting Experimental Metadata from DANDI</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">session_files</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../../data/barcoding_sessions.csv&quot;</span><span class="p">)</span>
<span class="n">session_files</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>identifier</th>
      <th>size</th>
      <th>path</th>
      <th>session_time</th>
      <th>sub_name</th>
      <th>sub_sex</th>
      <th>sub_age</th>
      <th>sub_genotype</th>
      <th>probes</th>
      <th>stim types</th>
      <th>#_units</th>
      <th>session_length</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>c3bbf094-904e-43b7-83d5-be5a8bf3826f</td>
      <td>2828829044</td>
      <td>sub-699241/sub-699241_ses-1318772854_ogen.nwb</td>
      <td>2023-12-19 00:00:00-08:00</td>
      <td>699241</td>
      <td>M</td>
      <td>124</td>
      <td>Pvalb-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'probeD', 'probeC', 'probeF', 'probeE', 'prob...</td>
      <td>{'UniqueFFF_presentations', 'invalid_times', '...</td>
      <td>2299</td>
      <td>7251.236727</td>
    </tr>
    <tr>
      <th>1</th>
      <td>ad5f1431-2119-4e85-b98e-0a89d5c6fd08</td>
      <td>2992502541</td>
      <td>sub-699846/sub-699846_ses-1314466742_ogen.nwb</td>
      <td>2023-11-30 00:00:00-08:00</td>
      <td>699846</td>
      <td>M</td>
      <td>100</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'UniqueFFF_presentations', 'invalid_times', '...</td>
      <td>2771</td>
      <td>7248.796817</td>
    </tr>
    <tr>
      <th>2</th>
      <td>26c15f00-af2c-4cc3-97a2-ab32dbe998ae</td>
      <td>4721689639</td>
      <td>sub-698259/sub-698259_ses-1314229564_ogen.nwb</td>
      <td>2023-11-29 00:00:00-08:00</td>
      <td>698259</td>
      <td>M</td>
      <td>111</td>
      <td>Pvalb-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'UniqueFFF_presentations', 'invalid_times', '...</td>
      <td>2744</td>
      <td>12104.177760</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9f6591b5-22b5-4a23-8009-d9cfba9fe525</td>
      <td>3058306362</td>
      <td>sub-692990/sub-692990_ses-1310924284_ogen.nwb</td>
      <td>2023-11-14 00:00:00-08:00</td>
      <td>692990</td>
      <td>F</td>
      <td>129</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'UniqueFFF_presentations', 'invalid_times', '...</td>
      <td>3338</td>
      <td>7248.085747</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cbc9402d-64ff-4a8f-a688-add16d7b984c</td>
      <td>2973901434</td>
      <td>sub-697302/sub-697302_ses-1309845146_ogen.nwb</td>
      <td>2023-11-09 00:00:00-08:00</td>
      <td>697302</td>
      <td>F</td>
      <td>97</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'UniqueFFF_presentations', 'invalid_times', '...</td>
      <td>2824</td>
      <td>7248.555437</td>
    </tr>
    <tr>
      <th>5</th>
      <td>ae100c59-59ce-4f46-b4be-0d68ea357372</td>
      <td>3077972048</td>
      <td>sub-697303/sub-697303_ses-1309536438_ogen.nwb</td>
      <td>2023-11-08 00:00:00-08:00</td>
      <td>697303</td>
      <td>F</td>
      <td>96</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'UniqueFFF_presentations', 'invalid_times', '...</td>
      <td>3465</td>
      <td>7254.287277</td>
    </tr>
    <tr>
      <th>6</th>
      <td>e367b37d-c854-45ba-bdae-602df4614dea</td>
      <td>3157021325</td>
      <td>sub-692360/sub-692360_ses-1301730660_ogen.nwb</td>
      <td>2023-10-05 00:00:00-07:00</td>
      <td>692360</td>
      <td>M</td>
      <td>94</td>
      <td>Pvalb-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'UniqueFFF_presentations', 'invalid_times', '...</td>
      <td>2844</td>
      <td>7250.575147</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0e172dc4-eeb4-408d-946f-c80d83cce34a</td>
      <td>2739385785</td>
      <td>sub-692991/sub-692991_ses-1308221984_ogen.nwb</td>
      <td>2023-11-02 00:00:00-07:00</td>
      <td>692991</td>
      <td>F</td>
      <td>117</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'UniqueFFF_presentations', 'invalid_times', '...</td>
      <td>2529</td>
      <td>7248.935487</td>
    </tr>
    <tr>
      <th>8</th>
      <td>518fffd6-6ad2-4021-89eb-c0bb1767d541</td>
      <td>2978882451</td>
      <td>sub-692984/sub-692984_ses-1303229472_ogen.nwb</td>
      <td>2023-10-12 00:00:00-07:00</td>
      <td>692984</td>
      <td>M</td>
      <td>96</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'probeD', 'probeB', 'probeF', 'probeE', 'prob...</td>
      <td>{'UniqueFFF_presentations', 'invalid_times', '...</td>
      <td>2892</td>
      <td>7249.644247</td>
    </tr>
    <tr>
      <th>9</th>
      <td>96786f67-a6ac-44dc-ba58-61317082fff3</td>
      <td>2555712145</td>
      <td>sub-685263/sub-685263_ses-1292234897_ogen.nwb</td>
      <td>2023-08-23 00:00:00-07:00</td>
      <td>685263</td>
      <td>M</td>
      <td>95</td>
      <td>Pvalb-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'UniqueFFF_presentations', 'invalid_times', '...</td>
      <td>2791</td>
      <td>7248.094377</td>
    </tr>
    <tr>
      <th>10</th>
      <td>74d2c6b9-8bbf-4ff1-b2a2-b91d401c12bb</td>
      <td>3237433423</td>
      <td>sub-682745/sub-682745_ses-1290822286_ogen.nwb</td>
      <td>2023-08-17 00:00:00-07:00</td>
      <td>682745</td>
      <td>M</td>
      <td>105</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'UniqueFFF_presentations', 'invalid_times', '...</td>
      <td>2878</td>
      <td>7258.679237</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2f2ac304-83a3-4352-8612-5f34b68062a0</td>
      <td>2504326547</td>
      <td>sub-681446/sub-681446_ses-1290510496_ogen.nwb</td>
      <td>2023-08-16 00:00:00-07:00</td>
      <td>681446</td>
      <td>M</td>
      <td>112</td>
      <td>Pvalb-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'UniqueFFF_presentations', 'invalid_times', '...</td>
      <td>2572</td>
      <td>7249.424087</td>
    </tr>
    <tr>
      <th>12</th>
      <td>fb92563d-0e56-4c61-aa86-5645a637fa2d</td>
      <td>2705076858</td>
      <td>sub-691524/sub-691524_ses-1298257492_ogen.nwb</td>
      <td>2023-09-20 00:00:00-07:00</td>
      <td>691524</td>
      <td>M</td>
      <td>84</td>
      <td>Pvalb-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'UniqueFFF_presentations', 'invalid_times', '...</td>
      <td>2407</td>
      <td>7247.240657</td>
    </tr>
    <tr>
      <th>13</th>
      <td>9bdb7302-dce6-4da7-b8b3-10b4bf9c998c</td>
      <td>3050930333</td>
      <td>sub-688546/sub-688546_ses-1295360519_ogen.nwb</td>
      <td>2023-09-07 00:00:00-07:00</td>
      <td>688546</td>
      <td>F</td>
      <td>91</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'UniqueFFF_presentations', 'invalid_times', '...</td>
      <td>3026</td>
      <td>7261.084057</td>
    </tr>
    <tr>
      <th>14</th>
      <td>b44a76a0-6bb2-44f0-930b-c39eca4e0549</td>
      <td>1747561931</td>
      <td>sub-695764/sub-695764_ses-1311204385.nwb</td>
      <td>2023-11-15 00:00:00-08:00</td>
      <td>695764</td>
      <td>F</td>
      <td>113</td>
      <td>wt/wt</td>
      <td>{'probeB', 'probeA', 'probeD'}</td>
      <td>{'acurl_Wd15_Vel2_Bndry1_Cntst0_oneway_present...</td>
      <td>1940</td>
      <td>7488.337196</td>
    </tr>
    <tr>
      <th>15</th>
      <td>e912f4be-bfb0-4e9a-8bf8-d1c99220ae9f</td>
      <td>1555233817</td>
      <td>sub-699321/sub-699321_ses-1312636156.nwb</td>
      <td>2023-11-21 00:00:00-08:00</td>
      <td>699321</td>
      <td>F</td>
      <td>95</td>
      <td>wt/wt</td>
      <td>{'probeB', 'probeA', 'probeD'}</td>
      <td>{'acurl_Wd15_Vel2_Bndry1_Cntst0_oneway_present...</td>
      <td>1640</td>
      <td>7490.698341</td>
    </tr>
    <tr>
      <th>16</th>
      <td>ca62be3f-c30a-433c-a980-eb932cf010f9</td>
      <td>2185603786</td>
      <td>sub-695763/sub-695763_ses-1317661297.nwb</td>
      <td>2023-12-14 00:00:00-08:00</td>
      <td>695763</td>
      <td>F</td>
      <td>142</td>
      <td>wt/wt</td>
      <td>{'probeB', 'probeF', 'probeA', 'probeD'}</td>
      <td>{'acurl_Wd15_Vel2_Bndry1_Cntst0_oneway_present...</td>
      <td>2860</td>
      <td>7500.974811</td>
    </tr>
    <tr>
      <th>17</th>
      <td>3d50d61f-92f9-4866-9395-34e45635c414</td>
      <td>1929899175</td>
      <td>sub-695762/sub-695762_ses-1317448357.nwb</td>
      <td>2023-12-13 00:00:00-08:00</td>
      <td>695762</td>
      <td>F</td>
      <td>141</td>
      <td>wt/wt</td>
      <td>{'probeB', 'probeA', 'probeD'}</td>
      <td>{'acurl_Wd15_Vel2_Bndry1_Cntst0_oneway_present...</td>
      <td>1918</td>
      <td>7487.893376</td>
    </tr>
    <tr>
      <th>18</th>
      <td>6e8ef649-ebb1-4614-9c77-b96a517ecab4</td>
      <td>1840809834</td>
      <td>sub-699322/sub-699322_ses-1317198704.nwb</td>
      <td>2023-12-12 00:00:00-08:00</td>
      <td>699322</td>
      <td>F</td>
      <td>116</td>
      <td>wt/wt</td>
      <td>{'probeD', 'probeA', 'probeF'}</td>
      <td>{'acurl_Wd15_Vel2_Bndry1_Cntst0_oneway_present...</td>
      <td>1833</td>
      <td>7549.683642</td>
    </tr>
    <tr>
      <th>19</th>
      <td>834f72fa-e5db-4b96-965b-4969241d9079</td>
      <td>3073270238</td>
      <td>sub-702134/sub-702134_ses-1324803287.nwb</td>
      <td>2024-01-18 00:00:00-08:00</td>
      <td>702134</td>
      <td>F</td>
      <td>135</td>
      <td>wt/wt</td>
      <td>{'probeB', 'probeF', 'probeA', 'probeD'}</td>
      <td>{'Stim04_SAC_Wd15_Vel2_Black_loop_presentation...</td>
      <td>3477</td>
      <td>8124.447662</td>
    </tr>
    <tr>
      <th>20</th>
      <td>bb88678e-1578-4c71-b42b-84f51c6ac9cc</td>
      <td>2892210284</td>
      <td>sub-702135/sub-702135_ses-1324561527.nwb</td>
      <td>2024-01-17 00:00:00-08:00</td>
      <td>702135</td>
      <td>F</td>
      <td>134</td>
      <td>wt/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'Stim04_SAC_Wd15_Vel2_Black_loop_presentation...</td>
      <td>2960</td>
      <td>8125.120905</td>
    </tr>
    <tr>
      <th>21</th>
      <td>3b2e4118-decf-47cd-87f0-82d7a1c7eb5f</td>
      <td>2082205427</td>
      <td>sub-714615/sub-714615_ses-1325748772.nwb</td>
      <td>2024-01-23 00:00:00-08:00</td>
      <td>714615</td>
      <td>F</td>
      <td>99</td>
      <td>wt/wt</td>
      <td>{'probeB', 'probeA', 'probeF'}</td>
      <td>{'Stim04_SAC_Wd15_Vel2_Black_loop_presentation...</td>
      <td>2738</td>
      <td>8217.055053</td>
    </tr>
    <tr>
      <th>22</th>
      <td>68b42a43-5983-48fd-aa3f-b68fc71d9e7e</td>
      <td>2555258204</td>
      <td>sub-714612/sub-714612_ses-1325995398.nwb</td>
      <td>2024-01-24 00:00:00-08:00</td>
      <td>714612</td>
      <td>M</td>
      <td>100</td>
      <td>wt/wt</td>
      <td>{'probeB', 'probeF', 'probeA', 'probeD'}</td>
      <td>{'Stim04_SAC_Wd15_Vel2_Black_loop_presentation...</td>
      <td>2342</td>
      <td>8098.478623</td>
    </tr>
    <tr>
      <th>23</th>
      <td>65fddd1e-fe4d-4fc6-90c3-318d489f07ab</td>
      <td>2923745960</td>
      <td>sub-714614/sub-714614_ses-1327183358.nwb</td>
      <td>2024-01-30 00:00:00-08:00</td>
      <td>714614</td>
      <td>F</td>
      <td>106</td>
      <td>wt/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'Stim04_SAC_Wd15_Vel2_Black_loop_presentation...</td>
      <td>3460</td>
      <td>8112.800597</td>
    </tr>
    <tr>
      <th>24</th>
      <td>63f6983c-e19f-4c47-b5d4-17669a49d4e6</td>
      <td>3301911033</td>
      <td>sub-714626/sub-714626_ses-1327655771.nwb</td>
      <td>2024-02-01 00:00:00-08:00</td>
      <td>714626</td>
      <td>M</td>
      <td>108</td>
      <td>wt/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'Stim04_SAC_Wd15_Vel2_Black_loop_presentation...</td>
      <td>3046</td>
      <td>8112.906779</td>
    </tr>
    <tr>
      <th>25</th>
      <td>abe6c75b-0e95-4947-9bc7-9a994f88c2b4</td>
      <td>2457473419</td>
      <td>sub-715811/sub-715811_ses-1328842209.nwb</td>
      <td>2024-02-06 00:00:00-08:00</td>
      <td>715811</td>
      <td>F</td>
      <td>106</td>
      <td>wt/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'Stim04_SAC_Wd15_Vel2_Black_loop_presentation...</td>
      <td>2239</td>
      <td>8117.421339</td>
    </tr>
    <tr>
      <th>26</th>
      <td>eacb37c8-6c1a-4d13-92d5-4655aa1533fb</td>
      <td>2643094371</td>
      <td>sub-715814/sub-715814_ses-1329090859.nwb</td>
      <td>2024-02-07 00:00:00-08:00</td>
      <td>715814</td>
      <td>M</td>
      <td>107</td>
      <td>wt/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'Stim04_SAC_Wd15_Vel2_Black_loop_presentation...</td>
      <td>2294</td>
      <td>8116.194144</td>
    </tr>
    <tr>
      <th>27</th>
      <td>b204b4aa-c8f5-4d0e-bb01-e4f7a0c0a99f</td>
      <td>2334526002</td>
      <td>sub-716464/sub-716464_ses-1330382682.nwb</td>
      <td>2024-02-13 00:00:00-08:00</td>
      <td>716464</td>
      <td>M</td>
      <td>106</td>
      <td>wt/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'Stim04_SAC_Wd15_Vel2_Black_loop_presentation...</td>
      <td>2273</td>
      <td>8110.720355</td>
    </tr>
    <tr>
      <th>28</th>
      <td>8f830377-d159-4d5d-95e1-8687f8896a0b</td>
      <td>2540301468</td>
      <td>sub-717441/sub-717441_ses-1332089263.nwb</td>
      <td>2024-02-20 00:00:00-08:00</td>
      <td>717441</td>
      <td>F</td>
      <td>99</td>
      <td>wt/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'Stim04_SAC_Wd15_Vel2_Black_loop_presentation...</td>
      <td>2243</td>
      <td>8115.416394</td>
    </tr>
    <tr>
      <th>29</th>
      <td>bde92775-0249-45f8-aaef-cdb230f9a121</td>
      <td>2550947797</td>
      <td>sub-717439/sub-717439_ses-1332563048.nwb</td>
      <td>2024-02-22 00:00:00-08:00</td>
      <td>717439</td>
      <td>M</td>
      <td>101</td>
      <td>wt/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'Stim04_SAC_Wd15_Vel2_Black_loop_presentation...</td>
      <td>2344</td>
      <td>8117.606718</td>
    </tr>
    <tr>
      <th>30</th>
      <td>ff83c0c5-fb00-446f-813a-51402aee4fd6</td>
      <td>2517103239</td>
      <td>sub-717437/sub-717437_ses-1333971345.nwb</td>
      <td>2024-02-28 00:00:00-08:00</td>
      <td>717437</td>
      <td>M</td>
      <td>107</td>
      <td>wt/wt</td>
      <td>{'probeB', 'probeF', 'probeA', 'probeD'}</td>
      <td>{'Stim01_SAC_Wd15_Vel2_White_loop_presentation...</td>
      <td>2530</td>
      <td>8381.842843</td>
    </tr>
    <tr>
      <th>31</th>
      <td>dfcf05b8-f1ff-4499-9b64-865d0d32f839</td>
      <td>1706916854</td>
      <td>sub-719666/sub-719666_ses-1335486174.nwb</td>
      <td>2024-03-05 00:00:00-08:00</td>
      <td>719666</td>
      <td>M</td>
      <td>106</td>
      <td>wt/wt</td>
      <td>{'probeB', 'probeD', 'probeC', 'probeF'}</td>
      <td>{'Stim01_SAC_Wd15_Vel2_White_loop_presentation...</td>
      <td>1434</td>
      <td>8413.365366</td>
    </tr>
    <tr>
      <th>32</th>
      <td>302f5b7b-bc1f-4a80-a903-ffb17486e5f5</td>
      <td>2833450938</td>
      <td>sub-716465/sub-716465_ses-1330689294.nwb</td>
      <td>2024-02-14 00:00:00-08:00</td>
      <td>716465</td>
      <td>M</td>
      <td>107</td>
      <td>wt/wt</td>
      <td>{'probeB', 'probeF', 'probeA', 'probeD'}</td>
      <td>{'Stim04_SAC_Wd15_Vel2_Black_loop_presentation...</td>
      <td>2602</td>
      <td>8108.838640</td>
    </tr>
    <tr>
      <th>33</th>
      <td>2f5b4c7a-9fb5-4dda-90cb-296baf8eb162</td>
      <td>3123949371</td>
      <td>sub-714624/sub-714624_ses-1327374064.nwb</td>
      <td>2024-01-31 00:00:00-08:00</td>
      <td>714624</td>
      <td>M</td>
      <td>107</td>
      <td>wt/wt</td>
      <td>{'probeD', 'probeB', 'probeC', 'probeF', 'prob...</td>
      <td>{'Stim04_SAC_Wd15_Vel2_Black_loop_presentation...</td>
      <td>3605</td>
      <td>8109.692943</td>
    </tr>
    <tr>
      <th>34</th>
      <td>0bc1a2e9-e2ef-428d-8b59-e786a852f28b</td>
      <td>798648101</td>
      <td>sub-717438/sub-717438_ses-1334311030.nwb</td>
      <td>2024-02-29 00:00:00-08:00</td>
      <td>717438</td>
      <td>M</td>
      <td>108</td>
      <td>wt/wt</td>
      <td>{'probeF'}</td>
      <td>{'Stim01_SAC_Wd15_Vel2_White_loop_presentation...</td>
      <td>487</td>
      <td>8379.600213</td>
    </tr>
    <tr>
      <th>35</th>
      <td>0cc9856d-b9f7-4595-9c53-07f8a47af9ce</td>
      <td>1926762029</td>
      <td>sub-717438/sub-717438_ses-1334311030_ecephys.nwb</td>
      <td>2024-02-29 00:00:00-08:00</td>
      <td>717438</td>
      <td>M</td>
      <td>108</td>
      <td>wt/wt</td>
      <td>{'probeF'}</td>
      <td>set()</td>
      <td>0</td>
      <td>-1.000000</td>
    </tr>
    <tr>
      <th>36</th>
      <td>6429d002-6ef7-4597-a6c7-fbd0f7cfa262</td>
      <td>2618315564</td>
      <td>sub-719667/sub-719667_ses-1333741475.nwb</td>
      <td>2024-02-27 00:00:00-08:00</td>
      <td>719667</td>
      <td>F</td>
      <td>99</td>
      <td>wt/wt</td>
      <td>{'probeB', 'probeF', 'probeA', 'probeD'}</td>
      <td>{'Stim01_SAC_Wd15_Vel2_White_loop_presentation...</td>
      <td>2897</td>
      <td>8382.142418</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_files</span><span class="p">[</span><span class="s2">&quot;sub_sex&quot;</span><span class="p">][</span><span class="n">session_files</span><span class="p">[</span><span class="s2">&quot;sub_sex&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">])</span>
<span class="n">f_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_files</span><span class="p">[</span><span class="s2">&quot;sub_sex&quot;</span><span class="p">][</span><span class="n">session_files</span><span class="p">[</span><span class="s2">&quot;sub_sex&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">])</span>
<span class="n">sst_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_files</span><span class="p">[</span><span class="n">session_files</span><span class="p">[</span><span class="s2">&quot;sub_genotype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;Sst&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">pval_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_files</span><span class="p">[</span><span class="n">session_files</span><span class="p">[</span><span class="s2">&quot;sub_genotype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;Pval&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">wt_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_files</span><span class="p">[</span><span class="n">session_files</span><span class="p">[</span><span class="s2">&quot;sub_genotype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;wt/wt&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dandiset Overview:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">session_files</span><span class="p">),</span> <span class="s2">&quot;files&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">session_files</span><span class="p">[</span><span class="s2">&quot;sub_name&quot;</span><span class="p">])),</span> <span class="s2">&quot;subjects&quot;</span><span class="p">,</span> <span class="n">m_count</span><span class="p">,</span> <span class="s2">&quot;males,&quot;</span><span class="p">,</span> <span class="n">f_count</span><span class="p">,</span> <span class="s2">&quot;females&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sst_count</span><span class="p">,</span> <span class="s2">&quot;sst,&quot;</span><span class="p">,</span> <span class="n">pval_count</span><span class="p">,</span> <span class="s2">&quot;pval,&quot;</span><span class="p">,</span> <span class="n">wt_count</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dandiset Overview:
37 files
36 subjects 20 males, 17 females
8 sst, 6 pval, 23 wt
</pre></div>
</div>
</div>
</div>
</section>
<section id="downloading-ecephys-file">
<h2>Downloading Ecephys File<a class="headerlink" href="#downloading-ecephys-file" title="Link to this heading">#</a></h2>
<p>Change the values below to download the file you’re interested in. The <code class="docutils literal notranslate"><span class="pre">dandiset_id</span></code> for this project is <code class="docutils literal notranslate"><span class="pre">000563</span></code> . Set <code class="docutils literal notranslate"><span class="pre">dandi_filepath</span></code> to correspond to the dandiset id and filepath of the file you want.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dandiset_id</span> <span class="o">=</span> <span class="s2">&quot;000563&quot;</span>
<span class="n">dandi_filepath</span> <span class="o">=</span> <span class="s2">&quot;sub-692990/sub-692990_ses-1310924284_ogen.nwb&quot;</span>
<span class="n">download_loc</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
<span class="n">dandi_api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DANDI_API_KEY&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This can sometimes take a while depending on the size of the file</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">dandi_download_open</span><span class="p">(</span><span class="n">dandiset_id</span><span class="p">,</span> <span class="n">dandi_filepath</span><span class="p">,</span> <span class="n">download_loc</span><span class="p">,</span> <span class="n">dandi_api_key</span><span class="o">=</span><span class="n">dandi_api_key</span><span class="p">)</span>
<span class="n">nwb</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>A newer version (0.67.1) of dandi/dandi-cli is available. You are using 0.61.2
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>File already exists
Opening file
</pre></div>
</div>
</div>
</div>
</section>
<section id="showing-probe-tracks">
<h2>Showing Probe Tracks<a class="headerlink" href="#showing-probe-tracks" title="Link to this heading">#</a></h2>
<p>One of the electrode configurations we used was novel to this dataset, designed to maximize the yield of visual units in the dorsolateral geniculate nucleus (LGN, aka LGd) and the superior colliculus (SC).  These are the  main retino-recipient subcortical areas that provide visual input to image-forming streams of visual processing in mice and other mammals.  Here we visualize an example of the novel electrode configuration.</p>
<p>The images below were rendered using the <a class="reference internal" href="../visualization/visualize_neuropixels_probes.html"><span class="std std-doc">Visualizing Neuropixels Probe Locations</span></a> notebook. The probes are using the <a class="reference external" href="https://community.brain-map.org/t/allen-mouse-ccf-accessing-and-using-related-data-and-tools/359">Common Coordinate Framework</a> (CCF). The experiment uses six probes labeled A-F to target various regions. Note that any warping is do to the spatial adjustment from the subject brain to the rendered model brain.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sagittal_view</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../../data/images/barcoding_probes_sagittal.png&quot;</span><span class="p">)</span>
<span class="n">dorsal_view</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../../data/images/barcoding_probes_dorsal.png&quot;</span><span class="p">)</span>
<span class="n">transverse_view</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../../data/images/barcoding_probes_transverse.png&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">60</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sagittal_view</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dorsal_view</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">transverse_view</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/866e09665f4bf0b7c5f84887589fbb7047acc75084c855dee86e68740d775c06.png" src="../_images/866e09665f4bf0b7c5f84887589fbb7047acc75084c855dee86e68740d775c06.png" />
</div>
</div>
</section>
<section id="find-out-about-the-units-recorded-in-the-experiment">
<h2>Find out about the units recorded in the experiment<a class="headerlink" href="#find-out-about-the-units-recorded-in-the-experiment" title="Link to this heading">#</a></h2>
<p>Below, the <code class="docutils literal notranslate"><span class="pre">Units</span></code> table is retrieved from the file. It contains many metrics for every putative neuronal unit, printed below. For the analysis in this notebook, we are only interested in the <code class="docutils literal notranslate"><span class="pre">spike_times</span></code> attribute. This is an array of timestamps that a spike is measured for each unit. For more information on the various unit metrics, see <a class="reference internal" href="../visualization/visualize_unit_metrics.html"><span class="std std-doc">Visualizing Unit Quality Metrics</span></a>. From this table, the Units used in this notebook are selected if they have ‘good’ quality rather than ‘noise’, and if they had relatively few interspike interval violations (this selects for units that are well isolated single neurons).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Helper function to find the brain location of each unit</span>
<span class="k">def</span> <span class="nf">getUnitsLocation</span><span class="p">(</span><span class="n">nwb</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   </span>
<span class="sd">    INPUTS:</span>
<span class="sd">      nwb      an nwb object</span>
<span class="sd">    OUTPUTS:</span>
<span class="sd">      unit_locations  List of the assigned brain locations of all units in the units table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">units</span><span class="o">=</span><span class="n">nwb</span><span class="o">.</span><span class="n">units</span>
    <span class="n">units_peak_channel_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">peak_channel_id</span><span class="p">)</span>
    <span class="n">n_units</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">units_peak_channel_id</span><span class="p">)</span>
    <span class="n">electrodes</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">electrodes</span>  
    <span class="n">channelLocations</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">electrodes</span><span class="o">.</span><span class="n">location</span><span class="p">)</span> <span class="c1"># anatomic locations of each channel</span>
    <span class="n">channelIDs</span> <span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">electrodes</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>  <span class="c1"># the id for that channel</span>
    <span class="n">unit_locations</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_units</span><span class="p">,))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_units</span><span class="p">):</span>
        <span class="c1">#find the brain region closest to the channel which has the peak value for that unit</span>
        <span class="n">unit_locations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">channelLocations</span><span class="p">[</span><span class="n">channelIDs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">units_peak_channel_id</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> 
    <span class="k">return</span> <span class="n">unit_locations</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the unit information needed for the anlaysis</span>
<span class="n">units</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">units</span>          <span class="c1"># extract spike times from the Units Data table </span>
<span class="n">units_spike_times</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="s2">&quot;spike_times&quot;</span><span class="p">]</span> <span class="c1"># pull out the `spike_times` attribute to be used later</span>
<span class="n">n_units</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of units: &#39;</span><span class="p">,</span><span class="n">n_units</span><span class="p">)</span>

<span class="c1"># example of unit properties one might use to filter the units</span>
<span class="n">units_quality</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;quality&quot;</span><span class="p">])</span> <span class="c1"># quality metric of each unit - list of strings</span>
<span class="n">units_isiviol</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;isi_violations&quot;</span><span class="p">])</span> <span class="c1"># isi violation metric or each unit - list of floats</span>

<span class="c1"># make a list with indexes of selected units</span>
<span class="n">goodUnits</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">units_quality</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">units_quality</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;good&#39;</span> <span class="ow">and</span> <span class="n">units_isiviol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">goodUnits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;of which &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">goodUnits</span><span class="p">),</span> <span class="s1">&#39;qualify for inclusion&#39;</span><span class="p">)</span>

<span class="c1">#retrieve the anatomical locations assigned to the units</span>
<span class="n">units_location</span> <span class="o">=</span> <span class="n">getUnitsLocation</span><span class="p">(</span><span class="n">nwb</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The selected units were found in: &#39;</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">units_location</span><span class="p">[</span><span class="n">goodUnits</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of units:  3338
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>of which  2163 qualify for inclusion
The selected units were found in: 
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;CA1&#39;, &#39;CA2&#39;, &#39;CA3&#39;, &#39;CP&#39;, &#39;DG-mo&#39;, &#39;DG-po&#39;, &#39;DG-sg&#39;, &#39;IGL&#39;,
       &#39;LGd-co&#39;, &#39;LGd-ip&#39;, &#39;LGd-sh&#39;, &#39;LH&#39;, &#39;LP&#39;, &#39;MOp1&#39;, &#39;MOp2/3&#39;, &#39;MOp5&#39;,
       &#39;MOp6a&#39;, &#39;RSPagl2/3&#39;, &#39;RSPagl5&#39;, &#39;RSPagl6a&#39;, &#39;RSPd2/3&#39;, &#39;RSPd5&#39;,
       &#39;RSPd6a&#39;, &#39;RSPv1&#39;, &#39;RSPv2/3&#39;, &#39;RSPv5&#39;, &#39;RSPv6a&#39;, &#39;RSPv6b&#39;, &#39;RT&#39;,
       &#39;SCig&#39;, &#39;SCiw&#39;, &#39;SCop&#39;, &#39;SCsg&#39;, &#39;SCzo&#39;, &#39;SSp-bfd2/3&#39;, &#39;SSp-bfd4&#39;,
       &#39;SSp-bfd5&#39;, &#39;SSp-bfd6a&#39;, &#39;TH&#39;, &#39;VISal2/3&#39;, &#39;VISal4&#39;, &#39;VISal5&#39;,
       &#39;VISal6a&#39;, &#39;VISal6b&#39;, &#39;VISpm1&#39;, &#39;VISpm2/3&#39;, &#39;VISpm4&#39;, &#39;VISpm5&#39;,
       &#39;VISpm6a&#39;, &#39;VPL&#39;, &#39;VPM&#39;, &#39;root&#39;], dtype=&#39;&lt;U32&#39;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="loading-stimulus-times">
<h2>Loading Stimulus Times<a class="headerlink" href="#loading-stimulus-times" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find out what stimulus conditions were used in the experiment</span>
<span class="c1"># See bottom of this notebook for more about the timeline of the entire experiment</span>
<span class="n">StimulusTypes</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">nwb</span><span class="o">.</span><span class="n">intervals</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">StimulusTypes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;RepeatFFF_presentations&#39;,
 &#39;UniqueFFF_presentations&#39;,
 &#39;invalid_times&#39;,
 &#39;receptive_field_block_presentations&#39;,
 &#39;static_block_presentations&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The full field flicker stimulus was sufficient to observe a barcode in all units that had barcodes,</span>
<span class="c1"># and is the easiest to interpret because all neurons had the identical stimulus in their receptive fields </span>
<span class="n">stimTypeToExtract</span><span class="o">=</span><span class="s1">&#39;RepeatFFF_presentations&#39;</span>
<span class="c1"># Information about the stimulus</span>
<span class="n">stim_table</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">intervals</span><span class="p">[</span><span class="n">stimTypeToExtract</span><span class="p">]</span>    
<span class="n">stim_table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <style>
            .container-fields {
                font-family: "Open Sans", Arial, sans-serif;
            }
            .container-fields .field-value {
                color: #00788E;
            }
            .container-fields details > summary {
                cursor: pointer;
                display: list-item;
            }
            .container-fields details > summary:hover {
                color: #0A6EAA;
            }
        </style>
        
        <script>
            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(function() {
                    console.log('Copied to clipboard: ' + text);
                }, function(err) {
                    console.error('Could not copy text: ', err);
                });
            }

            document.addEventListener('DOMContentLoaded', function() {
                let fieldKeys = document.querySelectorAll('.container-fields .field-key');
                fieldKeys.forEach(function(fieldKey) {
                    fieldKey.addEventListener('click', function() {
                        let accessCode = fieldKey.getAttribute('title').replace('Access code: ', '');
                        copyToClipboard(accessCode);
                    });
                });
            });
        </script>
        <div class='container-wrap'><div class='container-header'><div class='xr-obj-type'><h3>RepeatFFF_presentations (TimeIntervals)</h3></div></div><div style="margin-left: 0px;" class="container-fields"><span class="field-key" title="">description: </span><span class="field-value">Presentation times and stimuli details for 'RepeatFFF' stimuli. 
Note: image_name references control_description in stimulus/templates</span></div><details><summary style="display: list-item; margin-left: 0px;" class="container-fields field-key" title=""><b>table</b></summary><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>start_time</th>
      <th>stop_time</th>
      <th>stimulus_name</th>
      <th>stimulus_block</th>
      <th>index_repeat</th>
      <th>contrast</th>
      <th>mask</th>
      <th>opacity</th>
      <th>orientation</th>
      <th>phase</th>
      <th>spatial_frequency</th>
      <th>size</th>
      <th>units</th>
      <th>stimulus_index</th>
      <th>color</th>
      <th>tags</th>
      <th>timeseries</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>161.81776</td>
      <td>161.83444</td>
      <td>RepeatFFF</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>[0.0, 0.0]</td>
      <td>[250.0, 250.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>[stimulus_time_interval]</td>
      <td>[(7200, 1, timestamps pynwb.base.TimeSeries at 0x2345774932288\nFields:\n  comments: no comments\n  conversion: 1.0\n  data: &lt;HDF5 dataset "data": shape (405120,), type "&lt;f8"&gt;\n  description: no description\n  interval: 1\n  offset: 0.0\n  resolution: -1.0\n  timestamps: &lt;HDF5 dataset "timestamps": shape (405120,), type "&lt;f8"&gt;\n  timestamps_unit: seconds\n  unit: s\n)]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>161.83444</td>
      <td>161.85113</td>
      <td>RepeatFFF</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>[0.0, 0.0]</td>
      <td>[250.0, 250.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>[stimulus_time_interval]</td>
      <td>[(7201, 1, timestamps pynwb.base.TimeSeries at 0x2345774932288\nFields:\n  comments: no comments\n  conversion: 1.0\n  data: &lt;HDF5 dataset "data": shape (405120,), type "&lt;f8"&gt;\n  description: no description\n  interval: 1\n  offset: 0.0\n  resolution: -1.0\n  timestamps: &lt;HDF5 dataset "timestamps": shape (405120,), type "&lt;f8"&gt;\n  timestamps_unit: seconds\n  unit: s\n)]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>161.85113</td>
      <td>161.86781</td>
      <td>RepeatFFF</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>[0.0, 0.0]</td>
      <td>[250.0, 250.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>-1.0</td>
      <td>[stimulus_time_interval]</td>
      <td>[(7202, 1, timestamps pynwb.base.TimeSeries at 0x2345774932288\nFields:\n  comments: no comments\n  conversion: 1.0\n  data: &lt;HDF5 dataset "data": shape (405120,), type "&lt;f8"&gt;\n  description: no description\n  interval: 1\n  offset: 0.0\n  resolution: -1.0\n  timestamps: &lt;HDF5 dataset "timestamps": shape (405120,), type "&lt;f8"&gt;\n  timestamps_unit: seconds\n  unit: s\n)]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>161.86781</td>
      <td>161.88448</td>
      <td>RepeatFFF</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>[0.0, 0.0]</td>
      <td>[250.0, 250.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>-1.0</td>
      <td>[stimulus_time_interval]</td>
      <td>[(7203, 1, timestamps pynwb.base.TimeSeries at 0x2345774932288\nFields:\n  comments: no comments\n  conversion: 1.0\n  data: &lt;HDF5 dataset "data": shape (405120,), type "&lt;f8"&gt;\n  description: no description\n  interval: 1\n  offset: 0.0\n  resolution: -1.0\n  timestamps: &lt;HDF5 dataset "timestamps": shape (405120,), type "&lt;f8"&gt;\n  timestamps_unit: seconds\n  unit: s\n)]</td>
    </tr>
  </tbody>
</table><p>... and 43196 more rows.</p></details></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># pull out some stimulus details we will need for our analysis</span>
<span class="n">StimIndexList</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">stim_table</span><span class="p">[</span><span class="s2">&quot;stimulus_index&quot;</span><span class="p">]))</span> <span class="p">)</span>  <span class="c1"># array of stimulus conditions </span>
<span class="n">IndexRepeatList</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">stim_table</span><span class="p">[</span><span class="s2">&quot;index_repeat&quot;</span><span class="p">])))</span> <span class="c1"># array of repeat numbers within the block </span>
<span class="n">StimNameList</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">stim_table</span><span class="p">[</span><span class="s2">&quot;stimulus_name&quot;</span><span class="p">])</span>
<span class="n">nPresentations</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">StimIndexList</span><span class="p">);</span> <span class="c1"># determine number of instances from the data</span>
<span class="c1"># determine nRepeats from the data</span>
<span class="n">nRepeats</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">IndexRepeatList</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stimTypeToExtract</span><span class="p">,</span><span class="s1">&#39; was repeated &#39;</span><span class="p">,</span><span class="n">nRepeats</span><span class="p">,</span><span class="s1">&#39; times&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RepeatFFF_presentations  was repeated  90  times
</pre></div>
</div>
</div>
</div>
</section>
<section id="getting-trial-aligned-event-times">
<h2>Getting Trial-Aligned Event Times<a class="headerlink" href="#getting-trial-aligned-event-times" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find the start times of the repeated stimulus</span>
<span class="c1"># cast the index_repeat and stim_index columns from  hdmf.common.table.VectorData into arrays</span>
<span class="n">index_repeat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stim_table</span><span class="p">[</span><span class="s2">&quot;index_repeat&quot;</span><span class="p">])</span>  
<span class="n">stim_index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stim_table</span><span class="p">[</span><span class="s2">&quot;stimulus_index&quot;</span><span class="p">])</span>
<span class="c1"># note that the repeats are not necessarily back to back so the duration is determined by </span>
<span class="c1"># the end time of the same repeat, not the start time of the next repeat</span>
<span class="n">stim_times</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nRepeats</span><span class="o">*</span><span class="n">nPresentations</span><span class="p">)</span>
<span class="n">endtime</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nRepeats</span><span class="o">*</span><span class="n">nPresentations</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nPresentations</span><span class="p">):</span> <span class="c1">#loop over presentations of this stimulus</span>
    <span class="n">mask1</span><span class="o">=</span><span class="n">stim_index</span><span class="o">==</span><span class="n">StimIndexList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="c1">#true for all elements in this presentation</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nRepeats</span><span class="p">):</span>   <span class="c1">#loop over repeats within the presentation</span>
        <span class="n">mask2</span><span class="o">=</span><span class="n">index_repeat</span><span class="o">==</span><span class="n">j</span> <span class="c1">#true for all elements with this repeat number</span>
        <span class="n">ind1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">mask1</span><span class="p">,</span><span class="n">mask2</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># index of first element meeting conditions</span>
        <span class="n">stim_times</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">nRepeats</span><span class="o">+</span><span class="n">j</span><span class="p">]</span><span class="o">=</span> <span class="n">stim_table</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">][</span><span class="n">ind1</span><span class="p">]</span>

        <span class="n">ind2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">mask1</span><span class="p">,</span><span class="n">mask2</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># index of last element meeting conditions</span>
        <span class="n">endtime</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">nRepeats</span><span class="o">+</span><span class="n">j</span><span class="p">]</span><span class="o">=</span> <span class="n">stim_table</span><span class="p">[</span><span class="s2">&quot;stop_time&quot;</span><span class="p">][</span><span class="n">ind2</span><span class="p">]</span>

<span class="c1"># the actual duration of each repeat is given by end_time-start_time</span>
<span class="c1"># average these to get the nominal duration for all trials, for further analysis</span>
<span class="n">eachduration</span><span class="o">=</span><span class="n">endtime</span><span class="o">-</span><span class="n">stim_times</span> <span class="c1"># the values should be close to identical (check this)</span>
<span class="n">trial_duration</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eachduration</span><span class="p">)</span> <span class="c1"># then set the &quot;duration&quot; variable to the mean duration </span>
<span class="n">trial_duration</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">trial_duration</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span>  <span class="c1">#truncated to three significant digits</span>

<span class="n">totalStimTime</span><span class="o">=</span><span class="n">trial_duration</span><span class="o">*</span><span class="n">nRepeats</span> <span class="c1"># time in seconds total over all repeats</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#  makeAlignedEvents:  a helper function that extracts and aligns spike times for one unit</span>
<span class="k">def</span> <span class="nf">makeAlignedEvents</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span><span class="n">stim_times</span><span class="p">,</span><span class="n">duration</span><span class="p">:</span><span class="nb">float</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    INPUTS:</span>
<span class="sd">    spike_times     array of spike times of a single unit, in seconds</span>
<span class="sd">    stim_times      array of start times of a repeated stimulus, in seconds</span>
<span class="sd">    duration        duration of the repeated stimulus, in seconds</span>
<span class="sd">    </span>
<span class="sd">    OUTPUTS:</span>
<span class="sd">    events          1D array whose elements are all times when a spike is seen in a repeat relative to the start of repeat</span>
<span class="sd">  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nRepeats</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">stim_times</span><span class="p">)</span> <span class="c1">#number of stim_time entries would give us the number of repeats for that stimulus</span>
    <span class="n">events</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nRepeats</span><span class="p">,))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">stim_idx</span><span class="p">,</span> <span class="n">stim_time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stim_times</span><span class="p">):</span> 
        <span class="n">first_spike_in_range</span><span class="p">,</span> <span class="n">last_spike_in_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="p">[</span><span class="n">stim_time</span><span class="p">,</span> <span class="n">stim_time</span><span class="o">+</span><span class="n">duration</span><span class="p">])</span>
        <span class="n">spike_times_in_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spike_times</span><span class="p">[</span><span class="n">first_spike_in_range</span><span class="p">:</span><span class="n">last_spike_in_range</span><span class="p">])</span>  
        <span class="n">spike_times_in_range</span><span class="o">=</span><span class="n">spike_times_in_range</span><span class="o">-</span><span class="n">stim_time</span> <span class="c1">#set trial start as time 0 </span>
        <span class="n">events</span><span class="p">[</span><span class="n">stim_idx</span><span class="p">]</span><span class="o">=</span><span class="n">spike_times_in_range</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">events</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Choose example units to illustrate the barcode analysis methods</span>
<span class="c1"># These examples were chosen to illustrate two different barcodes and a neuron without a barcode</span>
<span class="c1"># in the sections below</span>
<span class="n">example_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">652</span><span class="p">,</span> <span class="mi">1109</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  

<span class="c1"># Extract the aligned spike times of the example neurons</span>
<span class="n">rasters</span><span class="o">=</span><span class="p">[]</span> <span class="c1"># the aligned spike times</span>
<span class="n">FR</span> <span class="o">=</span><span class="p">[]</span>     <span class="c1"># firing rate  </span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">example_indices</span><span class="p">)):</span>
    <span class="n">rasters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">makeAlignedEvents</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">[</span><span class="n">example_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">stim_times</span><span class="p">,</span><span class="n">trial_duration</span><span class="p">)</span> <span class="p">)</span>
    <span class="c1"># count spikes in all the repeats to estimate the firing rate</span>
    <span class="n">nspk</span><span class="o">=</span><span class="mi">0</span> 
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nRepeats</span><span class="p">):</span>
        <span class="n">nspk</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rasters</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
    <span class="n">FR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nspk</span><span class="o">/</span><span class="n">totalStimTime</span><span class="p">)</span> 
    <span class="c1"># print summary information about the examples</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;example&#39;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;is unit&#39;</span><span class="p">,</span><span class="n">example_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;, recorded from &#39;</span><span class="p">,</span> <span class="n">units_location</span><span class="p">[</span><span class="n">example_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="s1">&#39;, FR=&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">FR</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">1</span><span class="p">),</span><span class="s1">&#39; spk/sec&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>example 1 is unit 652 , recorded from  SCop , FR= 17.8  spk/sec
example 2 is unit 1109 , recorded from  LGd-co , FR= 11.8  spk/sec
example 3 is unit 0 , recorded from  LH , FR= 8.6  spk/sec
</pre></div>
</div>
</div>
</div>
</section>
<section id="plotting-rasters">
<h2>Plotting rasters<a class="headerlink" href="#plotting-rasters" title="Link to this heading">#</a></h2>
<p>To visualize the responses of neurons we can plot the times of spikes relative to the stimulus onset time, from the trial spike trains that were just computed. In a spike raster plot, the x axis is time in seconds, the y axis is repeat number, and each dot is the time of one spike. When spikes appear at the same time in every trial, we see a vertical stripe in the raster. Units that have such vertical stripes look like “barcodes”, hence the name of this project.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#show rasters for three example cells</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>  <span class="c1"># 1 row, 3 columns</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">eventplot</span><span class="p">(</span><span class="n">rasters</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Unit </span><span class="si">%d</span><span class="s2"> in </span><span class="si">%s</span><span class="s2"> </span><span class="si">%.1f</span><span class="s2"> spk/sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">example_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">units_location</span><span class="p">[</span><span class="n">example_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">FR</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span> 
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4e5193c61392b4aac02f6e4b8534f9033be3356d7d110e3e758eb889d6175491.png" src="../_images/4e5193c61392b4aac02f6e4b8534f9033be3356d7d110e3e758eb889d6175491.png" />
</div>
</div>
</section>
<section id="plotting-psths">
<h2>Plotting PSTHs<a class="headerlink" href="#plotting-psths" title="Link to this heading">#</a></h2>
<p>The Barcode of the cell is defined as the times of these precisely aligned firing events
One way to extract those times is to find the peaks in the peri-stimulus time histogram (PSTH).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute_psth: helper function to compute PSTH by assigning spike times to time bins</span>
<span class="k">def</span> <span class="nf">compute_psth</span><span class="p">(</span><span class="n">spike_trains</span><span class="p">,</span> <span class="n">total_duration</span><span class="p">,</span> <span class="n">bin_duration</span><span class="p">):</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_duration</span> <span class="o">/</span> <span class="n">bin_duration</span><span class="p">)</span>
    <span class="n">psth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">train</span> <span class="ow">in</span> <span class="n">spike_trains</span><span class="p">:</span>
        <span class="n">binned_spikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train</span><span class="p">)</span> <span class="o">/</span> <span class="n">bin_duration</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">valid_bins</span> <span class="o">=</span> <span class="n">binned_spikes</span><span class="p">[</span><span class="n">binned_spikes</span> <span class="o">&lt;</span> <span class="n">n_bins</span><span class="p">]</span>
        <span class="n">psth</span><span class="p">[</span><span class="n">valid_bins</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">psth</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spike_trains</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">psth</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the psth of one of the example neurons </span>
<span class="n">example</span><span class="o">=</span><span class="mi">0</span>  <span class="c1"># first example neuron</span>
<span class="n">bin_duration</span> <span class="o">=</span> <span class="mf">0.008</span> <span class="c1"># Time bin to use in seconds </span>
<span class="n">psth1</span><span class="o">=</span><span class="n">compute_psth</span><span class="p">(</span><span class="n">rasters</span><span class="p">[</span><span class="n">example</span><span class="p">],</span> <span class="n">trial_duration</span><span class="p">,</span> <span class="n">bin_duration</span><span class="p">)</span>
<span class="n">n_bins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">psth1</span><span class="p">)</span>
<span class="n">bin_midpoints</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_bins</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">bin_duration</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_midpoints</span><span class="p">,</span> <span class="n">psth1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Spikes/trial&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
<span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Unit </span><span class="si">%d</span><span class="s2"> in </span><span class="si">%s</span><span class="s2"> </span><span class="si">%.1f</span><span class="s2"> spk/sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">example_indices</span><span class="p">[</span><span class="n">example</span><span class="p">],</span> <span class="n">units_location</span><span class="p">[</span><span class="n">example_indices</span><span class="p">[</span><span class="n">example</span><span class="p">]],</span><span class="n">FR</span><span class="p">[</span><span class="n">example</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">trial_duration</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d8b5a5a56b49d9032b411e5e2d1356b91580abb457f6d3744042e645c1eac429.png" src="../_images/d8b5a5a56b49d9032b411e5e2d1356b91580abb457f6d3744042e645c1eac429.png" />
</div>
</div>
</section>
<section id="statistical-criterion-for-psth-peaks">
<h2>Statistical criterion for PSTH peaks<a class="headerlink" href="#statistical-criterion-for-psth-peaks" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>The “bars” of the barcode (as seen in rasters) correspond to peaks in the PSTH.</p></li>
<li><p>We set a cutoff for the minimum number of spikes observed in a timebin across repeats
to qualify as a psth peak or “bar”, such that a peak would be found &lt;5% of the time
if the response were generated by an inhomogeneous Poisson process with the
same firing rate as the neuron.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># getSpikeCountThreshold: helper function to determine the number of spikes in psth bin expected by chance</span>
<span class="k">def</span> <span class="nf">getSpikeCountThreshold</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns criterion spike-count thresholds (high and low) for detecting</span>
<span class="sd">    significantly above- or below-chance spike counts in any one time bin</span>
<span class="sd">    of a raster, under a Poisson null hypothesis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rate : float</span>
<span class="sd">        Mean spikes per bin in the data raster overall</span>
<span class="sd">    M : int</span>
<span class="sd">        Number of trials in the data raster</span>
<span class="sd">    N : int</span>
<span class="sd">        Number of time bins in the data raster</span>
<span class="sd">    alpha : float</span>
<span class="sd">        Acceptable fraction of false positives (e.g., 0.05)</span>
<span class="sd">    doplot : bool, optional</span>
<span class="sd">        If True, plot the PDF and thresholds (default False)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    highThresh : int</span>
<span class="sd">        Minimum spike count significantly above chance (Bonferroni-corrected)</span>
<span class="sd">    lowThresh : int</span>
<span class="sd">        Maximum spike count significantly below chance, or -1 if none</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Bonferroni correction for multiple comparisons</span>
    <span class="n">adj_alpha</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">/</span> <span class="n">N</span>
    
    <span class="c1"># Find low threshold</span>
    <span class="n">Clow</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">poisson</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">Clow</span><span class="p">,</span> <span class="n">rate</span> <span class="o">*</span> <span class="n">M</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">adj_alpha</span><span class="p">:</span>
        <span class="n">Clow</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">lowThresh</span> <span class="o">=</span> <span class="n">Clow</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># If Clow never increments, this becomes -1</span>

    <span class="c1"># Find high threshold, starting from Clow</span>
    <span class="n">Chigh</span> <span class="o">=</span> <span class="n">Clow</span>
    <span class="k">while</span> <span class="n">poisson</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">Chigh</span><span class="p">,</span> <span class="n">rate</span> <span class="o">*</span> <span class="n">M</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">adj_alpha</span><span class="p">:</span>
        <span class="n">Chigh</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">highThresh</span> <span class="o">=</span> <span class="n">Chigh</span>

    <span class="c1"># Optional plotting</span>
    <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Chigh</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">poisson</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">rate</span> <span class="o">*</span> <span class="n">M</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Spike count over M=</span><span class="si">{</span><span class="n">M</span><span class="si">}</span><span class="s1"> trials&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Probability on Poisson Null&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;For Mean </span><span class="si">{</span><span class="n">rate</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> spikes/bin, N=</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s1"> timebins&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">adj_alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">Chigh</span><span class="p">,</span> <span class="n">adj_alpha</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39; α=</span><span class="si">{</span><span class="n">alpha</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">Chigh</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">adj_alpha</span><span class="p">,</span> <span class="s1">&#39;nonsignificant&#39;</span><span class="p">,</span>
                 <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">Chigh</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">adj_alpha</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;significant&#39;</span><span class="p">,</span>
                 <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">()</span> <span class="c1"># to be coded: force xticks to be integers</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">highThresh</span><span class="p">,</span> <span class="n">lowThresh</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the threshold criterion for a sample neuron (same example selected above)</span>
<span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span> <span class="c1"># a significance criterion</span>
<span class="n">rate</span><span class="o">=</span><span class="n">FR</span><span class="p">[</span><span class="n">example</span><span class="p">]</span><span class="o">*</span><span class="n">bin_duration</span> <span class="c1"># rate in spikes per time bin</span>
<span class="n">highThresh</span><span class="p">,</span> <span class="n">lowThresh</span> <span class="o">=</span> <span class="n">getSpikeCountThreshold</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">nRepeats</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time bins with &gt;=&#39;</span><span class="p">,</span><span class="n">highThresh</span><span class="p">,</span><span class="s1">&#39; spikes over the &#39;</span><span class="p">,</span><span class="n">nRepeats</span><span class="p">,</span><span class="s1">&#39; repeats qualify as bars&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8fc454e759e0f0cf4983b703d10aa5ea158b6d6057631ea90203a77785b4157e.png" src="../_images/8fc454e759e0f0cf4983b703d10aa5ea158b6d6057631ea90203a77785b4157e.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Time bins with &gt;= 29  spikes over the  90  repeats qualify as bars
</pre></div>
</div>
</div>
</div>
</section>
<section id="extracting-barcodes">
<h2>Extracting barcodes<a class="headerlink" href="#extracting-barcodes" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>A stretch of contiguous qualifying time bins are considered part of the same peak</p></li>
<li><p>The time of the “bar” is defined as the midpointof the time bin(s) comprising the peak</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># find_bars: helper function to return the bar code of a spike raster</span>
<span class="k">def</span> <span class="nf">find_bars</span><span class="p">(</span><span class="n">spike_train</span><span class="p">,</span> <span class="n">trial_duration</span><span class="p">,</span> <span class="n">bin_duration</span><span class="p">,</span><span class="n">min_spikes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Identifies the times of PSTH peaks as bars of a barcode by a simple algorithm:</span>
<span class="sd">    All consecutive time bins above set threshold are considered to be part of the same bar, </span>
<span class="sd">     the mean of those bin midpoints is considered to be the bar time</span>
<span class="sd">    INPUTS</span>
<span class="sd">        spike_train     raster for a repeated stimulus as a list of aligned spike time lists</span>
<span class="sd">        trial_duration  the duration of the repeated stimulus </span>
<span class="sd">        bin_duration    bin size to use for the psth</span>
<span class="sd">        min_spikes      minimum integer number of spikes in a bin (summed over repeats)</span>
<span class="sd">                        for inclusion in peak identification</span>
<span class="sd">    OUTPUTS</span>
<span class="sd">        bars            times of the barcode bars in s relative to stimulus onset</span>
<span class="sd">        psth            the psth curve as mean number of spikes in bin per trial</span>
<span class="sd">        bin_midpoints   time axis for the psth</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nRepeats</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">spike_train</span><span class="p">)</span> <span class="c1"># number of repeats in raster</span>
    <span class="n">psth</span><span class="o">=</span><span class="n">compute_psth</span><span class="p">(</span><span class="n">spike_train</span><span class="p">,</span> <span class="n">trial_duration</span><span class="p">,</span> <span class="n">bin_duration</span><span class="p">)</span> <span class="c1"># mean number of spikes in bin per trial</span>
    <span class="n">significant_array</span> <span class="o">=</span> <span class="n">psth</span><span class="o">*</span><span class="n">nRepeats</span> <span class="o">&gt;=</span>  <span class="n">min_spikes</span> <span class="c1"># convert psth to integer spike count to compare to minspikes</span>
    <span class="n">significant_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">significant_array</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#indexes to qualifying time bins</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">psth</span><span class="p">)</span> 
    <span class="n">bin_midpoints</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_bins</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">bin_duration</span>

    <span class="c1"># Consecutive qualifying time bins are considered part of the same &quot;Bar&quot;</span>
    <span class="c1"># The time of that bar is considered to be the mean of those bin centers</span>
    <span class="n">bars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_group</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">significant_indices</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">current_group</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">current_group</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">current_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bin_midpoints</span><span class="p">[</span><span class="n">current_group</span><span class="p">]))</span>
            <span class="n">current_group</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">current_group</span><span class="p">:</span>
        <span class="n">bars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bin_midpoints</span><span class="p">[</span><span class="n">current_group</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">bars</span><span class="p">,</span><span class="n">psth</span><span class="p">,</span> <span class="n">bin_midpoints</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plotPSTHbarcode: helper function to plot PSTH and illustrate how bar times are derived</span>
<span class="k">def</span> <span class="nf">plotPSTHbarcode</span><span class="p">(</span><span class="n">psth</span><span class="p">,</span> <span class="n">bin_midpoints</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">bars</span><span class="p">,</span> <span class="n">xlim</span> <span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;PSTH and Barcode&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Visualization of barcode extraction from psth</span>
<span class="sd">    Plots the psth, threshold, and identified peak midpoints</span>
<span class="sd">    INPUTS</span>
<span class="sd">        psth           psth expressed as mean spikes in bin over repeats</span>
<span class="sd">        bin_midpoints  time axis for the psth</span>
<span class="sd">        threshold      threshold expressed as mean spikes in bin over repeats</span>
<span class="sd">        bars           times of identified bars</span>
<span class="sd">        xlim           optional axis limits</span>
<span class="sd">        title          optional figure title</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">24</span> <span class="c1"># font size</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_midpoints</span><span class="p">,</span> <span class="n">psth</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PSTH&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Spike Count&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mf">1.5</span><span class="o">*</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

    <span class="c1"># Plot threshold in red, points exceeding threshold in green</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_midpoints</span><span class="p">,</span> <span class="n">threshold</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">bin_midpoints</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Threshold&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>   

    <span class="n">significant_array</span> <span class="o">=</span> <span class="n">psth</span> <span class="o">&gt;=</span> <span class="n">threshold</span> <span class="c1"># both are in units of per-trial</span>
    <span class="n">significant_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">significant_array</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#indexes to qualifying time bins</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bin_midpoints</span><span class="p">[</span><span class="n">significant_indices</span><span class="p">],</span> <span class="n">psth</span><span class="p">[</span><span class="n">significant_indices</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

    <span class="c1">#show inferred bar times</span>
    <span class="n">bar_offset</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">psth</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.2</span>
    <span class="n">bar_height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">psth</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bar_x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bars</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">bar_x</span><span class="p">,</span><span class="n">bar_x</span><span class="p">],</span> <span class="n">bar_offset</span><span class="o">+</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">bar_height</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract barcode for the example neuron and visualize it</span>
<span class="n">bars</span><span class="p">,</span> <span class="n">psth</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span> <span class="n">find_bars</span><span class="p">(</span><span class="n">rasters</span><span class="p">[</span><span class="n">example</span><span class="p">],</span> <span class="n">trial_duration</span><span class="p">,</span> <span class="n">bin_duration</span><span class="p">,</span> <span class="n">highThresh</span><span class="p">)</span>
<span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># beginning and ending time to show in plot, in s</span>
<span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Unit </span><span class="si">%d</span><span class="s2"> in </span><span class="si">%s</span><span class="s2"> </span><span class="si">%.1f</span><span class="s2"> spk/sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">example_indices</span><span class="p">[</span><span class="n">example</span><span class="p">],</span> <span class="n">units_location</span><span class="p">[</span><span class="n">example_indices</span><span class="p">[</span><span class="n">example</span><span class="p">]],</span><span class="n">FR</span><span class="p">[</span><span class="n">example</span><span class="p">])</span>
<span class="n">plotPSTHbarcode</span><span class="p">(</span><span class="n">psth</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">highThresh</span><span class="o">/</span><span class="n">nRepeats</span><span class="p">,</span> <span class="n">bars</span><span class="p">,</span><span class="n">xlim</span><span class="p">,</span><span class="n">title</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8834e5c055f6f61386669b24397b5ae9655dcf184ea616845db2ee1e80ab6175.png" src="../_images/8834e5c055f6f61386669b24397b5ae9655dcf184ea616845db2ee1e80ab6175.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the barcodes of all three example units</span>
<span class="n">barcodes</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">example_indices</span><span class="p">)):</span>
    <span class="n">rate</span><span class="o">=</span><span class="n">FR</span><span class="p">[</span><span class="n">example</span><span class="p">]</span><span class="o">*</span><span class="n">bin_duration</span> <span class="c1"># rate, expressed in spikes per time bin</span>
    <span class="n">highThresh</span><span class="p">,</span> <span class="n">lowThresh</span> <span class="o">=</span> <span class="n">getSpikeCountThreshold</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">nRepeats</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">bars</span><span class="p">,</span> <span class="n">psth</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span> <span class="n">find_bars</span><span class="p">(</span><span class="n">rasters</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">trial_duration</span><span class="p">,</span> <span class="n">bin_duration</span><span class="p">,</span> <span class="n">highThresh</span><span class="p">)</span>
    <span class="n">barcodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bars</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unit &#39;</span><span class="p">,</span><span class="n">example_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39; has &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bars</span><span class="p">),</span> <span class="s1">&#39; bars in its barcode&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Unit  652  has  89  bars in its barcode
Unit  1109  has  52  bars in its barcode
Unit  0  has  0  bars in its barcode
</pre></div>
</div>
</div>
</div>
</section>
<section id="spike-distance-metric">
<h2>5. Spike Distance Metric<a class="headerlink" href="#spike-distance-metric" title="Link to this heading">#</a></h2>
<p>One way to quantify the similarity between two bar codes is an <strong>edit distance</strong>
(the same principle used to align and compare genetic sequences)</p>
<p>The <strong>spike distance metric</strong> measures the minimum number of operations to transform one spike train into another.
There are three legal operations:</p>
<ol class="arabic simple">
<li><p><strong>Deleting a Spike</strong></p>
<ul class="simple">
<li><p>Remove a spike from one train if it doesn’t match any spike in the other train.</p></li>
</ul>
</li>
<li><p><strong>Adding a Spike</strong></p>
<ul class="simple">
<li><p>Insert a spike into a train to align it with the other train.</p></li>
</ul>
</li>
<li><p><strong>Shifting a Spike</strong> (Cost depends on how far you shift):</p>
<ul class="simple">
<li><p>Adjust the timing of a spike to align it with a spike in the other train.</p></li>
<li><p>The cost of shifting depends on how far the spike moves, scaled by the <code class="docutils literal notranslate"><span class="pre">cost</span></code> parameter.</p></li>
</ul>
</li>
</ol>
<p>Citation: Victor JD, Purpura KP. Nature and precision of temporal coding in visual cortex: a metric-space analysis. J Neurophysiol. 1996;76(2):1310-26. Epub 1996/08/01. doi: 10.1152/jn.1996.76.2.1310.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># spkd:  helper function implementing a simple algorithm to compute the minimum edit distance  </span>
<span class="k">def</span> <span class="nf">spkd</span><span class="p">(</span><span class="n">tli</span><span class="p">,</span> <span class="n">tlj</span><span class="p">,</span> <span class="n">cost</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Determines the minimum number of operations required to convert one bar code into the other </span>
<span class="sd">    where the legal steps are to add a bar, delete a bar, or move a bar over by cost seconds</span>
<span class="sd">    INPUTS:</span>
<span class="sd">    tli        array of event times in one example, in seconds</span>
<span class="sd">    tlj        array of event times in another example, in seconds</span>
<span class="sd">    cost       number of seconds you can shift an event for the same cost as deleting or adding a spike</span>
<span class="sd">    </span>
<span class="sd">    OUTPUTS:</span>
<span class="sd">    d          the distance between i and j </span>
<span class="sd">  </span>
<span class="sd">    Translated to Python by Siddharth Vyasabattu 2025 from Matlab code by Daniel Reich</span>
<span class="sd">    Translated to Matlab by Daniel Reich 1999 from FORTRAN code by Jonathan Victor</span>
<span class="sd">    (used with permission from JV)</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nspi</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tli</span><span class="p">)</span>
    <span class="n">nspj</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tlj</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cost</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">nspi</span> <span class="o">-</span> <span class="n">nspj</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cost</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">nspi</span> <span class="o">+</span> <span class="n">nspj</span>

    <span class="c1"># Initialize the cost matrix</span>
    <span class="n">scr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nspi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Margins with the cost of adding a spike</span>
    <span class="n">scr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nspi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">scr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nspj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Calculate the costs for aligning spike trains</span>
    <span class="k">if</span> <span class="n">nspi</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nspj</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nspi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nspj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">scr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">scr</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">scr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">scr</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">cost</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tli</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tlj</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">scr</span><span class="p">[</span><span class="n">nspi</span><span class="p">,</span> <span class="n">nspj</span><span class="p">]</span>  <span class="c1">#the distance metric</span>
    <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
</div>
</div>
<section id="computing-distances-between-barcodes">
<h3>Computing Distances Between Barcodes<a class="headerlink" href="#computing-distances-between-barcodes" title="Link to this heading">#</a></h3>
<section id="to-illustrate-the-spike-distance-metric-let-s-compare-two-fictional-barcodes">
<h4>To illustrate the spike distance metric let’s compare two fictional barcodes<a class="headerlink" href="#to-illustrate-the-spike-distance-metric-let-s-compare-two-fictional-barcodes" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Barcode_A</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>     <span class="c1">#times of the bars, in s</span>
<span class="n">Barcode_B</span> <span class="o">=</span><span class="p">[</span><span class="mf">2.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">7.2</span><span class="p">]</span>  
<span class="n">Barcode_A</span><span class="p">,</span> <span class="n">Barcode_B</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>([2, 3, 7], [2.1, 5, 7.2])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cost</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># cost per 1s shift in a spike time</span>
<span class="n">spkd</span><span class="p">(</span><span class="n">Barcode_A</span><span class="p">,</span> <span class="n">Barcode_B</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.3000000000000003
</pre></div>
</div>
</div>
</div>
<p>Optional Exercises</p>
<ul class="simple">
<li><p>Modify the cost parameter to see how the distance changes.</p></li>
<li><p>Try computing the distance by hand using the algorithm above</p></li>
<li><p>Is the distance from Barcode_A to Barcode_B the same as from Barcode_B to Barcode_A?</p></li>
</ul>
</section>
<section id="now-compute-the-distance-between-the-barcodes-of-the-two-example-neurons-above-that-had-barcodes">
<h4>Now compute the distance between the barcodes of the two example neurons above that had barcodes<a class="headerlink" href="#now-compute-the-distance-between-the-barcodes-of-the-two-example-neurons-above-that-had-barcodes" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># recall the bar code lengths</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unit &#39;</span><span class="p">,</span><span class="n">example_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39; has &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">barcodes</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="s1">&#39; bars in its barcode&#39;</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Worst case, deleting all the bars of the first and inserting all the bars of the second&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;would cost &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">barcodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="s1">&#39; + &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">barcodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="s1">&#39; = &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">barcodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">barcodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

<span class="c1"># choose a cost parameter</span>
<span class="n">cost</span><span class="o">=</span><span class="mi">125</span>
<span class="c1"># two spikes will be aligned if it is &quot;cheaper&quot; than deleting one and inserting the other</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cost = &#39;</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="s1">&#39; means bars will be matched if they are &lt;&#39;</span><span class="p">,</span><span class="mi">2000</span><span class="o">/</span><span class="n">cost</span><span class="p">,</span><span class="s1">&#39; ms apart&#39;</span><span class="p">)</span>

<span class="c1"># The distance between the full length barcodes</span>
<span class="n">d</span><span class="o">=</span><span class="n">spkd</span><span class="p">(</span><span class="n">barcodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">barcodes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cost</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For a cost of &#39;</span><span class="p">,</span><span class="n">cost</span><span class="p">,</span><span class="s1">&#39; the distance is = &#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Unit  652  has  89  bars in its barcode
Unit  1109  has  52  bars in its barcode
Worst case, deleting all the bars of the first and inserting all the bars of the second
would cost  89  +  52  =  141
cost =  125  means bars will be matched if they are &lt; 16.0  ms apart
For a cost of  125  the distance is =  139.0
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="what-does-the-distance-between-two-barcodes-mean">
<h2>What does the distance between two barcodes mean?<a class="headerlink" href="#what-does-the-distance-between-two-barcodes-mean" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Any bar code can be converted to any other bar code for some cost. If they are identical the cost will be 0.</p></li>
<li><p>What cost should we expect on chance if the bar codes are not really related?</p></li>
<li><p>One negative control is to circularly permute one of the two barcodes</p></li>
</ul>
<section id="circular-permutation-explained">
<h3>Circular permutation explained<a class="headerlink" href="#circular-permutation-explained" title="Link to this heading">#</a></h3>
<p>To circularly permute a barcode we apply a random time shift to all the events.
If an event’s new time exceeds the total duration of the trial, it wraps around to the beginning
using modular arithmetic.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To illustrate suppose a barcode had bars at 2, 4 and 7s</span>
<span class="n">examplebarcode</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;example bar code = &#39;</span><span class="p">,</span><span class="n">examplebarcode</span><span class="p">)</span>

<span class="c1"># and suppose the random offset was 1.5s</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;offset = &#39;</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>

<span class="c1"># this adds the offset to each bar&#39;s time</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">examplebarcode</span><span class="p">)):</span>
    <span class="n">examplebarcode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">offset</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;shifted bar code = &#39;</span><span class="p">,</span><span class="n">examplebarcode</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;stimulus duration = &#39;</span><span class="p">,</span><span class="n">trial_duration</span><span class="p">)</span>

<span class="c1"># this wraps the values exceeding the trial duration back to </span>
<span class="c1"># the beginning and sorts them in order again</span>
<span class="n">permutedexample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span> <span class="n">examplebarcode</span> <span class="o">%</span> <span class="n">trial_duration</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;permuted bar code = &#39;</span><span class="p">,</span><span class="n">permutedexample</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>example bar code =  [2, 4, 7]
offset =  1.5
shifted bar code =  [3.5, 5.5, 8.5]
stimulus duration =  8.007
permuted bar code =  [0.493 3.5   5.5  ]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># permute_barcode: helper function to permute barcodes</span>
<span class="k">def</span> <span class="nf">permute_barcode</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span><span class="n">trial_duration</span><span class="p">):</span>
    <span class="n">random_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">trial_duration</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">barcode</span><span class="p">)):</span>
        <span class="n">barcode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">random_offset</span>
    <span class="n">permutedcode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">barcode</span> <span class="o">%</span> <span class="n">trial_duration</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">permutedcode</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Now let’s permute the full length barcode of the first example neuron and compute its distance to the barcode the second neuron as a negative control</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">permuted_barcode1</span> <span class="o">=</span> <span class="n">permute_barcode</span><span class="p">(</span><span class="n">barcodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trial_duration</span><span class="p">)</span>
<span class="n">control_d</span> <span class="o">=</span> <span class="n">spkd</span><span class="p">(</span><span class="n">permuted_barcode1</span><span class="p">,</span> <span class="n">barcodes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cost</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For a shift cost of &#39;</span><span class="p">,</span><span class="n">cost</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The distance from permuted neuron1 to neuron2 was &#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">control_d</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>For a shift cost of  125
The distance from permuted neuron1 to neuron2 was  123.6
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We can repeat this 1000 times to get a null distribution</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">perm_barcode_dist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">permuted_barcode1</span> <span class="o">=</span>  <span class="n">permute_barcode</span><span class="p">(</span><span class="n">barcodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">trial_duration</span><span class="p">)</span>
    <span class="n">perm_barcode_dist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spkd</span><span class="p">(</span><span class="n">permuted_barcode1</span><span class="p">,</span> <span class="n">barcodes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cost</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">perm_barcode_dist</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Null Distribution (Permuted Control)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Unpermuted Distance A-B&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Spike Distance Metric&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Bootstrap Null Distribution of Distances&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/249dd9669ebe9f50b65b47d11403e3d798bbb83bff5b8b7a992975d23800262f.png" src="../_images/249dd9669ebe9f50b65b47d11403e3d798bbb83bff5b8b7a992975d23800262f.png" />
</div>
</div>
<ul class="simple">
<li><p>If the true distance falls near the middle of the null distribution, the two barcodes are no more related than expected on chance</p></li>
<li><p>If the true distance is very <strong>small</strong> compared to the null distribution, the barcodes are significantly similar</p></li>
<li><p>If the true distance is very <strong>large</strong> compared to the null distribution,  the barcodes are significantly opposed (e.g. an ON vs OFF cell)</p></li>
<li><p>By comparing the distances between the barcodes of all units, we can cluster or <strong>classify</strong> neurons according to their barcodes</p></li>
</ul>
</section>
</section>
<section id="exercises-for-the-reader">
<h2>Exercises for the reader<a class="headerlink" href="#exercises-for-the-reader" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>You could try different cost parameters. The higher the cost, the more the distance reflects precise temporal alignment of the barcodes. The lower the cost, the more it reflects the difference in firing rates</p></li>
<li><p>You could try different example units, perhaps exploring different visual areas.</p></li>
<li><p>Above we hand-coded the bin size to use for the PSTHs, but you could try a different choice. The best choice can be derived in a principled way for each unit, for example based on the autocorrelation of the PSTH.</p></li>
<li><p>You could condition on other columns the units table to select units based on different inclusion criteria</p></li>
<li><p>You could try different distance metrics – there are many</p></li>
</ul>
</section>
<section id="other-things-you-can-find-in-this-dataset">
<h2>Other things you can find in this dataset<a class="headerlink" href="#other-things-you-can-find-in-this-dataset" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>We used two different electrode configurations; in half the mice we prioritized targeting of subcortical visual areas; the other half prioritized targeting cortical visual areas. This dataset has more dLGN and SC neurons than any previous Allen Institute dataset</p></li>
<li><p>The stimulus table variable ‘color’ contains the luminance of the visual stimulus in each video frame</p></li>
<li><p>We also presented a longer 120s unique full field white noise sequence</p></li>
<li><p>We also presented standing sine gratings modulated by white noise in time, in order to drive units that might not respond to spatially uniform stimuli. Spatial frequency, phase and orientation were varied.</p></li>
<li><p>There are flashed gabor stimuli which can be used to map the receptive field locations</p></li>
<li><p>Running speed and pupil dilation data could be used to test for modulatory effects on barcodes</p></li>
<li><p>Optotagging data can be used to identify units in one molecularly defined cell type per mouse</p></li>
</ul>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="session-timeline">
<h1>Session Timeline<a class="headerlink" href="#session-timeline" title="Link to this heading">#</a></h1>
<p>To get a good idea of the temporal structure of the stimulus throughout the session, the code below generates a timeline of the various ‘epochs’ of stimulus. It can be seen that there is a period of random full field flashes, followed by repeated full field flashes and more random flashes. Then static block presentations and receptive field presentations. Finally, there is an optogenetic stimulation period.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract epoch times from stim table where stimulus rows have a different &#39;block&#39; than following row</span>
<span class="c1"># returns list of epochs, where an epoch is of the form (stimulus name, stimulus block, start time, stop time)</span>
<span class="k">def</span> <span class="nf">extract_epochs</span><span class="p">(</span><span class="n">stim_name</span><span class="p">,</span> <span class="n">stim_table</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
    
    <span class="c1"># specify a current epoch stop and start time</span>
    <span class="n">epoch_start</span> <span class="o">=</span> <span class="n">stim_table</span><span class="o">.</span><span class="n">start_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">epoch_stop</span> <span class="o">=</span> <span class="n">stim_table</span><span class="o">.</span><span class="n">stop_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># for each row, try to extend current epoch stop_time</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stim_table</span><span class="p">)):</span>
        <span class="n">this_block</span> <span class="o">=</span> <span class="n">stim_table</span><span class="o">.</span><span class="n">stimulus_block</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># if end of table, end the current epoch</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_table</span><span class="p">):</span>
            <span class="n">epochs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">stim_name</span><span class="p">,</span> <span class="n">this_block</span><span class="p">,</span> <span class="n">epoch_start</span><span class="p">,</span> <span class="n">epoch_stop</span><span class="p">))</span>
            <span class="k">break</span>
            
        <span class="n">next_block</span> <span class="o">=</span> <span class="n">stim_table</span><span class="o">.</span><span class="n">stimulus_block</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># if next row is the same stim block, push back epoch_stop time</span>
        <span class="k">if</span> <span class="n">next_block</span> <span class="o">==</span> <span class="n">this_block</span><span class="p">:</span>
            <span class="n">epoch_stop</span> <span class="o">=</span> <span class="n">stim_table</span><span class="o">.</span><span class="n">stop_time</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># otherwise, end the current epoch, start new epoch</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epochs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">stim_name</span><span class="p">,</span> <span class="n">this_block</span><span class="p">,</span> <span class="n">epoch_start</span><span class="p">,</span> <span class="n">epoch_stop</span><span class="p">))</span>
            <span class="n">epoch_start</span> <span class="o">=</span> <span class="n">stim_table</span><span class="o">.</span><span class="n">start_time</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">epoch_stop</span> <span class="o">=</span> <span class="n">stim_table</span><span class="o">.</span><span class="n">stop_time</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">epochs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract epochs from all valid stimulus tables</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">stim_name</span> <span class="ow">in</span> <span class="n">nwb</span><span class="o">.</span><span class="n">intervals</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">stim_table</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">intervals</span><span class="p">[</span><span class="n">stim_name</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">epochs</span> <span class="o">=</span> <span class="n">extract_epochs</span><span class="p">(</span><span class="n">stim_name</span><span class="p">,</span> <span class="n">stim_table</span><span class="p">,</span> <span class="n">epochs</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">continue</span>

<span class="c1"># manually add optotagging epoch since the table is stored separately</span>
<span class="n">opto_stim_table</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">processing</span><span class="p">[</span><span class="s2">&quot;optotagging&quot;</span><span class="p">][</span><span class="s2">&quot;optogenetic_stimulation&quot;</span><span class="p">]</span>
<span class="n">opto_epoch</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;optogenetic_stimulation&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">opto_stim_table</span><span class="o">.</span><span class="n">start_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opto_stim_table</span><span class="o">.</span><span class="n">stop_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">epochs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opto_epoch</span><span class="p">)</span>

<span class="c1"># epochs take the form (stimulus name, stimulus block, start time, stop time)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">epochs</span><span class="p">))</span>
<span class="n">epochs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
(&#39;UniqueFFF_presentations&#39;, 0.0, 41.70058, 161.81776)
(&#39;RepeatFFF_presentations&#39;, 1.0, 161.81776, 882.43771)
(&#39;UniqueFFF_presentations&#39;, 2.0, 882.43771, 1002.53826)
(&#39;static_block_presentations&#39;, 3.0, 1002.53826, 6767.68327)
(&#39;receptive_field_block_presentations&#39;, 4.0, 6767.68327, 7248.085746666667)
(&#39;optogenetic_stimulation&#39;, 1.0, 7267.91448, 8138.04606)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_start</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="n">epoch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">]))</span>
<span class="n">time_end</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">epoch</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">]))</span>
<span class="n">all_units_spike_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span><span class="p">)</span>

<span class="c1"># make histogram of unit spikes per second over specified timeframe</span>
<span class="n">time_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span><span class="p">,</span> <span class="p">(</span><span class="n">time_end</span><span class="o">-</span><span class="n">time_start</span><span class="p">))</span>
<span class="n">hist</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">all_units_spike_times</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">time_bin_edges</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>41 8139
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate plot of spike histogram with colored epoch intervals and legend</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="c1"># assign unique color to each stimulus name</span>
<span class="n">stim_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="n">epoch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">})</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">stim_names</span><span class="p">)))</span>
<span class="n">stim_color_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">stim_names</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stim_names</span><span class="p">))}</span>

<span class="n">epoch_key</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
<span class="c1"># draw colored rectangles for each epoch</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">:</span>
    <span class="n">stim_name</span><span class="p">,</span> <span class="n">stim_block</span><span class="p">,</span> <span class="n">epoch_start</span><span class="p">,</span> <span class="n">epoch_end</span> <span class="o">=</span> <span class="n">epoch</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">stim_color_map</span><span class="p">[</span><span class="n">stim_name</span><span class="p">]</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">epoch_start</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">epoch_end</span><span class="o">-</span><span class="n">epoch_start</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">))</span>
    <span class="n">epoch_key</span><span class="p">[</span><span class="n">stim_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rec</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">height</span><span class="o">+</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time (s)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;# spikes&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;All Selected Unit Spikes Per Second Throughout Epochs&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">epoch_key</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">epoch_key</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.18</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">hist</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x22247e674c0&gt;]
</pre></div>
</div>
<img alt="../_images/257b1cb48945a2cbb8b1abdc5cbc768bab9081df70812ca051a0e07c8d1ef2f7.png" src="../_images/257b1cb48945a2cbb8b1abdc5cbc768bab9081df70812ca051a0e07c8d1ef2f7.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="visualizing-receptive-fields">
<h1>Visualizing Receptive Fields<a class="headerlink" href="#visualizing-receptive-fields" title="Link to this heading">#</a></h1>
<p>Very few SC units have been previously described in the Allen Institute datasets.
Here we visualize the receptive fields of some SC units in this dataset.
Note that due to limited recprding time, the receptive field stimuli were shown
for a very limited time, and therefore many RF maps are noisy.</p>
<p>The following code is taken from the <a class="reference internal" href="../first-order/receptive_fields.html"><span class="std std-doc">Showing Receptive Fields</span></a> notebook and is explained in more detail there.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make a list with indexes of units mapped to an area </span>
<span class="n">areasToInclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SCsg&#39;</span><span class="p">]</span> <span class="c1">#  [&#39;SCig&#39;, &#39;SCiw&#39;, &#39;SCop&#39;, &#39;SCsg&#39;]</span>
<span class="n">RFunits</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">units_quality</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">units_location</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">areasToInclude</span> <span class="ow">and</span> <span class="n">units_quality</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;good&quot;</span><span class="p">:</span>
        <span class="n">RFunits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">RFunits</span><span class="p">),</span> <span class="s1">&#39;units mapped to &#39;</span><span class="p">,</span> <span class="n">areasToInclude</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found  37 units mapped to  [&#39;SCsg&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### get receptive field of a unit using its spike times and the stim table</span>
<span class="n">rf_stim_table</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;receptive_field_block_presentations&quot;</span><span class="p">]</span>
<span class="c1">### get x and y coordinates of gabors displayed to build receptive field</span>

<span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">rf_stim_table</span><span class="o">.</span><span class="n">x_position</span><span class="p">)))</span>
<span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">rf_stim_table</span><span class="o">.</span><span class="n">y_position</span><span class="p">)))</span>
<span class="n">field_units</span> <span class="o">=</span> <span class="n">rf_stim_table</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># helper function to extract one unit&#39;s firing rate as a function of gabor location</span>
<span class="k">def</span> <span class="nf">get_rf</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span><span class="n">rf_stim_table</span><span class="p">):</span>
    <span class="c1"># INPUT</span>
    <span class="c1">#  spike_times: the spike times of one unit</span>
    <span class="c1">#</span>
    <span class="n">onset_delay</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="c1"># creates 2D array that stores response spike counts for each coordinate of the receptive field</span>
    <span class="n">unit_rf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ys</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">xs</span><span class="o">.</span><span class="n">size</span><span class="p">])</span>
    <span class="c1"># for every x and y coordinate in the field</span>
    <span class="k">for</span> <span class="n">xi</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">yi</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ys</span><span class="p">):</span>
            
            <span class="c1"># for this coordinate of the rf, count all the times that this neuron responds to a stimulus time with a spike</span>
            <span class="c1"># stim_times = rf_stim_table[(rf_stim_table.x_position == x) &amp; (rf_stim_table.y_position == y)].start_time</span>
            <span class="n">response_spike_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rf_stim_table</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">rf_stim_table</span><span class="p">[</span><span class="s1">&#39;x_position&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">x</span> <span class="ow">or</span> <span class="n">rf_stim_table</span><span class="p">[</span><span class="s1">&#39;y_position&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">y</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">rf_stim_table</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">rf_stim_table</span><span class="p">[</span><span class="s1">&#39;stop_time&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># any spike within 0.2 seconds after stim time is considered a response</span>
                <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="p">[</span><span class="n">start</span><span class="o">+</span><span class="n">onset_delay</span><span class="p">,</span> <span class="n">end</span><span class="o">+</span><span class="n">onset_delay</span><span class="p">])</span>
                <span class="n">response_spike_count</span> <span class="o">+=</span> <span class="n">end_idx</span><span class="o">-</span><span class="n">start_idx</span>

            <span class="n">unit_rf</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span> <span class="o">=</span> <span class="n">response_spike_count</span>
    
    <span class="k">return</span> <span class="n">unit_rf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute receptive fields of selected units (this can take some time)</span>
<span class="n">rfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">unit_idx</span> <span class="ow">in</span> <span class="n">RFunits</span><span class="p">:</span> 
    <span class="n">unit_spike_times</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;spike_times&#39;</span><span class="p">][</span><span class="n">unit_idx</span><span class="p">]</span>
    <span class="n">rfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_rf</span><span class="p">(</span><span class="n">unit_spike_times</span><span class="p">,</span><span class="n">rf_stim_table</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### helper function to display the receptive fields for each unit in a 2D plot</span>

<span class="k">def</span> <span class="nf">display_rfs</span><span class="p">(</span><span class="n">unit_rfs</span><span class="p">):</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unit_rfs</span><span class="p">)</span><span class="o">//</span><span class="n">n_cols</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">n_rows</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># handle case where there&#39;s &lt;= 10 rfs</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">irf</span><span class="p">,</span> <span class="n">rf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unit_rfs</span><span class="p">):</span>
        <span class="n">ax_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">irf</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax_col</span> <span class="o">=</span> <span class="n">irf</span><span class="o">%</span><span class="k">10</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">ax_row</span><span class="p">][</span><span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="c1"># making axis labels for first receptive field</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">field_units</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">field_units</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span> 
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)),</span> <span class="n">xs</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)),</span> <span class="n">ys</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">l</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">l</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># display the receptive fields </span>
<span class="n">display_rfs</span><span class="p">(</span><span class="n">rfs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5287666b26d4ad12714a4ddddd7b8ecb140f473fa1f37d366c4eccafdeb2dd86.png" src="../_images/5287666b26d4ad12714a4ddddd7b8ecb140f473fa1f37d366c4eccafdeb2dd86.png" />
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "AllenInstitute/openscope_databook",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./projects"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="sequence_learning.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">OpenScope’s Sequence Learning Dataset</p>
      </div>
    </a>
    <a class="right-next"
       href="vippo.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">OpenScope’s Vision2Hippocampus Dataset</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Introduction to the Temporal Barcode Dataset</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-1-white-noise-stimuli-evoke-temporally-precise-neural-responses-a-recording-of-a-salamander-retinal-ganglion-cell-in-a-dish-in-response-to-repeated-white-noise-full-field-flicker-from-berry-and-meister-1998-see-also-pillow-et-al-2005-b-recording-of-an-anesthetized-cat-lgn-cell-in-response-to-repeated-white-noise-fullfield-flicker-from-reinagel-and-reid-2000-c-response-of-an-alert-macaque-cortical-area-mt-neuron-in-response-to-a-grating-stimulus-whose-drift-direction-was-modulated-with-repeated-white-noise-from-buracas-et-al-1998">Figure 1. White noise stimuli evoke temporally precise neural responses. A. Recording of a salamander retinal ganglion cell in a dish in response to repeated white noise full-field flicker (from Berry and Meister 1998). See also: Pillow et al 2005, B. Recording of an anesthetized cat LGN cell in response to repeated white noise fullfield flicker (from Reinagel and Reid, 2000). C. Response of an alert macaque cortical area MT neuron in response to a grating stimulus whose drift direction was modulated with repeated white noise (from Buracas et al, 1998).</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-2-temporal-barcodes-define-reproducible-and-stable-types-a-recording-of-lgn-cells-in-two-different-anesthetized-cats-in-response-to-the-same-repeated-white-noise-full-field-flicker-from-reinagel-and-reid-2002-b-recordings-from-a-salamander-retinal-ganglion-cell-vs-a-rabbit-retinal-ganglion-cell-in-response-to-the-same-repeated-white-noise-full-field-flicker-from-berry-et-al-1997-c-recording-of-a-cat-lgn-cell-to-the-same-repeated-white-noise-full-field-flicker-shown-at-different-contrasts-from-gaudry-and-reinagel-2007">Figure 2. Temporal barcodes define reproducible and stable types. A. Recording of LGN cells in two different anesthetized cats in response to the same repeated white noise full-field flicker (from Reinagel and Reid, 2002). B. Recordings from a salamander retinal ganglion cell vs. a rabbit retinal ganglion cell in response to the same repeated white noise full-field flicker (from Berry et al, 1997). C. recording of a cat LGN cell to the same repeated white noise full-field flicker shown at different contrasts (from Gaudry and Reinagel, 2007).*</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-experiment">The Experiment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-ecephys-file">Downloading Ecephys File</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#showing-probe-tracks">Showing Probe Tracks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#find-out-about-the-units-recorded-in-the-experiment">Find out about the units recorded in the experiment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-stimulus-times">Loading Stimulus Times</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-trial-aligned-event-times">Getting Trial-Aligned Event Times</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-rasters">Plotting rasters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-psths">Plotting PSTHs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#statistical-criterion-for-psth-peaks">Statistical criterion for PSTH peaks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-barcodes">Extracting barcodes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spike-distance-metric">5. Spike Distance Metric</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-distances-between-barcodes">Computing Distances Between Barcodes</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#to-illustrate-the-spike-distance-metric-let-s-compare-two-fictional-barcodes">To illustrate the spike distance metric let’s compare two fictional barcodes</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#now-compute-the-distance-between-the-barcodes-of-the-two-example-neurons-above-that-had-barcodes">Now compute the distance between the barcodes of the two example neurons above that had barcodes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-does-the-distance-between-two-barcodes-mean">What does the distance between two barcodes mean?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#circular-permutation-explained">Circular permutation explained</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises-for-the-reader">Exercises for the reader</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#other-things-you-can-find-in-this-dataset">Other things you can find in this dataset</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#session-timeline">Session Timeline</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-receptive-fields">Visualizing Receptive Fields</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Carter Peene
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>