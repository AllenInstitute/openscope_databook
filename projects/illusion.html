
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>OpenScope’s Illusion Dataset &#8212; OpenScope Databook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-TJPN1M4PDX"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-TJPN1M4PDX');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-TJPN1M4PDX');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'projects/illusion';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="OpenScope’s Dendritic Coupling Dataset" href="dendritic_coupling.html" />
    <link rel="prev" title="OpenScope’s Global/Local Oddball Dataset" href="glo.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="OpenScope Databook - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="OpenScope Databook - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    OpenScope Databook
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../basics/background.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/download_nwb.html">Downloading an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/stream_nwb.html">Streaming an NWB File with remfile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/read_nwb.html">Reading an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/use_nwbwidgets.html">Exploring an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/get_dandiset_metadata.html">Getting Experimental Metadata from DANDI</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Visualizing NWB Files</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_2p_raw.html">Visualizing Raw 2-Photon Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_metrics.html">Visualizing Unit Quality Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_lfp_responses.html">Visualizing LFP Responses to Stimuli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_responses.html">Visualizing Neuronal Unit Responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_2p_responses.html">Visualizing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_spikes.html">Visualizing Neuronal Unit Spikes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_neuropixels_probes.html">Visualizing Neuropixels Probe Locations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_templates.html">Visualizing Stimulus Templates</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">First-Order Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../first-order/receptive_fields.html">Showing Receptive Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/optotagging.html">Identifying Optotagged Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/current_source_density.html">Current Source Density Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/classify_waveforms.html">Classifying Fast-Spiking and Regular-Spiking Neurons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/test_2p_responses.html">Statistically Testing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/test_unit_responses.html">Statistically Testing Spike Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/suite2p.html">Identifying Regions of Interest with Segmentation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Higher-Order Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../higher-order/cebra_time.html">Using CEBRA-Time to Identify Latent Embeddings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../higher-order/tca.html">Tensor Decomposition of Spiking Activity Through Trials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../higher-order/glm.html">Generalized Linear Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../higher-order/behavioral_state.html">Behavioral State from Trial Outcomes</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Openscope Experimental Projects</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="cred_assign_figures.html">Replicating OpenScope Credit Assignment project figures</a></li>
<li class="toctree-l1"><a class="reference internal" href="glo.html">OpenScope’s Global/Local Oddball Dataset</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">OpenScope’s Illusion Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="dendritic_coupling.html">OpenScope’s Dendritic Coupling Dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Embargoed Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../embargoed/modality_alignment.html">Aligning Data across Modalities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/visualize_behavior.html">Visualizing Behavioral Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/test_2p_responses_embargoed.html">Statistically Testing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/cell_matching.html">Cell Matching Across Days</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Methods</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../methods/jupyter_book.html">Jupyter/Jupyter Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods/github.html">Git/GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods/environments.html">Managing Environments on Multiple Platforms</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../contribution.html">Contributing to the Databook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors_index.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html">FAQ</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/AllenInstitute/openscope_databook/main?urlpath=lab/tree/docs/projects/illusion.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://hub.dandiarchive.org/hub/user-redirect/git-pull?repo=https%3A//github.com/AllenInstitute/openscope_databook&urlpath=lab/tree/openscope_databook/docs/projects/illusion.ipynb&branch=main" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on JupyterHub"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="JupyterHub logo" src="../_static/images/logo_jupyterhub.svg">
  </span>
<span class="btn__text-container">JupyterHub</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/AllenInstitute/openscope_databook/blob/main/docs/projects/illusion.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/AllenInstitute/openscope_databook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/AllenInstitute/openscope_databook/issues/new?title=Issue%20on%20page%20%2Fprojects/illusion.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/projects/illusion.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>OpenScope’s Illusion Dataset</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">Environment Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-experiment">The Experiment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-ecephys-file">Downloading Ecephys File</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#showing-stim-templates">Showing Stim Templates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#showing-probe-tracks">Showing Probe Tracks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-units-spikes">Extracting Units Spikes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#session-timeline">Session Timeline</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-stimulus-times">Extracting Stimulus Times</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-spike-matrix">Generating Spike Matrix</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#showing-response-windows">Showing Response Windows</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-responsive-cells">Selecting Responsive Cells</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-receptive-fields">Getting Receptive Fields</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optotagging">Optotagging</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#openscope-illusion-publication-example-analysis-code">OpenScope Illusion publication: Example Analysis Code</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fig-1e-identifying-exclusively-center-responsive-v1-neurons">Fig. 1e : identifying exclusively center-responsive V1 neurons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-the-receptive-field-of-each-exclusively-center-responsive-v1-neuron">Plot the receptive field of each exclusively center-responsive V1 neuron</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-the-average-of-exclusively-center-responsive-v1-neurons">Plot the average of exclusively center-responsive V1 neurons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-1f-stacked-peri-stimulus-time-histograms-psths-depicting-evoked-responses-to-i-c-and-i-re-images-for-exclusively-center-responsive-v1-neurons">Figure. 1f : stacked peri-stimulus time histograms (PSTHs) depicting evoked responses to <span class="math notranslate nohighlight">\(I_{C}\)</span> and <span class="math notranslate nohighlight">\(I_{RE}\)</span> images for exclusively center-responsive V1 neurons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fig-1g-for-exclusively-center-responsive-v1-neurons-that-are-also-responsive-to-at-least-one-of-the-four-i-c-images-compare-the-preferred-orientation-for-i-c-vs-i-re-images">Fig. 1g : for exclusively center-responsive V1 neurons that are also responsive to at least one of the four <span class="math notranslate nohighlight">\(I_{C}\)</span> images, compare the preferred orientation for <span class="math notranslate nohighlight">\(I_{C}\)</span> vs <span class="math notranslate nohighlight">\(I_{RE}\)</span> images</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="openscope-s-illusion-dataset">
<h1>OpenScope’s Illusion Dataset<a class="headerlink" href="#openscope-s-illusion-dataset" title="Link to this heading">#</a></h1>
<p>Imagine being out in the open sea on a boat. Suddenly, you notice a dark shape passing by underwater. Even though the shape is distorted by the wave and the color is a mere shade different from the water, you mind automatically infers the outline of a shark. As illustrated, perception is inference rather than faithful reconstruction. However sensory neuroscience has traditionally focused on the question of how faithfully/accurately the brain can represent sensory information. Moreover, sensory stimuli typically used in neurophysiology experiments make it difficult to dissociate between a neural representation that is faithful vs inferred. Illusions arise due to rational mistakes in perceptual inference, exemplifying the dichotomy between faithful representation and inferred representation. Openscope’s Illusion Experiment described by <a class="reference external" href="https://www.biorxiv.org/content/10.1101/2023.06.05.543698v1"><span id="id1">[<a class="reference internal" href="../bibliography.html#id21" title="Hyeyoung Shin, Mora B. Ogando, Lamiae Abdeladim, Severine Durand, Hannah Belski, Hannah Cabasco, Henry Loefler, Ahad Bawany, Ben Hardcastle, Josh Wilkes, Katrina Nguyen, Lucas Suarez, Tye Johnson, Warren Han, Ben Ouellette, Conor Grasso, Jackie Swapp, Vivian Ha, Ahrial Young, Shiella Caldejon, Ali Williford, Peter Groblewski, Shawn Olsen, Carly Kiselycznyk, Jerome Lecoq, and Hillel Adesnik. Recurrent pattern completion drives the neocortical representation of sensory inference. bioRxiv, ():, 2023. URL: https://doi.org/10.1101/2023.06.05.543698.">Shin <em>et al.</em>, 2023</a>]</span></a>, utilizes illusory contours (ICs) to study the neural mechanisms of perceptual inference.</p>
<p>ICs have direct neural substrates in the brain – there are neurons in the visual cortex that respond to ICs with the same specificity as to real edges (IC-encoders). Prior literature has shown IC-encoding in primary visual cortex (V1) arises through top-down feedback from higher visual areas (Figure 1). IC perception requires precise alignment of inducers (e.g., black circular shapes on either side of the illusory contour): Rotating one of the inducers no longer evokes an illusory percept (rotated control images, RCs). It follows that inducer-encoders, i.e., neurons that receive feedforward sensory information from inducers on either side of the IC, need to coordinate their sensory driven activity to drive IC-encoders in higher visual areas, and in turn, V1. In other words, IC-encoders need to bind with inducer-encoders on both sides of the IC. On the contrary, the binding of faithful neurons, i.e., neurons that respond to real edges but not to illusory contours, is inconsequential for IC perception. Therefore, ICs necessitate a much more selective group of neurons to bind compared to real edges, narrowing down the spatial component of the binding problem. Thus, ICs are ideally suited for addressing the temporal component of the binding problem.</p>
<p><img alt="illusion_fig1.png" src="../_images/illusion_fig1.png" /></p>
<section id="environment-setup">
<h2>Environment Setup<a class="headerlink" href="#environment-setup" title="Link to this heading">#</a></h2>
<p>⚠️<strong>Note: If running on a new environment, run this cell once and then restart the kernel</strong>⚠️</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">databook_utils.dandi_utils</span> <span class="kn">import</span> <span class="n">dandi_download_open</span>
<span class="k">except</span><span class="p">:</span>
    <span class="o">!</span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/AllenInstitute/openscope_databook.git
    <span class="o">%</span><span class="k">cd</span> openscope_databook
    <span class="o">%</span><span class="k">pip</span> install -e .
    <span class="o">%</span><span class="k">cd</span> docs/projects
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">floor</span><span class="p">,</span> <span class="n">ceil</span><span class="p">,</span> <span class="n">isclose</span>
<span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="kn">import</span> <span class="n">PatchCollection</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">Normalize</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter1d</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">kruskal</span><span class="p">,</span> <span class="n">wilcoxon</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.multicomp</span> <span class="kn">import</span> <span class="n">pairwise_tukeyhsd</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-experiment">
<h2>The Experiment<a class="headerlink" href="#the-experiment" title="Link to this heading">#</a></h2>
<p>As shown in the metadata table below, Openscope’s Illusion Experiment has produced 13 different main files on the <a class="reference external" href="http://dandiarchive.org">DANDI Archive</a> with 7 males and 5 females. There are no wildtype mice but there are Pvalb and Sst genotypes. This table was generated from <a class="reference internal" href="../basics/get_dandiset_metadata.html"><span class="std std-doc">Getting Experimental Metadata from DANDI</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">session_files</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../../data/illusion_sessions.csv&quot;</span><span class="p">)</span>
<span class="n">session_files</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>identifier</th>
      <th>size</th>
      <th>path</th>
      <th>session_time</th>
      <th>specimen_name</th>
      <th>sex</th>
      <th>age</th>
      <th>genotype</th>
      <th>probes</th>
      <th>stim_types</th>
      <th>n_units</th>
      <th>session_end</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>9ab6bfff-70ed-44dc-b384-96b4cef2b566</td>
      <td>3308934228</td>
      <td>sub-633229/sub-633229_ses-1199247593_ogen.nwb</td>
      <td>2022-08-17 00:00:00-07:00</td>
      <td>633229</td>
      <td>F</td>
      <td>101.0</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'OptogeneticStimulusDevice', 'probeD', 'probe...</td>
      <td>{'ICkcfg1_presentations', 'ICwcfg0_presentatio...</td>
      <td>3026</td>
      <td>7279.58784</td>
    </tr>
    <tr>
      <th>1</th>
      <td>15bbb781-f912-4630-b9fe-f3df864290ad</td>
      <td>2773818936</td>
      <td>sub-631510/sub-631510_ses-1196157974_ogen.nwb</td>
      <td>2022-08-03 00:00:00-07:00</td>
      <td>631510</td>
      <td>F</td>
      <td>99.0</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'OptogeneticStimulusDevice', 'probeD', 'probe...</td>
      <td>{'ICkcfg1_presentations', 'ICwcfg0_presentatio...</td>
      <td>2386</td>
      <td>7339.21131</td>
    </tr>
    <tr>
      <th>2</th>
      <td>f7b65765-41b5-4605-9585-95338c3a9e5a</td>
      <td>2717870004</td>
      <td>sub-620334/sub-620334_ses-1189887297_ogen.nwb</td>
      <td>2022-07-06 00:00:00-07:00</td>
      <td>620334</td>
      <td>M</td>
      <td>154.0</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'OptogeneticStimulusDevice', 'probeD', 'probe...</td>
      <td>{'ICkcfg1_presentations', 'ICwcfg0_presentatio...</td>
      <td>2092</td>
      <td>7279.89479</td>
    </tr>
    <tr>
      <th>3</th>
      <td>6b321a1c-55c4-4de5-8a25-373f2c5a4bc8</td>
      <td>3036007774</td>
      <td>sub-620333/sub-620333_ses-1188137866_ogen.nwb</td>
      <td>2022-06-30 00:00:00-07:00</td>
      <td>620333</td>
      <td>M</td>
      <td>148.0</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'OptogeneticStimulusDevice', 'probeD', 'probe...</td>
      <td>{'ICkcfg1_presentations', 'ICwcfg0_presentatio...</td>
      <td>2593</td>
      <td>7283.08716</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0073a783-5b41-42a8-882a-2960554d4e43</td>
      <td>2108745405</td>
      <td>sub-631570/sub-631570_ses-1194857009_ogen.nwb</td>
      <td>2022-07-28 00:00:00-07:00</td>
      <td>631570</td>
      <td>F</td>
      <td>92.0</td>
      <td>Pvalb-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'OptogeneticStimulusDevice', 'probeD', 'probe...</td>
      <td>{'ICkcfg1_presentations', 'ICwcfg0_presentatio...</td>
      <td>1789</td>
      <td>7278.92195</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1b7aaf88-eabd-46f5-8f2a-c1fecba823f2</td>
      <td>2598789798</td>
      <td>sub-625555/sub-625555_ses-1183070926_ogen.nwb</td>
      <td>2022-06-09 00:00:00-07:00</td>
      <td>625555</td>
      <td>F</td>
      <td>90.0</td>
      <td>Pvalb-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'OptogeneticStimulusDevice', 'probeD', 'probe...</td>
      <td>{'ICkcfg1_presentations', 'ICwcfg0_presentatio...</td>
      <td>2621</td>
      <td>7278.57204</td>
    </tr>
    <tr>
      <th>6</th>
      <td>3e3d9ce2-4d45-4f41-a957-532cbdf5bc39</td>
      <td>3619691457</td>
      <td>sub-625554/sub-625554_ses-1181330601_ogen.nwb</td>
      <td>2022-06-01 00:00:00-07:00</td>
      <td>625554</td>
      <td>M</td>
      <td>82.0</td>
      <td>Pvalb-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'OptogeneticStimulusDevice', 'probeD', 'probe...</td>
      <td>{'ICkcfg1_presentations', 'ICwcfg0_presentatio...</td>
      <td>2930</td>
      <td>7315.43515</td>
    </tr>
    <tr>
      <th>7</th>
      <td>f1a26076-0a3e-43c8-b138-5320bca7a23f</td>
      <td>2469141920</td>
      <td>sub-619296/sub-619296_ses-1187930705_ogen.nwb</td>
      <td>2022-06-29 00:00:00-07:00</td>
      <td>619296</td>
      <td>M</td>
      <td>154.0</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'OptogeneticStimulusDevice', 'probeD', 'probe...</td>
      <td>{'ICkcfg1_presentations', 'ICwcfg0_presentatio...</td>
      <td>1918</td>
      <td>7278.13709</td>
    </tr>
    <tr>
      <th>8</th>
      <td>bc340647-7b72-4ec8-aa86-ac236da36713</td>
      <td>2709636662</td>
      <td>sub-630506/sub-630506_ses-1192952695_ogen.nwb</td>
      <td>2022-07-20 00:00:00-07:00</td>
      <td>630506</td>
      <td>F</td>
      <td>92.0</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'OptogeneticStimulusDevice', 'probeD', 'probe...</td>
      <td>{'ICkcfg1_presentations', 'ICwcfg0_presentatio...</td>
      <td>2517</td>
      <td>7279.14674</td>
    </tr>
    <tr>
      <th>9</th>
      <td>efb53d2c-2d51-4a26-9b36-5d3d3ff7e19e</td>
      <td>2803551453</td>
      <td>sub-625545/sub-625545_ses-1182865981_ogen.nwb</td>
      <td>2022-06-08 00:00:00-07:00</td>
      <td>625545</td>
      <td>M</td>
      <td>89.0</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'OptogeneticStimulusDevice', 'probeD', 'probe...</td>
      <td>{'ICkcfg1_presentations', 'ICwcfg0_presentatio...</td>
      <td>2793</td>
      <td>7279.21336</td>
    </tr>
    <tr>
      <th>10</th>
      <td>e61edcf3-26e9-44e1-9017-3ee558197da5</td>
      <td>2453451408</td>
      <td>sub-619293/sub-619293_ses-1184980079_ogen.nwb</td>
      <td>2022-06-16 00:00:00-07:00</td>
      <td>619293</td>
      <td>M</td>
      <td>141.0</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'OptogeneticStimulusDevice', 'probeD', 'probe...</td>
      <td>{'ICkcfg1_presentations', 'ICwcfg0_presentatio...</td>
      <td>2136</td>
      <td>7454.53444</td>
    </tr>
    <tr>
      <th>11</th>
      <td>233e6f43-d51e-47f0-9cda-838444c274f6</td>
      <td>2557113684</td>
      <td>sub-637484/sub-637484_ses-1208667752_ogen.nwb</td>
      <td>2022-09-08 00:00:00-07:00</td>
      <td>637484</td>
      <td>M</td>
      <td>92.0</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>{'OptogeneticStimulusDevice', 'probeD', 'probe...</td>
      <td>{'ICkcfg1_presentations', 'ICwcfg0_presentatio...</td>
      <td>2373</td>
      <td>7349.25154</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_files</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">][</span><span class="n">session_files</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">])</span>
<span class="n">f_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_files</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">][</span><span class="n">session_files</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;F&quot;</span><span class="p">])</span>
<span class="n">sst_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_files</span><span class="p">[</span><span class="n">session_files</span><span class="p">[</span><span class="s2">&quot;genotype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;Sst&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">pval_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_files</span><span class="p">[</span><span class="n">session_files</span><span class="p">[</span><span class="s2">&quot;genotype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;Pval&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">wt_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_files</span><span class="p">[</span><span class="n">session_files</span><span class="p">[</span><span class="s2">&quot;genotype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;wt/wt&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dandiset Overview:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">session_files</span><span class="p">),</span> <span class="s2">&quot;files&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">session_files</span><span class="p">[</span><span class="s2">&quot;specimen_name&quot;</span><span class="p">])),</span> <span class="s2">&quot;subjects&quot;</span><span class="p">,</span> <span class="n">m_count</span><span class="p">,</span> <span class="s2">&quot;males,&quot;</span><span class="p">,</span> <span class="n">f_count</span><span class="p">,</span> <span class="s2">&quot;females&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sst_count</span><span class="p">,</span> <span class="s2">&quot;sst,&quot;</span><span class="p">,</span> <span class="n">pval_count</span><span class="p">,</span> <span class="s2">&quot;pval,&quot;</span><span class="p">,</span> <span class="n">wt_count</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dandiset Overview:
12 files
12 subjects 7 males, 5 females
9 sst, 3 pval, 0 wt
</pre></div>
</div>
</div>
</div>
</section>
<section id="downloading-ecephys-file">
<h2>Downloading Ecephys File<a class="headerlink" href="#downloading-ecephys-file" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dandiset_id</span> <span class="o">=</span> <span class="s2">&quot;000248&quot;</span>
<span class="n">dandi_filepath</span> <span class="o">=</span> <span class="s2">&quot;sub-620333/sub-620333_ses-1188137866_ogen.nwb&quot;</span>
<span class="n">download_loc</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This can sometimes take a while depending on the size of the file</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">dandi_download_open</span><span class="p">(</span><span class="n">dandiset_id</span><span class="p">,</span> <span class="n">dandi_filepath</span><span class="p">,</span> <span class="n">download_loc</span><span class="p">)</span>
<span class="n">nwb</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>A newer version (0.62.2) of dandi/dandi-cli is available. You are using 0.61.2
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>File already exists
Opening file
</pre></div>
</div>
</div>
</div>
</section>
<section id="showing-stim-templates">
<h2>Showing Stim Templates<a class="headerlink" href="#showing-stim-templates" title="Link to this heading">#</a></h2>
<p>The experiment consists of 118 unique stimulus frames which are shown throughout the duration in various phases. The groups below display the different sets of templates. There are four sets of Illusory Contour (IC) templates, that are either black or white, and are either arranged at 0 or 45 degrees on the screen. It can be seen that there are some images that show real contours and some that show illusory contours, as well as images whose IC encoders are orthogonal, showing no illusory contour. Additionally, there are Receptive Field and Size Templates which will be used identify neurons active in the relevant fields of the stim.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">nwb</span><span class="o">.</span><span class="n">stimulus_template</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;ICkcfg0_presentations&#39;, &#39;ICkcfg1_presentations&#39;, &#39;ICwcfg0_presentations&#39;, &#39;ICwcfg1_presentations&#39;, &#39;RFCI_presentations&#39;, &#39;sizeCI_presentations&#39;])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">show_images</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">n_cols</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_cols</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n_cols</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_rows</span><span class="p">)</span> <span class="c1"># can tweak these if sizing/spacing needs improvement</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.edgecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.linewidth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">template_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">images</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">template_name</span><span class="p">]</span>
        
        <span class="n">ax_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">)</span>
        <span class="n">ax_col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">n_cols</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">ax_row</span><span class="p">][</span><span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">ax_row</span><span class="p">][</span><span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="n">remainder</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_cols</span> <span class="o">*</span> <span class="n">n_rows</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
    <span class="n">remaining_axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="n">remainder</span><span class="p">:]</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">remaining_axes</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([])</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_template_imgs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">template_group</span> <span class="ow">in</span> <span class="n">nwb</span><span class="o">.</span><span class="n">stimulus_template</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">all_template_imgs</span> <span class="o">|=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">stimulus_template</span><span class="p">[</span><span class="n">template_group</span><span class="p">]</span><span class="o">.</span><span class="n">images</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_template_imgs</span><span class="p">),</span> <span class="s2">&quot;templates&quot;</span><span class="p">)</span>
<span class="n">show_images</span><span class="p">(</span><span class="n">all_template_imgs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>118 templates
</pre></div>
</div>
<img alt="../_images/c6fbddc07ad4a93e4e4e919182d3c275717206a11ab6361de5d03fbdc9ed08eb.png" src="../_images/c6fbddc07ad4a93e4e4e919182d3c275717206a11ab6361de5d03fbdc9ed08eb.png" />
</div>
</div>
</section>
<section id="showing-probe-tracks">
<h2>Showing Probe Tracks<a class="headerlink" href="#showing-probe-tracks" title="Link to this heading">#</a></h2>
<p>The images below were rendered using the <a class="reference internal" href="../visualization/visualize_neuropixels_probes.html"><span class="std std-doc">Visualizing Neuropixels Probe Locations</span></a> notebook. The probes are using the <a class="reference external" href="https://community.brain-map.org/t/allen-mouse-ccf-accessing-and-using-related-data-and-tools/359">Common Coordinate Framework</a> (CCF). The experiment uses six probes labeled A-F to target various regions. It can be seen that the probe tracks look bent. This is due to the fact that each mouse brain varies slightly, so the coordinate space is slightly warped when mapping the CCF coordinates to each mouse’s brain.</p>
<div class="cell tag_skip-execution docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sagittal_view</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../../data/images/probes_sagittal.png&quot;</span><span class="p">)</span>
<span class="n">dorsal_view</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../../data/images/probes_dorsal.png&quot;</span><span class="p">)</span>
<span class="n">transverse_view</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../../data/images/probes_transverse.png&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">60</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sagittal_view</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dorsal_view</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">transverse_view</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/95bbb392828e25a0327b3891c69a83dfadee4d8c5375ace91aa8802aa1dbded3.png" src="../_images/95bbb392828e25a0327b3891c69a83dfadee4d8c5375ace91aa8802aa1dbded3.png" />
</div>
</div>
</section>
<section id="extracting-units-spikes">
<h2>Extracting Units Spikes<a class="headerlink" href="#extracting-units-spikes" title="Link to this heading">#</a></h2>
<p>Below, the <code class="docutils literal notranslate"><span class="pre">Units</span></code> table is retrieved from the file. It contains many metrics for every putative neuronal unit, printed below. For the analysis in this notebook, we are only interested in the <code class="docutils literal notranslate"><span class="pre">spike_times</span></code> attribute. This is an array of timestamps that a spike is measured for each unit. For more information on the various unit metrics, see <a class="reference internal" href="../visualization/visualize_unit_metrics.html"><span class="std std-doc">Visualizing Unit Quality Metrics</span></a>. From this table, the Units used in this notebook are selected if they have ‘good’ quality rather than ‘noise’, and if they belong in one of the regions of the primary visual cortex.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">units</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">units</span>
<span class="n">units</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>quality</th>
      <th>nn_hit_rate</th>
      <th>max_drift</th>
      <th>firing_rate</th>
      <th>nn_miss_rate</th>
      <th>cumulative_drift</th>
      <th>amplitude</th>
      <th>silhouette_score</th>
      <th>peak_channel_id</th>
      <th>recovery_slope</th>
      <th>...</th>
      <th>isolation_distance</th>
      <th>snr</th>
      <th>velocity_above</th>
      <th>isi_violations</th>
      <th>velocity_below</th>
      <th>repolarization_slope</th>
      <th>cluster_id</th>
      <th>spike_times</th>
      <th>spike_amplitudes</th>
      <th>waveform_mean</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>18</th>
      <td>good</td>
      <td>0.972840</td>
      <td>54.39</td>
      <td>0.785629</td>
      <td>0.000101</td>
      <td>304.75</td>
      <td>409.946355</td>
      <td>-1.000000</td>
      <td>1</td>
      <td>-0.080977</td>
      <td>...</td>
      <td>58.451532</td>
      <td>4.150814</td>
      <td>-0.686767</td>
      <td>1.487302</td>
      <td>-1.000000</td>
      <td>1.240973</td>
      <td>0</td>
      <td>[4.619753663168268, 9.457581949708135, 13.1722...</td>
      <td>[0.00025338330763588783, 0.0004250468749792737...</td>
      <td>[[0.0, 0.742949999999996, 2.6014949999999954, ...</td>
    </tr>
    <tr>
      <th>19</th>
      <td>good</td>
      <td>0.985333</td>
      <td>24.95</td>
      <td>15.449669</td>
      <td>0.003207</td>
      <td>465.01</td>
      <td>220.825800</td>
      <td>0.315177</td>
      <td>4</td>
      <td>-0.295615</td>
      <td>...</td>
      <td>85.345951</td>
      <td>2.300934</td>
      <td>-0.206030</td>
      <td>0.070768</td>
      <td>0.000000</td>
      <td>0.870400</td>
      <td>1</td>
      <td>[4.599820350629247, 4.6193869968841055, 4.6958...</td>
      <td>[0.00017759864579981443, 0.0001952821079373443...</td>
      <td>[[0.0, 0.3352050000000011, 0.656565000000001, ...</td>
    </tr>
    <tr>
      <th>20</th>
      <td>good</td>
      <td>0.990667</td>
      <td>30.85</td>
      <td>4.441959</td>
      <td>0.001217</td>
      <td>514.47</td>
      <td>221.874120</td>
      <td>0.147414</td>
      <td>2</td>
      <td>-0.095838</td>
      <td>...</td>
      <td>79.468326</td>
      <td>2.524524</td>
      <td>0.618090</td>
      <td>0.128934</td>
      <td>-1.000000</td>
      <td>0.752556</td>
      <td>2</td>
      <td>[4.619453663481226, 4.6196536632725875, 13.132...</td>
      <td>[0.0004071066388380147, 0.0004011982449094236,...</td>
      <td>[[0.0, -1.3414050000000004, -0.667094999999999...</td>
    </tr>
    <tr>
      <th>21</th>
      <td>good</td>
      <td>0.905149</td>
      <td>46.79</td>
      <td>4.488801</td>
      <td>0.003357</td>
      <td>469.56</td>
      <td>249.373410</td>
      <td>0.079532</td>
      <td>4</td>
      <td>-0.227309</td>
      <td>...</td>
      <td>50.526803</td>
      <td>2.558366</td>
      <td>0.206030</td>
      <td>0.171801</td>
      <td>0.686767</td>
      <td>1.079105</td>
      <td>3</td>
      <td>[4.61718699917913, 4.6436869715345175, 4.65532...</td>
      <td>[0.0003194871684192031, 0.0002639795077521114,...</td>
      <td>[[0.0, -0.07585499999999135, -0.81860999999999...</td>
    </tr>
    <tr>
      <th>22</th>
      <td>good</td>
      <td>0.993333</td>
      <td>30.62</td>
      <td>24.789545</td>
      <td>0.001714</td>
      <td>210.26</td>
      <td>377.191620</td>
      <td>0.067281</td>
      <td>4</td>
      <td>-0.409635</td>
      <td>...</td>
      <td>109.089797</td>
      <td>3.961270</td>
      <td>-0.343384</td>
      <td>0.000746</td>
      <td>0.000000</td>
      <td>1.664511</td>
      <td>4</td>
      <td>[4.683020263835597, 4.689420257159162, 4.69892...</td>
      <td>[0.0004522358091835468, 0.0004033241545627162,...</td>
      <td>[[0.0, 0.7710299999999997, 2.760810000000002, ...</td>
    </tr>
    <tr>
      <th>23</th>
      <td>good</td>
      <td>0.887821</td>
      <td>31.42</td>
      <td>1.916063</td>
      <td>0.001044</td>
      <td>118.23</td>
      <td>221.932815</td>
      <td>0.083996</td>
      <td>6</td>
      <td>-0.232742</td>
      <td>...</td>
      <td>50.598302</td>
      <td>1.696094</td>
      <td>0.000000</td>
      <td>0.340775</td>
      <td>0.000000</td>
      <td>0.780761</td>
      <td>5</td>
      <td>[4.618953664002823, 4.619286996988425, 4.61948...</td>
      <td>[0.0005486640019763263, 0.00020423305698845652...</td>
      <td>[[0.0, -0.4504500000000009, -0.460785000000004...</td>
    </tr>
    <tr>
      <th>24</th>
      <td>good</td>
      <td>0.766667</td>
      <td>47.33</td>
      <td>0.319214</td>
      <td>0.000501</td>
      <td>277.97</td>
      <td>236.829255</td>
      <td>0.260263</td>
      <td>5</td>
      <td>-0.334351</td>
      <td>...</td>
      <td>35.118253</td>
      <td>1.700857</td>
      <td>-0.068677</td>
      <td>20.095854</td>
      <td>0.000000</td>
      <td>1.031677</td>
      <td>6</td>
      <td>[4.619886996362509, 7.269484232318557, 7.37791...</td>
      <td>[0.00034363439042978165, 0.0004037014396835840...</td>
      <td>[[0.0, -0.1534650000000184, -3.154515000000026...</td>
    </tr>
    <tr>
      <th>25</th>
      <td>good</td>
      <td>0.037037</td>
      <td>34.82</td>
      <td>0.169565</td>
      <td>0.000434</td>
      <td>160.86</td>
      <td>296.549955</td>
      <td>-0.038703</td>
      <td>6</td>
      <td>-0.364719</td>
      <td>...</td>
      <td>27.533061</td>
      <td>2.390386</td>
      <td>0.137353</td>
      <td>5.801667</td>
      <td>0.000000</td>
      <td>1.316846</td>
      <td>7</td>
      <td>[2413.647573913121, 2464.689920666051, 3131.98...</td>
      <td>[0.0003001921893995495, 0.00030728132092582244...</td>
      <td>[[0.0, -0.6731399999999987, -0.014234999999998...</td>
    </tr>
    <tr>
      <th>26</th>
      <td>good</td>
      <td>0.958865</td>
      <td>54.69</td>
      <td>12.707811</td>
      <td>0.003463</td>
      <td>427.25</td>
      <td>529.920495</td>
      <td>0.079900</td>
      <td>6</td>
      <td>-0.251467</td>
      <td>...</td>
      <td>78.752644</td>
      <td>1.623686</td>
      <td>0.068677</td>
      <td>0.042095</td>
      <td>-1.000000</td>
      <td>0.788288</td>
      <td>8</td>
      <td>[4.623886992189737, 4.652320295861619, 4.65715...</td>
      <td>[0.0005655237299818749, 0.00048325383310849506...</td>
      <td>[[0.0, -0.5851949999999991, -1.558634999999999...</td>
    </tr>
    <tr>
      <th>27</th>
      <td>good</td>
      <td>-1.000000</td>
      <td>0.00</td>
      <td>0.013463</td>
      <td>0.000000</td>
      <td>0.00</td>
      <td>411.379091</td>
      <td>-1.000000</td>
      <td>9</td>
      <td>-0.402577</td>
      <td>...</td>
      <td>19.339511</td>
      <td>1.841203</td>
      <td>0.000000</td>
      <td>920.347869</td>
      <td>0.480737</td>
      <td>1.715636</td>
      <td>9</td>
      <td>[226.64832204429678, 258.8894884105053, 333.61...</td>
      <td>[0.0005135168039303701, 0.0003143571474595976,...</td>
      <td>[[0.0, 1.9419421487603223, -0.7767768595041264...</td>
    </tr>
  </tbody>
</table>
<p>10 rows × 29 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### use the electrodes table to devise a function which maps units to their brain regions</span>

<span class="c1"># select electrodes</span>
<span class="n">channel_probes</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">electrodes</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">electrodes</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">electrodes</span><span class="p">)):</span>
    <span class="n">channel_id</span> <span class="o">=</span> <span class="n">electrodes</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">electrodes</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="n">channel_probes</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">location</span>

<span class="c1"># function aligns location information from electrodes table with channel id from the units table</span>
<span class="k">def</span> <span class="nf">get_unit_location</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">channel_probes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">peak_channel_id</span><span class="p">)]</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">get_unit_location</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">units</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;POL&#39;, &#39;VISl2/3&#39;, &#39;VISpm2/3&#39;, &#39;DG-sg&#39;, &#39;VISrl6a&#39;, &#39;VISam2/3&#39;, &#39;VISal6a&#39;, &#39;VISpm4&#39;, &#39;VISp6b&#39;, &#39;VISp4&#39;, &#39;MGm&#39;, &#39;VISam5&#39;, &#39;VISal2/3&#39;, &#39;VISp5&#39;, &#39;VISal6b&#39;, &#39;DG-mo&#39;, &#39;VISpm1&#39;, &#39;MGv&#39;, &#39;DG-po&#39;, &#39;LP&#39;, &#39;PoT&#39;, &#39;MGd&#39;, &#39;VISal4&#39;, &#39;VISp2/3&#39;, &#39;VISam1&#39;, &#39;VISpm5&#39;, &#39;root&#39;, &#39;SGN&#39;, &#39;VISal5&#39;, &#39;VISam4&#39;, &#39;SUB&#39;, &#39;CA3&#39;, &#39;VISrl2/3&#39;, &#39;VISl6a&#39;, &#39;CA1&#39;, &#39;VISrl5&#39;, &#39;ProS&#39;, &#39;VISrl4&#39;, &#39;APN&#39;, &#39;VISpm6b&#39;, &#39;VISpm6a&#39;, &#39;VISp6a&#39;, &#39;VISl5&#39;, &#39;VISl4&#39;, &#39;VISam6a&#39;, &#39;MB&#39;}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### selecting units spike times</span>

<span class="n">brain_regions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;VISp6a&quot;</span><span class="p">,</span> <span class="s2">&quot;VISp5&quot;</span><span class="p">,</span> <span class="s2">&quot;VISp4&quot;</span><span class="p">,</span> <span class="s2">&quot;VISp6b&quot;</span><span class="p">,</span> <span class="s2">&quot;VISp2/3&quot;</span><span class="p">]</span>

<span class="c1"># select units based if they have &#39;good&#39; quality and exists in one of the specified brain_regions</span>
<span class="n">units_spike_times</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">brain_regions</span><span class="p">:</span>
    <span class="n">location_units_spike_times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">get_unit_location</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="n">location</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">quality</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;good&quot;</span><span class="p">:</span>
            <span class="n">location_units_spike_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">spike_times</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">units_spike_times</span> <span class="o">+=</span> <span class="n">location_units_spike_times</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>114
</pre></div>
</div>
</div>
</div>
</section>
<section id="session-timeline">
<h2>Session Timeline<a class="headerlink" href="#session-timeline" title="Link to this heading">#</a></h2>
<p>To get a good idea of the order and the way stimulus is shown throughout the session, the code below generates a timeline of the various ‘epochs’ of stimulus. It can be seen that each of the four IC image sets are shown, followed by receptive field and size templates. The final epoch is optogenetic stimulation, which is not visual stimulus but optogenetic laser stimulus. More on this in the <em>Optotagging</em> section later.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract epoch times from stim table where stimulus rows have a different &#39;block&#39; than following row</span>
<span class="c1"># returns list of epochs, where an epoch is of the form (stimulus name, stimulus block, start time, stop time)</span>
<span class="k">def</span> <span class="nf">extract_epochs</span><span class="p">(</span><span class="n">stim_name</span><span class="p">,</span> <span class="n">stim_table</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>
    
    <span class="c1"># specify a current epoch stop and start time</span>
    <span class="n">epoch_start</span> <span class="o">=</span> <span class="n">stim_table</span><span class="o">.</span><span class="n">start_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">epoch_stop</span> <span class="o">=</span> <span class="n">stim_table</span><span class="o">.</span><span class="n">stop_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># for each row, try to extend current epoch stop_time</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stim_table</span><span class="p">)):</span>
        <span class="n">this_block</span> <span class="o">=</span> <span class="n">stim_table</span><span class="o">.</span><span class="n">stimulus_block</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># if end of table, end the current epoch</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_table</span><span class="p">):</span>
            <span class="n">epochs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">stim_name</span><span class="p">,</span> <span class="n">this_block</span><span class="p">,</span> <span class="n">epoch_start</span><span class="p">,</span> <span class="n">epoch_stop</span><span class="p">))</span>
            <span class="k">break</span>
            
        <span class="n">next_block</span> <span class="o">=</span> <span class="n">stim_table</span><span class="o">.</span><span class="n">stimulus_block</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># if next row is the same stim block, push back epoch_stop time</span>
        <span class="k">if</span> <span class="n">next_block</span> <span class="o">==</span> <span class="n">this_block</span><span class="p">:</span>
            <span class="n">epoch_stop</span> <span class="o">=</span> <span class="n">stim_table</span><span class="o">.</span><span class="n">stop_time</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># otherwise, end the current epoch, start new epoch</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epochs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">stim_name</span><span class="p">,</span> <span class="n">this_block</span><span class="p">,</span> <span class="n">epoch_start</span><span class="p">,</span> <span class="n">epoch_stop</span><span class="p">))</span>
            <span class="n">epoch_start</span> <span class="o">=</span> <span class="n">stim_table</span><span class="o">.</span><span class="n">start_time</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">epoch_stop</span> <span class="o">=</span> <span class="n">stim_table</span><span class="o">.</span><span class="n">stop_time</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">epochs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract epochs from all valid stimulus tables</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">stim_name</span> <span class="ow">in</span> <span class="n">nwb</span><span class="o">.</span><span class="n">intervals</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">stim_table</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">intervals</span><span class="p">[</span><span class="n">stim_name</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">epochs</span> <span class="o">=</span> <span class="n">extract_epochs</span><span class="p">(</span><span class="n">stim_name</span><span class="p">,</span> <span class="n">stim_table</span><span class="p">,</span> <span class="n">epochs</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">continue</span>

<span class="c1"># manually add optotagging epoch since the table is stored separately</span>
<span class="n">opto_stim_table</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">processing</span><span class="p">[</span><span class="s2">&quot;optotagging&quot;</span><span class="p">][</span><span class="s2">&quot;optogenetic_stimulation&quot;</span><span class="p">]</span>
<span class="n">opto_epoch</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;optogenetic_stimulation&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">opto_stim_table</span><span class="o">.</span><span class="n">start_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opto_stim_table</span><span class="o">.</span><span class="n">stop_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">epochs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opto_epoch</span><span class="p">)</span>

<span class="c1"># epochs take the form (stimulus name, stimulus block, start time, stop time)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">epochs</span><span class="p">))</span>
<span class="n">epochs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7
(&#39;ICwcfg1_presentations&#39;, 0.0, 66.27082, 4357.8786)
(&#39;ICwcfg0_presentations&#39;, 1.0, 4670.14116, 5222.60555)
(&#39;ICkcfg1_presentations&#39;, 2.0, 5230.6123, 5783.0766)
(&#39;ICkcfg0_presentations&#39;, 3.0, 5791.08332, 6343.54758)
(&#39;RFCI_presentations&#39;, 4.0, 6351.60441, 6531.80575)
(&#39;sizeCI_presentations&#39;, 5.0, 6561.86442, 7283.08716)
(&#39;optogenetic_stimulation&#39;, 1.0, 7318.96099, 8931.55232)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_start</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="n">epoch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">]))</span>
<span class="n">time_end</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="nb">max</span><span class="p">([</span><span class="n">epoch</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">]))</span>
<span class="n">all_units_spike_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span><span class="p">)</span>

<span class="c1"># make histogram of unit spikes per second over specified timeframe</span>
<span class="n">time_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span><span class="p">,</span> <span class="p">(</span><span class="n">time_end</span><span class="o">-</span><span class="n">time_start</span><span class="p">))</span>
<span class="n">hist</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">all_units_spike_times</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">time_bin_edges</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>66 8932
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate plot of spike histogram with colored epoch intervals and legend</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="c1"># assign unique color to each stimulus name</span>
<span class="n">stim_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="n">epoch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">})</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">stim_names</span><span class="p">)))</span>
<span class="n">stim_color_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">stim_names</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stim_names</span><span class="p">))}</span>

<span class="n">epoch_key</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
<span class="c1"># draw colored rectangles for each epoch</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">:</span>
    <span class="n">stim_name</span><span class="p">,</span> <span class="n">stim_block</span><span class="p">,</span> <span class="n">epoch_start</span><span class="p">,</span> <span class="n">epoch_end</span> <span class="o">=</span> <span class="n">epoch</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">stim_color_map</span><span class="p">[</span><span class="n">stim_name</span><span class="p">]</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">epoch_start</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">epoch_end</span><span class="o">-</span><span class="n">epoch_start</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">))</span>
    <span class="n">epoch_key</span><span class="p">[</span><span class="n">stim_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rec</span>
    
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">height</span><span class="o">+</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time (s)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;# spikes&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;All Unit Spikes Per Second Throughout Epochs&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">epoch_key</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">epoch_key</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.12</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">hist</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x25e2dedff10&gt;]
</pre></div>
</div>
<img alt="../_images/ad7993ff5a2ad581de83a7e3fd11bb1f74f0e16d28e5227fb2d744ab4566c104.png" src="../_images/ad7993ff5a2ad581de83a7e3fd11bb1f74f0e16d28e5227fb2d744ab4566c104.png" />
</div>
</div>
</section>
<section id="extracting-stimulus-times">
<h2>Extracting Stimulus Times<a class="headerlink" href="#extracting-stimulus-times" title="Link to this heading">#</a></h2>
<p>For this notebook, the first set of Illusory Contour stimulus, <code class="docutils literal notranslate"><span class="pre">ICkcfg0_presentations</span></code> is chosen. Shown below is this set’s stimulus table. In order to compare neuronal responses during a frame with an illusory contour and a frame without, the stimulus times following frame 10 and frame 5 are chosen.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nwb</span><span class="o">.</span><span class="n">intervals</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;ICkcfg0_presentations&#39;, &#39;ICkcfg1_presentations&#39;, &#39;ICwcfg0_presentations&#39;, &#39;ICwcfg1_presentations&#39;, &#39;RFCI_presentations&#39;, &#39;invalid_times&#39;, &#39;sizeCI_presentations&#39;, &#39;spontaneous_presentations&#39;])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stim_table</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;ICkcfg0_presentations&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stim_table</span><span class="o">.</span><span class="n">colnames</span><span class="p">)</span>
<span class="n">stim_table</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;start_time&#39;, &#39;stop_time&#39;, &#39;stimulus_name&#39;, &#39;stimulus_block&#39;, &#39;frame&#39;, &#39;stimulus_index&#39;, &#39;tags&#39;, &#39;timeseries&#39;)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>start_time</th>
      <th>stop_time</th>
      <th>stimulus_name</th>
      <th>stimulus_block</th>
      <th>frame</th>
      <th>stimulus_index</th>
      <th>tags</th>
      <th>timeseries</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5791.08332</td>
      <td>5791.48365</td>
      <td>ICkcfg0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>[stimulus_time_interval]</td>
      <td>[(13484, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5791.48365</td>
      <td>5791.88399</td>
      <td>ICkcfg0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>[stimulus_time_interval]</td>
      <td>[(13485, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5791.88399</td>
      <td>5792.28432</td>
      <td>ICkcfg0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>[stimulus_time_interval]</td>
      <td>[(13486, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5792.28432</td>
      <td>5792.68466</td>
      <td>ICkcfg0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>[stimulus_time_interval]</td>
      <td>[(13487, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5792.68466</td>
      <td>5793.08500</td>
      <td>ICkcfg0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>[stimulus_time_interval]</td>
      <td>[(13488, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5793.08500</td>
      <td>5793.48536</td>
      <td>ICkcfg0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>[stimulus_time_interval]</td>
      <td>[(13489, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>6</th>
      <td>5793.48536</td>
      <td>5793.88565</td>
      <td>ICkcfg0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>[stimulus_time_interval]</td>
      <td>[(13490, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>7</th>
      <td>5793.88565</td>
      <td>5794.28601</td>
      <td>ICkcfg0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>[stimulus_time_interval]</td>
      <td>[(13491, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>5794.28601</td>
      <td>5794.68631</td>
      <td>ICkcfg0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>[stimulus_time_interval]</td>
      <td>[(13492, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>9</th>
      <td>5794.68631</td>
      <td>5795.08669</td>
      <td>ICkcfg0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>[stimulus_time_interval]</td>
      <td>[(13493, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">stim_table</span><span class="o">.</span><span class="n">frame</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0, 13.0, 14.0, 15.0, 16.0, 17.0, 18.0, 19.0, 20.0, 21.0}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">illusion_stim_select</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="mf">1.0</span>
<span class="n">illusion_stim_times</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">stim_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stim_table</span><span class="p">))</span> <span class="k">if</span> <span class="n">illusion_stim_select</span><span class="p">(</span><span class="n">stim_table</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">illusion_stim_times</span><span class="p">))</span>

<span class="n">control_stim_select</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span>
<span class="n">control_stim_times</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">stim_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stim_table</span><span class="p">))</span> <span class="k">if</span> <span class="n">control_stim_select</span><span class="p">(</span><span class="n">stim_table</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">control_stim_times</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>30
750
</pre></div>
</div>
</div>
</div>
</section>
<section id="generating-spike-matrix">
<h2>Generating Spike Matrix<a class="headerlink" href="#generating-spike-matrix" title="Link to this heading">#</a></h2>
<p>To analyze the responses to the stimuli chosen, a 3D spike matrix is generated for each array of stimulus times. The matrix has shape <code class="docutils literal notranslate"><span class="pre">n_units</span></code> * <code class="docutils literal notranslate"><span class="pre">n_trials</span></code> * <code class="docutils literal notranslate"><span class="pre">n_bins</span></code>, where <code class="docutils literal notranslate"><span class="pre">n_bins</span></code> is the number of time bins used to count spikes. The parameters <code class="docutils literal notranslate"><span class="pre">time_resolution</span></code>, <code class="docutils literal notranslate"><span class="pre">window_start_time</span></code>, and <code class="docutils literal notranslate"><span class="pre">window_end_time</span></code> below can be adjusted to alter the duration and the bin_size of the resulting matrix.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># bin size for counting spikes</span>
<span class="n">time_resolution</span> <span class="o">=</span> <span class="mf">0.005</span>

<span class="c1"># start and end times (relative to the stimulus at 0 seconds) that we want to examine and align spikes to</span>
<span class="n">window_start_time</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.25</span>
<span class="n">window_end_time</span> <span class="o">=</span> <span class="mf">0.5</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_spike_matrix</span><span class="p">(</span><span class="n">stim_times</span><span class="p">,</span> <span class="n">units_spike_times</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">):</span>
    <span class="n">time_resolution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">))</span>
    <span class="c1"># 3D spike matrix to be populated with spike counts</span>
    <span class="n">spike_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_times</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># populate 3D spike matrix for each unit for each stimulus trial by counting spikes into bins</span>
    <span class="k">for</span> <span class="n">unit_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">)):</span>
        <span class="n">spike_times</span> <span class="o">=</span> <span class="n">units_spike_times</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">stim_idx</span><span class="p">,</span> <span class="n">stim_time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stim_times</span><span class="p">):</span>
            <span class="c1"># get spike times that fall within the bin&#39;s time range relative to the stim time        </span>
            <span class="n">first_bin_time</span> <span class="o">=</span> <span class="n">stim_time</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">last_bin_time</span> <span class="o">=</span> <span class="n">stim_time</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">first_spike_in_range</span><span class="p">,</span> <span class="n">last_spike_in_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="p">[</span><span class="n">first_bin_time</span><span class="p">,</span> <span class="n">last_bin_time</span><span class="p">])</span>
            <span class="n">spike_times_in_range</span> <span class="o">=</span> <span class="n">spike_times</span><span class="p">[</span><span class="n">first_spike_in_range</span><span class="p">:</span><span class="n">last_spike_in_range</span><span class="p">]</span>

            <span class="c1"># convert spike times into relative time bin indices</span>
            <span class="n">bin_indices</span> <span class="o">=</span> <span class="p">((</span><span class="n">spike_times_in_range</span> <span class="o">-</span> <span class="p">(</span><span class="n">first_bin_time</span><span class="p">))</span> <span class="o">/</span> <span class="n">time_resolution</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            
            <span class="c1"># mark that there is a spike at these bin times for this unit on this stim trial</span>
            <span class="k">for</span> <span class="n">bin_idx</span> <span class="ow">in</span> <span class="n">bin_indices</span><span class="p">:</span>
                <span class="n">spike_matrix</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">,</span> <span class="n">stim_idx</span><span class="p">,</span> <span class="n">bin_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">spike_matrix</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># time bins used</span>
<span class="n">n_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">window_end_time</span> <span class="o">-</span> <span class="n">window_start_time</span><span class="p">)</span> <span class="o">/</span> <span class="n">time_resolution</span><span class="p">)</span>
<span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">window_start_time</span><span class="p">,</span> <span class="n">window_end_time</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># calculate baseline and stimulus interval indices for use later</span>
<span class="n">stimulus_onset_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">time_resolution</span><span class="p">)</span>

<span class="n">illusion_spike_matrix</span> <span class="o">=</span> <span class="n">get_spike_matrix</span><span class="p">(</span><span class="n">illusion_stim_times</span><span class="p">,</span> <span class="n">units_spike_times</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>
<span class="n">control_spike_matrix</span> <span class="o">=</span> <span class="n">get_spike_matrix</span><span class="p">(</span><span class="n">control_stim_times</span><span class="p">,</span> <span class="n">units_spike_times</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">illusion_spike_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">control_spike_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(114, 30, 149)
(114, 750, 149)
</pre></div>
</div>
</div>
</div>
</section>
<section id="showing-response-windows">
<h2>Showing Response Windows<a class="headerlink" href="#showing-response-windows" title="Link to this heading">#</a></h2>
<p>After generating spike matrices, we can view the PSTHs for each unit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">show_response</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">window_start_time</span><span class="p">,</span> <span class="n">window_end_time</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="p">[],</span> <span class="n">skipticks</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cbar_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Input data has length 0; Nothing to display&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">aspect</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">window_start_time</span><span class="p">,</span> <span class="n">window_end_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">window</span><span class="p">)],</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cbar</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">cbar_label</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">window</span><span class="p">)],</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yticklabels</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yticklabels</span><span class="p">)))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">yticklabels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

        <span class="n">n_ticks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">yticklabels</span><span class="p">[::</span><span class="n">skipticks</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">n_ticks</span><span class="p">))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">show_many_responses</span><span class="p">(</span><span class="n">windows</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">window_idxs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subplot_title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbar_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">window_idxs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">window_idxs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">))</span>
    <span class="n">windows</span> <span class="o">=</span> <span class="n">windows</span><span class="p">[</span><span class="n">window_idxs</span><span class="p">]</span>
    
    <span class="c1"># handle case with no input data</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Input data has length 0; Nothing to display&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c1"># handle cases when there aren&#39;t enough windows for number of rows</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">rows</span><span class="o">*</span><span class="n">cols</span><span class="p">:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">)</span> <span class="o">//</span> <span class="n">cols</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">cols</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">rows</span><span class="p">),</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;constrained&quot;</span><span class="p">)</span>
    <span class="c1"># handle case when there&#39;s only one row</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="o">*</span><span class="n">cols</span><span class="p">):</span>
        <span class="n">ax_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="n">cols</span><span class="p">)</span>
        <span class="n">ax_col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">cols</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ax_row</span><span class="p">][</span><span class="n">ax_col</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">window</span> <span class="o">=</span> <span class="n">windows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">show_response</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">window_start_time</span><span class="p">,</span> <span class="n">window_end_time</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subplot_title</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">window_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ax_row</span> <span class="o">!=</span> <span class="n">rows</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ax_col</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">colorbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mi">2</span><span class="o">/</span><span class="n">cols</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">cbar_label</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_many_responses</span><span class="p">(</span><span class="n">illusion_spike_matrix</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/563b334ebbc7a54aa9f131e3060868a57f6e2100e7c9792f414b9e1135d283b5.png" src="../_images/563b334ebbc7a54aa9f131e3060868a57f6e2100e7c9792f414b9e1135d283b5.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_many_responses</span><span class="p">(</span><span class="n">control_spike_matrix</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/dca91eed4e10b202c47cecfdbd56173b48ecee44c3b0c582e95f9e84ebbe917a.png" src="../_images/dca91eed4e10b202c47cecfdbd56173b48ecee44c3b0c582e95f9e84ebbe917a.png" />
</div>
</div>
</section>
<section id="selecting-responsive-cells">
<h2>Selecting Responsive Cells<a class="headerlink" href="#selecting-responsive-cells" title="Link to this heading">#</a></h2>
<p>As discussed in <a class="reference internal" href="../first-order/test_2p_responses.html"><span class="std std-doc">Statistically Testing 2P Responses to Stimulus</span></a>, the criteria used to select for responsive cells can have a significant impact. Here, the simple criterion is to select units whose post-stimulus z-scores are greater than 1 or less than -1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">select_cells</span><span class="p">(</span><span class="n">spike_matrix</span><span class="p">,</span> <span class="n">stimulus_onset_idx</span><span class="p">):</span>
    <span class="n">baseline_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spike_matrix</span><span class="p">[:,:,:</span><span class="n">stimulus_onset_idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">mean_baseline_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">baseline_means</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">std_baseline_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">baseline_means</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">response_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spike_matrix</span><span class="p">[:,:,</span><span class="n">stimulus_onset_idx</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">mean_response_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">response_means</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">unit_z_scores</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_response_means</span> <span class="o">-</span> <span class="n">mean_baseline_means</span><span class="p">)</span> <span class="o">/</span> <span class="n">std_baseline_means</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">unit_z_scores</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">unit_z_scores</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">illusion_selected_idxs</span> <span class="o">=</span> <span class="n">select_cells</span><span class="p">(</span><span class="n">illusion_spike_matrix</span><span class="p">,</span> <span class="n">stimulus_onset_idx</span><span class="p">)</span>
<span class="n">show_many_responses</span><span class="p">(</span><span class="n">illusion_spike_matrix</span><span class="p">[</span><span class="n">illusion_selected_idxs</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/85d9cf06d2f008b6eec22022dd4825f82a462fdf81c4733c495ae7b0dc647dc4.png" src="../_images/85d9cf06d2f008b6eec22022dd4825f82a462fdf81c4733c495ae7b0dc647dc4.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">control_selected_idxs</span> <span class="o">=</span> <span class="n">select_cells</span><span class="p">(</span><span class="n">control_spike_matrix</span><span class="p">,</span> <span class="n">stimulus_onset_idx</span><span class="p">)</span>
<span class="n">show_many_responses</span><span class="p">(</span><span class="n">control_spike_matrix</span><span class="p">[</span><span class="n">control_selected_idxs</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Input data has length 0; Nothing to display
</pre></div>
</div>
</div>
</div>
</section>
<section id="getting-receptive-fields">
<h2>Getting Receptive Fields<a class="headerlink" href="#getting-receptive-fields" title="Link to this heading">#</a></h2>
<p>Because the experiment includes the receptive field, stimulus, can use responses to generate receptive field images for each cell. Below, this is done for each selected cell from the illusion stimulus set and the control stimulus set. After obtaining the list of coordinates that each RF stim occupies, it’s shown on one of the templates below for clarity. After this, the receptive fields are generated using its spike times and the stim times for each coordinate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf_stim_table</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;RFCI_presentations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
<span class="n">rf_stim_table</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>start_time</th>
      <th>stop_time</th>
      <th>stimulus_name</th>
      <th>stimulus_block</th>
      <th>stimulus_index</th>
      <th>temporal_frequency</th>
      <th>Mask</th>
      <th>orientation</th>
      <th>x_position</th>
      <th>y_position</th>
      <th>color</th>
      <th>contrast</th>
      <th>opacity</th>
      <th>phase</th>
      <th>spatial_frequency</th>
      <th>size</th>
      <th>units</th>
      <th>tags</th>
      <th>timeseries</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6351.60441</td>
      <td>6351.85456</td>
      <td>RFCI</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>//allen/programs/mindscope/workgroups/openscop...</td>
      <td>0.0</td>
      <td>-143.810387</td>
      <td>143.810387</td>
      <td>[1.0, 1.0, 1.0]</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>[12919.96666667, 12919.96666667]</td>
      <td>[0.00314683, 0.00314683]</td>
      <td>[2560.0, 2560.0]</td>
      <td>pix</td>
      <td>[stimulus_time_interval]</td>
      <td>[(14865, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>6351.85456</td>
      <td>6352.10475</td>
      <td>RFCI</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>//allen/programs/mindscope/workgroups/openscop...</td>
      <td>45.0</td>
      <td>-143.810387</td>
      <td>143.810387</td>
      <td>[1.0, 1.0, 1.0]</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>[12919.96666667, 12919.96666667]</td>
      <td>[0.00314683, 0.00314683]</td>
      <td>[2560.0, 2560.0]</td>
      <td>pix</td>
      <td>[stimulus_time_interval]</td>
      <td>[(14866, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>6352.10475</td>
      <td>6352.35496</td>
      <td>RFCI</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>//allen/programs/mindscope/workgroups/openscop...</td>
      <td>90.0</td>
      <td>-143.810387</td>
      <td>143.810387</td>
      <td>[1.0, 1.0, 1.0]</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>[12919.96666667, 12919.96666667]</td>
      <td>[0.00314683, 0.00314683]</td>
      <td>[2560.0, 2560.0]</td>
      <td>pix</td>
      <td>[stimulus_time_interval]</td>
      <td>[(14867, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>6352.35496</td>
      <td>6352.60520</td>
      <td>RFCI</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>//allen/programs/mindscope/workgroups/openscop...</td>
      <td>135.0</td>
      <td>-143.810387</td>
      <td>143.810387</td>
      <td>[1.0, 1.0, 1.0]</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>[12919.96666667, 12919.96666667]</td>
      <td>[0.00314683, 0.00314683]</td>
      <td>[2560.0, 2560.0]</td>
      <td>pix</td>
      <td>[stimulus_time_interval]</td>
      <td>[(14868, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>6352.60520</td>
      <td>6352.85541</td>
      <td>RFCI</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>//allen/programs/mindscope/workgroups/openscop...</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>203.378600</td>
      <td>[1.0, 1.0, 1.0]</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>[12919.96666667, 12919.96666667]</td>
      <td>[0.00314683, 0.00314683]</td>
      <td>[2560.0, 2560.0]</td>
      <td>pix</td>
      <td>[stimulus_time_interval]</td>
      <td>[(14869, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>6352.85541</td>
      <td>6353.10562</td>
      <td>RFCI</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>//allen/programs/mindscope/workgroups/openscop...</td>
      <td>45.0</td>
      <td>0.000000</td>
      <td>203.378600</td>
      <td>[1.0, 1.0, 1.0]</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>[12919.96666667, 12919.96666667]</td>
      <td>[0.00314683, 0.00314683]</td>
      <td>[2560.0, 2560.0]</td>
      <td>pix</td>
      <td>[stimulus_time_interval]</td>
      <td>[(14870, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>6</th>
      <td>6353.10562</td>
      <td>6353.35584</td>
      <td>RFCI</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>//allen/programs/mindscope/workgroups/openscop...</td>
      <td>90.0</td>
      <td>0.000000</td>
      <td>203.378600</td>
      <td>[1.0, 1.0, 1.0]</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>[12919.96666667, 12919.96666667]</td>
      <td>[0.00314683, 0.00314683]</td>
      <td>[2560.0, 2560.0]</td>
      <td>pix</td>
      <td>[stimulus_time_interval]</td>
      <td>[(14871, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>7</th>
      <td>6353.35584</td>
      <td>6353.62276</td>
      <td>RFCI</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>//allen/programs/mindscope/workgroups/openscop...</td>
      <td>135.0</td>
      <td>0.000000</td>
      <td>203.378600</td>
      <td>[1.0, 1.0, 1.0]</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>[12919.96666667, 12919.96666667]</td>
      <td>[0.00314683, 0.00314683]</td>
      <td>[2560.0, 2560.0]</td>
      <td>pix</td>
      <td>[stimulus_time_interval]</td>
      <td>[(14872, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>6353.62276</td>
      <td>6353.87291</td>
      <td>RFCI</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>//allen/programs/mindscope/workgroups/openscop...</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>203.378600</td>
      <td>[1.0, 1.0, 1.0]</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>[12919.96666667, 12919.96666667]</td>
      <td>[0.00314683, 0.00314683]</td>
      <td>[2560.0, 2560.0]</td>
      <td>pix</td>
      <td>[stimulus_time_interval]</td>
      <td>[(14873, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
    <tr>
      <th>9</th>
      <td>6353.87291</td>
      <td>6354.12316</td>
      <td>RFCI</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>//allen/programs/mindscope/workgroups/openscop...</td>
      <td>45.0</td>
      <td>0.000000</td>
      <td>203.378600</td>
      <td>[1.0, 1.0, 1.0]</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>[12919.96666667, 12919.96666667]</td>
      <td>[0.00314683, 0.00314683]</td>
      <td>[2560.0, 2560.0]</td>
      <td>pix</td>
      <td>[stimulus_time_interval]</td>
      <td>[(14874, 1, timestamps pynwb.base.TimeSeries a...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">template</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">stimulus_template</span><span class="p">[</span><span class="s2">&quot;ICkcfg0_presentations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="s2">&quot;ICkcfg0_presentations1&quot;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="o">-</span><span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">template</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span> <span class="p">])</span>

<span class="n">xcoords</span><span class="p">,</span> <span class="n">ycoords</span> <span class="o">=</span> <span class="n">rf_stim_table</span><span class="o">.</span><span class="n">x_position</span><span class="p">,</span> <span class="n">rf_stim_table</span><span class="o">.</span><span class="n">y_position</span>
<span class="n">xy_pairs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">xcoords</span><span class="p">,</span> <span class="n">ycoords</span><span class="p">))</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">xy_pairs</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Location of receptive field gratings on Screen&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Location of receptive field gratings on Screen&#39;)
</pre></div>
</div>
<img alt="../_images/d70b36f30573165d893a562ee960f423a795fa9c4caf04234d374e135047b07f.png" src="../_images/d70b36f30573165d893a562ee960f423a795fa9c4caf04234d374e135047b07f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### get x and y coordinates of gabors displayed to build receptive field</span>

<span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">rf_stim_table</span><span class="o">.</span><span class="n">x_position</span><span class="p">)))</span>
<span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">rf_stim_table</span><span class="o">.</span><span class="n">y_position</span><span class="p">)))</span>
<span class="n">field_units</span> <span class="o">=</span> <span class="n">rf_stim_table</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">field_units</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-203.3786     -143.81038721    0.          143.81038721  203.3786    ]
[-203.3786     -143.81038721    0.          143.81038721  203.3786    ]
pix
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### get receptive field of a unit using its spike times and the stim table</span>

<span class="k">def</span> <span class="nf">get_rf</span><span class="p">(</span><span class="n">spike_times</span><span class="p">):</span>
    <span class="c1"># creates 2D array that stores response spike counts for each coordinate of the receptive field</span>
    <span class="n">unit_rf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ys</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">xs</span><span class="o">.</span><span class="n">size</span><span class="p">])</span>
    <span class="c1"># for every x and y coordinate in the field</span>
    <span class="k">for</span> <span class="n">xi</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">yi</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ys</span><span class="p">):</span>
            
            <span class="c1"># for this coordinate of the rf, count all the times that this neuron responds to a stimulus time with a spike</span>
            <span class="n">stim_times</span> <span class="o">=</span> <span class="n">rf_stim_table</span><span class="p">[(</span><span class="n">rf_stim_table</span><span class="o">.</span><span class="n">x_position</span> <span class="o">==</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rf_stim_table</span><span class="o">.</span><span class="n">y_position</span> <span class="o">==</span> <span class="n">y</span><span class="p">)]</span><span class="o">.</span><span class="n">start_time</span>
            <span class="n">response_spike_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">stim_time</span> <span class="ow">in</span> <span class="n">stim_times</span><span class="p">:</span>
                <span class="c1"># any spike within 0.2 seconds after stim time is considered a response</span>
                <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="p">[</span><span class="n">stim_time</span><span class="p">,</span> <span class="n">stim_time</span><span class="o">+</span><span class="mf">0.2</span><span class="p">])</span>
                <span class="n">response_spike_count</span> <span class="o">+=</span> <span class="n">end_idx</span><span class="o">-</span><span class="n">start_idx</span>

            <span class="n">unit_rf</span><span class="p">[</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">]</span> <span class="o">=</span> <span class="n">response_spike_count</span>
    
    <span class="k">return</span> <span class="n">unit_rf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### compute receptive fields for each unit in selected units</span>

<span class="n">illusion_rfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">illusion_selected_idxs</span><span class="p">:</span>
    <span class="n">these_spike_times</span> <span class="o">=</span> <span class="n">units_spike_times</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">illusion_rfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_rf</span><span class="p">(</span><span class="n">these_spike_times</span><span class="p">))</span>

<span class="n">control_rfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">control_selected_idxs</span><span class="p">:</span>
    <span class="n">these_spike_times</span> <span class="o">=</span> <span class="n">units_spike_times</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">control_rfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_rf</span><span class="p">(</span><span class="n">these_spike_times</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### display the receptive fields for each unit in a 2D plot</span>

<span class="k">def</span> <span class="nf">display_rfs</span><span class="p">(</span><span class="n">rfs</span><span class="p">,</span> <span class="n">n_cols</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rfs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No receptive fields provided. Nothing to display&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rfs</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_cols</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">n_rows</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># handle case where there&#39;s &lt;= n_cols rfs</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">irf</span><span class="p">,</span> <span class="n">rf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rfs</span><span class="p">):</span>
        <span class="n">ax_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">irf</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax_col</span> <span class="o">=</span> <span class="n">irf</span><span class="o">%</span><span class="k">10</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">ax_row</span><span class="p">][</span><span class="n">ax_col</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="c1"># making axis labels for first receptive field</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">field_units</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">field_units</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span> 
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)),</span> <span class="n">xs</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">)),</span> <span class="n">ys</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">())</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">())</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_rfs</span><span class="p">(</span><span class="n">illusion_rfs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d6b4b6e167ac76fca98b27fc3d2227953fad95e588b27db2dc00849db8ae7c09.png" src="../_images/d6b4b6e167ac76fca98b27fc3d2227953fad95e588b27db2dc00849db8ae7c09.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_rfs</span><span class="p">(</span><span class="n">control_rfs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No receptive fields provided. Nothing to display
</pre></div>
</div>
</div>
</div>
</section>
<section id="optotagging">
<h2>Optotagging<a class="headerlink" href="#optotagging" title="Link to this heading">#</a></h2>
<p>As mentioned earlier, the final epoch of the sessions is optotagging. The principles behind the optotagging are discussed in the <a class="reference internal" href="../first-order/optotagging.html"><span class="std std-doc">Identifying Optotagged Units</span></a> notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">opto_stim_table</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">processing</span><span class="p">[</span><span class="s2">&quot;optotagging&quot;</span><span class="p">][</span><span class="s2">&quot;optogenetic_stimulation&quot;</span><span class="p">]</span>
<span class="n">opto_stim_table</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>start_time</th>
      <th>condition</th>
      <th>level</th>
      <th>stop_time</th>
      <th>stimulus_name</th>
      <th>duration</th>
      <th>tags</th>
      <th>timeseries</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>7318.96099</td>
      <td>cosine pulse</td>
      <td>1.4</td>
      <td>7319.96099</td>
      <td>cosine_1s</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(0, 1, optotagging pynwb.ogen.OptogeneticSeri...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>7321.17076</td>
      <td>2 ms pulse at 1 Hz</td>
      <td>1.4</td>
      <td>7321.17276</td>
      <td>1Hz_2ms</td>
      <td>0.002</td>
      <td>[optical_stimulation]</td>
      <td>[(1, 1, optotagging pynwb.ogen.OptogeneticSeri...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>7323.65220</td>
      <td>2 ms pulses at 20 Hz</td>
      <td>1.4</td>
      <td>7324.65220</td>
      <td>20Hz_2ms</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(2, 1, optotagging pynwb.ogen.OptogeneticSeri...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>7326.82191</td>
      <td>2 ms pulses at 60 Hz</td>
      <td>1.4</td>
      <td>7327.82191</td>
      <td>60Hz_2ms</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(3, 1, optotagging pynwb.ogen.OptogeneticSeri...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>7329.87304</td>
      <td>2 ms pulses at 20 Hz</td>
      <td>1.4</td>
      <td>7330.87304</td>
      <td>20Hz_2ms</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(4, 1, optotagging pynwb.ogen.OptogeneticSeri...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>7332.11283</td>
      <td>10 ms pulse at 1 Hz</td>
      <td>1.4</td>
      <td>7332.12283</td>
      <td>1Hz_10ms</td>
      <td>0.010</td>
      <td>[optical_stimulation]</td>
      <td>[(5, 1, optotagging pynwb.ogen.OptogeneticSeri...</td>
    </tr>
    <tr>
      <th>6</th>
      <td>7334.31469</td>
      <td>2 ms pulses at 20 Hz</td>
      <td>1.4</td>
      <td>7335.31469</td>
      <td>20Hz_2ms</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(6, 1, optotagging pynwb.ogen.OptogeneticSeri...</td>
    </tr>
    <tr>
      <th>7</th>
      <td>7336.87440</td>
      <td>2 ms pulses at 60 Hz</td>
      <td>1.4</td>
      <td>7337.87440</td>
      <td>60Hz_2ms</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(7, 1, optotagging pynwb.ogen.OptogeneticSeri...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>7339.38551</td>
      <td>1 second square pulse: continuously on for 1s</td>
      <td>1.4</td>
      <td>7340.38551</td>
      <td>square_1s</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(8, 1, optotagging pynwb.ogen.OptogeneticSeri...</td>
    </tr>
    <tr>
      <th>9</th>
      <td>7342.08362</td>
      <td>2 ms pulses at 20 Hz</td>
      <td>1.4</td>
      <td>7343.08362</td>
      <td>20Hz_2ms</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(9, 1, optotagging pynwb.ogen.OptogeneticSeri...</td>
    </tr>
    <tr>
      <th>10</th>
      <td>7344.86520</td>
      <td>2 ms pulses at 40 Hz</td>
      <td>1.4</td>
      <td>7345.86520</td>
      <td>40Hz_2ms</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(10, 1, optotagging pynwb.ogen.OptogeneticSer...</td>
    </tr>
    <tr>
      <th>11</th>
      <td>7347.25499</td>
      <td>2 ms pulses at 10 Hz'</td>
      <td>1.4</td>
      <td>7348.25499</td>
      <td>10Hz_2ms</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(11, 1, optotagging pynwb.ogen.OptogeneticSer...</td>
    </tr>
    <tr>
      <th>12</th>
      <td>7349.46547</td>
      <td>cosine pulse</td>
      <td>1.4</td>
      <td>7350.46547</td>
      <td>cosine_1s</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(12, 1, optotagging pynwb.ogen.OptogeneticSer...</td>
    </tr>
    <tr>
      <th>13</th>
      <td>7351.73567</td>
      <td>2 ms pulse at 1 Hz</td>
      <td>1.4</td>
      <td>7351.73767</td>
      <td>1Hz_2ms</td>
      <td>0.002</td>
      <td>[optical_stimulation]</td>
      <td>[(13, 1, optotagging pynwb.ogen.OptogeneticSer...</td>
    </tr>
    <tr>
      <th>14</th>
      <td>7354.80738</td>
      <td>2 ms pulses at 20 Hz</td>
      <td>1.4</td>
      <td>7355.80738</td>
      <td>20Hz_2ms</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(14, 1, optotagging pynwb.ogen.OptogeneticSer...</td>
    </tr>
    <tr>
      <th>15</th>
      <td>7357.04720</td>
      <td>1 second square pulse: continuously on for 1s</td>
      <td>1.4</td>
      <td>7358.04720</td>
      <td>square_1s</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(15, 1, optotagging pynwb.ogen.OptogeneticSer...</td>
    </tr>
    <tr>
      <th>16</th>
      <td>7359.49828</td>
      <td>2 ms pulses at 60 Hz</td>
      <td>1.4</td>
      <td>7360.49828</td>
      <td>60Hz_2ms</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(16, 1, optotagging pynwb.ogen.OptogeneticSer...</td>
    </tr>
    <tr>
      <th>17</th>
      <td>7361.73832</td>
      <td>2 ms pulses at 40 Hz</td>
      <td>1.4</td>
      <td>7362.73832</td>
      <td>40Hz_2ms</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(17, 1, optotagging pynwb.ogen.OptogeneticSer...</td>
    </tr>
    <tr>
      <th>18</th>
      <td>7364.08007</td>
      <td>2 ms pulses at 80 Hz</td>
      <td>1.4</td>
      <td>7365.08007</td>
      <td>80Hz_2ms</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(18, 1, optotagging pynwb.ogen.OptogeneticSer...</td>
    </tr>
    <tr>
      <th>19</th>
      <td>7366.48982</td>
      <td>2 ms pulses at 50 Hz</td>
      <td>1.4</td>
      <td>7367.48982</td>
      <td>50Hz_2ms</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(19, 1, optotagging pynwb.ogen.OptogeneticSer...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">opto_stim_times</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">opto_stim_table</span> <span class="k">if</span> <span class="n">isclose</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mf">1.0</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of stim times:&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">opto_stim_times</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of units:&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of stim times: 500
Number of units: 114
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># bin size for counting spikes</span>
<span class="n">time_resolution</span> <span class="o">=</span> <span class="mf">0.005</span>

<span class="c1"># start and end times (relative to the stimulus at 0 seconds) that we want to examine and align spikes to</span>
<span class="n">window_start_time</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.25</span>
<span class="n">window_end_time</span> <span class="o">=</span> <span class="mf">0.5</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># time bins used</span>
<span class="n">n_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">window_end_time</span> <span class="o">-</span> <span class="n">window_start_time</span><span class="p">)</span> <span class="o">/</span> <span class="n">time_resolution</span><span class="p">)</span>
<span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">window_start_time</span><span class="p">,</span> <span class="n">window_end_time</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># calculate baseline and stimulus interval indices for use later</span>
<span class="n">stimulus_onset_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">time_resolution</span><span class="p">)</span>

<span class="n">opto_spike_matrix</span> <span class="o">=</span> <span class="n">get_spike_matrix</span><span class="p">(</span><span class="n">opto_stim_times</span><span class="p">,</span> <span class="n">units_spike_times</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">opto_spike_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(114, 500, 149)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_many_responses</span><span class="p">(</span><span class="n">opto_spike_matrix</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f30b85b7ae7491105c7172fc95c71f106beb9372f1670994188c3e30ed912bee.png" src="../_images/f30b85b7ae7491105c7172fc95c71f106beb9372f1670994188c3e30ed912bee.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">opto_selected_idxs</span> <span class="o">=</span> <span class="n">select_cells</span><span class="p">(</span><span class="n">opto_spike_matrix</span><span class="p">,</span> <span class="n">stimulus_onset_idx</span><span class="p">)</span>
<span class="n">show_many_responses</span><span class="p">(</span><span class="n">opto_spike_matrix</span><span class="p">[</span><span class="n">opto_selected_idxs</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f9abc4cfe94b8ed07aa7d466e4db1ccd47b2ddc3a492b09449abc5d223f6b2b8.png" src="../_images/f9abc4cfe94b8ed07aa7d466e4db1ccd47b2ddc3a492b09449abc5d223f6b2b8.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">opto_rfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">opto_selected_idxs</span><span class="p">:</span>
    <span class="n">these_spike_times</span> <span class="o">=</span> <span class="n">units_spike_times</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">opto_rfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_rf</span><span class="p">(</span><span class="n">these_spike_times</span><span class="p">))</span>

<span class="n">display_rfs</span><span class="p">(</span><span class="n">opto_rfs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2e88c7fd49433ccee2b62544673d14799e8e05da0aa9112b3520e1eb3ca98240.png" src="../_images/2e88c7fd49433ccee2b62544673d14799e8e05da0aa9112b3520e1eb3ca98240.png" />
</div>
</div>
</section>
<section id="openscope-illusion-publication-example-analysis-code">
<h2>OpenScope Illusion publication: Example Analysis Code<a class="headerlink" href="#openscope-illusion-publication-example-analysis-code" title="Link to this heading">#</a></h2>
<p>The following code replicates some of the analysis created for the publication that accompanies OpenScope’s Illusion project, <a class="reference external" href="https://www.biorxiv.org/content/10.1101/2023.06.05.543698v1"><span id="id2">[<a class="reference internal" href="../bibliography.html#id21" title="Hyeyoung Shin, Mora B. Ogando, Lamiae Abdeladim, Severine Durand, Hannah Belski, Hannah Cabasco, Henry Loefler, Ahad Bawany, Ben Hardcastle, Josh Wilkes, Katrina Nguyen, Lucas Suarez, Tye Johnson, Warren Han, Ben Ouellette, Conor Grasso, Jackie Swapp, Vivian Ha, Ahrial Young, Shiella Caldejon, Ali Williford, Peter Groblewski, Shawn Olsen, Carly Kiselycznyk, Jerome Lecoq, and Hillel Adesnik. Recurrent pattern completion drives the neocortical representation of sensory inference. bioRxiv, ():, 2023. URL: https://doi.org/10.1101/2023.06.05.543698.">Shin <em>et al.</em>, 2023</a>]</span></a>, this includes a more robust calculation of the receptive fields for units along with several other metrics.</p>
<p>Here, we are reproducing Fig 1d-g, where we show that mouse primary visual cortex (V1) neurons respond to illusory contours despite the lack of visual information within their receptive fields. Von der Heydt and colleagues had showed the existence of illusory contours in primate visual cortex <span id="id3">[<a class="reference internal" href="../bibliography.html#id22" title="Rudiger von der Heydt, E. Peterhans, and Gunter Baumgartner. Illusory contours and cortical neuron responses. Science, ():, 1984. URL: https://doi.org/10.1126/science.6539501.">von der Heydt <em>et al.</em>, 1984</a>]</span>, <span id="id4">[]</span>. We are replicating their result in mouse V1.</p>
<p>It is important to note that originally we imposed a fixed-gaze restriction; i.e., we only analyzed the trials where the pupil position was within 8 visual degrees of the resting pupil position throughout the duration of the trial. For simplicity, we did not include this condition in this example code.</p>
<p>An example session was selected, thus figures may look different from the paper (Shin et al., 2023 bioRxiv).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># uncomment desired files (more will cause a lot of memory consumption)</span>
<span class="n">nwb_paths</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># &quot;sub-619293/sub-619293_ses-1184980079_ogen.nwb&quot;,</span>
    <span class="c1"># &quot;sub-620333/sub-620333_ses-1188137866_ogen.nwb&quot;,</span>
    <span class="c1"># &quot;sub-620334/sub-620334_ses-1189887297_ogen.nwb&quot;,</span>
    <span class="c1"># &quot;sub-625545/sub-625545_ses-1182865981_ogen.nwb&quot;,</span>
    <span class="c1"># &quot;sub-625554/sub-625554_ses-1181330601_ogen.nwb&quot;,</span>
    <span class="c1"># &quot;sub-619296/sub-619296_ses-1187930705_ogen.nwb&quot;,</span>
    <span class="c1"># &quot;sub-625555/sub-625555_ses-1183070926_ogen.nwb&quot;,</span>
    <span class="c1"># &quot;sub-630506/sub-630506_ses-1192952695_ogen.nwb&quot;,</span>
    <span class="c1"># &quot;sub-631510/sub-631510_ses-1196157974_ogen.nwb&quot;,</span>
    <span class="c1"># &quot;sub-631570/sub-631570_ses-1194857009_ogen.nwb&quot;,</span>
    <span class="s2">&quot;sub-633229/sub-633229_ses-1199247593_ogen.nwb&quot;</span><span class="p">,</span>
    <span class="c1"># &quot;sub-637484/sub-637484_ses-1208667752_ogen.nwb&quot;</span>
    <span class="p">]</span>

<span class="n">nwb_ios</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">dandi_filepath</span> <span class="ow">in</span> <span class="n">nwb_paths</span><span class="p">:</span>
    <span class="c1"># This can sometimes take a while depending on the size of the file</span>
    <span class="n">nwb_ios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dandi_download_open</span><span class="p">(</span><span class="n">dandiset_id</span><span class="p">,</span> <span class="n">dandi_filepath</span><span class="p">,</span> <span class="n">download_loc</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PATH                               SIZE   DONE            DONE% CHECKSUM STATUS          MESSAGE
sub-633229_ses-1199247593_ogen.nwb 3.3 GB 3.3 GB           100%    ok    done                   
Summary:                           3.3 GB 3.3 GB                         1 done                 
                                          100.00%                                               
Downloaded file to ./sub-633229_ses-1199247593_ogen.nwb
Opening file
</pre></div>
</div>
</div>
</div>
<section id="fig-1e-identifying-exclusively-center-responsive-v1-neurons">
<h3>Fig. 1e : identifying exclusively center-responsive V1 neurons<a class="headerlink" href="#fig-1e-identifying-exclusively-center-responsive-v1-neurons" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">analyzeRFCI</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">trialorder</span><span class="p">,</span> <span class="n">sponFR</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; This function defines the receptive fields (RF) of each neuron.</span>
<span class="sd">    Args:</span>
<span class="sd">        R (np.ndarray): Firing rate matrix of shape (Nneurons, Ntrials).</span>
<span class="sd">        trialorder (np.ndarray): Trial type of each trial.</span>
<span class="sd">        trial type description: 10000s: classic 0 vs inverse 1, 1000s: which ctrsizes, 10-100s: which RFcenter, 1s: which direction.</span>
<span class="sd">        sponFR (np.ndarray): Spontaneous firing rate of each neuron.</span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing the following keys:</span>
<span class="sd">            Rrfclassic (np.ndarray): Firing rate of each neuron for each classic RF.</span>
<span class="sd">            Rrfinverse (np.ndarray): Firing rate of each neuron for each inverse RF.</span>
<span class="sd">            RFindclassic (np.ndarray): Index of the RF with the highest firing rate for each neuron in the classic condition.</span>
<span class="sd">            RFindinverse (np.ndarray): Index of the RF with the highest firing rate for each neuron in the inverse condition.</span>
<span class="sd">            Pkw_rfclassic (np.ndarray): Kruskal-Wallis p-value for each neuron in the classic condition.</span>
<span class="sd">            Pkw_rfinverse (np.ndarray): Kruskal-Wallis p-value for each neuron in the inverse condition.</span>
<span class="sd">            sigmc_rfclassic (np.ndarray): Whether the max firing rate is significantly different from the others in the classic condition.</span>
<span class="sd">            sigmc_rfinverse (np.ndarray): Whether the max firing rate is significantly different from the others in the inverse condition.</span>
<span class="sd">            pRrfclassic (np.ndarray): Wilcoxon p-value for each neuron in the classic condition.</span>
<span class="sd">            pRrfinverse (np.ndarray): Wilcoxon p-value for each neuron in the inverse condition.</span>
<span class="sd">            pRFclassic (np.ndarray): Wilcoxon p-value for the max firing rate in the classic condition.</span>
<span class="sd">            pRFinverse (np.ndarray): Wilcoxon p-value for the max firing rate in the inverse condition.</span>
<span class="sd">            RFsigexclclassic (np.ndarray): Whether the max firing rate is significantly different from the others in the classic condition.</span>
<span class="sd">            RFsigexclinverse (np.ndarray): Whether the max firing rate is significantly different from the others in the inverse condition.</span>
<span class="sd">            RFexclsigclassic (np.ndarray): Whether the max firing rate is significantly different from the others in the classic condition.</span>
<span class="sd">            RFexclsiginverse (np.ndarray): Whether the max firing rate is significantly different from the others in the inverse condition.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">sponFR</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;check sponFR&#39;</span><span class="p">)</span>

    <span class="n">Nneurons</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Nrfs</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">Rrfclassic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nneurons</span><span class="p">,</span> <span class="n">Nrfs</span><span class="p">))</span>
    <span class="n">Rrfinverse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nneurons</span><span class="p">,</span> <span class="n">Nrfs</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">rfi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nrfs</span><span class="p">):</span>
        <span class="n">crftrials</span> <span class="o">=</span> <span class="p">(</span><span class="n">trialorder</span> <span class="o">//</span> <span class="mi">10000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">trialorder</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">==</span> <span class="n">rfi</span><span class="p">)</span>
        <span class="n">Rrfclassic</span><span class="p">[:,</span> <span class="n">rfi</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R</span><span class="p">[:,</span> <span class="n">crftrials</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">irftrials</span> <span class="o">=</span> <span class="p">(</span><span class="n">trialorder</span> <span class="o">//</span> <span class="mi">10000</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">trialorder</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">==</span> <span class="n">rfi</span><span class="p">)</span>
        <span class="n">Rrfinverse</span><span class="p">[:,</span> <span class="n">rfi</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R</span><span class="p">[:,</span> <span class="n">irftrials</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="n">RFindclassic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">Rrfclassic</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">RFindinverse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">Rrfinverse</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">Pkw_rfclassic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nneurons</span><span class="p">)</span>
    <span class="n">Pkw_rfinverse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nneurons</span><span class="p">)</span>
    <span class="n">sigmc_rfclassic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nneurons</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">sigmc_rfinverse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nneurons</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nneurons</span><span class="p">):</span>
        <span class="c1"># Classic</span>
        <span class="n">crftrials</span> <span class="o">=</span> <span class="p">(</span><span class="n">trialorder</span> <span class="o">//</span> <span class="mi">10000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">unique_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">trialorder</span><span class="p">[</span><span class="n">crftrials</span><span class="p">])</span>
        <span class="n">group_labels</span> <span class="o">=</span> <span class="n">trialorder</span><span class="p">[</span><span class="n">crftrials</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="n">ci</span><span class="p">,</span> <span class="n">crftrials</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">kruskal</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">group_labels</span> <span class="o">==</span> <span class="n">val</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">unique_groups</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">Pkw_rfclassic</span><span class="p">[</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">Pkw_rfclassic</span><span class="p">[</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="c1"># Perform Tukey HSD if the p-value from Kruskal-Wallis is significant</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">tukey_results</span> <span class="o">=</span> <span class="n">pairwise_tukeyhsd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">group_labels</span><span class="p">)</span>
            <span class="c1"># Find rows in the Tukey results related to the max firing rate index</span>
            <span class="k">for</span> <span class="n">comparison</span> <span class="ow">in</span> <span class="n">tukey_results</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># Skip the header row</span>
                <span class="k">if</span> <span class="n">RFindclassic</span><span class="p">[</span><span class="n">ci</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">comparison</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>  <span class="c1"># +1 since Python uses 0-indexing</span>
                    <span class="n">sigmc_rfclassic</span><span class="p">[</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span>
                    <span class="k">break</span>

        <span class="c1"># Inverse</span>
        <span class="n">irftrials</span> <span class="o">=</span> <span class="p">(</span><span class="n">trialorder</span> <span class="o">//</span> <span class="mi">10000</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">unique_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">trialorder</span><span class="p">[</span><span class="n">irftrials</span><span class="p">])</span>
        <span class="n">group_labels</span> <span class="o">=</span> <span class="n">trialorder</span><span class="p">[</span><span class="n">irftrials</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="n">ci</span><span class="p">,</span> <span class="n">irftrials</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">kruskal</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">group_labels</span> <span class="o">==</span> <span class="n">val</span><span class="p">]</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">unique_groups</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">Pkw_rfinverse</span><span class="p">[</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">Pkw_rfinverse</span><span class="p">[</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Perform Tukey HSD if the p-value from Kruskal-Wallis is significant</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">tukey_results</span> <span class="o">=</span> <span class="n">pairwise_tukeyhsd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">group_labels</span><span class="p">)</span>
            <span class="c1"># Find rows in the Tukey results related to the max firing rate index</span>
            <span class="k">for</span> <span class="n">comparison</span> <span class="ow">in</span> <span class="n">tukey_results</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="n">RFindinverse</span><span class="p">[</span><span class="n">ci</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">comparison</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>  <span class="c1"># +1 since Python uses 0-indexing</span>
                    <span class="n">sigmc_rfinverse</span><span class="p">[</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span>
                    <span class="k">break</span>

    <span class="n">pRrfclassic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">Nneurons</span><span class="p">,</span> <span class="n">Nrfs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">rfi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nrfs</span><span class="p">):</span>
        <span class="n">crftrials</span> <span class="o">=</span> <span class="p">(</span><span class="n">trialorder</span> <span class="o">//</span> <span class="mi">10000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">trialorder</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">==</span> <span class="n">rfi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">crftrials</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nneurons</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pRrfclassic</span><span class="p">[</span><span class="n">ci</span><span class="p">,</span> <span class="n">rfi</span><span class="p">]</span> <span class="o">=</span> <span class="n">wilcoxon</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">ci</span><span class="p">,</span> <span class="n">crftrials</span><span class="p">]</span> <span class="o">-</span> <span class="n">sponFR</span><span class="p">[</span><span class="n">ci</span><span class="p">])</span><span class="o">.</span><span class="n">pvalue</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="n">pRrfinverse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">Nneurons</span><span class="p">,</span> <span class="n">Nrfs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">rfi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nrfs</span><span class="p">):</span>
        <span class="n">irftrials</span> <span class="o">=</span> <span class="p">(</span><span class="n">trialorder</span> <span class="o">//</span> <span class="mi">10000</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">trialorder</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">==</span> <span class="n">rfi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">irftrials</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nneurons</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pRrfinverse</span><span class="p">[</span><span class="n">ci</span><span class="p">,</span> <span class="n">rfi</span><span class="p">]</span> <span class="o">=</span> <span class="n">wilcoxon</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">ci</span><span class="p">,</span> <span class="n">irftrials</span><span class="p">]</span> <span class="o">-</span> <span class="n">sponFR</span><span class="p">[</span><span class="n">ci</span><span class="p">])</span><span class="o">.</span><span class="n">pvalue</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="n">pRFclassic</span> <span class="o">=</span> <span class="n">pRrfclassic</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Nneurons</span><span class="p">),</span> <span class="n">RFindclassic</span><span class="p">]</span>
    <span class="n">pRFinverse</span> <span class="o">=</span> <span class="n">pRrfinverse</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Nneurons</span><span class="p">),</span> <span class="n">RFindinverse</span><span class="p">]</span>

    <span class="n">tempsorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">pRrfclassic</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">RFsigexclclassic</span> <span class="o">=</span> <span class="p">(</span><span class="n">pRFclassic</span> <span class="o">*</span> <span class="n">Nrfs</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pRFclassic</span> <span class="o">==</span> <span class="n">tempsorted</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tempsorted</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Nrfs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">tempsorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">pRrfinverse</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">RFsigexclinverse</span> <span class="o">=</span> <span class="p">(</span><span class="n">pRFinverse</span> <span class="o">*</span> <span class="n">Nrfs</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pRFinverse</span> <span class="o">==</span> <span class="n">tempsorted</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tempsorted</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Nrfs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">RFexclsigclassic</span> <span class="o">=</span> <span class="p">(</span><span class="n">pRFclassic</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pRrfclassic</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">RFexclsiginverse</span> <span class="o">=</span> <span class="p">(</span><span class="n">pRFinverse</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pRrfinverse</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">RFCI</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Rrfclassic&#39;</span><span class="p">:</span> <span class="n">Rrfclassic</span><span class="p">,</span>
        <span class="s1">&#39;Rrfinverse&#39;</span><span class="p">:</span> <span class="n">Rrfinverse</span><span class="p">,</span>
        <span class="s1">&#39;RFindclassic&#39;</span><span class="p">:</span> <span class="n">RFindclassic</span><span class="p">,</span>
        <span class="s1">&#39;RFindinverse&#39;</span><span class="p">:</span> <span class="n">RFindinverse</span><span class="p">,</span>
        <span class="s1">&#39;Pkw_rfclassic&#39;</span><span class="p">:</span> <span class="n">Pkw_rfclassic</span><span class="p">,</span>
        <span class="s1">&#39;Pkw_rfinverse&#39;</span><span class="p">:</span> <span class="n">Pkw_rfinverse</span><span class="p">,</span>
        <span class="s1">&#39;sigmc_rfclassic&#39;</span><span class="p">:</span> <span class="n">sigmc_rfclassic</span><span class="p">,</span>
        <span class="s1">&#39;sigmc_rfinverse&#39;</span><span class="p">:</span> <span class="n">sigmc_rfinverse</span><span class="p">,</span>
        <span class="s1">&#39;pRrfclassic&#39;</span><span class="p">:</span> <span class="n">pRrfclassic</span><span class="p">,</span>
        <span class="s1">&#39;pRrfinverse&#39;</span><span class="p">:</span> <span class="n">pRrfinverse</span><span class="p">,</span>
        <span class="s1">&#39;pRFclassic&#39;</span><span class="p">:</span> <span class="n">pRFclassic</span><span class="p">,</span>
        <span class="s1">&#39;pRFinverse&#39;</span><span class="p">:</span> <span class="n">pRFinverse</span><span class="p">,</span>
        <span class="s1">&#39;RFsigexclclassic&#39;</span><span class="p">:</span> <span class="n">RFsigexclclassic</span><span class="p">,</span>
        <span class="s1">&#39;RFsigexclinverse&#39;</span><span class="p">:</span> <span class="n">RFsigexclinverse</span><span class="p">,</span>
        <span class="s1">&#39;RFexclsigclassic&#39;</span><span class="p">:</span> <span class="n">RFexclsigclassic</span><span class="p">,</span>
        <span class="s1">&#39;RFexclsiginverse&#39;</span><span class="p">:</span> <span class="n">RFexclsiginverse</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">RFCI</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_stim_table_info</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; This function extracts information from the stimulus table.</span>
<span class="sd">    Args:</span>
<span class="sd">        table_name (str): Name of the stimulus table.</span>
<span class="sd">        table (np.ndarray): Stimulus table. </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary containing the following keys:</span>
<span class="sd">            start_time (np.ndarray): Start time of each trial.</span>
<span class="sd">            stop_time (np.ndarray): Stop time of each trial.</span>
<span class="sd">            frame (np.ndarray): Frame number of each trial.</span>
<span class="sd">            trialframeinds (np.ndarray): Frame indices of each trial.</span>
<span class="sd">            trialstart (np.ndarray): Start time of each trial.</span>
<span class="sd">            trialend (np.ndarray): Stop time of each trial.</span>
<span class="sd">            numtrials (int): Number of trials.</span>
<span class="sd">            trialorder (np.ndarray): Order of each trial.</span>
<span class="sd">            trialtypedescription (list): Description of each trial type.</span>
<span class="sd">            ICtrialtypes (list): Trial types for IC.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">stim_table_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">][:]</span>  <span class="c1"># Adjust indexing and loading method</span>
    <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;stop_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;stop_time&#39;</span><span class="p">][:]</span>  <span class="c1"># Adjust indexing and loading method</span>
    
    <span class="n">viskeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">colnames</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">viskeys</span><span class="p">:</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">k</span><span class="p">][:]</span>  <span class="c1"># Adjust indexing and loading method</span>
    
    <span class="k">if</span> <span class="s1">&#39;frame&#39;</span> <span class="ow">in</span> <span class="n">stim_table_info</span><span class="p">:</span>
        <span class="n">frame_firsttrial</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frame_firsttrial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stim_table_info</span>  <span class="c1"># Skip if &#39;frame&#39; is empty or all zeros</span>

        <span class="c1"># Adjust frame_firsttrial to the nearest multiple of 10</span>
        <span class="k">if</span> <span class="n">frame_firsttrial</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;first trial was blank&#39;</span><span class="p">)</span>
            <span class="n">frame_firsttrial</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="n">frame_firsttrial</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span>

        <span class="n">frame_lasttrial</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="nb">next</span><span class="p">((</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">]))</span> <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># Adjust frame_lasttrial to the nearest multiple of 10 + 9</span>
        <span class="k">if</span> <span class="n">frame_lasttrial</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;last trial was blank&#39;</span><span class="p">)</span>
            <span class="n">frame_lasttrial</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="n">frame_lasttrial</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">9</span>

        <span class="n">trialframeinds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">frame_firsttrial</span><span class="p">,</span> <span class="n">frame_lasttrial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialframeinds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trialframeinds</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialstart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trialframeinds</span><span class="p">]</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;stop_time&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trialframeinds</span><span class="p">]</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;numtrials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trialframeinds</span><span class="p">)</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trialframeinds</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="s1">&#39;cfg1&#39;</span> <span class="ow">in</span> <span class="n">table_name</span><span class="p">:</span>
            <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialtypedescription&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Blank&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;TC1&#39;</span><span class="p">,</span> <span class="s1">&#39;IC1&#39;</span><span class="p">,</span> <span class="s1">&#39;LC1&#39;</span><span class="p">,</span> <span class="s1">&#39;TC2&#39;</span><span class="p">,</span> <span class="s1">&#39;LC2&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;IC2&#39;</span><span class="p">,</span> <span class="s1">&#39;IRE1&#39;</span><span class="p">,</span> <span class="s1">&#39;IRE2&#39;</span><span class="p">,</span> <span class="s1">&#39;TRE1&#39;</span><span class="p">,</span> <span class="s1">&#39;TRE2&#39;</span><span class="p">,</span> <span class="s1">&#39;XRE1&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;XRE2&#39;</span><span class="p">,</span><span class="s1">&#39;InBR&#39;</span><span class="p">,</span> <span class="s1">&#39;InBL&#39;</span><span class="p">,</span> <span class="s1">&#39;InTL&#39;</span><span class="p">,</span> <span class="s1">&#39;InTR&#39;</span><span class="p">,</span> <span class="s1">&#39;OutBR&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;OutBL&#39;</span><span class="p">,</span> <span class="s1">&#39;OutTL&#39;</span><span class="p">,</span> <span class="s1">&#39;OutTL&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;cfg0&#39;</span> <span class="ow">in</span> <span class="n">table_name</span><span class="p">:</span>
            <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialtypedescription&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Blank&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;TC1&#39;</span><span class="p">,</span> <span class="s1">&#39;IC1&#39;</span><span class="p">,</span> <span class="s1">&#39;LC1&#39;</span><span class="p">,</span> <span class="s1">&#39;TC2&#39;</span><span class="p">,</span> <span class="s1">&#39;LC2&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;IC2&#39;</span><span class="p">,</span> <span class="s1">&#39;IRE1&#39;</span><span class="p">,</span> <span class="s1">&#39;IRE2&#39;</span><span class="p">,</span> <span class="s1">&#39;TRE1&#39;</span><span class="p">,</span> <span class="s1">&#39;TRE2&#39;</span><span class="p">,</span> <span class="s1">&#39;XRE1&#39;</span><span class="p">,</span> <span class="s1">&#39;XRE2&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;InR&#39;</span><span class="p">,</span> <span class="s1">&#39;InB&#39;</span><span class="p">,</span> <span class="s1">&#39;InL&#39;</span><span class="p">,</span> <span class="s1">&#39;InT&#39;</span><span class="p">,</span> <span class="s1">&#39;OutR&#39;</span><span class="p">,</span> <span class="s1">&#39;OutB&#39;</span><span class="p">,</span> <span class="s1">&#39;OutL&#39;</span><span class="p">,</span> <span class="s1">&#39;OutT&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;unrecognized configuration&#39;</span><span class="p">)</span>
        
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;ICtrialtypes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">107</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span> <span class="mi">506</span><span class="p">,</span> <span class="mi">511</span><span class="p">,</span> <span class="mi">1105</span><span class="p">,</span> <span class="mi">1109</span><span class="p">,</span> <span class="mi">1201</span><span class="p">,</span>
                                    <span class="mi">1299</span><span class="p">,</span> <span class="mi">1301</span><span class="p">,</span> <span class="mi">1302</span><span class="p">,</span> <span class="mi">1303</span><span class="p">,</span> <span class="mi">1304</span><span class="p">,</span> <span class="mi">1305</span><span class="p">,</span> <span class="mi">1306</span><span class="p">,</span> <span class="mi">1307</span><span class="p">,</span> <span class="mi">1308</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;ICwcfg1&#39;</span> <span class="ow">in</span> <span class="n">stim_table_info</span><span class="p">:</span>
            <span class="n">expectNtrials</span> <span class="o">=</span> <span class="mi">5300</span> <span class="c1">#12*400+10*50</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expectNtrials</span> <span class="o">=</span> <span class="mi">22</span><span class="o">*</span><span class="mi">30</span>
        
        <span class="k">if</span> <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;numtrials&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expectNtrials</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;check numtrials&#39;</span><span class="p">)</span>
        
    <span class="c1"># RFCIblocks</span>
    <span class="c1"># (+right, +up)</span>
    <span class="c1"># &#39;10000s: which type(classic 0 vs inverse 1), 1000s which ctrsizes, 10~100s which RFcenter,1s: which direction&#39;</span>

    <span class="k">if</span> <span class="s1">&#39;y_position&#39;</span> <span class="ow">in</span> <span class="n">stim_table_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialstart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;stop_time&#39;</span><span class="p">]</span>

        <span class="n">yx_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;y_position&#39;</span><span class="p">],</span> <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;x_position&#39;</span><span class="p">]))</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;sizepix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">203.3786</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;MaskDiaVisDeg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="c1"># Defining RFcentersrel</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;RFcentersrel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
        <span class="p">])</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;RFcenters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;sizepix&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;RFcentersrel&#39;</span><span class="p">]</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;RFcentersVisDeg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;MaskDiaVisDeg&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;RFcentersrel&#39;</span><span class="p">]</span>
        
        <span class="n">unique_yx_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">yx_position</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">all_rfcenters_in_unique_yx</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">rfcenter</span> <span class="o">==</span> <span class="n">unique_yx_position</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">rfcenter</span> <span class="ow">in</span> <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;RFcenters&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_rfcenters_in_unique_yx</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;check RFcenters&#39;</span><span class="p">)</span>
            
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">])</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;MaskList&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;Mask&#39;</span><span class="p">])</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;numtrials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">])</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;numtrials&#39;</span><span class="p">]))</span>
        
        <span class="k">for</span> <span class="n">typi</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">]):</span>
            <span class="n">trialsoi</span> <span class="o">=</span> <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">direction</span>
            <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialorder&#39;</span><span class="p">][</span><span class="n">trialsoi</span><span class="p">]</span> <span class="o">+=</span> <span class="n">typi</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">typi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;RFcenters&#39;</span><span class="p">])):</span>
            <span class="n">trialsoi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">yx_position</span> <span class="o">==</span> <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;RFcenters&#39;</span><span class="p">][</span><span class="n">typi</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialorder&#39;</span><span class="p">][</span><span class="n">trialsoi</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="n">typi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">typi</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;MaskList&#39;</span><span class="p">]):</span>
            <span class="n">trialsoi</span> <span class="o">=</span> <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;Mask&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mask</span>
            <span class="n">maskno</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialorder&#39;</span><span class="p">][</span><span class="n">trialsoi</span><span class="p">]</span> <span class="o">+=</span> <span class="n">maskno</span> 
            
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialtypedescription&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;10000s: classic 0 vs inverse 1,</span><span class="se">\</span>
<span class="s1">        1000s: which ctrsizes, 10-100s: which RFcenter, 1s: which direction&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;sizeCI&#39;</span> <span class="ow">in</span> <span class="n">table_name</span><span class="p">:</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialstart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;stop_time&#39;</span><span class="p">]</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">])</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;MaskList&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;Mask&#39;</span><span class="p">])</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;numtrials&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">])</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;numtrials&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">typi</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;directions&#39;</span><span class="p">]):</span>
            <span class="n">trialsoi</span> <span class="o">=</span> <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">direction</span>
            <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialorder&#39;</span><span class="p">][</span><span class="n">trialsoi</span><span class="p">]</span> <span class="o">+=</span> <span class="n">typi</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">typi</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;MaskList&#39;</span><span class="p">]):</span>
            <span class="n">trialsoi</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="o">==</span> <span class="n">mask</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;Mask&#39;</span><span class="p">]]</span>
            <span class="n">tempss</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">maskno</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tempss</span><span class="p">)</span>
            <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialorder&#39;</span><span class="p">][</span><span class="n">trialsoi</span><span class="p">]</span> <span class="o">+=</span> <span class="n">maskno</span>
            
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;MaskDiaVisDeg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">]</span>
        <span class="n">stim_table_info</span><span class="p">[</span><span class="s1">&#39;trialtypedescription&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;10000s: classic 0 vs inverse 1,</span><span class="se">\</span>
<span class="s1">        1000s: which ctrsizes, 10-100s: which RFcenter, 1s: which direction&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">stim_table_info</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calculate_spiketrain</span><span class="p">(</span><span class="n">wanted_neurons</span><span class="p">,</span> <span class="n">timelength</span><span class="p">,</span> <span class="n">spiketime_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; This function calculates the spike train matrix.</span>
<span class="sd">    Args:</span>
<span class="sd">        wanted_neurons (list): List of neurons to be included.</span>
<span class="sd">        timelength (int): Length of time.</span>
<span class="sd">        spiketime_data (np.ndarray): Spike time data.</span>
<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: Spike train matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">spiketrainmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">wanted_neurons</span><span class="p">),</span> <span class="n">timelength</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">unit_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wanted_neurons</span><span class="p">)):</span>
        <span class="n">unit_spike_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">spiketime_data</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">spiketrainmatrix</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">,</span> <span class="n">unit_spike_times</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">spiketrainmatrix</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calculate_psthmatrix</span><span class="p">(</span><span class="n">spiketrainmatrix</span><span class="p">,</span> <span class="n">wanted_neurons</span><span class="p">,</span> <span class="n">trialstart</span><span class="p">,</span> <span class="n">trial_ind</span><span class="p">,</span> <span class="n">timeline</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; This function calculates the PSTH matrix.</span>
<span class="sd">    Args:</span>
<span class="sd">        spiketrainmatrix (np.ndarray): Spike train matrix.</span>
<span class="sd">        wanted_neurons (list): List of neurons to be included.</span>
<span class="sd">        trialstart (np.ndarray): Start time of each trial.</span>
<span class="sd">        trial_ind (np.ndarray): Index of each trial.</span>
<span class="sd">        timeline (np.ndarray): Timeline.</span>
<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: PSTH matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_units</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wanted_neurons</span><span class="p">)</span>
    <span class="n">num_trials</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trialstart</span><span class="p">)</span>
    <span class="n">psthmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_units</span><span class="p">,</span> <span class="n">num_trials</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeline</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wanted_neurons</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">trial</span><span class="p">,</span> <span class="n">trial_start</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trial_ind</span><span class="p">):</span>
            <span class="n">trial_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">trial_start</span><span class="p">)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">trial_start</span> <span class="o">+</span> <span class="n">timeline</span>
            <span class="n">psthmatrix</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">trial</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">spiketrainmatrix</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">indices</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">psthmatrix</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># iterate through sessions and calculate receptive fields for V1 units</span>

<span class="n">RFCI</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nwb_paths</span><span class="p">))}</span>
<span class="n">sponFRall</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nwb_paths</span><span class="p">))}</span>
<span class="n">psth_session</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nwb_paths</span><span class="p">))}</span>
<span class="n">tempR</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nwb_paths</span><span class="p">))}</span>
<span class="n">vis_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">{}</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nwb_paths</span><span class="p">))}</span>

<span class="k">for</span> <span class="n">nwb_idx</span><span class="p">,</span> <span class="n">io</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nwb_ios</span><span class="p">):</span>
    <span class="n">nwb</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">units</span>
    
    <span class="n">units_qc</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unit_isi_violations</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="s1">&#39;isi_violations&#39;</span><span class="p">][:]</span>
    <span class="n">unit_amplitude_cutoff</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="s1">&#39;amplitude_cutoff&#39;</span><span class="p">][:]</span>
    <span class="n">unit_presence_ratio</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="s1">&#39;presence_ratio&#39;</span><span class="p">][:]</span>

    <span class="c1"># quality control criteria for unit filtering</span>
    <span class="n">units_qc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">unit_isi_violations</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">unit_amplitude_cutoff</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">unit_presence_ratio</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># find neurons located in V1(VISp)</span>
    <span class="n">V1electrodeindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;VISp&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;VISpm&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">nwb</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">][:]]))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">V1electrode_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">nwb</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">V1electrodeindex</span><span class="p">]</span>
    <span class="n">electrodes_key</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">nwb</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span><span class="s1">&#39;probe_id&#39;</span><span class="p">][:]</span> <span class="o">+</span> <span class="n">nwb</span><span class="o">.</span><span class="n">electrodes</span><span class="p">[</span><span class="s1">&#39;local_index&#39;</span><span class="p">]</span>
    <span class="n">V1common_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">V1electrode_ids</span><span class="p">,</span> <span class="n">electrodes_key</span><span class="p">)</span>
    <span class="n">V1units</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;peak_channel_id&#39;</span><span class="p">],</span> <span class="n">V1common_values</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">V1units_qc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">V1units</span><span class="p">,</span> <span class="n">units_qc</span><span class="p">)</span> <span class="c1"># quality controlled units&#39; indices</span>

    <span class="n">max_spike_times</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;spike_times&quot;</span><span class="p">][</span><span class="n">unit_idx</span><span class="p">])</span> <span class="k">for</span> <span class="n">unit_idx</span> <span class="ow">in</span> <span class="n">V1units_qc</span><span class="p">]</span>
    <span class="n">Tlen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">max_spike_times</span><span class="p">)))</span> <span class="c1"># time length for spike train matrix</span>
    <span class="n">spike_times</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="s2">&quot;spike_times&quot;</span><span class="p">][</span><span class="n">V1units_qc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">V1units_qc</span><span class="p">)]]</span>

    <span class="n">Tres</span> <span class="o">=</span> <span class="mf">0.001</span>

    <span class="n">spiketrain</span> <span class="o">=</span> <span class="n">calculate_spiketrain</span><span class="p">(</span><span class="n">V1units_qc</span><span class="p">,</span> <span class="n">Tlen</span><span class="p">,</span> <span class="n">spike_times</span><span class="p">)</span>
    
    <span class="c1"># vis extracts all relevant information about visual presentations</span>
    <span class="n">all_tables_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># table_names = list(nwb.intervals.keys())  # Adjust the path according to your NWB file structure</span>
    <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">nwb</span><span class="o">.</span><span class="n">intervals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">all_tables_info</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_stim_table_info</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
        
    <span class="n">durations</span> <span class="o">=</span> <span class="n">all_tables_info</span><span class="p">[</span><span class="s1">&#39;spontaneous_presentations&#39;</span><span class="p">][</span><span class="s1">&#39;stop_time&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">all_tables_info</span><span class="p">[</span><span class="s1">&#39;spontaneous_presentations&#39;</span><span class="p">][</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span>
    <span class="n">mv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">durations</span><span class="p">)</span>
    <span class="n">mi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">durations</span><span class="p">)</span>
    

    <span class="c1"># Calculate start and end indices</span>
    <span class="n">sponTstartind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">all_tables_info</span><span class="p">[</span><span class="s1">&#39;spontaneous_presentations&#39;</span><span class="p">][</span><span class="s1">&#39;start_time&#39;</span><span class="p">][</span><span class="n">mi</span><span class="p">]</span> <span class="o">/</span> <span class="n">Tres</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">sponTendind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">all_tables_info</span><span class="p">[</span><span class="s1">&#39;spontaneous_presentations&#39;</span><span class="p">][</span><span class="s1">&#39;stop_time&#39;</span><span class="p">][</span><span class="n">mi</span><span class="p">]</span> <span class="o">/</span> <span class="n">Tres</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Compute mean firing rates</span>
    <span class="n">sponFRall</span><span class="p">[</span><span class="n">nwb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spiketrain</span><span class="p">[:,</span> <span class="n">sponTstartind</span><span class="p">:</span><span class="n">sponTendind</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">Tres</span>
    <span class="n">meanFRall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spiketrain</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">Tres</span>
    
    <span class="n">psth</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">psthtli</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">nwb</span><span class="o">.</span><span class="n">intervals</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;spontaneous&#39;</span> <span class="ow">in</span> <span class="n">table_name</span> <span class="ow">or</span> <span class="s1">&#39;invalid_times&#39;</span> <span class="ow">in</span> <span class="n">table_name</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">trialstart_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_tables_info</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="s1">&#39;trialstart&#39;</span><span class="p">])</span>
        <span class="n">psthtrialinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">trialstart_array</span> <span class="o">/</span> <span class="n">Tres</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="n">psth</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_psthmatrix</span><span class="p">(</span><span class="n">spiketrain</span><span class="p">,</span> <span class="n">V1units_qc</span><span class="p">,</span> <span class="n">trialstart_array</span><span class="p">,</span> <span class="n">psthtrialinds</span><span class="p">,</span> <span class="n">psthtli</span><span class="p">)</span>

    <span class="n">psth_session</span><span class="p">[</span><span class="n">nwb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">psth</span>
    <span class="n">vis_dict</span><span class="p">[</span><span class="n">nwb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_tables_info</span>
    
    <span class="n">tloi</span> <span class="o">=</span> <span class="p">(</span><span class="n">psthtli</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">psthtli</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">tempR</span><span class="p">[</span><span class="n">nwb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">psth</span><span class="p">[</span><span class="s1">&#39;RFCI_presentations&#39;</span><span class="p">][:,</span> <span class="p">::</span><span class="mi">4</span><span class="p">,</span> <span class="n">tloi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">temptrialorder</span> <span class="o">=</span> <span class="n">all_tables_info</span><span class="p">[</span><span class="s1">&#39;RFCI_presentations&#39;</span><span class="p">][</span><span class="s1">&#39;trialorder&#39;</span><span class="p">][::</span><span class="mi">4</span><span class="p">]</span>

    <span class="c1"># Assuming the function analyzeRFCI is already defined as per the previous translation</span>
    <span class="n">RFCI</span><span class="p">[</span><span class="n">nwb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">analyzeRFCI</span><span class="p">(</span><span class="n">tempR</span><span class="p">[</span><span class="n">nwb_idx</span><span class="p">],</span> <span class="n">temptrialorder</span><span class="p">,</span> <span class="n">sponFRall</span><span class="p">[</span><span class="n">nwb_idx</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_signeurons</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">sig_neurons</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nwb_paths</span><span class="p">))}</span>
<span class="k">for</span> <span class="n">path_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nwb_paths</span><span class="p">)):</span>
    <span class="n">sig_neurons</span><span class="p">[</span><span class="n">path_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">RFCI</span><span class="p">[</span><span class="n">path_idx</span><span class="p">][</span><span class="s1">&#39;RFsigexclclassic&#39;</span><span class="p">],</span> <span class="n">RFCI</span><span class="p">[</span><span class="n">path_idx</span><span class="p">][</span><span class="s1">&#39;RFindclassic&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">num_signeurons</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig_neurons</span><span class="p">[</span><span class="n">path_idx</span><span class="p">])</span>

<span class="n">num_signeurons</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RFcenters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">vis_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RFCI_presentations&#39;</span><span class="p">][</span><span class="s1">&#39;RFcenters&#39;</span><span class="p">]))</span>
<span class="n">RFcenters</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[   0.        ,    0.        ],
       [-203.3786    ,    0.        ],
       [-143.81038721,  143.81038721],
       [   0.        ,  203.3786    ],
       [ 143.81038721,  143.81038721],
       [ 203.3786    ,    0.        ],
       [ 143.81038721, -143.81038721],
       [   0.        , -203.3786    ],
       [-143.81038721, -143.81038721]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># select trial order index what we want</span>
<span class="n">position_all</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:[]</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nwb_paths</span><span class="p">))}</span>
<span class="k">for</span> <span class="n">path_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nwb_paths</span><span class="p">)):</span>
    <span class="n">nrf</span> <span class="o">=</span> <span class="mi">9</span>

    <span class="n">trialorder</span> <span class="o">=</span> <span class="n">vis_dict</span><span class="p">[</span><span class="n">path_idx</span><span class="p">][</span><span class="s1">&#39;RFCI_presentations&#39;</span><span class="p">][</span><span class="s1">&#39;trialorder&#39;</span><span class="p">]</span>
    <span class="n">position</span><span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrf</span><span class="p">)}</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrf</span><span class="p">):</span>
        <span class="n">position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">vis_dict</span><span class="p">[</span><span class="n">path_idx</span><span class="p">][</span><span class="s1">&#39;RFCI_presentations&#39;</span><span class="p">][</span><span class="s1">&#39;trialorder&#39;</span><span class="p">]</span><span class="o">//</span><span class="mi">10</span><span class="o">%</span><span class="k">10</span> == i, vis_dict[path_idx][&#39;RFCI_presentations&#39;][&#39;trialorder&#39;]//10000 == 0))[0][::4]
    <span class="n">position_all</span><span class="p">[</span><span class="n">path_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">position</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_psth_all</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrf</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">path_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nwb_paths</span><span class="p">)):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig_neurons</span><span class="p">[</span><span class="n">path_idx</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sig_psth</span> <span class="o">=</span> <span class="n">psth_session</span><span class="p">[</span><span class="n">path_idx</span><span class="p">][</span><span class="s1">&#39;RFCI_presentations&#39;</span><span class="p">][</span><span class="n">sig_neurons</span><span class="p">[</span><span class="n">path_idx</span><span class="p">],:,:]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrf</span><span class="p">):</span>
            <span class="n">mean_psth</span> <span class="o">=</span> <span class="p">(</span><span class="n">sig_psth</span><span class="p">[:,</span> <span class="n">position_all</span><span class="p">[</span><span class="n">path_idx</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="mi">500</span><span class="p">:])</span><span class="o">/</span><span class="n">Tres</span> <span class="o">-</span> <span class="n">sponFRall</span><span class="p">[</span><span class="n">path_idx</span><span class="p">][</span><span class="n">sig_neurons</span><span class="p">[</span><span class="n">path_idx</span><span class="p">]][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="n">mean_psth_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_psth</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">each_mean_psth</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrf</span><span class="p">)}</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrf</span><span class="p">):</span>
    <span class="n">each_mean_psth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mean_psth_all</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-the-receptive-field-of-each-exclusively-center-responsive-v1-neuron">
<h3>Plot the receptive field of each exclusively center-responsive V1 neuron<a class="headerlink" href="#plot-the-receptive-field-of-each-exclusively-center-responsive-v1-neuron" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cols</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_signeurons</span> <span class="o">//</span> <span class="n">cols</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">cols</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">rows</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>  
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  

<span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_signeurons</span><span class="p">):</span>
    <span class="n">firing_rate_allneurons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrf</span><span class="p">):</span>
        <span class="n">firing_rate_allneurons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">each_mean_psth</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">num</span><span class="p">])</span>

    <span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">RFcenters</span><span class="p">]))</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">4</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>

    <span class="c1"># Create a list to hold the circle patches</span>
    <span class="n">circles</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Loop through each position and create a circle patch with the mean firing rate color</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">firing_rate_allneurons</span><span class="p">,</span> <span class="n">RFcenters</span><span class="p">)):</span>
        <span class="n">circle</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">radius</span><span class="p">)</span>
        <span class="n">circles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nrf</span><span class="p">)[</span><span class="n">idx</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="c1"># Create a patch collection with the circles</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">PatchCollection</span><span class="p">(</span><span class="n">circles</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

    <span class="c1"># Set the array for the colormap with normalized firing rates</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">firing_rate_allneurons</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_clim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_norm</span><span class="p">(</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Add the patch collection to the axis</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c1"># Format the plot</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">320</span><span class="p">,</span> <span class="mi">320</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">320</span><span class="p">,</span> <span class="mi">320</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>


<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="n">num_signeurons</span><span class="p">:]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1a7cfb69ffaaab1f04fce1f9bbae7a18c6899a2dd4ed657b6e28bdfa65eb5a06.png" src="../_images/1a7cfb69ffaaab1f04fce1f9bbae7a18c6899a2dd4ed657b6e28bdfa65eb5a06.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">firing_rate_position</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrf</span><span class="p">):</span>
    <span class="n">firing_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mean_psth_all</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">firing_rate_position</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">firing_rate</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-the-average-of-exclusively-center-responsive-v1-neurons">
<h3>Plot the average of exclusively center-responsive V1 neurons<a class="headerlink" href="#plot-the-average-of-exclusively-center-responsive-v1-neurons" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize the figure and axis</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="c1"># Create a list to hold the circle patches</span>
<span class="n">circles</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Loop through each position and create a circle patch with the mean firing rate color</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">firing_rate_position</span><span class="p">,</span> <span class="n">RFcenters</span><span class="p">)):</span>
    <span class="n">circle</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">radius</span><span class="p">)</span>
    <span class="n">circles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nrf</span><span class="p">)[</span><span class="n">idx</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># Create a patch collection with the circles</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">PatchCollection</span><span class="p">(</span><span class="n">circles</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="c1"># Set the array for the colormap with normalized firing rates</span>
<span class="n">p</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">firing_rate_position</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">set_clim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">p</span><span class="o">.</span><span class="n">set_norm</span><span class="p">(</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>

<span class="c1"># Add the patch collection to the axis</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="c1"># Format the plot</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">320</span><span class="p">,</span> <span class="mi">320</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">320</span><span class="p">,</span> <span class="mi">320</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="c1"># Create a colorbar</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;ΔFiring Rate (Hz)&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="c1"># Show the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b0c7cac5a4c1117cf3a906f61ed54569f5b7d72f146d997f4660ba55c761e1aa.png" src="../_images/b0c7cac5a4c1117cf3a906f61ed54569f5b7d72f146d997f4660ba55c761e1aa.png" />
</div>
</div>
</section>
<section id="figure-1f-stacked-peri-stimulus-time-histograms-psths-depicting-evoked-responses-to-i-c-and-i-re-images-for-exclusively-center-responsive-v1-neurons">
<h3>Figure. 1f : stacked peri-stimulus time histograms (PSTHs) depicting evoked responses to <span class="math notranslate nohighlight">\(I_{C}\)</span> and <span class="math notranslate nohighlight">\(I_{RE}\)</span> images for exclusively center-responsive V1 neurons<a class="headerlink" href="#figure-1f-stacked-peri-stimulus-time-histograms-psths-depicting-evoked-responses-to-i-c-and-i-re-images-for-exclusively-center-responsive-v1-neurons" title="Link to this heading">#</a></h3>
<p>note, we are subtracting spontaneous period activity from each neuron to assess the magnitude of visual evoked activity (i.e., change from baseline)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ICtrials</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="c1"># trial order is 45, 135 dgree in ICwcfg1_presentations, 0, 90 degree in ICwcfg0_presentations</span>
<span class="n">REtrials</span> <span class="o">=</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">IC_aggregate_list1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">RE_aggregate_list1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">path_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nwb_paths</span><span class="p">)):</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">sig_neurons</span><span class="p">[</span><span class="n">path_idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>       
        <span class="n">trial_order</span> <span class="o">=</span> <span class="n">vis_dict</span><span class="p">[</span><span class="n">path_idx</span><span class="p">][</span><span class="s1">&#39;ICwcfg1_presentations&#39;</span><span class="p">][</span><span class="s1">&#39;trialorder&#39;</span><span class="p">]</span>
        
        <span class="n">indices_by_element</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ICtrials</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trial_order</span><span class="p">)</span> <span class="o">==</span> <span class="n">item</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indices_by_element</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">REtrials</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trial_order</span><span class="p">)</span> <span class="o">==</span> <span class="n">item</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indices_by_element</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>


        <span class="n">sig_psth1</span> <span class="o">=</span> <span class="n">psth_session</span><span class="p">[</span><span class="n">path_idx</span><span class="p">][</span><span class="s1">&#39;ICwcfg1_presentations&#39;</span><span class="p">][</span><span class="n">sig</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">Tres</span> <span class="o">-</span>  <span class="n">sponFRall</span><span class="p">[</span><span class="n">path_idx</span><span class="p">][</span><span class="n">sig</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>


        <span class="n">ICpsth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">sig_psth1</span><span class="p">[:,</span> <span class="n">indices_by_element</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">ICtrials</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Concatenate along the trial axis</span>
        <span class="n">REpsth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">sig_psth1</span><span class="p">[:,</span> <span class="n">indices_by_element</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">REtrials</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Concatenate along the trial axis</span>

        <span class="n">IC_aggregate_list1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ICpsth</span><span class="p">)</span>
        <span class="n">RE_aggregate_list1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">REpsth</span><span class="p">)</span>

<span class="c1"># After all files are processed, concatenate the list of arrays into a single array</span>
<span class="k">if</span> <span class="n">IC_aggregate_list1</span><span class="p">:</span>
    <span class="n">IC_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">IC_aggregate_list1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Concatenate along the neuron axis</span>
<span class="k">if</span> <span class="n">RE_aggregate_list1</span><span class="p">:</span>
    <span class="n">RE_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">RE_aggregate_list1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">IC_aggregate_list0</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">RE_aggregate_list0</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">path_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nwb_paths</span><span class="p">)):</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">sig_neurons</span><span class="p">[</span><span class="n">path_idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>       
        <span class="n">trial_order</span> <span class="o">=</span> <span class="n">vis_dict</span><span class="p">[</span><span class="n">path_idx</span><span class="p">][</span><span class="s1">&#39;ICwcfg0_presentations&#39;</span><span class="p">][</span><span class="s1">&#39;trialorder&#39;</span><span class="p">]</span>

        <span class="n">indices_by_element</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ICtrials</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trial_order</span><span class="p">)</span> <span class="o">==</span> <span class="n">item</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indices_by_element</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">REtrials</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trial_order</span><span class="p">)</span> <span class="o">==</span> <span class="n">item</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indices_by_element</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">sig_psth0</span> <span class="o">=</span> <span class="n">psth_session</span><span class="p">[</span><span class="n">path_idx</span><span class="p">][</span><span class="s1">&#39;ICwcfg0_presentations&#39;</span><span class="p">][</span><span class="n">sig</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">Tres</span> <span class="o">-</span>  <span class="n">sponFRall</span><span class="p">[</span><span class="n">path_idx</span><span class="p">][</span><span class="n">sig</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>


        <span class="n">ICpsth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">sig_psth0</span><span class="p">[:,</span> <span class="n">indices_by_element</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">ICtrials</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Concatenate along the trial axis</span>
        <span class="n">REpsth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">sig_psth0</span><span class="p">[:,</span> <span class="n">indices_by_element</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">REtrials</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Concatenate along the trial axis</span>

        <span class="n">IC_aggregate_list0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ICpsth</span><span class="p">)</span>
        <span class="n">RE_aggregate_list0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">REpsth</span><span class="p">)</span>

<span class="c1"># After all files are processed, concatenate the list of arrays into a single array</span>
<span class="k">if</span> <span class="n">IC_aggregate_list0</span><span class="p">:</span>
    <span class="n">IC_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">IC_aggregate_list0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Concatenate along the neuron axis</span>
<span class="k">if</span> <span class="n">RE_aggregate_list0</span><span class="p">:</span>
    <span class="n">RE_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">RE_aggregate_list0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">IC_aggregate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">IC_0</span><span class="p">,</span> <span class="n">IC_1</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">RE_aggregate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">RE_0</span><span class="p">,</span> <span class="n">RE_1</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="n">IC_convol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="s1">&#39;same&#39;</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">arr</span><span class="o">=</span><span class="n">IC_aggregate</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kernel</span><span class="p">))</span>
<span class="n">IC_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">IC_convol</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

<span class="n">SEM_IC</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">IC_convol</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">IC_convol</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">psthtli</span><span class="p">,</span> <span class="n">IC_mean</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">psthtli</span><span class="p">,</span> <span class="p">(</span><span class="n">IC_mean</span><span class="o">-</span><span class="n">SEM_IC</span><span class="p">),</span> <span class="p">(</span><span class="n">IC_mean</span> <span class="o">+</span> <span class="n">SEM_IC</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time(ms)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Rate(Hz)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">35</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;IC trials&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>


<span class="n">RE_convol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="s1">&#39;same&#39;</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">arr</span><span class="o">=</span><span class="n">RE_aggregate</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kernel</span><span class="p">))</span>
<span class="n">RE_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">RE_convol</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

<span class="n">SEM_RE</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">RE_convol</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">RE_convol</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">psthtli</span><span class="p">,</span> <span class="n">RE_mean</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">psthtli</span><span class="p">,</span> <span class="p">(</span><span class="n">RE_mean</span><span class="o">-</span><span class="n">SEM_RE</span><span class="p">),</span> <span class="p">(</span><span class="n">RE_mean</span> <span class="o">+</span> <span class="n">SEM_RE</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">35</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;RE trials&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time(ms)&#39;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e1a2e403643771150ba6874b60038b0fa47fbdb5fbe53adf4b79609201f2fe53.png" src="../_images/e1a2e403643771150ba6874b60038b0fa47fbdb5fbe53adf4b79609201f2fe53.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sigma</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">IC_convol</span> <span class="o">=</span> <span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">IC_aggregate</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">RE_convol</span> <span class="o">=</span> <span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">RE_aggregate</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">stim_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">psthtli</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">psthtli</span> <span class="o">&lt;=</span> <span class="mi">400</span><span class="p">)</span>
<span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">IC_convol</span><span class="p">[:,:,</span><span class="n">stim_time</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">IC_heat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">IC_convol</span><span class="p">[:,:,</span><span class="n">stim_time</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">RE_heat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">RE_convol</span><span class="p">[:,:,</span><span class="n">stim_time</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">sorted_IC_heat</span> <span class="o">=</span> <span class="n">IC_heat</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">sorted_RE_heat</span> <span class="o">=</span> <span class="n">RE_heat</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">,</span> <span class="p">:]</span> <span class="c1">#in same order with IC heat</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">psth</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sorted_IC_heat</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">30</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">psth</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ΔRate (Hz)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PSTH per Neuron (IC)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Neurons&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">sorted_IC_heat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span> 
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">sorted_IC_heat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> 
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sorted_IC_heat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sorted_IC_heat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0.2&#39;</span><span class="p">,</span> <span class="s1">&#39;0.4&#39;</span><span class="p">])</span>

<span class="n">psth2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sorted_RE_heat</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">30</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">psth2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ΔRate (Hz)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PSTH per Neuron (RE)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Neurons&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">sorted_RE_heat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">sorted_RE_heat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sorted_RE_heat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sorted_RE_heat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0.2&#39;</span><span class="p">,</span> <span class="s1">&#39;0.4&#39;</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/423d3405550ba661371158223a91bc686bbc9c9bc166d0e7da452628baa15085.png" src="../_images/423d3405550ba661371158223a91bc686bbc9c9bc166d0e7da452628baa15085.png" />
</div>
</div>
</section>
<section id="fig-1g-for-exclusively-center-responsive-v1-neurons-that-are-also-responsive-to-at-least-one-of-the-four-i-c-images-compare-the-preferred-orientation-for-i-c-vs-i-re-images">
<h3>Fig. 1g : for exclusively center-responsive V1 neurons that are also responsive to at least one of the four <span class="math notranslate nohighlight">\(I_{C}\)</span> images, compare the preferred orientation for <span class="math notranslate nohighlight">\(I_{C}\)</span> vs <span class="math notranslate nohighlight">\(I_{RE}\)</span> images<a class="headerlink" href="#fig-1g-for-exclusively-center-responsive-v1-neurons-that-are-also-responsive-to-at-least-one-of-the-four-i-c-images-compare-the-preferred-orientation-for-i-c-vs-i-re-images" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define neurons that significantly respond to IC images.</span>
<span class="n">sig_IC</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">]</span>
<span class="n">blank_aggregate1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">blank_aggregate0</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">IC_aggregate_list1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">IC_aggregate_list0</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">path_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nwb_paths</span><span class="p">)):</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">sig_neurons</span><span class="p">[</span><span class="n">path_idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>       
        <span class="n">trial_order</span> <span class="o">=</span> <span class="n">vis_dict</span><span class="p">[</span><span class="n">path_idx</span><span class="p">][</span><span class="s1">&#39;ICwcfg1_presentations&#39;</span><span class="p">][</span><span class="s1">&#39;trialorder&#39;</span><span class="p">]</span>
        
        <span class="n">indices_by_element</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sig_IC</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trial_order</span><span class="p">)</span> <span class="o">==</span> <span class="n">item</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indices_by_element</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">indices_by_element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trial_order</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#index of blank</span>
        

        <span class="n">sig_psth1</span> <span class="o">=</span> <span class="n">psth_session</span><span class="p">[</span><span class="n">path_idx</span><span class="p">][</span><span class="s1">&#39;ICwcfg1_presentations&#39;</span><span class="p">][</span><span class="n">sig</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">Tres</span>
        
        <span class="n">ICpsth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">sig_psth1</span><span class="p">[:,</span> <span class="n">indices_by_element</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sig_IC</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Concatenate along the trial axis</span>
        <span class="n">blank_psth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">sig_psth1</span><span class="p">[:,</span> <span class="n">indices_by_element</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        
        <span class="n">IC_aggregate_list1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ICpsth</span><span class="p">)</span>
        <span class="n">blank_aggregate1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blank_psth</span><span class="p">)</span>
        
        
<span class="k">for</span> <span class="n">path_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nwb_paths</span><span class="p">)):</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">sig_neurons</span><span class="p">[</span><span class="n">path_idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>       
        <span class="n">trial_order</span> <span class="o">=</span> <span class="n">vis_dict</span><span class="p">[</span><span class="n">path_idx</span><span class="p">][</span><span class="s1">&#39;ICwcfg0_presentations&#39;</span><span class="p">][</span><span class="s1">&#39;trialorder&#39;</span><span class="p">]</span>
        
        <span class="n">indices_by_element</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sig_IC</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trial_order</span><span class="p">)</span> <span class="o">==</span> <span class="n">item</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indices_by_element</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">indices_by_element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trial_order</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        


        <span class="n">sig_psth1</span> <span class="o">=</span> <span class="n">psth_session</span><span class="p">[</span><span class="n">path_idx</span><span class="p">][</span><span class="s1">&#39;ICwcfg0_presentations&#39;</span><span class="p">][</span><span class="n">sig</span><span class="p">,:,:]</span> <span class="o">/</span> <span class="n">Tres</span>
        

        <span class="n">ICpsth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">sig_psth1</span><span class="p">[:,</span> <span class="n">indices_by_element</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sig_IC</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Concatenate along the trial axis</span>
        <span class="n">blank_psth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">sig_psth1</span><span class="p">[:,</span> <span class="n">indices_by_element</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


        <span class="n">IC_aggregate_list0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ICpsth</span><span class="p">)</span>
        <span class="n">blank_aggregate0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blank_psth</span><span class="p">)</span>

<span class="c1"># After all files are processed, concatenate the list of arrays into a single array</span>
<span class="k">if</span> <span class="n">IC_aggregate_list1</span><span class="p">:</span>
    <span class="n">sig_IC_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">IC_aggregate_list1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Concatenate along the neuron axis</span>
    
<span class="k">if</span> <span class="n">IC_aggregate_list0</span><span class="p">:</span>
    <span class="n">sig_IC_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">IC_aggregate_list0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
<span class="k">if</span> <span class="n">blank_aggregate0</span><span class="p">:</span>
    <span class="n">sig_blank_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">blank_aggregate0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
<span class="k">if</span> <span class="n">blank_aggregate1</span><span class="p">:</span>
    <span class="n">sig_blank_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">blank_aggregate1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_IC_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sig_IC_0</span><span class="p">[:,:,</span> <span class="n">stim_time</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">mean_blank_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sig_blank_0</span><span class="p">[:,:,</span> <span class="n">stim_time</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">len_IC1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mean_IC_0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

<span class="n">p_values0_IC1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">p_values0_IC2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mean_IC_0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="c1">#Statistics on &#39;blank&#39; and &#39;IC1 trial&#39; in ICwcfg0 presentations</span>
    <span class="n">stat</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">mean_IC_0</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">len_IC1</span><span class="p">],</span> <span class="n">mean_blank_0</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;greater&#39;</span><span class="p">)</span>
    <span class="n">p_values0_IC1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    
    <span class="c1">#Statistics on &#39;blank&#39; and &#39;IC2 trial&#39; in ICwcfg0 presentations</span>
    <span class="n">stat</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">mean_IC_0</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">len_IC1</span><span class="p">:],</span> <span class="n">mean_blank_0</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;greater&#39;</span><span class="p">)</span>
    <span class="n">p_values0_IC2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_IC_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sig_IC_1</span><span class="p">[:,:,</span> <span class="n">stim_time</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">mean_blank_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sig_blank_1</span><span class="p">[:,:,</span> <span class="n">stim_time</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">len_IC1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mean_IC_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

<span class="n">p_values1_IC1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">p_values1_IC2</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mean_IC_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="c1"># Statistics on &#39;blank&#39; and &#39;IC1 trial&#39; in ICwcfg1 presentations</span>
    <span class="n">stat</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">mean_IC_1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">len_IC1</span><span class="p">],</span> <span class="n">mean_blank_1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;greater&#39;</span><span class="p">)</span>
    <span class="n">p_values1_IC1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c1">#Statistics on &#39;blank&#39; and &#39;IC2 trial&#39; in ICwcfg1 presentations</span>
    <span class="n">stat</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">mean_IC_1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">len_IC1</span><span class="p">:],</span> <span class="n">mean_blank_1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;greater&#39;</span><span class="p">)</span>
    <span class="n">p_values1_IC2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_values_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">p_values0_IC1</span><span class="p">,</span> <span class="n">p_values0_IC2</span><span class="p">,</span> <span class="n">p_values1_IC1</span><span class="p">,</span> <span class="n">p_values1_IC2</span><span class="p">]</span>
<span class="n">p_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_signeurons</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_values_list</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_values_list</span><span class="p">):</span>
    <span class="n">p_values</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">IC_sig_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">p_values</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>order of IC_means and RE_means is <strong>0, 45, 90, 135 degree</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">len_IC0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">IC_0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="n">len_IC1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">IC_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="n">len_RE0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">RE_0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="n">len_RE1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">RE_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">IC_means</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">IC_0</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">len_IC0</span><span class="p">,</span> <span class="n">stim_time</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">IC_1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">len_IC1</span><span class="p">,</span> <span class="n">stim_time</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">IC_0</span><span class="p">[:,</span> <span class="n">len_IC0</span><span class="p">:</span><span class="n">len_IC0</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">stim_time</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">IC_1</span><span class="p">[:,</span> <span class="n">len_IC1</span><span class="p">:</span><span class="n">len_IC1</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">stim_time</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="p">]</span>


<span class="n">IC_combined_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">IC_means</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RE_means</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">RE_0</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">len_RE0</span><span class="p">,</span> <span class="n">stim_time</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">RE_1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">len_RE1</span><span class="p">,</span> <span class="n">stim_time</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">RE_0</span><span class="p">[:,</span> <span class="n">len_RE0</span><span class="p">:</span><span class="n">len_RE0</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">stim_time</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">RE_1</span><span class="p">[:,</span> <span class="n">len_RE1</span><span class="p">:</span><span class="n">len_RE1</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">stim_time</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="p">]</span>


<span class="n">RE_combined_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">RE_means</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RE_max_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">RE_combined_means</span><span class="p">[</span><span class="n">IC_sig_ind</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">IC_max_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">IC_combined_means</span><span class="p">[</span><span class="n">IC_sig_ind</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pref_ori</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">RE_combined_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">IC_combined_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
<span class="k">for</span> <span class="n">re_idx</span><span class="p">,</span> <span class="n">ic_idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">RE_max_idx</span><span class="p">,</span> <span class="n">IC_max_idx</span><span class="p">):</span>
    <span class="n">pref_ori</span><span class="p">[</span><span class="n">re_idx</span><span class="p">,</span> <span class="n">ic_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">orientations</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">135</span><span class="p">]</span>


<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">oris</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pref_ori</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Orientation Preference&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pref. IC Orientation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pref. RE Orientation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orientations</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">orientations</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orientations</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">orientations</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">oris</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;# Neurons&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/67136a37a097651eb969d23f2d149349a56c361fa5d16ef3638fdf417ca8bc55.png" src="../_images/67136a37a097651eb969d23f2d149349a56c361fa5d16ef3638fdf417ca8bc55.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "AllenInstitute/openscope_databook",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./projects"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="glo.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">OpenScope’s Global/Local Oddball Dataset</p>
      </div>
    </a>
    <a class="right-next"
       href="dendritic_coupling.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">OpenScope’s Dendritic Coupling Dataset</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">Environment Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-experiment">The Experiment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-ecephys-file">Downloading Ecephys File</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#showing-stim-templates">Showing Stim Templates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#showing-probe-tracks">Showing Probe Tracks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-units-spikes">Extracting Units Spikes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#session-timeline">Session Timeline</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-stimulus-times">Extracting Stimulus Times</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-spike-matrix">Generating Spike Matrix</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#showing-response-windows">Showing Response Windows</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-responsive-cells">Selecting Responsive Cells</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-receptive-fields">Getting Receptive Fields</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optotagging">Optotagging</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#openscope-illusion-publication-example-analysis-code">OpenScope Illusion publication: Example Analysis Code</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fig-1e-identifying-exclusively-center-responsive-v1-neurons">Fig. 1e : identifying exclusively center-responsive V1 neurons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-the-receptive-field-of-each-exclusively-center-responsive-v1-neuron">Plot the receptive field of each exclusively center-responsive V1 neuron</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-the-average-of-exclusively-center-responsive-v1-neurons">Plot the average of exclusively center-responsive V1 neurons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#figure-1f-stacked-peri-stimulus-time-histograms-psths-depicting-evoked-responses-to-i-c-and-i-re-images-for-exclusively-center-responsive-v1-neurons">Figure. 1f : stacked peri-stimulus time histograms (PSTHs) depicting evoked responses to <span class="math notranslate nohighlight">\(I_{C}\)</span> and <span class="math notranslate nohighlight">\(I_{RE}\)</span> images for exclusively center-responsive V1 neurons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fig-1g-for-exclusively-center-responsive-v1-neurons-that-are-also-responsive-to-at-least-one-of-the-four-i-c-images-compare-the-preferred-orientation-for-i-c-vs-i-re-images">Fig. 1g : for exclusively center-responsive V1 neurons that are also responsive to at least one of the four <span class="math notranslate nohighlight">\(I_{C}\)</span> images, compare the preferred orientation for <span class="math notranslate nohighlight">\(I_{C}\)</span> vs <span class="math notranslate nohighlight">\(I_{RE}\)</span> images</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Carter Peene
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>