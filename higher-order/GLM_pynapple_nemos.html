
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Introduction to Generalized Linear Models using Pynapple and NeMoS &#8212; OpenScope Databook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-TJPN1M4PDX"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-TJPN1M4PDX');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-TJPN1M4PDX');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'higher-order/GLM_pynapple_nemos';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Generalized Linear Models" href="glm.html" />
    <link rel="prev" title="Tensor Decomposition of Spiking Activity Through Trials" href="tca.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="OpenScope Databook - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="OpenScope Databook - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    OpenScope Databook
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../basics/background.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/download_nwb.html">Downloading an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/stream_nwb.html">Streaming an NWB File with remfile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/read_nwb.html">Reading an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/use_nwbwidgets.html">Exploring an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/get_dandiset_metadata.html">Getting Experimental Metadata from DANDI</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Visualizing NWB Files</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_2p_raw.html">Visualizing Raw 2-Photon Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_metrics.html">Visualizing Unit Quality Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_lfp_responses.html">Visualizing LFP Responses to Stimuli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_responses.html">Visualizing Neuronal Unit Responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_2p_responses.html">Visualizing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_spikes.html">Visualizing Neuronal Unit Spikes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_neuropixels_probes.html">Visualizing Neuropixels Probe Locations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_templates.html">Visualizing Stimulus Templates</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">First-Order Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../first-order/receptive_fields.html">Showing Receptive Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/optotagging.html">Identifying Optotagged Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/current_source_density.html">Current Source Density Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/classify_waveforms.html">Classifying Fast-Spiking and Regular-Spiking Neurons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/test_2p_responses.html">Statistically Testing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/test_unit_responses.html">Statistically Testing Spike Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/suite2p.html">Identifying Regions of Interest with Segmentation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Higher-Order Analysis</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="cebra_time.html">Using CEBRA-Time to Identify Latent Embeddings</a></li>
<li class="toctree-l1"><a class="reference internal" href="tca.html">Tensor Decomposition of Spiking Activity Through Trials</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Introduction to Generalized Linear Models using Pynapple and NeMoS</a></li>
<li class="toctree-l1"><a class="reference internal" href="glm.html">Generalized Linear Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="behavioral_state.html">Behavioral State from Trial Outcomes</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Openscope Experimental Projects</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../projects/cred_assign_figures.html">Replicating OpenScope Credit Assignment project figures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects/glo.html">OpenScope’s Global/Local Oddball Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects/illusion.html">OpenScope’s Illusion Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects/dendritic_coupling.html">OpenScope’s Dendritic Coupling Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects/sequence_learning.html">OpenScope’s Sequence Learning Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects/barcoding.html">Introduction to the Temporal Barcode Dataset</a></li>


<li class="toctree-l1"><a class="reference internal" href="../projects/vippo.html">OpenScope’s Vision2Hippocampus Dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Embargoed Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../embargoed/modality_alignment.html">Aligning Data across Modalities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/visualize_behavior.html">Visualizing Behavioral Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/test_2p_responses_embargoed.html">Statistically Testing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/cell_matching.html">Cell Matching Across Days</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Methods</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../methods/jupyter_book.html">Jupyter/Jupyter Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods/github.html">Git/GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods/environments.html">Managing Environments on Multiple Platforms</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../contribution.html">Contributing to the Databook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors_index.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html">FAQ</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/AllenInstitute/openscope_databook/main?urlpath=lab/tree/docs/higher-order/GLM_pynapple_nemos.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://hub.dandiarchive.org/hub/user-redirect/git-pull?repo=https%3A//github.com/AllenInstitute/openscope_databook&urlpath=lab/tree/openscope_databook/docs/higher-order/GLM_pynapple_nemos.ipynb&branch=main" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on JupyterHub"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="JupyterHub logo" src="../_static/images/logo_jupyterhub.svg">
  </span>
<span class="btn__text-container">JupyterHub</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/AllenInstitute/openscope_databook/blob/main/docs/higher-order/GLM_pynapple_nemos.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/AllenInstitute/openscope_databook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/AllenInstitute/openscope_databook/issues/new?title=Issue%20on%20page%20%2Fhigher-order/GLM_pynapple_nemos.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/higher-order/GLM_pynapple_nemos.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Introduction to Generalized Linear Models using Pynapple and NeMoS</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background-on-glms">Background on GLMs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup-and-library-imports">Environment setup and library imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-data">Download data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extraction-preprocessing-and-stimuli-revision">Extraction, preprocessing and stimuli revision</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-spiking-data">Extracting spiking data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-trial-structure">Extracting trial structure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing-spiking-data">Preprocessing spiking data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#revision-of-stimuli-and-spiking-data">Revision of stimuli and spiking data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#splitting-the-dataset-in-train-and-test">Splitting the dataset in train and test</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fitting-a-glm">Fitting a GLM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-the-data-for-nemos">Preparing the data for <strong>NeMoS</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#constructing-the-design-matrix-using-basis-functions">Constructing the design matrix using basis functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#initialize-and-fit-a-glm-single-unit">Initialize and fit a GLM: single unit</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assess-glm-performance-predict-and-psth">Assess GLM performance: predict and PSTH</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#initialize-and-fit-a-glm-populationglm">Initialize and fit a GLM: <code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assess-populationglm-performance-psth">Assess <code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code> performance: PSTH</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-coupling-as-a-new-predictor">Adding coupling as a new predictor</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assess-coupling-populationglm-performance-heatmap">Assess coupling <code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code> performance: heatmap</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-model-performance-quantitatively-pseudo-r-2-mcfadden">Evaluate model performance quantitatively: Pseudo-<span class="math notranslate nohighlight">\(R^2\)</span> McFadden</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#food-for-thought">Food for thought</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-citation">Data citation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resources">Resources</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="introduction-to-generalized-linear-models-using-pynapple-and-nemos">
<h1>Introduction to Generalized Linear Models using <a class="reference external" href="https://pynapple.org">Pynapple</a> and <a class="reference external" href="https://nemos.readthedocs.io/en/latest/">NeMoS</a><a class="headerlink" href="#introduction-to-generalized-linear-models-using-pynapple-and-nemos" title="Link to this heading">#</a></h1>
<div class="sd-card sd-sphinx-override sd-mb-3 sd-shadow-sm docutils">
<div class="sd-card-body docutils">
<p class="sd-card-text">Authors: Camila Maura, Edoardo Balzani &amp; Guillaume Viejo</p>
</div>
</div>
<p>In this notebook, we will use <a class="reference external" href="https://pynapple.org"><strong>Pynapple</strong></a> and <a class="reference external" href="https://nemos.readthedocs.io/en/latest/"><strong>NeMoS</strong></a> packages (supported by the <a class="reference external" href="https://neurorse.flatironinstitute.org">Flatiron Institute</a>), to model spiking neural data using <a class="reference external" href="https://en.wikipedia.org/wiki/Generalized_linear_model">Generalized Linear Models (GLM)</a>. We will explain what GLMs are and which are their components, then use <strong>Pynapple</strong> and <strong>NeMoS</strong> python packages to preprocess real data from the Primary Visual Cortex (VISp) of mice, and use a GLM model to predict spiking neural data as a function of passive visual stimuli. We will also show how, if you have recordings from a large population of neurons simultaneously, you can build connections between the neurons into the GLM in the form of coupling filters.</p>
<p>We will be analyzing data from the <a class="reference external" href="https://portal.brain-map.org/circuits-behavior/visual-coding-neuropixels">Visual Coding - Neuropixels dataset</a>, published by the Allen Institute. This dataset uses <a class="reference external" href="https://www.nature.com/articles/nature24636">extracellular electrophysiology probes</a> to record spikes from multiple regions in the brain during passive visual stimulation. For simplicity, we will focus on the activity of neurons in the visual cortex (VISp) during passive exposure to full-field flashes of color either black (coded as “-1.0”) or white (coded as “1.0”) in a gray background.</p>
<p>We have three main goals in this notebook:</p>
<ol class="arabic simple">
<li><p>Introduce the key components of Generalized Linear Models (GLMs),</p></li>
<li><p>Demonstrate how to pre-process real experimental data recorded from mice using <strong>Pynapple</strong>, and</p></li>
<li><p>Use <strong>NeMoS</strong> to fit GLMs to that data and explore model-based insights.</p></li>
</ol>
<p>By the end of this notebook, you should have a clearer understanding of the fundamental building blocks of GLMs, as well as how <strong>Pynapple</strong> and <strong>NeMoS</strong> can streamline the process of modeling and analyzing neural data, making it a much more accessible and efficient endeavor.</p>
<section id="background-on-glms">
<h2>Background on GLMs<a class="headerlink" href="#background-on-glms" title="Link to this heading">#</a></h2>
<p>A GLM is a regression model which trains a filter to predict a value (output) as it relates to some other variable (or input). In the neuroscience context, we can use a particular type of GLM to predict spikes: the linear-nonlinear-Poisson (LNP) model. This type of model receives one or more inputs and then sends them through a linear  “filter” or transformation, passes said transformation through a nonlinearity to get the firing rate and uses that firing rate as the mean of a Poisson distribution to generate spikes. We will go through each of these steps one by one:</p>
<p><img alt="LNP model schematic" src="../_images/lnp_model.png" /></p>
<div style="text-align: center;">
<p>LNP model schematic. Modified from <span id="id1">Pillow <em>et al.</em> [<a class="reference internal" href="../bibliography.html#id5" title="Jonathan W. Pillow, Jonathon Shlens, Liam Paninski, Alexander Sher, Alan M. Litke, E. J. Chichilnisky, and Eero P. Simoncelli. Spatio-temporal correlations and visual signalling in a complete neuronal population. Nature, 454(7207):995–999, 2008. doi:10.1038/nature07140.">2008</a>]</span>
<span id="cite1a"></span><a href="#ref1">[1a]</a>.</p>
</div>
<ol class="arabic">
<li><p>Sends the inputs through a linear “filter” or transformation</p>
<p>The inputs (also known as “predictors” or “filters”) are first passed through a linear transformation:</p>
<div class="math notranslate nohighlight">
\[
    \begin{aligned}
    L(X) = WX + c
    \end{aligned}
    \]</div>
<p>Where <span class="math notranslate nohighlight">\(X\)</span> is the input (in matrix form), <span class="math notranslate nohighlight">\(W\)</span> is a matrix and <span class="math notranslate nohighlight">\(c\)</span> is a vector (intercept).</p>
<p><span class="math notranslate nohighlight">\(L\)</span> scales (makes bigger or smaller) or shifts (up or down) the input. When there is zero input, this is equivalent to changing the baseline rate of the neuron, which is how the intercept should be interpreted. So far, this is the same treatment of an ordinary linear regression.</p>
</li>
<li><p>Passes the transformation through a nonlinearity to get the firing rate.</p>
<p>The aim of a LNP model is to predict the firing rate of a neuron and use it to generate spikes, but if we were only to keep <span class="math notranslate nohighlight">\(L(X)\)</span> as it is, we would quickly notice that we could obtain negative values for firing rates, which makes no sense! This is what the nonlinearity part of the model handles: by passing the linear transformation through an exponential function, it is assured that the resulting firing rate will always be non-negative.</p>
<p>As such, the firing rate in a LNP model is defined:</p>
<div class="math notranslate nohighlight">
\[
    \begin{aligned}
    \lambda =  exp(L(X))
    \end{aligned}
    \]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda\)</span> is a vector containing the firing rates corresponding to each timepoint.</p>
</li>
</ol>
<div class="dropdown admonition">
<p class="admonition-title">A note on nonlinearity</p>
<p>In <strong>NeMoS</strong>, the nonlinearity is kept fixed. We default to the exponential, but a small number of other choices, such as soft-plus, are allowed. The allowed choices guarantee both the non-negativity constraint described above, as well as convexity, i.e. a single optimal solution. In principle, one could choose a more complex nonlinearity, but convexity is not guaranteed in general.</p>
</div>
<div class="dropdown admonition">
<p class="admonition-title">What is the difference between a “link function” and the “nonlinearity”?</p>
<p>The link function states the relationship between the linear predictor and the mean of the distribution function. If <span class="math notranslate nohighlight">\(g\)</span> is a link function, <span class="math notranslate nohighlight">\(L(⋅)\)</span> is the linear predictor and <span class="math notranslate nohighlight">\(\lambda\)</span> the mean of the distribution function:</p>
<div class="math notranslate nohighlight">
\[
\begin{aligned}
g(\lambda) = L(⋅)
\end{aligned}
\]</div>
<div class="math notranslate nohighlight">
\[
\begin{aligned}
\lambda = g^{-1}(L(⋅))
\end{aligned}
\]</div>
<p>the “nonlinearity” is the name for the inverse of the link function <span class="math notranslate nohighlight">\(g^{-1}(⋅)\)</span>.</p>
</div>
<ol class="arabic" start="3">
<li><p>Uses the firing rate as the mean of a Poisson distribution to generate spikes</p>
<p>In this type of GLM, each spike train is modeled as a sample from a Poisson distribution whose mean is the firing rate — that is, the output of the linear-nonlinear components of the model.</p>
<p>Spiking is a stochastic process. This means that a given firing rate can lead to many different possible spike trains. Since the model could generate an infinite number of spike train realizations, how do we evaluate how well it explains the single observed spike train? We do this by computing the log-likelihood: it quantifies how likely it is to observe the actual spike train given the predicted firing rate. If <span class="math notranslate nohighlight">\( y(t) \)</span> is the observed spike count and <span class="math notranslate nohighlight">\( \lambda(t) \)</span> is the predicted firing rate at time <span class="math notranslate nohighlight">\( t \)</span>, then the log-likelihood at time <span class="math notranslate nohighlight">\( t \)</span>:</p>
<div class="math notranslate nohighlight">
\[
    \log P(y(t) \mid \lambda(t)) = y(t)\log\lambda(t) - \lambda(t) -\log(y(t)!)
    \]</div>
<p>However, the term <span class="math notranslate nohighlight">\( -\log(y(t)!) \)</span> does not depend on <span class="math notranslate nohighlight">\( \lambda \)</span>, and therefore is constant with respect to the model. As a result, it is usually dropped during optimization, leaving us with the simplified log-likelihood:</p>
<div class="math notranslate nohighlight">
\[
    \log P(y(t) \mid \lambda(t)) = y(t) \log \lambda(t) - \lambda(t)
    \]</div>
<p>This forms the loss function for LNPs. In practice, we aim to maximize this log-likelihood, which is equivalent to minimizing the negative log-likelihood — that is, finding the firing rate <span class="math notranslate nohighlight">\(\lambda(t)\)</span> that makes the observed spike train as likely as possible under the model.</p>
</li>
</ol>
<div class="dropdown admonition">
<p class="admonition-title">Why using GLMs?</p>
<ol class="arabic simple">
<li><p>Why not just use linear regression? Because neural data breaks its key assumptions. Linear regression expects normally distributed data with constant variance, but spike counts are non-Gaussian. Even more problematic, neural variability isn’t constant: neurons that fire more frequently also tend to be more variable. This violates the homoscedasticity assumption that’s fundamental to linear regression, making GLMs a much more suitable framework for modeling neural activity.</p></li>
<li><p>GLMs are as easy to fit as linear regression! The objective function (negative log-likelihood) of GLMs with canonical link functions (such as log link which we are using here) is convex, which means there is one local minimum and no local maxima, ensuring convergence to the right answer.</p></li>
</ol>
</div>
<div class="dropdown admonition">
<p class="admonition-title">More resources on GLMs</p>
<p>If you would like to learn more about GLMs, you can refer to:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://NeMoS.readthedocs.io/en/latest/background/plot_00_conceptual_intro.html">NeMoS GLM tutorial</a>: for a bit more detailed explanation of all the components of a GLM within the <strong>NeMoS</strong> framework, as well as some nice visualizations of all the steps of the input transformation!</p></li>
<li><p><a class="reference external" href="https://flatironinstitute.github.io/neurorse-workshops/workshops/jan-2025/branch/main/full/day2/current_injection.html">Introduction to GLM - CCN software workshop by the Flatiron Institute</a>: for a step by step example of using GLMs to fit the activity of a single neuron in VISp under current injection.</p></li>
<li><p><a class="reference external" href="https://compneuro.neuromatch.io/tutorials/W1D3_GeneralizedLinearModels/student/W1D3_Tutorial1.html">Neuromatch Academy GLM tutorial</a>: for a bit  more detailed explanation of the components of a GLM, slides and some coding exercises to ensure comprehension.</p></li>
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=NFeGW5ljUoI&amp;amp;t=4230s">Jonathan Pillow’s COSYNE tutorial</a>: for a longer tutorial of all of the components of a GLM, as well as different types of GLM besides LNP</p></li>
</ul>
</div>
</section>
<section id="environment-setup-and-library-imports">
<h2>Environment setup and library imports<a class="headerlink" href="#environment-setup-and-library-imports" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install requirements for the databook</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">databook_utils.dandi_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">dandi_download_open</span>
<span class="k">except</span><span class="p">:</span>
    <span class="o">!</span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/AllenInstitute/openscope_databook.git
    <span class="o">%</span><span class="k">cd</span> openscope_databook
    <span class="o">%</span><span class="k">pip</span> install -e .
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\ntry:\n    from databook_utils.dandi_utils import dandi_download_open\nexcept:\n    !git clone https://github.com/AllenInstitute/openscope_databook.git\n    %cd openscope_databook\n    %pip install -e .\n&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">zscore</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pynapple</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nap</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nemos</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nmo</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Imports for ease of visualization</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaxNLocator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_kde</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Patch</span>

<span class="c1"># Parameters for plotting</span>
<span class="n">custom_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;axes.spines.right&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;axes.spines.top&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;ticks&quot;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;colorblind&quot;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">rc</span><span class="o">=</span><span class="n">custom_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="download-data">
<h2>Download data<a class="headerlink" href="#download-data" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dataset information</span>
<span class="n">dandiset_id</span> <span class="o">=</span> <span class="s2">&quot;000021&quot;</span>
<span class="n">dandi_filepath</span> <span class="o">=</span> <span class="s2">&quot;sub-726298249/sub-726298249_ses-754829445.nwb&quot;</span>
<span class="n">download_loc</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>

<span class="c1"># Download the data using NeMoS</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">fetch</span><span class="o">.</span><span class="n">download_dandi_data</span><span class="p">(</span><span class="n">dandiset_id</span><span class="p">,</span> <span class="n">dandi_filepath</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have downloaded the data, it is very simple to open the dataset with <strong>Pynapple</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">NWBFile</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">lazy_loading</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">nwb</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">nwb</span>

<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>754829445
┍━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┯━━━━━━━━━━━━━┑
│ Keys                                               │ Type        │
┝━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━┥
│ units                                              │ TsGroup     │
│ static_gratings_presentations                      │ IntervalSet │
│ spontaneous_presentations                          │ IntervalSet │
│ natural_scenes_presentations                       │ IntervalSet │
│ natural_movie_three_presentations                  │ IntervalSet │
│ natural_movie_one_presentations                    │ IntervalSet │
│ gabors_presentations                               │ IntervalSet │
│ flashes_presentations                              │ IntervalSet │
│ drifting_gratings_presentations                    │ IntervalSet │
│ timestamps                                         │ Tsd         │
│ running_wheel_rotation                             │ Tsd         │
│ running_speed_end_times                            │ Tsd         │
│ running_speed                                      │ Tsd         │
│ raw_gaze_mapping/screen_coordinates_spherical      │ TsdFrame    │
│ raw_gaze_mapping/screen_coordinates                │ TsdFrame    │
│ raw_gaze_mapping/pupil_area                        │ Tsd         │
│ raw_gaze_mapping/eye_area                          │ Tsd         │
│ optogenetic_stimulation                            │ IntervalSet │
│ optotagging                                        │ Tsd         │
│ filtered_gaze_mapping/screen_coordinates_spherical │ TsdFrame    │
│ filtered_gaze_mapping/screen_coordinates           │ TsdFrame    │
│ filtered_gaze_mapping/pupil_area                   │ Tsd         │
│ filtered_gaze_mapping/eye_area                     │ Tsd         │
│ running_wheel_supply_voltage                       │ Tsd         │
│ running_wheel_signal_voltage                       │ Tsd         │
│ raw_running_wheel_rotation                         │ Tsd         │
┕━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┷━━━━━━━━━━━━━┙
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title"><strong>Pynapple</strong> objects</p>
<p>When printing data, we can see four type of <strong>Pynapple</strong> objects:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://pynapple.org/generated/pynapple.TsGroup.html#pynapple.TsGroup"><code class="docutils literal notranslate"><span class="pre">TsGroup</span></code></a> : Dictionary-like object to group objects with different timestamps</p></li>
<li><p><a class="reference external" href="https://pynapple.org/generated/pynapple.IntervalSet.html#pynapple.IntervalSet"><code class="docutils literal notranslate"><span class="pre">IntervalSet</span></code></a> : A class representing a (irregular) set of time intervals in elapsed time, with relative operations</p></li>
<li><p><a class="reference external" href="https://pynapple.org/generated/pynapple.Tsd.html#pynapple.Tsd"><code class="docutils literal notranslate"><span class="pre">Tsd</span></code></a> : 1-dimensional container for neurophysiological time series - provides standardized time representation, plus various functions for manipulating times series.</p></li>
<li><p><a class="reference external" href="https://pynapple.org/generated/pynapple.TsdFrame.html#pynapple.TsdFrame"><code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code></a> : Column-based container for neurophysiological time series</p></li>
</ul>
<p>To learn more, please refer to the <a class="reference external" href="https://pynapple.org"><strong>Pynapple</strong> documentation</a></p>
</div>
</section>
<section id="extraction-preprocessing-and-stimuli-revision">
<h2>Extraction, preprocessing and stimuli revision<a class="headerlink" href="#extraction-preprocessing-and-stimuli-revision" title="Link to this heading">#</a></h2>
<section id="extracting-spiking-data">
<h3>Extracting spiking data<a class="headerlink" href="#extracting-spiking-data" title="Link to this heading">#</a></h3>
<p>We have a lot of information in <code class="docutils literal notranslate"><span class="pre">data</span></code>, but we are interested in the units.</p>
<p>(it might take a while the first time that you run this - it’s okay! the dataset is quite big)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">units</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span>

<span class="c1"># See the columns</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;columns : </span><span class="si">{</span><span class="n">units</span><span class="o">.</span><span class="n">metadata_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># See the dataset</span>
<span class="nb">print</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>columns : [&#39;rate&#39;, &#39;spread&#39;, &#39;velocity_below&#39;, &#39;silhouette_score&#39;, &#39;firing_rate&#39;, &#39;d_prime&#39;, &#39;nn_hit_rate&#39;, &#39;waveform_duration&#39;, &#39;amplitude&#39;, &#39;cluster_id&#39;, &#39;snr&#39;, &#39;local_index&#39;, &#39;peak_channel_id&#39;, &#39;PT_ratio&#39;, &#39;presence_ratio&#39;, &#39;max_drift&#39;, &#39;cumulative_drift&#39;, &#39;repolarization_slope&#39;, &#39;waveform_halfwidth&#39;, &#39;amplitude_cutoff&#39;, &#39;nn_miss_rate&#39;, &#39;quality&#39;, &#39;velocity_above&#39;, &#39;isolation_distance&#39;, &#39;l_ratio&#39;, &#39;recovery_slope&#39;, &#39;isi_violations&#39;]
Index      rate      spread    velocity_below    silhouette_score    firing_rate    d_prime    nn_hit_rate    ...
---------  --------  --------  ----------------  ------------------  -------------  ---------  -------------  -----
951763702  2.38003   30.0      nan               nan                 2.38           4.77       0.98           ...
951763707  0.01147   80.0      nan               0.03                0.01           3.48       0.0            ...
951763711  3.1503    50.0      nan               0.17                3.15           6.08       1.0            ...
951763715  6.53      40.0      nan               0.12                6.53           5.04       0.99           ...
951763720  2.00296   40.0      0.0               0.2                 2.0            6.45       0.99           ...
951763724  8.66233   60.0      -7.55             0.22                8.66           3.1        0.86           ...
951763729  11.13402  30.0      -0.69             0.01                11.13          4.61       0.98           ...
...        ...       ...       ...               ...                 ...            ...        ...            ...
951777559  0.02108   110.0     -2.59             nan                 0.02           2.95       0.0            ...
951777565  0.08143   140.0     0.46              nan                 0.08           4.37       0.29           ...
951777571  0.20088   70.0      0.69              nan                 0.2            6.03       0.82           ...
951777576  0.01085   80.0      -0.96             nan                 0.01           2.28       nan            ...
951777582  0.1457    140.0     -3.49             -0.08               0.15           5.2        0.43           ...
951777593  0.0464    90.0      nan               nan                 0.05           3.83       0.59           ...
951777600  0.0621    60.0      -0.69             nan                 0.06           6.12       0.25           ...
</pre></div>
</div>
</div>
</div>
<p>Taking a closer look at the columns, we can see there is a lot of information we do not need. We are solely interested in predicting the spiking activity from the neurons from VISp. Thus, we will remove the metadata from all columns except for rate, quality (to make sure we filter the bad-quality neurons) and peak_channel_id (this last one contains relevant information for brain area identification).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">restrict_cols</span><span class="p">(</span><span class="n">cols_to_keep</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">cols_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">metadata_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols_to_keep</span><span class="p">]</span>
    <span class="n">data</span><span class="o">.</span><span class="n">drop_info</span><span class="p">(</span><span class="n">cols_to_remove</span><span class="p">)</span>
    
<span class="c1"># Choose which columns to remove and remove them</span>
<span class="n">cols_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rate&#39;</span><span class="p">,</span> <span class="s1">&#39;quality&#39;</span><span class="p">,</span><span class="s1">&#39;peak_channel_id&#39;</span><span class="p">]</span>
<span class="n">restrict_cols</span><span class="p">(</span><span class="n">cols_to_keep</span><span class="p">,</span><span class="n">units</span><span class="p">)</span>

<span class="c1"># See the dataset</span>
<span class="nb">print</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index      rate      peak_channel_id    quality
---------  --------  -----------------  ---------
951763702  2.38003   850135036          good
951763707  0.01147   850135036          noise
951763711  3.1503    850135038          good
951763715  6.53      850135038          good
951763720  2.00296   850135044          good
951763724  8.66233   850135044          noise
951763729  11.13402  850135044          noise
...        ...       ...                ...
951777559  0.02108   850139336          good
951777565  0.08143   850139526          noise
951777571  0.20088   850139738          good
951777576  0.01085   850139338          good
951777582  0.1457    850139622          good
951777593  0.0464    850139620          good
951777600  0.0621    850139642          good
</pre></div>
</div>
</div>
</div>
<p>Here we do not have the brain area information but we need it, so we need to do some preprocessing to extract brain area from the nwb object using the peak_channel_id metadata. Luckily, <strong>Pynapple</strong> stored the nwb object as well.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Units and brain areas those units belong to are in two different places. </span>
<span class="c1"># With the electrodes table, we can map units to their corresponding brain regions.</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_unit_location</span><span class="p">(</span><span class="n">unit_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aligns location information from electrodes table with channel id from the units table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">channel_probes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span><span class="o">.</span><span class="n">peak_channel_id</span><span class="p">)]</span>

<span class="n">channel_probes</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">electrodes</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">electrodes</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">electrodes</span><span class="p">)):</span>
    <span class="n">channel_id</span> <span class="o">=</span> <span class="n">electrodes</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">electrodes</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="n">channel_probes</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">location</span>

<span class="c1"># Add a new column to include location in our spikes TsGroup</span>
<span class="n">units</span><span class="o">.</span><span class="n">brain_area</span> <span class="o">=</span> <span class="p">[</span><span class="n">channel_probes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ch_id</span><span class="p">)]</span> <span class="k">for</span> <span class="n">ch_id</span> <span class="ow">in</span> <span class="n">units</span><span class="o">.</span><span class="n">peak_channel_id</span><span class="p">]</span>

<span class="c1"># Remove peak_channel_id because we already got the brain_area information</span>
<span class="n">units</span><span class="o">.</span><span class="n">drop_info</span><span class="p">(</span><span class="s2">&quot;peak_channel_id&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index      rate      quality    brain_area
---------  --------  ---------  ------------
951763702  2.38003   good       PoT
951763707  0.01147   noise      PoT
951763711  3.1503    good       PoT
951763715  6.53      good       PoT
951763720  2.00296   good       PoT
951763724  8.66233   noise      PoT
951763729  11.13402  noise      PoT
...        ...       ...        ...
951777559  0.02108   good       LP
951777565  0.08143   noise      DG
951777571  0.20088   good       VISpm
951777576  0.01085   good       LP
951777582  0.1457    good       CA1
951777593  0.0464    good       CA1
951777600  0.0621    good       CA1
</pre></div>
</div>
</div>
</div>
</section>
<section id="extracting-trial-structure">
<h3>Extracting trial structure<a class="headerlink" href="#extracting-trial-structure" title="Link to this heading">#</a></h3>
<p>Mice were exposed to a series of stimuli (gabor patches, flashes, natural images, etc.), out of which we are exclusively interested in flashes presentation for this tutorial.</p>
<p><img alt="visual_stimuli_set.png" src="../_images/visual_stimuli_set.png" /></p>
<div style="text-align: center;">
<p>Visual stimuli set. Modified from <span id="id2">Allen Institute for Brain Science [<a class="reference internal" href="../bibliography.html#id2" title="Allen Institute for Brain Science. Allen brain observatory - neuropixels visual coding - technical white paper. Technical Report, Allen Institute for Brain Science, October 2019. URL: https://brainmapportal-live-4cc80a57cd6e400d854-f7fdcae.divio-media.net/filer_public/80/75/8075a100-ca64-429a-b39a-569121b612b2/neuropixels_visual_coding_-_white_paper_v10.pdf.">2019</a>]</span> <span id="cite2"></span><a href="#ref2">[2]</a>.</p>
</div>
<p>During the flashes presentation trials, mice were exposed to white or black full-field flashes in a gray background, each lasting 250 ms, and separated by a 2 second inter-trial interval. In total, they were exposed to 150 flashes (75 black, 75 white).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract flashes as an Interval Set object</span>
<span class="n">flashes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;flashes_presentations&quot;</span><span class="p">]</span>

<span class="c1"># Remove unnecessary columns, similarly to above</span>
<span class="n">cols_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>
<span class="n">restrict_cols</span><span class="p">(</span><span class="n">cols_to_keep</span><span class="p">,</span> <span class="n">flashes</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">flashes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>index    start           end             color
0        1285.600869922  1285.851080039  -1.0
1        1287.602559922  1287.852767539  -1.0
2        1289.604229922  1289.854435039  -1.0
3        1291.605889922  1291.856100039  -1.0
4        1293.607609922  1293.857807539  1.0
5        1295.609249922  1295.859455039  -1.0
6        1297.610959922  1297.861155039  1.0
...      ...             ...             ...
143      1571.840009922  1572.090212539  -1.0
144      1573.841669922  1574.091877539  1.0
145      1575.843359922  1576.093562539  1.0
146      1577.845019922  1578.095227539  -1.0
147      1579.846709922  1580.096915039  1.0
148      1581.848389922  1582.098595039  1.0
149      1583.850039922  1584.100247539  -1.0
shape: (150, 2), time unit: sec.
</pre></div>
</div>
</div>
</div>
<p>Create an object for white and a separate object for black flashes</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flashes_white</span> <span class="o">=</span> <span class="n">flashes</span><span class="p">[</span><span class="n">flashes</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1.0&quot;</span><span class="p">]</span>
<span class="n">flashes_black</span> <span class="o">=</span> <span class="n">flashes</span><span class="p">[</span><span class="n">flashes</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-1.0&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_stimuli</span><span class="p">():</span>
    <span class="n">n_flashes</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">n_seconds</span> <span class="o">=</span> <span class="mi">13</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mf">.5</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;flashes_presentations&quot;</span><span class="p">][</span><span class="s2">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">offset</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">n_seconds</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;silver&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.4</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">flashes_white</span><span class="p">[:</span><span class="n">n_flashes</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">flashes_white</span><span class="p">[:</span><span class="n">n_flashes</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.4</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">flashes_black</span><span class="p">[:</span><span class="n">n_flashes</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">flashes_black</span><span class="p">[:</span><span class="n">n_flashes</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">)]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Absent = 0, Present = 1&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Stimuli presentation&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">integer</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">start</span><span class="o">-</span><span class="mf">.1</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>And we can plot the stimuli</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_stimuli</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/25e2694b05c5f8289b515ed5f670daf72ae399cc0a97ae928941583c5474bad3.png" src="../_images/25e2694b05c5f8289b515ed5f670daf72ae399cc0a97ae928941583c5474bad3.png" />
</div>
</div>
<p>To analyze how units’ activity evolves around the time of stimulus presentation, we can extend each stimulus interval to include some time before and after the flash. Specifically, we add 500 ms before the flash onset and 500 ms after the flash offset. This gives us a window that captures pre-stimulus baseline activity and any delayed neural responses.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dt</span> <span class="o">=</span> <span class="mf">.50</span> <span class="c1"># 500 ms</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">flashes</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">dt</span> <span class="c1"># Start 500 ms before stimulus presentation</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">flashes</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="n">dt</span> <span class="c1"># End 500 ms after stimulus presentation</span>

<span class="n">extended_flashes</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">flashes</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="n">extended_flashes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>index    start           end             color
0        1285.100869922  1286.351080039  -1.0
1        1287.102559922  1288.352767539  -1.0
2        1289.104229922  1290.354435039  -1.0
3        1291.105889922  1292.356100039  -1.0
4        1293.107609922  1294.357807539  1.0
5        1295.109249922  1296.359455039  -1.0
6        1297.110959922  1298.361155039  1.0
...      ...             ...             ...
143      1571.340009922  1572.590212539  -1.0
144      1573.341669922  1574.591877539  1.0
145      1575.343359922  1576.593562539  1.0
146      1577.345019922  1578.595227539  -1.0
147      1579.346709922  1580.596915039  1.0
148      1581.348389922  1582.598595039  1.0
149      1583.350039922  1584.600247539  -1.0
shape: (150, 2), time unit: sec.
</pre></div>
</div>
</div>
</div>
<p>This extended IntervalSet, <code class="docutils literal notranslate"><span class="pre">extended_flashes</span></code>, will later allow us to restrict units’ activity to the periods surrounding each flash stimulus.</p>
<p>We now create one object for white and another for black extended flashes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">extended_flashes_white</span> <span class="o">=</span> <span class="n">extended_flashes</span><span class="p">[</span><span class="n">extended_flashes</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;1.0&quot;</span><span class="p">]</span>
<span class="n">extended_flashes_black</span> <span class="o">=</span> <span class="n">extended_flashes</span><span class="p">[</span><span class="n">extended_flashes</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;-1.0&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="preprocessing-spiking-data">
<h3>Preprocessing spiking data<a class="headerlink" href="#preprocessing-spiking-data" title="Link to this heading">#</a></h3>
<p>There are multiple reasons for filtering units. Here, we will use four criteria: brain area, quality of units, firing rate and responsiveness</p>
<ol class="arabic simple">
<li><p>Brain area: we are interested in analyzing VISp units for this tutorial</p></li>
<li><p>Quality: we will only select “good” quality units</p></li>
<li><p>Firing rate: overall, we want units with a firing rate larger than 2Hz around the presentation of stimuli</p></li>
<li><p>Responsiveness: for the purposes of the tutorial, we will select the most responsive units (top 15%), and only use those for further analysis. We define responsiveness as the normalized difference between post stimulus and pre stimulus average firing rate.</p></li>
</ol>
<div class="dropdown admonition">
<p class="admonition-title">What does it mean for a unit to be of “good” quality?</p>
<p>More information on unit quality metrics can be found in <a class="reference internal" href="../visualization/visualize_unit_metrics.html"><span class="std std-doc">Visualizing Unit Quality Metrics </span></a></p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filter units according criteria 1 &amp; 2</span>
<span class="n">units</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span>
    <span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;brain_area&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;VISp&quot;</span><span class="p">)</span> <span class="o">&amp;</span> 
    <span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;quality&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;good&quot;</span><span class="p">)</span>
<span class="p">]</span> 

<span class="c1"># Restrict around stimuli presentation</span>
<span class="n">units</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">extended_flashes</span><span class="p">)</span> 

<span class="c1"># Filter according to criterion 3</span>
<span class="n">units</span> <span class="o">=</span> <span class="n">units</span><span class="p">[(</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">2.0</span><span class="p">)]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index      rate      quality    brain_area
---------  --------  ---------  ------------
951765440  2.32495   good       VISp
951765454  22.6523   good       VISp
951765460  2.29829   good       VISp
951765467  25.80912  good       VISp
951765485  22.96158  good       VISp
951765547  2.83687   good       VISp
951765552  5.69507   good       VISp
...        ...       ...        ...
951768823  5.40712   good       VISp
951768830  7.58276   good       VISp
951768835  5.60442   good       VISp
951768881  4.01534   good       VISp
951768894  4.2713    good       VISp
951769295  2.23963   good       VISp
951769344  2.91152   good       VISp
</pre></div>
</div>
</div>
</div>
<p>Now, to calculate responsiveness, we need to do some preprocessing to align units’ spiking timestamps with the onset of the stimulus repetitions, and then take an average over them. For this, we will use the <a class="reference external" href="https://pynapple.org/generated/pynapple.process.perievent.html#pynapple.process.perievent.compute_perievent"><code class="docutils literal notranslate"><span class="pre">compute_perievent</span></code></a> function, which allows us to re-center time series and timestamps around particular events and compute spikes-triggered averages.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set window of perievent 500 ms before and after the start of the event</span>
<span class="n">window_size</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">.250</span><span class="p">,</span> <span class="mf">.500</span><span class="p">)</span> 

<span class="c1"># Re-center timestamps for white stimuli</span>
<span class="c1"># +50 because we subtracted 500 ms at beginning of stimulus presentation</span>
<span class="n">peri_white</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent</span><span class="p">(</span><span class="n">timestamps</span> <span class="o">=</span> <span class="n">units</span><span class="p">,</span>
                                        <span class="n">tref</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">extended_flashes_white</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span><span class="mf">.50</span><span class="p">),</span> 
                                        <span class="n">minmax</span> <span class="o">=</span> <span class="n">window_size</span>
<span class="p">)</span>

<span class="c1"># Re-center timestamps for black stimuli</span>
<span class="c1"># +50 because we subtracted 500 ms at beginning of stimulus presentation</span>
<span class="n">peri_black</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent</span><span class="p">(</span><span class="n">timestamps</span> <span class="o">=</span> <span class="n">units</span><span class="p">,</span>
                                        <span class="n">tref</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">extended_flashes_black</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span><span class="mf">.50</span><span class="p">),</span> 
                                        <span class="n">minmax</span> <span class="o">=</span> <span class="n">window_size</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The output of the perievent is a dictionary of <a class="reference external" href="https://pynapple.org/generated/pynapple.TsGroup.html#pynapple.TsGroup"><code class="docutils literal notranslate"><span class="pre">TsGroup</span></code></a> objects, indexed by each unit ID.</p>
<div class="dropdown admonition">
<p class="admonition-title">Will the output of <code class="docutils literal notranslate"><span class="pre">compute_perievent</span></code> always be a dictionary?</p>
<p>No. In this case it is because the input was a <code class="docutils literal notranslate"><span class="pre">TsGroup</span></code> containing the spiking information of multiple units. Had it been a <code class="docutils literal notranslate"><span class="pre">Ts/Tsd/TsdFrame/TsdTensor</span></code> (only one unit), then the output of <a class="reference external" href="https://pynapple.org/generated/pynapple.process.perievent.html#pynapple.process.perievent.compute_perievent"><code class="docutils literal notranslate"><span class="pre">compute_perievent</span></code></a> would have been a <code class="docutils literal notranslate"><span class="pre">TsGroup</span></code>.
For more information, please refer to <a class="reference external" href="https://pynapple.org/generated/pynapple.process.perievent.html#pynapple.process.perievent.compute_perievent"><strong>Pynapple</strong> documentation for processing perievents</a>.</p>
</div>
<p>When we index an element of this dictionary, we retrieve the spike times aligned to stimulus onset for a single unit, across all repetitions of the stimulus. These spike times are centered around the stimulus within the specified <code class="docutils literal notranslate"><span class="pre">window_size</span></code>. You’ll notice that the <code class="docutils literal notranslate"><span class="pre">ref_times</span></code> in the perievent output correspond exactly to the start times of the stimulus presentations!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s select one unit</span>
<span class="n">example_id</span> <span class="o">=</span> <span class="mi">951765485</span> 
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of trials: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">peri_black</span><span class="p">[</span><span class="n">example_id</span><span class="p">])</span><span class="si">}</span><span class="se">\n</span><span class="s2"> &quot;</span><span class="p">)</span>

<span class="c1"># And print it&#39;s rates</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TsGroup of centered activity for unit </span><span class="si">{</span><span class="n">example_id</span><span class="si">}</span><span class="s2">: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">peri_black</span><span class="p">[</span><span class="n">example_id</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Start times of black flashes presentation</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;black flashes start times: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">flashes_black</span><span class="o">.</span><span class="n">starts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of trials: 75
 
TsGroup of centered activity for unit 951765485: 
 Index    rate      ref_times
-------  --------  -----------
0        18.66667  1285.6
1        18.66667  1287.6
2        12.0      1289.6
3        9.33333   1291.61
4        32.0      1295.61
5        20.0      1303.62
6        18.66667  1307.62
...      ...       ...
68       13.33333  1561.83
69       6.66667   1563.83
70       8.0       1565.83
71       12.0      1569.84
72       20.0      1571.84
73       12.0      1577.85
74       10.66667  1583.85

black flashes start times: 
 Time (s)
1285.600869922
1287.602559922
1289.604229922
1291.605889922
1295.609249922
1303.615919922
1307.619279922
...
1561.831629922
1563.833279922
1565.834999922
1569.838349922
1571.840009922
1577.845019922
1583.850039922
shape: 75
</pre></div>
</div>
</div>
</div>
<p>Let’s inspect a bit further our TsGroup objects with the centered spikes. If we grab the FIRST element of <code class="docutils literal notranslate"><span class="pre">peri_black[example_id]</span></code>, we would get the spike times centered around the FIRST presentation of stimulus.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">peri_black</span><span class="p">[</span><span class="n">example_id</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Time (s)
-0.128226254
-0.12362626
0.070806812
0.132140063
0.223106608
0.252739902
0.270706544
0.305906497
0.308506494
0.330173131
0.401073036
0.434739658
0.455372963
0.471839608
shape: 14
</pre></div>
</div>
</div>
</div>
<p>Negative spike times are expected here because the spike times in <code class="docutils literal notranslate"><span class="pre">peri_white</span></code> and <code class="docutils literal notranslate"><span class="pre">peri_black</span></code> are aligned relative to stimulus onset. A negative time means the spike occurred before the stimulus was presented, while a positive time indicates the spike occurred after stimulus onset. This alignment allows us to analyze how neuronal activity changes around the time of stimulus presentation.</p>
<p>We can also visualize these aligned spike times to better understand the timing and rate of neural responses relative to the stimulus. This type of plot is known as a <a class="reference external" href="https://en.wikipedia.org/wiki/Peristimulus_time_histogram">Peristimulus Time Histogram (PSTH)</a>, and it shows how spiking activity is distributed around the stimulus onset. Let’s generate a PSTH for the first 9 units to explore their response patterns.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_raster_psth</span><span class="p">(</span><span class="n">peri_color</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">color_flashes</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">,</span> <span class="n">n_units</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mf">0.015</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot perievent time histograms (PSTHs) and raster plots for multiple units.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    peri_color : dict</span>
<span class="sd">        Dictionary mapping unit names to binned spike count peri-stimulus data (e.g., binned time series).</span>
<span class="sd">    units : dict</span>
<span class="sd">        Dictionary of neural units, e.g., spike trains or trial-aligned spike events.</span>
<span class="sd">    color_flashes : str</span>
<span class="sd">        A label indicating the flash color condition (&#39;black&#39; or other), used for visual styling.</span>
<span class="sd">    bin_size : float</span>
<span class="sd">        Size of the bin used for spike count computation (in seconds).</span>
<span class="sd">    smoothing : float</span>
<span class="sd">        Standard deviation for Gaussian smoothing of the PSTH traces.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Layout setup: 9 columns (units), 2 rows (split vertically into PSTH and raster plot)</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="n">n_units</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># Use tab10 color palette for plotting different units</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="n">n_cols</span><span class="p">]</span>

    <span class="c1"># Extract unit names for iteration</span>
    <span class="n">units_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_rows</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Plot as many units as half the number of rows </span>
                            <span class="c1"># each unit occupies 2 rows (one for psth and other for raster)</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">units_list</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]):</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">peri_color</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span>
            <span class="n">line_color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

            <span class="c1"># Plot PSTH (smoothed firing rate)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">bin_size</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">bin_size</span><span class="p">)</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="n">smoothing</span><span class="p">),</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">line_color</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># Stimulus onset line</span>
            <span class="n">span_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span> <span class="k">if</span> <span class="n">color_flashes</span> <span class="o">==</span> <span class="s2">&quot;black&quot;</span> <span class="k">else</span> <span class="s2">&quot;silver&quot;</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.250</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">span_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>  <span class="c1"># Stim duration</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Plot raster</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">to_tsd</span><span class="p">(),</span> <span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">mew</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.250</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">span_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>

            <span class="c1"># Shift window for next units</span>
            <span class="n">start</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">end</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Y-axis and title annotations</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rate (Hz)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Trial&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_rows</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rate (Hz)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Trial&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="s1">&#39;Time from stim(s)&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;PSTH &amp; Spike Raster Plot - </span><span class="si">{</span><span class="n">color_flashes</span><span class="si">}</span><span class="s1"> flashes&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bin_size</span> <span class="o">=</span> <span class="mf">0.005</span> <span class="c1"># Bin size</span>

<span class="c1"># Plot PSTH and spike raster plots</span>
<span class="n">plot_raster_psth</span><span class="p">(</span><span class="n">peri_white</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">)</span>
<span class="n">plot_raster_psth</span><span class="p">(</span><span class="n">peri_black</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/172db073bb7c56ae0534c39848ffc9338a7386abc2d2a8124c10f19575ba5895.png" src="../_images/172db073bb7c56ae0534c39848ffc9338a7386abc2d2a8124c10f19575ba5895.png" />
<img alt="../_images/6d66069510cb28660f20a358ceabc0de326a64ff71f9704b092110d474ce123a.png" src="../_images/6d66069510cb28660f20a358ceabc0de326a64ff71f9704b092110d474ce123a.png" />
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">How to choose bin size?</p>
<p>The <code class="docutils literal notranslate"><span class="pre">bin_size</span></code> determines the width of the time bins used to discretize the spike train. For example, a bin size of 0.005 means each second is divided into 200 bins of 5 milliseconds each. Smaller bin sizes provide higher temporal resolution, allowing you to detect rapid changes in firing rate, while larger bin sizes smooth out the activity over time but may obscure fine temporal dynamics.</p>
<p>In this tutorial, we use a bin size of 0.005, but there is no one-size-fits-all rule. The optimal bin size depends on the timescale of the neural activity you are modeling. For fast, precisely timed responses, a small bin size may be necessary. For slower or more sustained responses, larger bins may be more appropriate. Ultimately, it’s a modeling decision that should balance resolution with interpretability and noise.</p>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Why does the PSTH plot look so smooth?</p>
<p>We are using the <a class="reference external" href="https://pynapple.org/generated/pynapple.Tsd.smooth.html#pynapple.Tsd.smooth"><code class="docutils literal notranslate"><span class="pre">smooth</span></code></a> function from <strong>Pynapple</strong> to apply Gaussian smoothing to the perievent time series before plotting. This reduces trial-to-trial variability and emphasizes consistent temporal patterns in firing rate, making features like peaks or latency shifts easier to interpret—especially when spike trains are noisy or sparse.</p>
<p>In this tutorial, we use a Gaussian kernel with a standard deviation of 0.015 seconds.</p>
<p>To convert the standard deviation from seconds to bins, we divide by the bin size:</p>
<p><span class="math notranslate nohighlight">\( 
\begin{aligned}
\frac{0.015}{0.005} = 3 \text{ bins} 
\end{aligned}
\)</span></p>
<p>For implementation details, refer to the <a class="reference external" href="https://pynapple.org/generated/pynapple.Tsd.smooth.html#pynapple.Tsd.smooth"><strong>Pynapple</strong> documentation</a>.</p>
</div>
<p>In the plot above, we can see that some units (951765552, pink or 951765557, gray) are clearly more responsive than others (951765454, orange), which are apparently not modulated by the flashes. Thus, it would make sense to take a subset of the neurons, the most responsive ones, and model those.</p>
<p>We will now calculate responsiveness for each neuron as the normalized difference between average firing rate before and after stimulus presentation, and select the most responsive ones for further analyses.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_responsiveness</span><span class="p">(</span><span class="n">perievents</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate responsiveness for each neuron. This is</span>
<span class="sd">    computer as:</span>

<span class="sd">    post_presentation_avg  : </span>
<span class="sd">        Average firing rate during presentation (250 ms) of stimulus across</span>
<span class="sd">        all instances of stimulus. </span>

<span class="sd">    pre_presentation_avg :</span>
<span class="sd">        Average firing rate prior (250 ms) to the presentation of stimulus</span>
<span class="sd">        across all instances prior of stimulus. </span>

<span class="sd">    responsiveness : </span>
<span class="sd">        abs((post_presentation_avg - pre_presentation_avg) / (post_presentation_avg + pre_presentation_avg))</span>

<span class="sd">    Larger values indicate higher responsiveness to the stimuli.</span>
<span class="sd">        </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    perievents : TsGroup</span>
<span class="sd">        Contains perievent information of a subset of neurons</span>
<span class="sd">    bin_size : float</span>
<span class="sd">        Bin size for calculating spike counts</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------   </span>
<span class="sd">    resp_array : np.array</span>
<span class="sd">        Array of responsiveness information.</span>
<span class="sd">    resp_dict : dict</span>
<span class="sd">        Dictionary of responsiveness information. Indexed by each neuron&#39;s,</span>
<span class="sd">        contains responsiveness, pre_presentation_avg and post_presentation_avg information</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resp_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">resp_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">perievents</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">unit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">perievents</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="c1"># Count the number of timestamps in each bin_size bin.</span>
        <span class="n">peri_counts</span> <span class="o">=</span> <span class="n">perievents</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">bin_size</span><span class="p">)</span>

        <span class="c1"># Get the firing rate</span>
        <span class="n">peri_rate</span> <span class="o">=</span> <span class="n">peri_counts</span><span class="o">/</span><span class="n">bin_size</span>

        <span class="c1"># Compute average firing rate for each millisecond in the</span>
        <span class="c1"># the 250 ms before stimulus presentation</span>
        <span class="n">pre_presentation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">peri_rate</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">([</span><span class="o">-</span><span class="mf">.25</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Compute average firing rate for each millisecond in the</span>
        <span class="c1"># the 250 ms after stimulus presentation</span>
        <span class="n">post_presentation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">peri_rate</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mf">.25</span><span class="p">]))</span>

        <span class="n">pre_presentation_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pre_presentation</span><span class="p">)</span>
        <span class="n">post_presentation_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">post_presentation</span><span class="p">)</span>
        <span class="n">responsiveness</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">post_presentation_avg</span> <span class="o">-</span> <span class="n">pre_presentation_avg</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">post_presentation_avg</span> <span class="o">+</span> <span class="n">pre_presentation_avg</span><span class="p">))</span>

        <span class="n">resp_dict</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;responsiveness&quot;</span><span class="p">:</span> <span class="n">responsiveness</span><span class="p">,</span>
            <span class="s2">&quot;pre_presentation_avg&quot;</span><span class="p">:</span> <span class="n">pre_presentation_avg</span><span class="p">,</span>
            <span class="s2">&quot;post_presentation_avg&quot;</span><span class="p">:</span> <span class="n">post_presentation_avg</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">resp_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">responsiveness</span>

    <span class="k">return</span> <span class="n">resp_array</span><span class="p">,</span> <span class="n">resp_dict</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate responsiveness</span>
<span class="n">responsiveness_white</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">get_responsiveness</span><span class="p">(</span><span class="n">peri_white</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">)</span>
<span class="n">responsiveness_black</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">get_responsiveness</span><span class="p">(</span><span class="n">peri_black</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">)</span>

<span class="c1"># Add responsiveness as metadata for units</span>
<span class="n">units</span><span class="o">.</span><span class="n">set_info</span><span class="p">(</span><span class="n">responsiveness_white</span><span class="o">=</span><span class="n">responsiveness_white</span><span class="p">)</span>
<span class="n">units</span><span class="o">.</span><span class="n">set_info</span><span class="p">(</span><span class="n">responsiveness_black</span><span class="o">=</span><span class="n">responsiveness_black</span><span class="p">)</span>

<span class="c1"># See metadata</span>
<span class="nb">print</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index      rate      quality    brain_area    responsiveness_white    responsiveness_black
---------  --------  ---------  ------------  ----------------------  ----------------------
951765440  2.32495   good       VISp          0.14                    0.28
951765454  22.6523   good       VISp          0.02                    0.02
951765460  2.29829   good       VISp          0.18                    0.0
951765467  25.80912  good       VISp          0.17                    0.22
951765485  22.96158  good       VISp          0.15                    0.39
951765547  2.83687   good       VISp          0.39                    0.0
951765552  5.69507   good       VISp          0.75                    0.81
...        ...       ...        ...           ...                     ...
951768823  5.40712   good       VISp          0.03                    0.4
951768830  7.58276   good       VISp          0.15                    0.47
951768835  5.60442   good       VISp          0.07                    0.27
951768881  4.01534   good       VISp          0.5                     0.27
951768894  4.2713    good       VISp          0.09                    0.46
951769295  2.23963   good       VISp          0.2                     0.45
951769344  2.91152   good       VISp          0.68                    0.92
</pre></div>
</div>
</div>
</div>
<p>Now I can keep the top 15% most responsive units for ongoing analyses.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get threshold for top 15% most responsive</span>
<span class="n">thresh_black</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;responsiveness_black&quot;</span><span class="p">],</span> <span class="mi">85</span><span class="p">)</span>
<span class="n">thresh_white</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;responsiveness_white&quot;</span><span class="p">],</span> <span class="mi">85</span><span class="p">)</span>

<span class="c1"># Only keep units that are within the 15% most responsive for either black or white</span>
<span class="n">units</span> <span class="o">=</span> <span class="n">units</span><span class="p">[(</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;responsiveness_black&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">thresh_black</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;responsiveness_white&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">thresh_white</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Remaining units: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index      rate     quality    brain_area    responsiveness_white    responsiveness_black
---------  -------  ---------  ------------  ----------------------  ----------------------
951765552  5.69507  good       VISp          0.75                    0.81
951765732  4.31929  good       VISp          0.9                     1.0
951768154  2.82087  good       VISp          0.64                    0.89
951768278  3.43944  good       VISp          0.5                     0.66
951768285  4.06867  good       VISp          0.91                    0.3
951768291  2.77821  good       VISp          0.99                    0.5
951768307  2.32495  good       VISp          0.88                    0.5
...        ...      ...        ...           ...                     ...
951768586  2.82087  good       VISp          0.59                    0.52
951768621  3.41278  good       VISp          0.35                    0.59
951768632  5.93503  good       VISp          0.16                    0.79
951768749  2.04767  good       VISp          0.94                    0.91
951768754  2.76755  good       VISp          0.78                    1.0
951768815  2.23963  good       VISp          0.59                    0.76
951769344  2.91152  good       VISp          0.68                    0.92

Remaining units: 19
</pre></div>
</div>
</div>
</div>
</section>
<section id="revision-of-stimuli-and-spiking-data">
<h3>Revision of stimuli and spiking data<a class="headerlink" href="#revision-of-stimuli-and-spiking-data" title="Link to this heading">#</a></h3>
<p>Now that we have selected the units we will use for our analyses, we can see how these look alongside the stimuli in a raster plot:</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">raster_plot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">n_neurons</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="p">),</span> <span class="n">n_flashes</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_seconds</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a raster of spiking activity for a subset of neurons during the initial stimulus presentations.</span>

<span class="sd">    This function visualizes spike times as a raster plot for a selected number of neurons</span>
<span class="sd">    over a specified time window. The spikes are aligned with stimulus presentations, and </span>
<span class="sd">    flashes of different types (white or black) are shown as shaded regions in the background.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : nap.TsGroup</span>
<span class="sd">        A `TsGroup` object which contains all info of all units&#39; spikes without any filtering</span>
<span class="sd">    units : nap.TsdFrame</span>
<span class="sd">        A `TsdFrame` object where each column corresponds to the spike train of a neuron. It contains only the filtered neurons after preprocessing</span>
<span class="sd">    n_neurons : int, optional</span>
<span class="sd">        Number of neurons to include in the plot. Defaults to the total number of units.</span>
<span class="sd">    n_flashes : int, optional</span>
<span class="sd">        Number of white and black flash presentations to show. Defaults to 5.</span>
<span class="sd">    n_seconds : float, optional</span>
<span class="sd">        Total duration (in seconds) of the time window to display. Defaults to 13 seconds.</span>
<span class="sd">    offset : float, optional</span>
<span class="sd">        Time (in seconds) to start plotting before the first flash. Useful to visualize pre-stimulus activity.</span>
<span class="sd">        Defaults to 0.5 seconds.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Displays a raster plot using `matplotlib`.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The flashes are overlaid using `axvspan`, with white flashes in light gray and black flashes in black.</span>
<span class="sd">    - Each spike is drawn as a vertical line (&#39;|&#39;) at its timestamp.</span>
<span class="sd">    - Spike times are converted to a single `Tsd` object with unique identifiers for each unit to facilitate plotting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;flashes_presentations&quot;</span><span class="p">][</span><span class="s2">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">offset</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">n_seconds</span>

    <span class="c1"># Select full spiking activity from units without restriction</span>
    <span class="n">units_</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> 

    <span class="c1"># Select a subset from those - the filtered ones</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">units_</span><span class="p">[</span><span class="n">units</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

    <span class="c1"># Restrict the spike trains to the selected time window</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>

    <span class="c1"># Convert spike trains to a single Tsd object and label each neuron for plotting</span>
    <span class="n">neurons_to_plot</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">to_tsd</span><span class="p">([</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">)])</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">neurons_to_plot</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mew</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Overlay white flashes</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">flashes_white</span><span class="p">[:</span><span class="n">n_flashes</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">flashes_white</span><span class="p">[:</span><span class="n">n_flashes</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="mf">.50</span><span class="p">,</span>  <span class="n">e</span> <span class="o">+</span> <span class="mf">.50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;silver&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="mf">.50</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">e</span> <span class="o">+</span> <span class="mf">.50</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>

    <span class="c1"># Overlay black flashes</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">flashes_black</span><span class="p">[:</span><span class="n">n_flashes</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">flashes_black</span><span class="p">[:</span><span class="n">n_flashes</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="mf">.50</span><span class="p">,</span>  <span class="n">e</span> <span class="o">+</span> <span class="mf">.50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="mf">.50</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">e</span> <span class="o">+</span> <span class="mf">.50</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Unit&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Primary Visual Cortex (VISp) units spikes and stimuli&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">raster_plot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0e0fc259c8cf153a1a4f565ec5c71b00434e5fea9e0070044df4b83c6b48015a.png" src="../_images/0e0fc259c8cf153a1a4f565ec5c71b00434e5fea9e0070044df4b83c6b48015a.png" />
</div>
</div>
<p>Above we can see a spike raster plot from the selected VISp units displayed alongside the black and white flashes presented to the mice. Each row represents spike times from a different unit. Black and silver bars indicate the presentation of black and white flashes, respectively. The bright red vertical lines mark the windows of interest, 500 ms before stimulus onset and 500 ms after stimulus offset,  which are shaded in light red. Spikes occurring within these windows (the shaded red areas) are the ones that will be used for model fitting.</p>
<p>We can also look with each unit’s activity centered around the flashes presentation with a PSTH, as we did before.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the perievent for a subset of the units (most responsive ones)</span>
<span class="n">peri_white</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">peri_white</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">units</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">peri_white</span><span class="p">}</span>
<span class="n">peri_black</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">peri_black</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">units</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">peri_black</span><span class="p">}</span>

<span class="n">params_obs</span> <span class="o">=</span> <span class="p">[</span><span class="n">peri_white</span><span class="p">,</span> 
              <span class="n">peri_black</span><span class="p">]</span>

<span class="c1"># Plot PSTH and spike raster plots</span>
<span class="n">plot_raster_psth</span><span class="p">(</span><span class="n">peri_white</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">)</span>
<span class="n">plot_raster_psth</span><span class="p">(</span><span class="n">peri_black</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/37170405e8e80664d03063afa463640e3117122543bfee66f64a62c2ff00e332.png" src="../_images/37170405e8e80664d03063afa463640e3117122543bfee66f64a62c2ff00e332.png" />
<img alt="../_images/74e89f0d89b10136cc882b93863197b18818575031ac5d81abbc9ce6528bb10f.png" src="../_images/74e89f0d89b10136cc882b93863197b18818575031ac5d81abbc9ce6528bb10f.png" />
</div>
</div>
</section>
<section id="splitting-the-dataset-in-train-and-test">
<h3>Splitting the dataset in train and test<a class="headerlink" href="#splitting-the-dataset-in-train-and-test" title="Link to this heading">#</a></h3>
<p>We could train the model on the entire dataset. However, if we do so, we wouldn’t have a way to assess whether the model is truly capable of making accurate predictions or if it’s simply overfitting to the data. The simplest way around this is to have a reserved part of the data for testing.</p>
<p>Here, we will split the data in two: 70% will be for training and 30% will be for testing. However, we can’t simply grab the first 70% timeseries - what if we are biasing our sample and there are some neurons that respond only towards the end or the beginning of the recording? For that, we will gather one every three flashes, and those will go to the testing set. The rest, will go to the training set.</p>
<div class="dropdown admonition">
<p class="admonition-title">How to decide how to split my data?</p>
<p>The optimal way to split your data depends on your specific research question, the structure of your data, and the modeling goals. There’s no single correct approach—splitting strategies can and should be adapted to the context.</p>
<p>For example, you might choose a simple two-way split (training and test), or include a third validation set to tune model parameters before final testing. Some researchers split their data 50/50, while others use more unbalanced ratios depending on dataset size.</p>
<p>In some cases, it may make sense to split based on stimulus properties or experimental design. Suppose you suspect that a mouse’s response to white flashes changes with repeated exposure—e.g., due to habituation. Then, randomly mixing all trials might obscure important patterns. Instead, separating interleaved vs. repeated flash conditions could give you a more meaningful evaluation of model generalization.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We take one every three flashes (33% of all flashes of test)</span>
<span class="n">flashes_test_white</span> <span class="o">=</span> <span class="n">extended_flashes_white</span><span class="p">[::</span><span class="mi">3</span><span class="p">]</span>
<span class="n">flashes_test_black</span> <span class="o">=</span> <span class="n">extended_flashes_black</span><span class="p">[::</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Pynapple</strong> has a nice function to get all the epochs: <a class="reference external" href="https://pynapple.org/generated/pynapple.IntervalSet.set_diff.html"><code class="docutils literal notranslate"><span class="pre">set_diff</span></code></a>. With it, we can get all of the interval sets which are not in the interval set passed as argument.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The remaining is separated for training</span>
<span class="n">flashes_train_white</span> <span class="o">=</span> <span class="n">extended_flashes_white</span><span class="o">.</span><span class="n">set_diff</span><span class="p">(</span><span class="n">flashes_test_white</span><span class="p">)</span>
<span class="n">flashes_train_black</span> <span class="o">=</span> <span class="n">extended_flashes_black</span><span class="o">.</span><span class="n">set_diff</span><span class="p">(</span><span class="n">flashes_test_black</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Consider black and white for test and train
using <a class="reference external" href="https://pynapple.org/generated/pynapple.IntervalSet.union.html#pynapple.IntervalSet.union"><code class="docutils literal notranslate"><span class="pre">union</span></code></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Merge both stimuli types in a single interval set</span>
<span class="n">flashes_test</span> <span class="o">=</span> <span class="n">flashes_test_white</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">flashes_test_black</span><span class="p">)</span>
<span class="n">flashes_train</span> <span class="o">=</span> <span class="n">flashes_train_white</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">flashes_train_black</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have our intervals correctly, we can use <a class="reference external" href="https://pynapple.org/generated/pynapple.TsGroup.restrict.html#pynapple.TsGroup.restrict"><code class="docutils literal notranslate"><span class="pre">restrict</span></code></a> to get our test and train sets for units</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># General spike counts</span>
<span class="n">units_counts</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">bin_size</span><span class="p">,</span> <span class="n">ep</span> <span class="o">=</span> <span class="n">extended_flashes</span><span class="p">)</span>

<span class="c1"># Restrict counts to test and train</span>
<span class="n">units_counts_test</span> <span class="o">=</span> <span class="n">units_counts</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_test</span><span class="p">)</span>
<span class="n">units_counts_train</span> <span class="o">=</span> <span class="n">units_counts</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="fitting-a-glm">
<h2>Fitting a GLM<a class="headerlink" href="#fitting-a-glm" title="Link to this heading">#</a></h2>
<section id="preparing-the-data-for-nemos">
<h3>Preparing the data for <strong>NeMoS</strong><a class="headerlink" href="#preparing-the-data-for-nemos" title="Link to this heading">#</a></h3>
<p>Now that we have a good understanding of our data, and that we have split our dataset in the corresponding test and train subsets, we are almost ready to run our model. However, before we can construct it, we need to get our data in the right format.</p>
<p>When fitting a single neuron, <strong>NeMoS</strong> requires that the predictors and spike counts it operates on have the following properties:</p>
<ul class="simple">
<li><p>predictors and spike counts must have the same number of time points.</p></li>
<li><p>predictors must be two-dimensional, with shape <code class="docutils literal notranslate"><span class="pre">(n_time_bins,</span> <span class="pre">n_features)</span></code>. So far, we have two features in this tutorial: white and black flashes.</p></li>
<li><p>spike counts must be one-dimensional, with shape <code class="docutils literal notranslate"><span class="pre">(n_time_bins,)</span></code>.</p></li>
<li><p>predictors and spike counts must be jax.numpy arrays, numpy arrays, <a class="reference external" href="https://pynapple.org/generated/pynapple.Tsd.html#pynapple.Tsd"><code class="docutils literal notranslate"><span class="pre">Tsd</span></code></a> or <a class="reference external" href="https://pynapple.org/generated/pynapple.TsdFrame.html#pynapple.TsdFrame"><code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code></a>.</p></li>
</ul>
<p>When fitting multiple neurons, spike counts must be two-dimensional: <code class="docutils literal notranslate"><span class="pre">(n_time_bins,</span> <span class="pre">n_neurons)</span></code>. In that case, spike can be <a class="reference external" href="https://pynapple.org/generated/pynapple.TsGroup.html#pynapple.TsGroup"><code class="docutils literal notranslate"><span class="pre">TsGroup</span></code></a> objects as well.</p>
<p>First, we can make sure that our predictors and our spike counts have the same number of time bins.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a TsdFrame filled by zeros, for the size of units_counts</span>
<span class="n">predictors</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">TsdFrame</span><span class="p">(</span>
    <span class="n">t</span><span class="o">=</span><span class="n">units_counts</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
    <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">units_counts</span><span class="p">),</span> <span class="mi">2</span><span class="p">)),</span> 
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>At the moment, the flashes are in a IntervalSet, we need to grab them and make them time series of stimuli, separated by black and white (because we are interested in how neurons’ responses are modulated by each individual stimulus type separately).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check whether there is a flash within a given bin of spikes</span>
<span class="c1"># If there is not, put a nan in that index</span>
<span class="n">idx_white</span> <span class="o">=</span> <span class="n">flashes_white</span><span class="o">.</span><span class="n">in_interval</span><span class="p">(</span><span class="n">units_counts</span><span class="p">)</span>
<span class="n">idx_black</span> <span class="o">=</span> <span class="n">flashes_black</span><span class="o">.</span><span class="n">in_interval</span><span class="p">(</span><span class="n">units_counts</span><span class="p">)</span>

<span class="c1"># Replace everything that is not nan with 1 in the corresponding column</span>
<span class="n">predictors</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">idx_white</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">predictors</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">idx_black</span><span class="p">),</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="n">predictors</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Time (s)        white    black
--------------  -------  -------
1285.103369922  0.0      0.0
1285.108369922  0.0      0.0
1285.113369922  0.0      0.0
1285.118369922  0.0      0.0
1285.123369922  0.0      0.0
1285.128369922  0.0      0.0
1285.133369922  0.0      0.0
...             ...      ...
1584.567539922  0.0      0.0
1584.572539922  0.0      0.0
1584.577539922  0.0      0.0
1584.582539922  0.0      0.0
1584.587539922  0.0      0.0
1584.592539922  0.0      0.0
1584.597539922  0.0      0.0
dtype: float64, shape: (37500, 2)
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">predictors</span></code> and <code class="docutils literal notranslate"><span class="pre">units_counts</span></code> match in the first dimension because they have the same number of timepoints, as intended. Meanwhile, in the second dimension, predictors is 2 because we have black and white flashes, and counts has 19 because the selected units for this tutorial sums to 19.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;predictors shape: </span><span class="si">{</span><span class="n">predictors</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">count shape: </span><span class="si">{</span><span class="n">units_counts</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Just to make sure that we got the right output, let’s plot our new <code class="docutils literal notranslate"><span class="pre">predictors</span></code> <a class="reference external" href="https://pynapple.org/generated/pynapple.TsdFrame.html#pynapple.TsdFrame"><code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code></a> as lines alongside our first plot.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">stimuli_plot</span><span class="p">(</span><span class="n">predictors</span><span class="p">,</span> <span class="n">n_flashes</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">n_seconds</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mf">.5</span><span class="p">):</span>
    <span class="n">n_flashes</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">n_seconds</span> <span class="o">=</span> <span class="mi">13</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mf">.5</span>

    <span class="c1"># Start a little bit earlier than the first flash presentation</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;flashes_presentations&quot;</span><span class="p">][</span><span class="s2">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">offset</span> 
    <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">n_seconds</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="c1"># Different coloured flashes</span>
    <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;silver&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.4</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">flashes_white</span><span class="p">[:</span><span class="n">n_flashes</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">flashes_white</span><span class="p">[:</span><span class="n">n_flashes</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.4</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">flashes_black</span><span class="p">[:</span><span class="n">n_flashes</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">flashes_black</span><span class="p">[:</span><span class="n">n_flashes</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">)]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">predictors</span><span class="p">[</span><span class="s2">&quot;white&quot;</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span> <span class="s2">&quot;silver&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">predictors</span><span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">],</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Absent = 0, Present = 1&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Presented Stimuli&quot;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">)</span> 

    <span class="c1"># Only use integer values for ticks</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">integer</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stimuli_plot</span><span class="p">(</span><span class="n">predictors</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c59df3369701f2e6355c0ff625b4b80d4e422ac8d2c53fa04fa7f5e433165838.png" src="../_images/c59df3369701f2e6355c0ff625b4b80d4e422ac8d2c53fa04fa7f5e433165838.png" />
</div>
</div>
<p>They match perfectly!</p>
<p>As a last preprocessing step, let’s just split <code class="docutils literal notranslate"><span class="pre">predictors</span></code> in train and test.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictors_test</span> <span class="o">=</span> <span class="n">predictors</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_test</span><span class="p">)</span>
<span class="n">predictors_train</span> <span class="o">=</span> <span class="n">predictors</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="constructing-the-design-matrix-using-basis-functions">
<h3>Constructing the design matrix using basis functions<a class="headerlink" href="#constructing-the-design-matrix-using-basis-functions" title="Link to this heading">#</a></h3>
<p>Right now, our predictors consist of the black and white flash values at each time point. However, this setup assumes that the neuron’s spiking behavior is driven only by the instantaneous flash presentation. In reality, neurons integrate information over time — so why not modify our predictors to reflect that?</p>
<p>We can achieve this by including variables that represent the history of exposure to the flashes. For this, we must decide the duration of time that we think is relevant: does the exposure to flashes 10 ms ago matter? What about 100 ms ago? 1s? We should use priori knowledge of our system to determine a initial value.</p>
<p>For this tutorial, we will use the whole duration of the stimuli as relevant history. That is, we will model each unit’s response to 250 ms full-field flashes by capturing how stimulus history over that duration influences spiking. We therefore define a 250 ms stimulus window, aligned with the flash onset, which spans the entire stimulus duration. This window enables the GLM to learn how the neuron’s firing rate evolves throughout the flash. Using a shorter window could omit delayed effects, while a longer window may incorporate unrelated post-stimulus activity.</p>
<p>To construct our stimulus history predictor, we could generate time-lagged copies of the stimulus input (in the form of a <a class="reference external" href="https://en.wikipedia.org/wiki/Hankel_matrix">Hankel Matrix</a>). Specifically, the value of the first predictor at time <span class="math notranslate nohighlight">\( t \)</span> would correspond to the stimulus at time <span class="math notranslate nohighlight">\( t \)</span>, while the second predictor would capture the stimulus at time <span class="math notranslate nohighlight">\( t - 1 \)</span> , and so on, up to a maximum lag corresponding to the length of the stimulus integration window (250 ms in our case).</p>
<div class="info admonition">
<p class="admonition-title">How do you build a Hankel matrix?</p>
<p>Every row is a shifted copy of the row above!</p>
<p><img alt="hankel_matrix" src="../_images/hankel_matrix.gif" /></p>
<p>Construction of Hankel Matrix. Modified from <span id="id3">Pillow [<a class="reference internal" href="../bibliography.html#id3" title="Jonathan Pillow. Jonathan pillow - tutorial: statistical models for neural data - part 1 (cosyne 2018). YouTube, March 2018. URL: https://www.youtube.com/watch?v=NFeGW5ljUoI.">2018</a>]</span> <span id="cite3"></span><a href="#ref3">[3]</a>.</p>
<p>For an example on how to build a design matrix using the raw history as a predictor, see this <a class="reference internal" href="glm.html"><span class="std std-doc">GLM notebook</span></a> or this <a class="reference external" href="https://nemos.readthedocs.io/en/latest/how_to_guide/raw_history_feature.html#raw-spike-history-as-a-feature"><strong>NeMoS</strong> Fit GLMs for neural coupling tutorial</a>.</p>
</div>
<p>However, modeling each time lag with an independent parameter leads to a high-dimensional filter that is prone to overfitting (given that we are using a bin size of 0.005, we would end up with 50 lags = 50 parameters per flash color!) A better idea is to do some dimensionality reduction on these predictors, by parametrizing them using basis functions. This will allow us to capture interesting non-linear effects with a relatively low-dimensional parametrization that preserves convexity.</p>
<p>The way you perform this dimensionality reduction should be carefully considered. Choosing the appropriate type of basis functions, deciding how many to include, and setting their parameters all depend on the specifics of your problem. It’s essential to reflect on which aspects of the stimulus history are worth retaining and how best to represent them. For instance, do you expect sharp transient responses right after stimulus onset? Or are you more interested in slower, sustained effects?</p>
<div class="info admonition">
<p class="admonition-title">Note</p>
<p><strong>NeMoS</strong> has a whole library of basis objects available at <a class="reference external" href="https://nemos.readthedocs.io/en/latest/background/basis/README.html#table-basis"><code class="docutils literal notranslate"><span class="pre">nmo.basis</span></code></a>. You can explore the different options available there and think carefully about which one best matches your problem and assumptions.</p>
</div>
<p>Certain aspects of our units’ response dynamics suggest that applying multiple basis transformations to the stimulus can help better capture the structure that drives the units’ activity. In particular, some neurons exhibit a strong response immediately after flash onset, while others (or the same unit) show an additional peak in activity at flash offset.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot perievent for a single unit as an example</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_peri_single_unit</span><span class="p">(</span><span class="n">peri_white</span><span class="p">,</span> <span class="n">peri_black</span><span class="p">,</span> <span class="n">unit_id</span><span class="p">):</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">### white</span>
    <span class="c1"># observed</span>
    <span class="n">peri_u</span> <span class="o">=</span> <span class="n">peri_white</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span>
    <span class="n">peri_u_count</span> <span class="o">=</span> <span class="n">peri_u</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">bin_size</span><span class="p">)</span>

    <span class="n">peri_u_count_conv_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">peri_u_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span>
    <span class="n">peri_u_rate_conv</span> <span class="o">=</span> <span class="n">peri_u_count_conv_mean</span> <span class="o">/</span> <span class="n">bin_size</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peri_u_rate_conv</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.250</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;silver&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">.25</span><span class="p">,</span> <span class="mf">.5</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;White flashes&quot;</span><span class="p">)</span>

    <span class="c1">#### black</span>
    <span class="c1"># observed</span>
    <span class="n">peri_u</span> <span class="o">=</span> <span class="n">peri_black</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span>
    <span class="n">peri_u_count</span> <span class="o">=</span> <span class="n">peri_u</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">bin_size</span><span class="p">)</span>

    <span class="n">peri_u_count_conv_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">peri_u_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span>
    <span class="n">peri_u_rate_conv</span> <span class="o">=</span> <span class="n">peri_u_count_conv_mean</span> <span class="o">/</span> <span class="n">bin_size</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peri_u_rate_conv</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;observed&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.250</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">.25</span><span class="p">,</span> <span class="mf">.5</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Black flashes&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rate (Hz)&quot;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">.05</span><span class="p">,</span> <span class="s1">&#39;Time from stim(s)&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">.95</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;PSTH unit </span><span class="si">{</span><span class="n">unit_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Choose an example unit</span>
<span class="n">unit_id</span> <span class="o">=</span> <span class="mi">951768318</span>

<span class="n">plot_peri_single_unit</span><span class="p">(</span><span class="n">peri_white</span><span class="p">,</span> <span class="n">peri_black</span><span class="p">,</span> <span class="n">unit_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/5e8296fef662fd3ee48b91ab73475fa7221d7b7ea58a1552a7f71de81b27f88f.png" src="../_images/5e8296fef662fd3ee48b91ab73475fa7221d7b7ea58a1552a7f71de81b27f88f.png" />
</div>
</div>
<p>These distinct temporal features motivate us to model the onset and offset components separately, using tailored basis functions for each. Considering that, we will apply three distinct transformations to our predictors, each targeting a specific portion or feature of the stimulus:</p>
<ol class="arabic simple">
<li><p>Flash onset (beginning):
We will convolve the early phase of the flash presentation with a basis function. This allows for fine temporal resolution immediately after stimulus onset, where rapid neural responses are often expected.</p></li>
<li><p>Flash offset (end):
We will convolve the later phase of the flash (around its end) with a different basis function. This emphasizes activity changes around stimulus termination.</p></li>
<li><p>Full flash duration (smoothing):
We will convolve the entire flash period with a third basis function, serving as a smoother to capture more sustained or slowly varying effects across the full stimulus window.</p></li>
</ol>
<p>First, we will transform our predictors to get flash onset and offset. We should do this for train</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">white_train_on</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span>
    <span class="n">t</span><span class="o">=</span><span class="n">predictors_train</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> 
    <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">predictors_train</span><span class="p">[</span><span class="s2">&quot;white&quot;</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">time_support</span> <span class="o">=</span> <span class="n">units_counts_train</span><span class="o">.</span><span class="n">time_support</span>
<span class="p">)</span>

<span class="n">white_train_off</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span>
    <span class="n">t</span><span class="o">=</span><span class="n">predictors_train</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> 
    <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">predictors_train</span><span class="p">[</span><span class="s2">&quot;white&quot;</span><span class="p">])</span><span class="o">==-</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">time_support</span> <span class="o">=</span> <span class="n">units_counts_train</span><span class="o">.</span><span class="n">time_support</span>
<span class="p">)</span>

<span class="c1"># Black train</span>
<span class="n">black_train_on</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span>
    <span class="n">t</span><span class="o">=</span><span class="n">predictors_train</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> 
    <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">predictors_train</span><span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">time_support</span> <span class="o">=</span> <span class="n">units_counts_train</span><span class="o">.</span><span class="n">time_support</span>
<span class="p">)</span>
<span class="n">black_train_off</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span>
    <span class="n">t</span><span class="o">=</span><span class="n">predictors_train</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> 
    <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">predictors_train</span><span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">])</span><span class="o">==-</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">time_support</span> <span class="o">=</span> <span class="n">units_counts_train</span><span class="o">.</span><span class="n">time_support</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>and test set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># White test</span>
<span class="n">white_test_on</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span>
    <span class="n">t</span><span class="o">=</span><span class="n">predictors_test</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> 
    <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">predictors_test</span><span class="p">[</span><span class="s2">&quot;white&quot;</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">time_support</span><span class="o">=</span><span class="n">units_counts_test</span><span class="o">.</span><span class="n">time_support</span>
    
<span class="p">)</span>
<span class="n">white_test_off</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span>
    <span class="n">t</span><span class="o">=</span><span class="n">predictors_test</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> 
    <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">predictors_test</span><span class="p">[</span><span class="s2">&quot;white&quot;</span><span class="p">])</span><span class="o">==-</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">time_support</span><span class="o">=</span><span class="n">units_counts_test</span><span class="o">.</span><span class="n">time_support</span>
<span class="p">)</span>

<span class="c1"># Black test</span>
<span class="n">black_test_on</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span>
    <span class="n">t</span><span class="o">=</span><span class="n">predictors_test</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> 
    <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">predictors_test</span><span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">time_support</span><span class="o">=</span><span class="n">units_counts_test</span><span class="o">.</span><span class="n">time_support</span>
<span class="p">)</span>
<span class="n">black_test_off</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span>
    <span class="n">t</span><span class="o">=</span><span class="n">predictors_test</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> 
    <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">predictors_test</span><span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">])</span><span class="o">==-</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">time_support</span><span class="o">=</span><span class="n">units_counts_test</span><span class="o">.</span><span class="n">time_support</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">What are <a class="reference external" href="https://numpy.org/doc/2.2/reference/generated/numpy.diff.html">np.diff</a> and <a class="reference external" href="https://numpy.org/doc/2.2/reference/generated/numpy.hstack.html#numpy-hstack">np.hstack</a> doing?</p>
<p><a class="reference external" href="https://numpy.org/doc/2.2/reference/generated/numpy.diff.html"><code class="docutils literal notranslate"><span class="pre">np.diff</span></code></a> is a NumPy function that computes the difference between consecutive elements in an array.</p>
<p>Our stimulus predictors are binary: they take the value 0 when no flash is present, and 1 during the flash. For example, a typical pattern might look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>Calling <a class="reference external" href="https://numpy.org/doc/2.2/reference/generated/numpy.diff.html"><code class="docutils literal notranslate"><span class="pre">np.diff</span></code></a> on this array will compute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>This result highlights transitions:</p>
<ul class="simple">
<li><p>A value of 1 indicates the start of a flash (0 → 1),</p></li>
<li><p>A value of -1 indicates the end of a flash (1 → 0),</p></li>
<li><p>All other values represent no change.</p></li>
</ul>
<p>However, because <a class="reference external" href="https://numpy.org/doc/2.2/reference/generated/numpy.diff.html"><code class="docutils literal notranslate"><span class="pre">np.diff</span></code></a> returns an array that is one element shorter than the original, we prepend a 0 using <a class="reference external" href="https://numpy.org/doc/2.2/reference/generated/numpy.hstack.html#numpy-hstack"><code class="docutils literal notranslate"><span class="pre">np.hstack</span></code></a> to align it with the original timestamps.</p>
</div>
<p>We now have our predictors, it’s time to choose which basis functions are the most suitable for our ends.</p>
<p>For history-type inputs like we’re discussing, the raised cosine log-stretched basis first described in <span id="id4">Pillow <em>et al.</em> [<a class="reference internal" href="../bibliography.html#id4" title="Jonathan W. Pillow, Liam Paninski, Valerie J. Uzzell, Eero P. Simoncelli, and E. J. Chichilnisky. Prediction and Decoding of Retinal Ganglion Cell Responses with a Probabilistic Spiking Model. Journal of Neuroscience, 25(47):11003–11013, 2005. doi:10.1523/JNEUROSCI.3305-05.2005.">2005</a>]</span><span id="cite4"></span><a href="#ref4"> [4]</a> is a good fit. This basis set has the nice property that their precision drops linearly with distance from event, which makes sense for many history-related inputs in neuroscience: whether an input happened 1 or 5 ms ago matters a lot, whereas whether an input happened 51 or 55 ms ago is less important. We will apply this basis function to the beginning of the flash.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Duration of stimuli</span>
<span class="n">stimulus_history_duration</span> <span class="o">=</span> <span class="mf">0.25</span> 

<span class="c1"># Window length in bin size units</span>
<span class="n">window_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stimulus_history_duration</span> <span class="o">/</span> <span class="n">bin_size</span><span class="p">)</span>

<span class="n">basis_example</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">RaisedCosineLogConv</span><span class="p">(</span>
    <span class="n">n_basis_funcs</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> 
    <span class="n">window_size</span> <span class="o">=</span> <span class="n">window_len</span><span class="p">,</span> 
<span class="p">)</span>
<span class="n">sample_points</span><span class="p">,</span> <span class="n">basis_values</span> <span class="o">=</span> <span class="n">basis_example</span><span class="o">.</span><span class="n">evaluate_on_grid</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sample_points</span><span class="p">,</span> <span class="n">basis_values</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Raised cosine log-stretched basis&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Amplitude&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Lag&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/1303067481b9e4d2af916f0accb2296800c66a97db602675a696b38c1d7321fc.png" src="../_images/1303067481b9e4d2af916f0accb2296800c66a97db602675a696b38c1d7321fc.png" />
</div>
</div>
<p>Another very useful transformation we can apply to our predictors is that of the raised cosine linearly spaced basis, in which the domain is uniformly covered. This is an interesting basis because it is symmetric. We will apply this to the end of the flash.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Duration of stimuli</span>
<span class="n">stimulus_history_duration</span> <span class="o">=</span> <span class="mf">0.25</span> 

<span class="c1"># Window length in bin size units</span>
<span class="n">window_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stimulus_history_duration</span> <span class="o">/</span> <span class="n">bin_size</span><span class="p">)</span>

<span class="n">basis_example</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">RaisedCosineLinearConv</span><span class="p">(</span>
    <span class="n">n_basis_funcs</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> 
    <span class="n">window_size</span> <span class="o">=</span> <span class="n">window_len</span><span class="p">,</span> 
<span class="p">)</span>
<span class="n">sample_points</span><span class="p">,</span> <span class="n">basis_values</span> <span class="o">=</span> <span class="n">basis_example</span><span class="o">.</span><span class="n">evaluate_on_grid</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sample_points</span><span class="p">,</span> <span class="n">basis_values</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Raised cosine linear basis&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Amplitude&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Lag&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/8e92b6a95e4e6188f2139f99ecb09ac5aef4748f6a93958990dbe52b1d323186.png" src="../_images/8e92b6a95e4e6188f2139f99ecb09ac5aef4748f6a93958990dbe52b1d323186.png" />
</div>
</div>
<p>To see how these look convolved with the stimuli, let’s create our basis objects!</p>
<p>When we instantiate a basis object, the only arguments we must specify is the number of functions we want and the mode of operation of the basis:</p>
<ul class="simple">
<li><p>Number of functions: with more basis functions, we’ll be able to represent the effect of the corresponding input with the higher precision, at the cost of adding additional parameters.</p></li>
<li><p>Mode of operation: either <code class="docutils literal notranslate"><span class="pre">Conv</span></code> for convolutional or <code class="docutils literal notranslate"><span class="pre">Eval</span></code>for evaluation form of the basis. This is determined by the type of feature we aim to represent. This is not a parameter; instead, the choice of basis will include <code class="docutils literal notranslate"><span class="pre">Conv</span></code> or <code class="docutils literal notranslate"><span class="pre">Eval</span></code> in the name.</p></li>
</ul>
<div class="info admonition">
<p class="admonition-title">When should I use the convolutional or evaluation form of the basis?</p>
<ul class="simple">
<li><p>Evaluation bases transform the input through the non-linear function defined by the basis. This can be used to represent features such as spatial location and head direction.</p></li>
<li><p>Convolution bases apply a convolution of the input data to the bank of filters defined by the basis, and is particularly useful when analyzing data with inherent temporal dependencies, such as spike history or the history of flash exposure in this example. In convolution mode, we must additionally specify the <code class="docutils literal notranslate"><span class="pre">window_size</span></code> (the length of the filters in bins).</p></li>
</ul>
</div>
<p>Since we are using Convolution bases, we need to specify the <code class="docutils literal notranslate"><span class="pre">window_size</span></code>. In this tutorial, we will use 250 ms.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Duration of stimuli</span>
<span class="n">stimulus_history_duration</span> <span class="o">=</span> <span class="mf">0.250</span>

<span class="c1"># Window length in bin size units</span>
<span class="n">window_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stimulus_history_duration</span> <span class="o">/</span> <span class="n">bin_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can initialize our basis objects. As mentioned, for each flash type (white and black), we will create three separate basis objects: one for the onset of the flash, one for the offset, and one that spans the entire duration of the flash. In this tutorial, each basis object will have 5 basis functions.</p>
<div class="dropdown admonition">
<p class="admonition-title">How many functions should I use for each basis object?</p>
<p>When conducting your own analysis, you should carefully consider what number of basis functions is optimal for your specific dataset and scientific question. Too few may poorly predict the dynamics; too many may lead to overfitting or unnecessary complexity. You can conduct cross validation to find the optimal number of basis functions. For more information on how to tune your bases, you can refer to <a class="reference external" href="https://nemos.readthedocs.io/en/latest/how_to_guide/plot_06_sklearn_pipeline_cv_demo.html"><strong>NeMoS</strong> notebook on conducting cross validation for bases</a>.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize basis objects</span>
<span class="c1"># White</span>
<span class="c1"># Raised Cosine Log Stretched basis for &quot;On&quot;</span>
<span class="n">basis_white_on</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">RaisedCosineLogConv</span><span class="p">(</span>
    <span class="n">n_basis_funcs</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> 
    <span class="n">window_size</span> <span class="o">=</span> <span class="n">window_len</span><span class="p">,</span> 
    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;white_on&quot;</span>
<span class="p">)</span>

<span class="c1"># Raised Cosine Linear basis for &quot;Off&quot;</span>
<span class="n">basis_white_off</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">RaisedCosineLinearConv</span><span class="p">(</span>
    <span class="n">n_basis_funcs</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> 
    <span class="n">window_size</span> <span class="o">=</span> <span class="n">window_len</span><span class="p">,</span> 
    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;white_off&quot;</span><span class="p">,</span>
    <span class="n">conv_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;predictor_causality&quot;</span><span class="p">:</span><span class="s2">&quot;acausal&quot;</span><span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Raised Cosine Log Stretched basis for smoothing throughout stimuli presentaiton</span>
<span class="n">basis_white_stim</span><span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">RaisedCosineLogConv</span><span class="p">(</span>
    <span class="n">n_basis_funcs</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> 
    <span class="n">window_size</span> <span class="o">=</span> <span class="n">window_len</span><span class="p">,</span> 
    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;white_stim&quot;</span>
<span class="p">)</span>

<span class="c1"># Black</span>
<span class="c1"># Raised Cosine Log Stretched basis for &quot;On&quot;</span>
<span class="n">basis_black_on</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">RaisedCosineLogConv</span><span class="p">(</span>
    <span class="n">n_basis_funcs</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> 
    <span class="n">window_size</span> <span class="o">=</span> <span class="n">window_len</span><span class="p">,</span> 
    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;black_on&quot;</span>
<span class="p">)</span>

<span class="c1"># Raised Cosine Linear basis for &quot;Off&quot;</span>
<span class="n">basis_black_off</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">RaisedCosineLinearConv</span><span class="p">(</span>
    <span class="n">n_basis_funcs</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> 
    <span class="n">window_size</span> <span class="o">=</span> <span class="n">window_len</span><span class="p">,</span> 
    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;black_off&quot;</span><span class="p">,</span>
    <span class="n">conv_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;predictor_causality&quot;</span><span class="p">:</span><span class="s2">&quot;acausal&quot;</span><span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Raised Cosine Log Stretched basis for smoothing throughout stimuli presentaiton</span>
<span class="n">basis_black_stim</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">RaisedCosineLogConv</span><span class="p">(</span>
    <span class="n">n_basis_funcs</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> 
    <span class="n">window_size</span> <span class="o">=</span> <span class="n">window_len</span><span class="p">,</span> 
    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;black_stim&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">What is the <code class="docutils literal notranslate"><span class="pre">predictor_causality</span></code> parameter doing in the initialization of the <code class="docutils literal notranslate"><span class="pre">RaisedCosineLinearConv</span></code> basis?</p>
<p>This manages the causality of the predictor: <code class="docutils literal notranslate"><span class="pre">&quot;causal&quot;</span></code> is the default setting, and it means that the convolution will occur with respect to the input. Conversely <code class="docutils literal notranslate"><span class="pre">&quot;acausal&quot;</span></code>, the one we are using now for the raised cosine linear basis, applies the convolution to both sides of the stimulus equally. For more information, please refer to <a class="reference external" href="https://nemos.readthedocs.io/en/latest/background/plot_03_1D_convolution.html#causal-anti-causal-and-acausal-filters"><strong>NeMoS</strong> notebook on causal, anti-causal and acausal filters</a></p>
</div>
<p>Using the <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/_basis/nemos.basis._basis.AdditiveBasis.compute_features.html#nemos.basis._basis.AdditiveBasis.compute_features"><code class="docutils literal notranslate"><span class="pre">compute_features</span></code></a> function, <strong>NeMoS</strong> convolves our input features (predictors) with the basis object to compress them. Let’s see how that looks!</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_basis_feature_summary</span><span class="p">(</span>
    <span class="n">basis_object</span><span class="p">,</span>
    <span class="n">predictors</span><span class="p">,</span>
    <span class="n">interval</span><span class="p">,</span>
    <span class="n">label</span><span class="p">,</span>
    <span class="n">window_len</span><span class="p">,</span>
    <span class="n">title</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot summary of basis functions and convolved features for a given input.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    basis_object : object</span>
<span class="sd">        A basis object implementing `compute_features()` and `evaluate_on_grid()`.</span>
<span class="sd">    predictors : Tsd or TsdFrame</span>
<span class="sd">        Time series of stimulus predictors to convolve.</span>
<span class="sd">    interval : nap.IntervalSet</span>
<span class="sd">        Interval to restrict the predictors and features to.</span>
<span class="sd">    label : str</span>
<span class="sd">        Label for the raw stimulus trace (e.g. &quot;Flash&quot;).</span>
<span class="sd">    window_len : float</span>
<span class="sd">        Duration of the window used to scale the basis time axis.</span>
<span class="sd">    title : str</span>
<span class="sd">        Title to display above the figure.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Compute features</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">basis_object</span><span class="o">.</span><span class="n">compute_features</span><span class="p">(</span><span class="n">predictors</span><span class="p">)</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>

    <span class="c1"># Restrict raw stimulus as well</span>
    <span class="n">restricted_input</span> <span class="o">=</span> <span class="n">predictors</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>

    <span class="c1"># Create time axis for basis</span>
    <span class="n">time</span><span class="p">,</span> <span class="n">basis</span> <span class="o">=</span> <span class="n">basis_object</span><span class="o">.</span><span class="n">evaluate_on_grid</span><span class="p">(</span><span class="n">basis_object</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span>
    <span class="n">time</span> <span class="o">*=</span> <span class="n">window_len</span>

    <span class="c1"># Initialize plot</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Plot raw predictors</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">restricted_input</span><span class="p">,</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>

    <span class="c1"># Plot first basis function and its feature</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">basis</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Amp.&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Feature 1&quot;</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">features</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;conv.&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="c1"># Plot last basis function and its feature</span>
    <span class="n">last_idx</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">color</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">last_idx</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">basis</span><span class="p">[:,</span> <span class="n">last_idx</span><span class="p">],</span> <span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature </span><span class="si">{</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">features</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="p">)</span>

    <span class="c1"># Plot all basis functions and features</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;All features&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interval</span> <span class="o">=</span> <span class="n">flashes_train_white</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">plot_basis_feature_summary</span><span class="p">(</span>
    <span class="n">basis_white_on</span><span class="p">,</span>
    <span class="n">white_train_on</span><span class="p">,</span>
    <span class="n">interval</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Flash&quot;</span><span class="p">,</span>
    <span class="n">window_len</span><span class="o">=</span><span class="n">window_len</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Flashes On - Raised Cosine Log-Stretched Conv&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a719784555cb5aded9c42090ef1129465b2d5e4ba21afbc7d254636c30c0f194.png" src="../_images/a719784555cb5aded9c42090ef1129465b2d5e4ba21afbc7d254636c30c0f194.png" />
</div>
</div>
<p>On the top row, we can see the basis function, same as in the plot “Raised cosine log-stretched basis” above. On the bottom row, we are showing the beginning of one flash presentation, as a dashed line, and corresponding features over a small window of time. These features are the result of a convolution between the basis function on the top row with the black dashed line showed below. The basis functions get progressively wider and delayed from the flash onset, so we can think of the features as weighted averages that get progressively later and smoother.</p>
<p>In the leftmost plot, we can see that the first feature almost perfectly tracks the input. Looking at the basis function above, that makes sense: this function’s max is at 0 and quickly decays. In the middle plot, we can see that the last feature has a fairly long lag compared to the flash beginning, and is a lot smoother. Looking at the rightmost plot, we can see that the other features vary between these two extremes, getting smoother and more delayed.</p>
<p>Now let’s see how our convolved features look for the basis for a instance of full flash duration:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_basis_feature_summary</span><span class="p">(</span>
    <span class="n">basis_white_stim</span><span class="p">,</span>
    <span class="n">predictors_train</span><span class="p">[</span><span class="s2">&quot;white&quot;</span><span class="p">],</span>
    <span class="n">interval</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Flash&quot;</span><span class="p">,</span>
    <span class="n">window_len</span><span class="o">=</span><span class="n">window_len</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Flash Presentation - Raised Cosine Log-Stretched Conv&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a9d2f0ec83b01a40c623216df3f0beeac31a6b56d9768149201be96d5c6e64de.png" src="../_images/a9d2f0ec83b01a40c623216df3f0beeac31a6b56d9768149201be96d5c6e64de.png" />
</div>
</div>
<p>This is very similar to the Flashes On convolution, just a bit wider, as the duration of the flash is longer than a single instance of initiation of flash.</p>
<p>Finally, let’s see how our Raised Cosine Linear Conv basis is transforming our Flashes Off predictor.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_basis_feature_summary</span><span class="p">(</span>
    <span class="n">basis_white_off</span><span class="p">,</span>
    <span class="n">white_train_off</span><span class="p">,</span>
    <span class="n">interval</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Flash&quot;</span><span class="p">,</span>
    <span class="n">window_len</span><span class="o">=</span><span class="n">window_len</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Flashes Off - Raised Cosine Linear Conv&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7dbed380a062d1008543bcb924a116b0128fad91700943e08efc1dd1b1a59515.png" src="../_images/7dbed380a062d1008543bcb924a116b0128fad91700943e08efc1dd1b1a59515.png" />
</div>
</div>
<p>This basis might look a bit different, and that’s because we’re using the <code class="docutils literal notranslate"><span class="pre">&quot;acausal&quot;</span></code>setting for the <code class="docutils literal notranslate"><span class="pre">&quot;predictor_causality&quot;</span></code> option. In this mode, the center of the convolution is aligned with the end of the flash, rather than strictly following the stimulus forward in time.</p>
<p>This acausal alignment allows the model to capture changes in firing rate that occur both just before and after the flash ends. This is particularly useful for smoothing transitions between basis-driven components: it helps avoid abrupt or artificial jumps in the predicted firing rate at stimulus offset. Instead, we can interpolate more smoothly across time, producing more interpretable predictions.</p>
<hr class="docutils" />
<p>These are the elements of our feature matrix: representations of not just the instantaneous presentation of a flash, but also of its history. Let’s see what this looks like when we go to fit the model!</p>
<p>In our case, we want our basis to be composed by both black and white flashes features. For that, we can build an <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/_basis/nemos.basis._basis.AdditiveBasis.html"><code class="docutils literal notranslate"><span class="pre">additive</span> <span class="pre">basis</span></code></a>. This will concatenate our already declared basis objects.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define additive basis object</span>
<span class="n">additive_basis</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">basis_white_on</span> <span class="o">+</span> 
    <span class="n">basis_white_off</span> <span class="o">+</span> 
    <span class="n">basis_white_stim</span> <span class="o">+</span> 
    <span class="n">basis_black_on</span> <span class="o">+</span> 
    <span class="n">basis_black_off</span> <span class="o">+</span> 
    <span class="n">basis_black_stim</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can convolve our predictors with each basis within our <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/_basis/nemos.basis._basis.AdditiveBasis.html"><code class="docutils literal notranslate"><span class="pre">additive</span> <span class="pre">basis</span></code></a> by calling <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/_basis/nemos.basis._basis.AdditiveBasis.compute_features.html#nemos.basis._basis.AdditiveBasis.compute_features"><code class="docutils literal notranslate"><span class="pre">compute_features</span></code></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convolve basis with inputs - train set</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">additive_basis</span><span class="o">.</span><span class="n">compute_features</span><span class="p">(</span>
    <span class="n">white_train_on</span><span class="p">,</span>
    <span class="n">white_train_off</span><span class="p">,</span>
    <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span><span class="n">t</span><span class="o">=</span> <span class="n">white_train_on</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="n">predictors_train</span><span class="p">[</span><span class="s2">&quot;white&quot;</span><span class="p">],</span> <span class="n">time_support</span><span class="o">=</span><span class="n">units_counts_train</span><span class="o">.</span><span class="n">time_support</span><span class="p">),</span>
    <span class="n">black_train_on</span><span class="p">,</span>
    <span class="n">black_train_off</span><span class="p">,</span>
    <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span><span class="n">t</span><span class="o">=</span> <span class="n">black_train_on</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="n">predictors_train</span><span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">],</span> <span class="n">time_support</span><span class="o">=</span><span class="n">units_counts_train</span><span class="o">.</span><span class="n">time_support</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Convolve basis with inputs - test set</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">additive_basis</span><span class="o">.</span><span class="n">compute_features</span><span class="p">(</span>
    <span class="n">white_test_on</span><span class="p">,</span>
    <span class="n">white_test_off</span><span class="p">,</span>
    <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span><span class="n">t</span><span class="o">=</span> <span class="n">white_test_on</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="n">predictors_test</span><span class="p">[</span><span class="s2">&quot;white&quot;</span><span class="p">],</span> <span class="n">time_support</span><span class="o">=</span><span class="n">units_counts_test</span><span class="o">.</span><span class="n">time_support</span><span class="p">),</span>
    <span class="n">black_test_on</span><span class="p">,</span>
    <span class="n">black_test_off</span><span class="p">,</span>
    <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span><span class="n">t</span><span class="o">=</span> <span class="n">black_test_on</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="n">predictors_test</span><span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">],</span> <span class="n">time_support</span><span class="o">=</span><span class="n">units_counts_test</span><span class="o">.</span><span class="n">time_support</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">More resources on basis functions</p>
<ul class="simple">
<li><p><a class="reference external" href="https://nemos.readthedocs.io/en/latest/tutorials/plot_02_head_direction.html"><strong>NeMoS</strong> fit head-direction population tutorial</a>: For a step by step explanation of how to build the design matrix first as a result of convolving the features with the identity matrix, and then by using basis functions, alongside nice visualizations.</p></li>
<li><p><a class="reference external" href="https://flatironinstitute.github.io/neurorse-workshops/workshops/jan-2025/branch/main/full/day2/current_injection.html#fitting-the-model">Flatiron Institute Introduction to GLMs tutorial</a>: For a detailed explanation, step by step, on how predictors look with and without basis functions, with nice visualizations as well.</p></li>
<li><p><a class="reference external" href="https://nemos.readthedocs.io/en/latest/background/basis/plot_02_ND_basis_function.html"><strong>NeMoS</strong> notebook on composition of basis functions</a>: For a detailed explanation of the different operations that can be carried out using basis functions in 2 and more dimensions.</p></li>
<li><p><a class="reference external" href="https://www.microsoft.com/en-us/research/wp-content/uploads/2006/01/Bishop-Pattern-Recognition-and-Machine-Learning-2006.pdf">Bishop, 2009</a>: Section 3.1 for a formal description of what basis functions are and some examples of them.</p></li>
<li><p><a class="reference external" href="https://nemos.readthedocs.io/en/latest/how_to_guide/plot_06_sklearn_pipeline_cv_demo.html"><strong>NeMoS</strong> notebook on conducting cross validation for bases</a>: For a detailed explanation of how to combine <strong>NeMos</strong> objects within a <strong>scikit-learn</strong> pipeline to select the number of bases and bases type using cross validation.</p></li>
</ul>
</div>
</section>
<section id="initialize-and-fit-a-glm-single-unit">
<h3>Initialize and fit a GLM: single unit<a class="headerlink" href="#initialize-and-fit-a-glm-single-unit" title="Link to this heading">#</a></h3>
<p>Now we are finally ready to start our model!</p>
<p>First, we need to define our GLM model object. To initialize our model, we need to specify the <code class="docutils literal notranslate"><span class="pre">solver_name</span></code>, the <code class="docutils literal notranslate"><span class="pre">regularizer</span></code>, the <code class="docutils literal notranslate"><span class="pre">regularizer_strength</span></code> and the <code class="docutils literal notranslate"><span class="pre">observation_model</span></code>. All of these are optional.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">solver_name</span></code>: this string specifies the solver algorithm. The default behavior depends on the regularizer, as each regularization scheme is only compatible with a subset of possible solvers.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regularizer</span></code>: this string or object specifies the regularization scheme. Regularization modifies the objective function to reflect your prior beliefs about the parameters, such as sparsity. Regularization becomes more important as the number of input features, and thus model parameters, grows. <strong>NeMoS</strong>’s solvers can be found within the <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/regularizer/nemos.regularizer.Regularizer.html#nemos.regularizer.Regularizer"><code class="docutils literal notranslate"><span class="pre">nemos.regularizer</span></code></a> module.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">observation_model</span></code>: this object links the firing rate and the observed data (in this case spikes), describing the distribution of neural activity (and thus changing the log-likelihood). For spiking data, we use the Poisson observation model.</p></li>
</ul>
<p>For this tutorial, we’ll use a LBFGS <code class="docutils literal notranslate"><span class="pre">solver_name</span></code> with Ridge <code class="docutils literal notranslate"><span class="pre">regularizer</span></code>, and a <code class="docutils literal notranslate"><span class="pre">regularizer_strength</span></code> of 7.745e-06</p>
<div class="dropdown admonition">
<p class="admonition-title">Why LBFGS?</p>
<p>LBFGS is a quasi-Netwon method, that is, it uses the first derivative (the gradient) and approximates the second derivative (the Hessian) in order to solve the problem. This means that LBFGS tends to find a solution faster and is often less sensitive to step-size. Try other solvers to see how they behave!</p>
</div>
<div class="dropdown admonition">
<p class="admonition-title">What is regularization?</p>
<p>When fitting models, it is generally recommended to use regularization, a technique that adds a constraint or penalty to the model’s cost function. Regularization works by discouraging the coefficients from reaching large values.</p>
<p>Penalizing large coefficients is beneficial because it helps prevent overfitting, a phenomenon in which the model fits the training data too closely, capturing noise instead of the underlying pattern. Large coefficients often indicate a model that is too complex or sensitive to small fluctuations in the data. By keeping coefficients smaller and more stable, regularization promotes simpler models that generalize better to unseen data, improving predictive performance and robustness.</p>
<p>In this tutorial, we will use Ridge regularization (or L2 regularization). In this type of regularization, the penalty term added to the loss function is:</p>
<div class="math notranslate nohighlight">
\[
\text{Penalty} = \frac{\lambda}{2N} \sum_{j} \theta_j^2
\]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda\)</span> is the regularization strength, <span class="math notranslate nohighlight">\(N\)</span> is the number of samples and <span class="math notranslate nohighlight">\(\theta_j\)</span> are the model coefficients, stored in <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.GLM.html#nemos.glm.GLM.coef_"><code class="docutils literal notranslate"><span class="pre">model.coef_</span></code></a>.</p>
<p>Please refer to <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/regularizer/nemos.regularizer.Ridge.html#nemos.regularizer.Ridge"><strong>NeMoS</strong> documentation</a> for more details on how this was implemented.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">regularizer_strength</span> <span class="o">=</span> <span class="mf">7.745e-06</span>
<span class="c1"># Initialize model object of a single unit</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">glm</span><span class="o">.</span><span class="n">GLM</span><span class="p">(</span>
    <span class="n">regularizer</span> <span class="o">=</span> <span class="s2">&quot;Ridge&quot;</span><span class="p">,</span>
    <span class="n">regularizer_strength</span> <span class="o">=</span> <span class="n">regularizer_strength</span><span class="p">,</span>
    <span class="n">solver_name</span><span class="o">=</span><span class="s2">&quot;LBFGS&quot;</span><span class="p">,</span> 
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Where did the <code class="docutils literal notranslate"><span class="pre">regularizer_strength</span></code> value come from?</p>
<p>We conducted cross validation to obtain the regularization strength:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span>

<span class="c1"># Initialize model object</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">glm</span><span class="o">.</span><span class="n">GLM</span><span class="p">(</span>
    <span class="n">regularizer</span> <span class="o">=</span> <span class="s2">&quot;Ridge&quot;</span><span class="p">,</span>
    <span class="n">regularizer_strength</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="n">solver_name</span><span class="o">=</span><span class="s2">&quot;LBFGS&quot;</span><span class="p">,</span> 
    <span class="c1">#solver_kwargs=dict(tol=10**-12)</span>
<span class="p">)</span>

<span class="c1"># Create parameter grid</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;regularizer_strength&quot;</span> <span class="p">:</span> 
    <span class="n">np</span><span class="o">.</span><span class="n">geomspace</span><span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Instantiate the grid search object</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span><span class="n">param_grid</span><span class="p">,</span> 
    <span class="n">cv</span><span class="o">=</span><span class="mi">5</span>
    <span class="p">)</span>

<span class="c1"># Run grid search</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">u_counts_train</span><span class="p">)</span>

<span class="c1"># Print optimal parameter</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span><span class="o">.</span><span class="n">regularizer_strength</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">7.742636826811277e-06</span>
</pre></div>
</div>
<p>In this tutorial, for conciseness, we will use the regularizer strength obtained for this single neuron across the entire population. However, please note that when running your own analysis, it is necessary to find the optimal regularizer strength for each neuron individually, as there is no guarantee that the optimal solution for one neuron will also be optimal for another.</p>
</div>
<p>First let’s choose an example unit to fit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Choose an example unit</span>
<span class="n">unit_id</span> <span class="o">=</span> <span class="mi">951768318</span>

<span class="c1"># Get counts for train and test for said unit</span>
<span class="n">u_counts_train</span> <span class="o">=</span> <span class="n">units_counts_train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span>
<span class="n">u_counts_test</span> <span class="o">=</span> <span class="n">units_counts_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><strong>NeMoS</strong> models are intended to be used like <a class="reference external" href="https://scikit-learn.org/stable/getting_started.html"><strong>scikit-learn</strong></a> estimators. In these, a model instance is initialized with hyperparameters (like regularization strength, solver, etc), and then we can call the <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.GLM.fit.html#nemos.glm.GLM.fit"><code class="docutils literal notranslate"><span class="pre">fit()</span></code></a> function to fit the model to data. Since we have already created our model and have our data, we can go ahead and call <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.GLM.fit.html#nemos.glm.GLM.fit"><code class="docutils literal notranslate"><span class="pre">fit()</span></code></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">u_counts_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GLM(
    observation_model=PoissonObservations(inverse_link_function=exp),
    regularizer=Ridge(),
    regularizer_strength=7.745e-06,
    solver_name=&#39;LBFGS&#39;
)
</pre></div>
</div>
</div>
</div>
<p>Now that we have fit our data, we can retrieve the resulting parameters. Similar to <a class="reference external" href="https://scikit-learn.org/stable/getting_started.html"><strong>scikit-learn</strong></a> , these are stored as the <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.GLM.html#nemos.glm.GLM.coef_"><code class="docutils literal notranslate"><span class="pre">coef_</span></code></a>.and <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.GLM.html#nemos.glm.GLM.intercept_"><code class="docutils literal notranslate"><span class="pre">intercept_</span></code></a> attributes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;firing_rate(t) = exp(</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="si">}</span><span class="s2"> * flash(t) + </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">intercept_</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>firing_rate(t) = exp([ 0.42339513 -0.14622475 -1.6153557   2.4666765   2.4574258   1.0377612
  0.8538695   1.4687707   2.131266   -0.04929369  0.4735016   0.44654387
 -0.99847394  0.31412154 -0.1562404   0.73338383  0.03729352 -1.1021913
  1.0413783   2.3387983  -0.02767342  1.3869107  -0.33982408  0.52867544
  0.01454498  0.01976705  0.08946032 -0.17806664 -0.00803406  0.08180097] * flash(t) + [-3.94904])
</pre></div>
</div>
</div>
</div>
<div class="info admonition">
<p class="admonition-title">Note</p>
<p>Note that <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.GLM.html#nemos.glm.GLM.coef_"><code class="docutils literal notranslate"><span class="pre">model.coef_</span></code></a> has shape <code class="docutils literal notranslate"><span class="pre">(n_features,</span> <span class="pre">)</span></code>, while <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.GLM.html#nemos.glm.GLM.intercept_"><code class="docutils literal notranslate"><span class="pre">model.intercept_</span></code></a> has shape (<code class="docutils literal notranslate"><span class="pre">n_neurons</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">(</span><span class="mi">30</span><span class="p">,)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">intercept_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
</pre></div>
</div>
</div>
</section>
<section id="assess-glm-performance-predict-and-psth">
<h3>Assess GLM performance: predict and PSTH<a class="headerlink" href="#assess-glm-performance-predict-and-psth" title="Link to this heading">#</a></h3>
<p>Although it is helpful to examine the model parameters, they don’t tell us much about how well the model is performing. So how can we assess its quality?</p>
<p>One way is to use the model to predict firing rates and compare those predictions to the smoothed spike train. By calling <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.GLM.predict.html#nemos.glm.GLM.predict"><code class="docutils literal notranslate"><span class="pre">predict</span></code></a>, we obtain the model’s predicted firing rate for the input data — that is, the output of the nonlinearity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use predict to obtain the firing rates</span>
<span class="n">pred_unit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Convert units from spikes/bin to spikes/sec</span>
<span class="n">pred_unit</span> <span class="o">=</span> <span class="n">pred_unit</span><span class="o">/</span> <span class="n">bin_size</span>

<span class="nb">print</span><span class="p">(</span><span class="n">pred_unit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Time (s)
--------------  ---
1285.103369922  nan
1285.108369922  nan
1285.113369922  nan
1285.118369922  nan
1285.123369922  nan
1285.128369922  nan
1285.133369922  nan
...
1576.560859922  nan
1576.565859922  nan
1576.570859922  nan
1576.575859922  nan
1576.580859922  nan
1576.585859922  nan
1576.590859922  nan
dtype: float32, shape: (12500,)
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Why is our time series full of NaN values!?</p>
<p>IT IS NOT! We have NaN values at the beginning and end of each flash presentation. This is due to the convolution window used when applying the basis functions. In our case, the model uses a 250 ms temporal window, meaning that at any given time point, the model looks back 250 ms into the stimulus history.</p>
<p>As a result, during the first 250 ms of each trial, the convolution cannot be fully computed — the model lacks sufficient preceding data to construct the input to the linear filter. This leads to NaN values in the predicted firing rate during this initial period.</p>
<p>Given our bin size of 5 ms, 250 ms corresponds to 50 time bins. Thus, we expect the first 50 time points of the prediction to contain NaNs. After that, the model has enough history to compute valid predictions.</p>
<p>For example, if we inspect the predictions starting at timepoint 50, we no longer see NaN values at the beginning:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">pred_unit</span><span class="p">[</span><span class="mi">50</span><span class="p">:])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Time</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="o">--------------</span>  <span class="o">---------</span>
<span class="mf">1285.353369922</span>    <span class="mf">3.85464</span>
<span class="mf">1285.358369922</span>    <span class="mf">3.85464</span>
<span class="mf">1285.363369922</span>    <span class="mf">3.85464</span>
<span class="mf">1285.368369922</span>    <span class="mf">3.85464</span>
<span class="mf">1285.373369922</span>    <span class="mf">3.85464</span>
<span class="mf">1285.378369922</span>    <span class="mf">3.85464</span>
<span class="mf">1285.383369922</span>    <span class="mf">3.85464</span>
<span class="o">...</span>
<span class="mf">1576.560859922</span>  <span class="n">nan</span>
<span class="mf">1576.565859922</span>  <span class="n">nan</span>
<span class="mf">1576.570859922</span>  <span class="n">nan</span>
<span class="mf">1576.575859922</span>  <span class="n">nan</span>
<span class="mf">1576.580859922</span>  <span class="n">nan</span>
<span class="mf">1576.585859922</span>  <span class="n">nan</span>
<span class="mf">1576.590859922</span>  <span class="n">nan</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">12450</span><span class="p">,)</span>
</pre></div>
</div>
<p>By contrast, timepoint 49 still includes a NaN:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">pred_unit</span><span class="p">[</span><span class="mi">49</span><span class="p">:])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Time</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="o">--------------</span>  <span class="o">---------</span>
<span class="mf">1285.348369922</span>  <span class="n">nan</span>
<span class="mf">1285.353369922</span>    <span class="mf">3.85464</span>
<span class="mf">1285.358369922</span>    <span class="mf">3.85464</span>
<span class="mf">1285.363369922</span>    <span class="mf">3.85464</span>
<span class="mf">1285.368369922</span>    <span class="mf">3.85464</span>
<span class="mf">1285.373369922</span>    <span class="mf">3.85464</span>
<span class="mf">1285.378369922</span>    <span class="mf">3.85464</span>
<span class="o">...</span>
<span class="mf">1576.560859922</span>  <span class="n">nan</span>
<span class="mf">1576.565859922</span>  <span class="n">nan</span>
<span class="mf">1576.570859922</span>  <span class="n">nan</span>
<span class="mf">1576.575859922</span>  <span class="n">nan</span>
<span class="mf">1576.580859922</span>  <span class="n">nan</span>
<span class="mf">1576.585859922</span>  <span class="n">nan</span>
<span class="mf">1576.590859922</span>  <span class="n">nan</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">12451</span><span class="p">,)</span>
</pre></div>
</div>
<p>Similarly, we find NaNs at the end of the convolution - specifically in the last 25 bins because the basis for Flashes Off is <code class="docutils literal notranslate"><span class="pre">acausal</span></code>. Given our 250 ms window, an <code class="docutils literal notranslate"><span class="pre">acausal</span></code>convolution means that the convolution is centered in the event (in our case, flash offset), and it requires 125 ms (or 25 bins!) to each side of every timepoint to be computed. When there are 125 ms left to go (or less), the basis does not have enough timepoints to conduct the convolution, and this results in NaN values.</p>
<p>So, the NaNs are not an error — they’re simply a byproduct of the convolution requiring a full 250 ms or 125 ms history before producing an output.</p>
</div>
<p>Now, we can use <strong>Pynapple</strong> function <a class="reference external" href="https://pynapple.org/generated/pynapple.process.perievent.html#pynapple.process.perievent.compute_perievent_continuous"><code class="docutils literal notranslate"><span class="pre">compute_perievent_continuous</span></code></a> to re-center the timestamps of the predicted rates around the stimulus presentations, in a similar manner than at the beginning of the tutorial. In contrast to <a class="reference external" href="https://pynapple.org/generated/pynapple.process.perievent.html#pynapple.process.perievent.compute_perievent"><code class="docutils literal notranslate"><span class="pre">compute_perievent</span></code></a>, <a class="reference external" href="https://pynapple.org/generated/pynapple.process.perievent.html#pynapple.process.perievent.compute_perievent_continuous"><code class="docutils literal notranslate"><span class="pre">compute_perievent_continuous</span></code></a> allows us to center a continuous time series.</p>
<p>We re-center the timestamps in the same way as we did at the beginning of the tutorial.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Re-center timestamps around white stimuli</span>
<span class="c1"># +50 because we subtracted .50 at beginning of stimulus presentation</span>
<span class="n">peri_white_pred_unit</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent_continuous</span><span class="p">(</span>
    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">pred_unit</span><span class="p">,</span> 
    <span class="n">tref</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">flashes_test_white</span><span class="o">.</span><span class="n">start</span><span class="o">+</span><span class="mf">.50</span><span class="p">),</span>
    <span class="n">minmax</span><span class="o">=</span><span class="n">window_size</span>
<span class="p">)</span>  
<span class="c1"># Re-center timestamps for black stimuli</span>
<span class="c1"># +50 because we subtracted .50 at beginning of stimulus presentation</span>
<span class="n">peri_black_pred_unit</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent_continuous</span><span class="p">(</span>
    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">pred_unit</span><span class="p">,</span> 
    <span class="n">tref</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">flashes_test_black</span><span class="o">.</span><span class="n">start</span><span class="o">+</span><span class="mf">.50</span><span class="p">),</span> 
    <span class="n">minmax</span><span class="o">=</span><span class="n">window_size</span>
<span class="p">)</span>  

<span class="c1"># Print centered spikes</span>
<span class="nb">print</span><span class="p">(</span><span class="n">peri_white_pred_unit</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Time (s)    0        1        2        3        4        ...
----------  -------  -------  -------  -------  -------  -----
-0.25       nan      nan      3.85464  nan      nan      ...
-0.245      3.85464  3.85464  3.85464  3.85464  3.85464  ...
-0.24       3.85464  3.85464  3.85464  3.85464  3.85464  ...
-0.235      3.85464  3.85464  3.85464  3.85464  3.85464  ...
-0.23       3.85464  3.85464  3.85464  3.85464  3.85464  ...
-0.225      3.85464  3.85464  3.85464  3.85464  3.85464  ...
-0.22       3.85464  3.85464  3.85464  3.85464  3.85464  ...
...         ...      ...      ...      ...      ...      ...
0.47        3.82009  3.82009  3.83403  3.82009  3.82009  ...
0.475       3.83403  3.83403  3.84355  3.83403  3.83403  ...
0.48        3.84355  3.84355  3.84954  3.84355  3.84355  ...
0.485       3.84954  3.84954  3.85284  3.84954  3.84954  ...
0.49        3.85284  3.85284  3.85429  3.85284  3.85284  ...
0.495       3.85429  3.85429  3.85464  3.85429  3.85429  ...
0.5         3.85464  3.85464  3.85464  3.85464  3.85464  ...
dtype: float64, shape: (151, 25)
</pre></div>
</div>
</div>
</div>
<p>The resulting object is a <strong>Pynapple</strong> <a class="reference external" href="https://pynapple.org/generated/pynapple.TsdFrame.html#pynapple.TsdFrame"><code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code></a> of shape <code class="docutils literal notranslate"><span class="pre">(n_time_bins,n_trials)</span></code> (we are defining one trial as one presentation of stimuli).</p>
<p>With that, we can plot the PSTH of both the average firing rate of this unit and the average predicted rate.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_peri_predict</span><span class="p">(</span>
        <span class="n">peri_white_pred_unit</span><span class="p">,</span> 
        <span class="n">peri_black_pred_unit</span><span class="p">,</span> 
        <span class="n">peri_white</span><span class="p">,</span> 
        <span class="n">peri_black</span><span class="p">,</span>
        <span class="n">unit_id</span> <span class="o">=</span> <span class="n">unit_id</span>
    
<span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">### white</span>
    <span class="c1"># predicted</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">peri_white_pred_unit</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;predicted&quot;</span><span class="p">)</span>

    <span class="n">peri_u</span> <span class="o">=</span> <span class="n">peri_white</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span>
    <span class="n">peri_u_count</span> <span class="o">=</span> <span class="n">peri_u</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">bin_size</span><span class="p">)</span>

    <span class="n">peri_u_count_conv_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">peri_u_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span>
    <span class="n">peri_u_rate_conv</span> <span class="o">=</span> <span class="n">peri_u_count_conv_mean</span> <span class="o">/</span> <span class="n">bin_size</span>
    <span class="c1"># observed</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peri_u_rate_conv</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.250</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;silver&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">.25</span><span class="p">,</span> <span class="mf">.5</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;White flashes&quot;</span><span class="p">)</span>

    <span class="c1">#### black</span>
    <span class="c1"># predicted</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">peri_black_pred_unit</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>

    <span class="n">peri_u</span> <span class="o">=</span> <span class="n">peri_black</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span>
    <span class="n">peri_u_count</span> <span class="o">=</span> <span class="n">peri_u</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">bin_size</span><span class="p">)</span>

    <span class="n">peri_u_count_conv_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">peri_u_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span>
    <span class="n">peri_u_rate_conv</span> <span class="o">=</span> <span class="n">peri_u_count_conv_mean</span> <span class="o">/</span> <span class="n">bin_size</span>
    <span class="c1"># observed</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peri_u_rate_conv</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;observed&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.250</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">.25</span><span class="p">,</span> <span class="mf">.5</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Black flashes&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rate (Hz)&quot;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">.05</span><span class="p">,</span> <span class="s1">&#39;Time from stim(s)&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">.95</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;PSTH unit </span><span class="si">{</span><span class="n">unit_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_peri_predict</span><span class="p">(</span><span class="n">peri_white_pred_unit</span><span class="p">,</span> 
        <span class="n">peri_black_pred_unit</span><span class="p">,</span> 
        <span class="n">peri_white</span><span class="p">,</span> 
        <span class="n">peri_black</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5429a83cda90b850db4c34fabe46a6848f48bb9e440d0b8f3b147944a61a90c1.png" src="../_images/5429a83cda90b850db4c34fabe46a6848f48bb9e440d0b8f3b147944a61a90c1.png" />
</div>
</div>
<p>Now, we can move to fit all neurons!</p>
</section>
<section id="initialize-and-fit-a-glm-populationglm">
<h3>Initialize and fit a GLM: <a class="reference external" href="https://nemos.readthedocs.io/en/latest/how_to_guide/plot_03_population_glm.html"><code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code></a><a class="headerlink" href="#initialize-and-fit-a-glm-populationglm" title="Link to this heading">#</a></h3>
<p><strong>NeMoS</strong> has a separate <a class="reference external" href="https://nemos.readthedocs.io/en/latest/how_to_guide/plot_03_population_glm.html"><code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code></a> object for fitting a population of neurons. This is equivalent to fitting each individually in a loop, but faster. It operates very similarly to the <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.GLM.html#nemos.glm.GLM.coef_"><code class="docutils literal notranslate"><span class="pre">GLM</span></code></a> object we used a moment ago.</p>
<p>The first step is initializing the model, as with the <code class="docutils literal notranslate"><span class="pre">GLM</span></code> object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_stimuli</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">glm</span><span class="o">.</span><span class="n">PopulationGLM</span><span class="p">(</span>
    <span class="n">regularizer</span> <span class="o">=</span> <span class="s2">&quot;Ridge&quot;</span><span class="p">,</span>
    <span class="n">regularizer_strength</span> <span class="o">=</span> <span class="n">regularizer_strength</span><span class="p">,</span>
    <span class="n">solver_name</span><span class="o">=</span><span class="s2">&quot;LBFGS&quot;</span> 
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Our input for the <a class="reference external" href="https://nemos.readthedocs.io/en/latest/how_to_guide/plot_03_population_glm.html"><code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code></a> can be the same basis object we used for fitting a single unit. Since we now want to fit all neurons, the counts for our model will be <code class="docutils literal notranslate"><span class="pre">units_counts_train</span></code>. With that, we call <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.PopulationGLM.fit.html#nemos.glm.PopulationGLM.fit"><code class="docutils literal notranslate"><span class="pre">model_stimuli.fit()</span></code></a> to fit our model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_stimuli</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train</span><span class="p">,</span>
    <span class="n">units_counts_train</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PopulationGLM(
    observation_model=PoissonObservations(inverse_link_function=exp),
    regularizer=Ridge(),
    regularizer_strength=7.745e-06,
    solver_name=&#39;LBFGS&#39;
)
</pre></div>
</div>
</div>
</div>
<p>Same as before, our coefficients live in the <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.PopulationGLM.html#nemos.glm.PopulationGLM.coef_"><code class="docutils literal notranslate"><span class="pre">coef_</span></code></a> attribute, while our intercept is stored in the <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.PopulationGLM.html#nemos.glm.PopulationGLM.intercept_"><code class="docutils literal notranslate"><span class="pre">intercept_</span></code></a> attribute.</p>
<p>However, since here we have fitted all units, the shape of our <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.PopulationGLM.html#nemos.glm.PopulationGLM.coef_"><code class="docutils literal notranslate"><span class="pre">coef_</span></code></a> output will be <code class="docutils literal notranslate"><span class="pre">(n_coefficients,</span> <span class="pre">n_units)</span></code>. Similarly, the shape of our <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.PopulationGLM.html#nemos.glm.PopulationGLM.intercept_"><code class="docutils literal notranslate"><span class="pre">intercept_</span></code></a> output will be <code class="docutils literal notranslate"><span class="pre">(n_units,)</span></code> because there is one intercept per unit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">model_stimuli</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model_stimuli</span><span class="o">.</span><span class="n">intercept_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(30, 19)
(19,)
</pre></div>
</div>
</div>
</div>
</section>
<section id="assess-populationglm-performance-psth">
<h3>Assess <a class="reference external" href="https://nemos.readthedocs.io/en/latest/how_to_guide/plot_03_population_glm.html"><code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code></a> performance: PSTH<a class="headerlink" href="#assess-populationglm-performance-psth" title="Link to this heading">#</a></h3>
<p>To evaluate how well our <a class="reference external" href="https://nemos.readthedocs.io/en/latest/how_to_guide/plot_03_population_glm.html"><code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code></a> model captures the neural responses, we can visualize the activity of individual units using a PSTH.</p>
<p>For that, we first use the <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.PopulationGLM.predict.html#nemos.glm.PopulationGLM.predict"><code class="docutils literal notranslate"><span class="pre">predict</span></code></a> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Predict spikes rate of all neurons in the population</span>
<span class="n">predicted</span> <span class="o">=</span> <span class="n">model_stimuli</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Convert units from spikes/bin to spikes/sec</span>
<span class="n">predicted</span> <span class="o">=</span> <span class="n">predicted</span><span class="o">/</span> <span class="n">bin_size</span>
</pre></div>
</div>
</div>
</div>
<p>Then, we use <strong>Pynapple</strong> function <a class="reference external" href="https://pynapple.org/generated/pynapple.process.perievent.html#pynapple.process.perievent.compute_perievent_continuous"><code class="docutils literal notranslate"><span class="pre">compute_perievent_continuous</span></code></a> to re-center the timestamps of the observed and predicted rates around the stimulus presentations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Re-center timestamps for test set</span>
<span class="n">peri_white_test</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent_continuous</span><span class="p">(</span>
    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_test</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">bin_size</span><span class="p">),</span>
    <span class="n">tref</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">flashes_test_white</span><span class="o">.</span><span class="n">start</span><span class="o">+</span><span class="mf">.50</span><span class="p">),</span>
    <span class="n">minmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">window_size</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Re-center timestampsfor test set</span>
<span class="n">peri_black_test</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent_continuous</span><span class="p">(</span>
    <span class="n">timeseries</span> <span class="o">=</span>  <span class="n">units</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_test</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">bin_size</span><span class="p">),</span>
    <span class="n">tref</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">flashes_test_black</span><span class="o">.</span><span class="n">start</span><span class="o">+</span><span class="mf">.50</span><span class="p">),</span>
    <span class="n">minmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">window_size</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Re-center timestamps for predicted</span>
<span class="n">peri_white_pred</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent_continuous</span><span class="p">(</span>
    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">predicted</span><span class="p">,</span> 
    <span class="n">tref</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">flashes_test_white</span><span class="o">.</span><span class="n">start</span><span class="o">+</span><span class="mf">.50</span><span class="p">),</span>
    <span class="n">minmax</span><span class="o">=</span><span class="p">(</span><span class="n">window_size</span><span class="p">)</span>
<span class="p">)</span>  

<span class="c1"># Re-center timestamps for predicted</span>
<span class="n">peri_black_pred</span> <span class="o">=</span>  <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent_continuous</span><span class="p">(</span>
    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">predicted</span><span class="p">,</span> 
    <span class="n">tref</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">flashes_test_black</span><span class="o">.</span><span class="n">start</span><span class="o">+</span><span class="mf">.50</span><span class="p">),</span>
    <span class="n">minmax</span><span class="o">=</span><span class="p">(</span><span class="n">window_size</span><span class="p">)</span>
<span class="p">)</span>  
</pre></div>
</div>
</div>
</div>
<p>We can then plot the centered spikes in a PSTH! Let’s see how that looks for the first 9 units.</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_pop_psth</span><span class="p">(</span>
        <span class="n">peri_color</span><span class="p">,</span> 
        <span class="n">color_flashes</span><span class="p">,</span> 
        <span class="n">bin_size</span><span class="p">,</span> 
        <span class="n">smoothing</span><span class="o">=</span><span class="mf">0.015</span><span class="p">,</span>
        <span class="n">n_units</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> 
        <span class="o">**</span><span class="n">peri_others</span>
        <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot perievent time histograms (PSTHs) and raster plots for multiple units.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    peri_color : dict</span>
<span class="sd">        Dictionary mapping unit names to binned spike count peri-stimulus data (e.g., binned time series).</span>
<span class="sd">    units : dict</span>
<span class="sd">        Dictionary of neural units, e.g., spike trains or trial-aligned spike events.</span>
<span class="sd">    color_flashes : str</span>
<span class="sd">        A label indicating the flash color condition (&#39;black&#39; or other), used for visual styling.</span>
<span class="sd">    bin_size : float</span>
<span class="sd">        Size of the bin used for spike count computation (in seconds).</span>
<span class="sd">    smoothing : float</span>
<span class="sd">        Standard deviation for Gaussian smoothing of the PSTH traces.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Layout setup: 7 columns (units), 2 rows (split vertically into PSTH and raster plot)</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="n">n_units</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="mf">2.5</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># Use tab20 color palette for plotting different units</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab20</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="n">n_cols</span><span class="p">]</span>

    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">n_rows</span> <span class="c1"># Plot as many units as half the number of rows </span>
                            <span class="c1"># each unit occupies 2 rows (one for psth and other for raster)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_units</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="n">peri_color</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Plot PSTH (smoothed firing rate)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">bin_size</span><span class="p">)</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="n">smoothing</span><span class="p">),</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Observed&quot;</span>
        <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">bin_size</span><span class="p">)</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="n">smoothing</span><span class="p">),</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># Stimulus onset line</span>
        <span class="n">span_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span> <span class="k">if</span> <span class="n">color_flashes</span> <span class="o">==</span> <span class="s2">&quot;black&quot;</span> <span class="k">else</span> <span class="s2">&quot;silver&quot;</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.250</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">span_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>  <span class="c1"># Stim duration</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">peri_pred</span><span class="p">)</span> <span class="ow">in</span> <span class="n">peri_others</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">u_pred</span> <span class="o">=</span> <span class="n">peri_pred</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">u_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
            <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">u_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Shift window for next units</span>
        <span class="n">start</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">end</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c1"># Y-axis and title annotations</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rate (Hz)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_rows</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rate (Hz)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Trial&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="s1">&#39;Time from stim(s)&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;PSTH - </span><span class="si">{</span><span class="n">color_flashes</span><span class="si">}</span><span class="s1"> flashes&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_pop_psth</span><span class="p">(</span>
    <span class="n">peri_white_test</span><span class="p">,</span> 
    <span class="s2">&quot;white&quot;</span><span class="p">,</span> 
    <span class="n">bin_size</span><span class="p">,</span>
    <span class="n">peri_pred_stimuli</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Predicted&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">peri_white_pred</span><span class="p">)</span>
    <span class="p">)</span>

<span class="n">plot_pop_psth</span><span class="p">(</span>
    <span class="n">peri_black_test</span><span class="p">,</span> 
    <span class="s2">&quot;black&quot;</span><span class="p">,</span> 
    <span class="n">bin_size</span><span class="p">,</span>
    <span class="n">peri_pred_stimuli</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Predicted&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">peri_black_pred</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/86b3c45d22cb3f8777aef0f5c452c4eb837459284057b1636204d117313130c4.png" src="../_images/86b3c45d22cb3f8777aef0f5c452c4eb837459284057b1636204d117313130c4.png" />
<img alt="../_images/c342983cc405e195c27c97b4cce990bd15ecc954cd677eb6a76f20131cd57b34.png" src="../_images/c342983cc405e195c27c97b4cce990bd15ecc954cd677eb6a76f20131cd57b34.png" />
</div>
</div>
<p>The model does pretty good! However, we can see some artifacts and unnatural peaks. What could we try to improve this model a little bit?</p>
</section>
</section>
<section id="adding-coupling-as-a-new-predictor">
<h2>Adding coupling as a new predictor<a class="headerlink" href="#adding-coupling-as-a-new-predictor" title="Link to this heading">#</a></h2>
<p>We can try extending the model in order to improve its performance. There are many ways one can do this: the iterative refinement and improvement of your model is an important part of the scientific process! In this tutorial, we’ll discuss one such extension, but you’re encouraged to try others.</p>
<p>Now, we’ll extend the model by adding coupling terms—that is, including the activity of other neurons as predictors—to account for shared variability within the network. It’s been shown by  <span id="id5">Pillow <em>et al.</em> [<a class="reference internal" href="../bibliography.html#id5" title="Jonathan W. Pillow, Jonathon Shlens, Liam Paninski, Alexander Sher, Alan M. Litke, E. J. Chichilnisky, and Eero P. Simoncelli. Spatio-temporal correlations and visual signalling in a complete neuronal population. Nature, 454(7207):995–999, 2008. doi:10.1038/nature07140.">2008</a>]</span>
<span id="cite1b"></span><a href="#ref1">[1b]</a> that spike times can be predicted more accurately when taking into account the spiking of neighbouring units.</p>
<p>We start by creating a new basis object</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># New basis object for coupling</span>
<span class="n">basis_coupling</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">RaisedCosineLogConv</span><span class="p">(</span>
    <span class="n">n_basis_funcs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="n">window_len</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;spike_history&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can add this new basis to our old <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/_basis/nemos.basis._basis.AdditiveBasis.html"><code class="docutils literal notranslate"><span class="pre">additive</span> <span class="pre">basis</span></code></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># New additive basis with coupling term</span>
<span class="n">additive_basis_coupling</span> <span class="o">=</span> <span class="n">additive_basis</span> <span class="o">+</span> <span class="n">basis_coupling</span>
</pre></div>
</div>
</div>
</div>
<p>And use <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/_basis/nemos.basis._basis.AdditiveBasis.compute_features.html#nemos.basis._basis.AdditiveBasis.compute_features"><code class="docutils literal notranslate"><span class="pre">compute_features</span></code></a> to convolve our input features with the basis object to compress them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the features for train and test</span>
<span class="n">X_coupling_train</span> <span class="o">=</span> <span class="n">additive_basis_coupling</span><span class="o">.</span><span class="n">compute_features</span><span class="p">(</span>
    <span class="n">white_train_on</span><span class="p">,</span>
    <span class="n">white_train_off</span><span class="p">,</span>
    <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span><span class="n">t</span><span class="o">=</span> <span class="n">white_train_on</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="n">predictors_train</span><span class="p">[</span><span class="s2">&quot;white&quot;</span><span class="p">],</span> <span class="n">time_support</span><span class="o">=</span><span class="n">units_counts_train</span><span class="o">.</span><span class="n">time_support</span><span class="p">),</span>
    <span class="n">black_train_on</span><span class="p">,</span>
    <span class="n">black_train_off</span><span class="p">,</span>
    <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span><span class="n">t</span><span class="o">=</span> <span class="n">black_train_on</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="n">predictors_train</span><span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">],</span> <span class="n">time_support</span><span class="o">=</span><span class="n">units_counts_train</span><span class="o">.</span><span class="n">time_support</span><span class="p">),</span>
    <span class="n">nap</span><span class="o">.</span><span class="n">TsdFrame</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">units_counts_train</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">units_counts_train</span><span class="p">,</span> <span class="n">time_support</span><span class="o">=</span><span class="n">units_counts_train</span><span class="o">.</span><span class="n">time_support</span><span class="p">)</span> <span class="c1"># Our spike counts</span>
<span class="p">)</span>
<span class="n">X_coupling_test</span> <span class="o">=</span> <span class="n">additive_basis_coupling</span><span class="o">.</span><span class="n">compute_features</span><span class="p">(</span>
    <span class="n">white_test_on</span><span class="p">,</span>
    <span class="n">white_test_off</span><span class="p">,</span>
    <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span><span class="n">t</span><span class="o">=</span> <span class="n">white_test_on</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="n">predictors_test</span><span class="p">[</span><span class="s2">&quot;white&quot;</span><span class="p">],</span> <span class="n">time_support</span><span class="o">=</span><span class="n">units_counts_test</span><span class="o">.</span><span class="n">time_support</span><span class="p">),</span>
    <span class="n">black_test_on</span><span class="p">,</span>
    <span class="n">black_test_off</span><span class="p">,</span>
    <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span><span class="n">t</span><span class="o">=</span> <span class="n">black_test_on</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="n">predictors_test</span><span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">],</span> <span class="n">time_support</span><span class="o">=</span><span class="n">units_counts_test</span><span class="o">.</span><span class="n">time_support</span><span class="p">),</span>
    <span class="n">nap</span><span class="o">.</span><span class="n">TsdFrame</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">units_counts_test</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">units_counts_test</span><span class="p">,</span> <span class="n">time_support</span><span class="o">=</span><span class="n">units_counts_test</span><span class="o">.</span><span class="n">time_support</span><span class="p">)</span> <span class="c1"># Our spike counts</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="info admonition">
<p class="admonition-title">What is the result of running <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/_basis/nemos.basis._basis.AdditiveBasis.compute_features.html#nemos.basis._basis.AdditiveBasis.compute_features"><code class="docutils literal notranslate"><span class="pre">compute_features</span></code></a> with our raised cosine log-stretched basis and the spike counts?</p>
<p><a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/_basis/nemos.basis._basis.AdditiveBasis.compute_features.html#nemos.basis._basis.AdditiveBasis.compute_features"><code class="docutils literal notranslate"><span class="pre">compute_features</span></code></a> is convolving all spike counts from all neurons with a raised cosine log-stretched basis. We do this because adding a coupling filter would resemble interactions between cells, and can mimic the effects of shared input noise, as mentioned in <span id="id6">Pillow <em>et al.</em> [<a class="reference internal" href="../bibliography.html#id5" title="Jonathan W. Pillow, Jonathon Shlens, Liam Paninski, Alexander Sher, Alan M. Litke, E. J. Chichilnisky, and Eero P. Simoncelli. Spatio-temporal correlations and visual signalling in a complete neuronal population. Nature, 454(7207):995–999, 2008. doi:10.1038/nature07140.">2008</a>]</span> <span id="cite1c"></span><a href="#ref1">[1c]</a>.</p>
</div>
<p>We initialize a new <a class="reference external" href="https://nemos.readthedocs.io/en/latest/how_to_guide/plot_03_population_glm.html"><code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code></a> object</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">regularizer_strength</span> <span class="o">=</span> <span class="mf">0.005</span> 

<span class="n">model_coupling</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">glm</span><span class="o">.</span><span class="n">PopulationGLM</span><span class="p">(</span>
    <span class="n">regularizer</span> <span class="o">=</span> <span class="s2">&quot;Ridge&quot;</span><span class="p">,</span>
    <span class="n">regularizer_strength</span> <span class="o">=</span> <span class="n">regularizer_strength</span><span class="p">,</span>
    <span class="n">solver_name</span><span class="o">=</span><span class="s2">&quot;LBFGS&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Where did this new <code class="docutils literal notranslate"><span class="pre">regularizer_strength</span></code> value come from?</p>
<p>We conducted cross validation again to obtain the regularization strength for this new model. Adding extra parameters increases the risk of overfitting, so getting a new <code class="docutils literal notranslate"><span class="pre">regularizer_strength</span></code> to account for that makes sense.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridSearchCV</span>

<span class="n">model_coupling</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">glm</span><span class="o">.</span><span class="n">PopulationGLM</span><span class="p">(</span>
    <span class="n">regularizer</span> <span class="o">=</span> <span class="s2">&quot;Ridge&quot;</span><span class="p">,</span>
    <span class="n">regularizer_strength</span> <span class="o">=</span> <span class="n">regularizer_strength</span><span class="p">,</span>
    <span class="n">solver_name</span><span class="o">=</span><span class="s2">&quot;LBFGS&quot;</span>
<span class="p">)</span>
<span class="c1"># Create parameter grid</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;regularizer_strength&quot;</span> <span class="p">:</span> 
    <span class="n">np</span><span class="o">.</span><span class="n">geomspace</span><span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Instantiate the grid search object</span>
<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
    <span class="n">model_coupling</span><span class="p">,</span><span class="n">param_grid</span><span class="p">,</span> 
    <span class="n">cv</span><span class="o">=</span><span class="mi">5</span>
    <span class="p">)</span>

<span class="c1"># Run grid search</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_coupling_train</span><span class="p">,</span> <span class="n">units_counts_train</span><span class="p">)</span>

<span class="c1"># Print optimal parameter</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span><span class="o">.</span><span class="n">regularizer_strength</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mf">0.004641588833612782</span>
</pre></div>
</div>
<p>Here we got a regularizer strength for the whole population but, again, when conducting a real analysis, a regularizer strength must be obtained for each unit.</p>
</div>
<p>And we fit calling <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.PopulationGLM.fit.html#nemos.glm.PopulationGLM.fit"><code class="docutils literal notranslate"><span class="pre">model_coupling.fit()</span></code></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_coupling</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_coupling_train</span><span class="p">,</span><span class="n">units_counts_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PopulationGLM(
    observation_model=PoissonObservations(inverse_link_function=exp),
    regularizer=Ridge(),
    regularizer_strength=0.005,
    solver_name=&#39;LBFGS&#39;
)
</pre></div>
</div>
</div>
</div>
<section id="assess-coupling-populationglm-performance-heatmap">
<h3>Assess coupling <a class="reference external" href="https://nemos.readthedocs.io/en/latest/how_to_guide/plot_03_population_glm.html"><code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code></a> performance: heatmap<a class="headerlink" href="#assess-coupling-populationglm-performance-heatmap" title="Link to this heading">#</a></h3>
<p>Another way to visually inspect how well our <a class="reference external" href="https://nemos.readthedocs.io/en/latest/how_to_guide/plot_03_population_glm.html"><code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code></a> model captures the neural responses is to summarize the activity from all the units using a heatmap. Here’s how we construct it:</p>
<ol class="arabic simple">
<li><p>Predict: we get the predicted firing rate of each timepoint for each neuron using <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.PopulationGLM.predict.html#nemos.glm.PopulationGLM.predict"><code class="docutils literal notranslate"><span class="pre">predict</span></code></a> with our <a class="reference external" href="https://nemos.readthedocs.io/en/latest/how_to_guide/plot_03_population_glm.html"><code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code></a> model object.</p></li>
<li><p>Re center timestamps: we can use <strong>Pynapple</strong> function <a class="reference external" href="https://pynapple.org/generated/pynapple.process.perievent.html#pynapple.process.perievent.compute_perievent_continuous"><code class="docutils literal notranslate"><span class="pre">compute_perievent_continuous</span></code></a> to re-center spiking activity timestamps around the presentation of stimuli.</p></li>
<li><p>Z-scoring: We normalize the activity of each unit by converting it to z-scores. This removes differences in firing rate scale and allows us to focus on the relative response patterns across neurons.</p></li>
<li><p>Sorting by peak time: We then sort neurons by the time at which they show their peak response in the observed data. This reveals any sequential or structured dynamics in the population response. We sort the observed data, and then use that sorting to order the prediction.</p></li>
<li><p>Side-by-side comparison: Finally, we plot the observed and predicted population responses side by side. If the model captures the key features of the response, the predicted plot should resemble the observed one: we would expect to see a similar diagonal or curved band of activity, reflecting the ordered peak responses.</p></li>
</ol>
<p>Step 1: The same way as before, we can obtain the predictions using <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.PopulationGLM.predict.html#nemos.glm.PopulationGLM.predict"><code class="docutils literal notranslate"><span class="pre">predict</span></code></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predicted</span> <span class="o">=</span> <span class="n">model_coupling</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_coupling_test</span><span class="p">)</span><span class="o">/</span> <span class="n">bin_size</span>
</pre></div>
</div>
</div>
</div>
<p>Step 2: we can center unit’s activity around stimuli presentation with <a class="reference external" href="https://pynapple.org/generated/pynapple.process.perievent.html#pynapple.process.perievent.compute_perievent_continuous"><code class="docutils literal notranslate"><span class="pre">compute_perievent_continuous</span></code></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Re-center timestamps for predicted</span>
<span class="n">peri_white_pred_coupling</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent_continuous</span><span class="p">(</span>
    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">predicted</span><span class="p">,</span> 
    <span class="n">tref</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">flashes_test_white</span><span class="o">.</span><span class="n">start</span><span class="o">+</span><span class="mf">.50</span><span class="p">),</span>
    <span class="n">minmax</span><span class="o">=</span><span class="p">(</span><span class="n">window_size</span><span class="p">)</span>
<span class="p">)</span>  

<span class="n">peri_black_pred_coupling</span> <span class="o">=</span>  <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent_continuous</span><span class="p">(</span>
    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">predicted</span><span class="p">,</span> 
    <span class="n">tref</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">flashes_test_black</span><span class="o">.</span><span class="n">start</span><span class="o">+</span><span class="mf">.50</span><span class="p">),</span>
    <span class="n">minmax</span><span class="o">=</span><span class="p">(</span><span class="n">window_size</span><span class="p">)</span>
<span class="p">)</span>  
</pre></div>
</div>
</div>
</div>
<p>Steps 3 and 4: Z-scoring and sorting according to peak time</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_zscore_dic</span><span class="p">(</span>
        <span class="n">peri_white_test</span><span class="p">,</span> 
        <span class="n">peri_black_test</span><span class="p">,</span>
        <span class="n">peri_white_pred</span><span class="p">,</span>
        <span class="n">peri_black_pred</span><span class="p">,</span>
        <span class="n">smoothing</span> <span class="o">=</span> <span class="mf">0.015</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes z-scored, time-aligned population responses for both observed </span>
<span class="sd">    and predicted data and stores the outputs in separate dictionaries</span>
<span class="sd">    </span>
<span class="sd">    For each stimulus condition (white, black), the function:</span>
<span class="sd">    - Averages peri-stimulus time series across trials</span>
<span class="sd">    - Restricts to a fixed time window around stimulus onset</span>
<span class="sd">    - Applies z-scoring across time for each neuron</span>
<span class="sd">    - Sorts neurons by time of peak response (in observed data)</span>
<span class="sd">    - Returns sorted z-scored matrices for both  and predicted data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    peri_white_test : TsdFrame</span>
<span class="sd">        Observed responses to white stimuli (trials × time × neurons).</span>
<span class="sd">    peri_black_test : TsdFrame</span>
<span class="sd">        Observed responses to black stimuli.</span>
<span class="sd">    peri_white_pred : TsdFrame</span>
<span class="sd">        Predicted responses to white stimuli.</span>
<span class="sd">    peri_black_pred : TsdFrame</span>
<span class="sd">        Predicted responses to black stimuli.</span>
<span class="sd">    smoothing : float</span>
<span class="sd">        Standard deviation for Gaussian smoothing of the perievent traces.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dic_test : dict</span>
<span class="sd">        Dictionary containing:</span>
<span class="sd">            - &#39;z&#39;: z-scored and sorted observed activity (time × neurons)</span>
<span class="sd">            - &#39;order&#39;: neuron sorting indices based on peak response</span>
<span class="sd">    dic_pred : dict</span>
<span class="sd">        Dictionary containing:</span>
<span class="sd">            - &#39;z&#39;: z-scored predicted activity, sorted using test order</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Time window around the stimulus (250 ms before and 500ms after)</span>
    <span class="n">restriction</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">.24</span><span class="p">,</span> <span class="mf">.5</span><span class="p">]</span>

    <span class="c1"># Initialize dictionaries to store processed data</span>
    <span class="n">dic_test</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;white&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>  <span class="c1"># Z-scored + sorted activity + sort order</span>
        <span class="s2">&quot;black&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="p">}</span>
    <span class="n">dic_pred</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;white&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>  <span class="c1"># Z-scored + sorted predicted activity</span>
        <span class="s2">&quot;black&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="p">}</span>

    <span class="c1"># Process TEST data for each stimulus type</span>
    <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">peri</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">peri_white_test</span><span class="p">,</span> <span class="n">peri_black_test</span><span class="p">]):</span>
        <span class="c1"># Restrict time window and average across trials</span>
        <span class="n">mean_peri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="n">peri</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span><span class="n">restriction</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="n">smoothing</span><span class="p">)</span>
        <span class="c1"># Z-score across time for each neuron (independently)</span>
        <span class="n">z_mean_peri</span> <span class="o">=</span> <span class="n">zscore</span><span class="p">(</span><span class="n">mean_peri</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Sort neurons by time of their peak response</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">z_mean_peri</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="c1"># Apply sorting to z-scored data</span>
        <span class="n">z_sorted</span> <span class="o">=</span> <span class="n">z_mean_peri</span><span class="p">[:,</span> <span class="n">order</span><span class="p">]</span>
        <span class="c1"># Store results in dictionary</span>
        <span class="n">dic_test</span><span class="p">[</span><span class="n">color</span><span class="p">][</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_sorted</span>
        <span class="n">dic_test</span><span class="p">[</span><span class="n">color</span><span class="p">][</span><span class="s2">&quot;order&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>

    <span class="c1"># Process PREDICTED data</span>
    <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">peri</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">],</span> 
        <span class="p">[</span><span class="n">peri_white_pred</span><span class="p">,</span> <span class="n">peri_black_pred</span><span class="p">]):</span>  
        <span class="c1"># Restrict time window and average across trials</span>
        <span class="n">mean_peri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="n">peri</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span><span class="n">restriction</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="c1"># Z-score across time for each neuron</span>
        <span class="n">z_mean_peri</span> <span class="o">=</span> <span class="n">zscore</span><span class="p">(</span><span class="n">mean_peri</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Use the same neuron ordering as in test data for comparison</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">dic_test</span><span class="p">[</span><span class="n">color</span><span class="p">][</span><span class="s2">&quot;order&quot;</span><span class="p">]</span>
        <span class="c1"># Sort predicted responses using test-data order</span>
        <span class="n">z_sorted</span> <span class="o">=</span> <span class="n">z_mean_peri</span><span class="p">[:,</span> <span class="n">order</span><span class="p">]</span>
        <span class="c1"># Store in dictionary</span>
        <span class="n">dic_pred</span><span class="p">[</span><span class="n">color</span><span class="p">][</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_sorted</span>

    <span class="k">return</span> <span class="n">dic_test</span><span class="p">,</span> <span class="n">dic_pred</span>
</pre></div>
</div>
</div>
</div>
<p>Create our dictionaries of z-scored mean activity</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dic_test</span><span class="p">,</span> <span class="n">dic_pred_coupling</span> <span class="o">=</span> <span class="n">create_zscore_dic</span><span class="p">(</span>
    <span class="n">peri_white_test</span><span class="p">,</span>
    <span class="n">peri_black_test</span><span class="p">,</span>
    <span class="n">peri_white_pred_coupling</span><span class="p">,</span>
    <span class="n">peri_black_pred_coupling</span>
<span class="p">)</span>

<span class="n">dic_test</span><span class="p">,</span> <span class="n">dic_pred_stimuli</span> <span class="o">=</span> <span class="n">create_zscore_dic</span><span class="p">(</span>
    <span class="n">peri_white_test</span><span class="p">,</span> 
    <span class="n">peri_black_test</span><span class="p">,</span>
    <span class="n">peri_white_pred</span><span class="p">,</span>
    <span class="n">peri_black_pred</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Step 5: Plot side by side comparison</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_zscores</span><span class="p">(</span><span class="n">dic_test</span><span class="p">,</span> <span class="n">dic_pred_stimuli</span><span class="p">,</span> <span class="n">dic_pred_coupling</span><span class="p">,</span> <span class="n">bin_size</span> <span class="o">=</span> <span class="n">bin_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot heatmaps of z-scored neuronal responses for both observed and predicted data.</span>

<span class="sd">    For each stimulus type (white and black), the function:</span>
<span class="sd">    - Plots a heatmap of z-scored activity for each unit, sorted by time of peak response</span>
<span class="sd">    - Compares observed and predicted activity side-by-side</span>
<span class="sd">    - Adds time markers at stimulus onset and offset</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dic_test : dict</span>
<span class="sd">        Dictionary with observed z-scored and sorted activity for &#39;white&#39; and &#39;black&#39; stimuli.</span>
<span class="sd">    dic_pred : dict</span>
<span class="sd">        Dictionary with predicted z-scored activity for &#39;white&#39; and &#39;black&#39; stimuli,</span>
<span class="sd">        sorted using the same order as dic_test.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Displays matplotlib figures.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">]:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

        <span class="c1"># Number of time bins in z-scored matrix (time x neurons)</span>
        <span class="c1">#num_bins = dic_test[color][&quot;z&quot;].shape[0]</span>

        <span class="c1"># Create time axis assuming bin size defined elsewhere</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">)</span>

        <span class="c1"># Image limits: [x_min, x_max, y_min, y_max]</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dic_test</span><span class="p">[</span><span class="n">color</span><span class="p">][</span><span class="s2">&quot;z&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="c1"># Plot observed activity</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dic_test</span><span class="p">[</span><span class="n">color</span><span class="p">][</span><span class="s2">&quot;z&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>  <span class="c1"># neurons on y-axis, time on x-axis</span>
            <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="n">limits</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">color</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Observed&quot;</span><span class="p">)</span>

        <span class="c1"># Plot predicted activity with stimuli model</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dic_pred_stimuli</span><span class="p">[</span><span class="n">color</span><span class="p">][</span><span class="s2">&quot;z&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="n">limits</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">color</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Predicted (Stimuli)&quot;</span><span class="p">)</span>

        <span class="c1"># Plot predicted activity with coupling model</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dic_pred_coupling</span><span class="p">[</span><span class="n">color</span><span class="p">][</span><span class="s2">&quot;z&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="n">limits</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">color</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Predicted (Stimuli + Coupling)&quot;</span><span class="p">)</span>

        <span class="c1"># Add vertical lines for stimulus onset (0s) and offset (0.25s)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
            <span class="n">a</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Unit&quot;</span><span class="p">)</span>

        <span class="c1"># Shared x-axis label</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="s1">&#39;Time from stim (s)&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

        <span class="c1"># Colorbar</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Z-score&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_zscores</span><span class="p">(</span><span class="n">dic_test</span><span class="p">,</span> <span class="n">dic_pred_stimuli</span><span class="p">,</span> <span class="n">dic_pred_coupling</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/394e6a206ecd703b64b2cfc9244ba24f7ce7d510f91df2554570dc528ce74e39.png" src="../_images/394e6a206ecd703b64b2cfc9244ba24f7ce7d510f91df2554570dc528ce74e39.png" />
<img alt="../_images/18e827e1378abd97f89f5cf907b6e0f9f1656cbd8ab26b658c860f27955b5859.png" src="../_images/18e827e1378abd97f89f5cf907b6e0f9f1656cbd8ab26b658c860f27955b5859.png" />
</div>
</div>
<p>To the left of this plot we can see the observed z-scored activity, sorted by peak response time. In the middle, we can see the z-scored predictions of the model with Stimuli filters. To the right, we can see the z-scored predictions of the model with Stimuli and Coupling filters.</p>
<p>We can see that the average peak activity looks similar! Let’s compare the prediction of the Stimuli versus the Stimuli + Coupling model using a PSTH:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_pop_psth</span><span class="p">(</span>
    <span class="n">peri_white_test</span><span class="p">,</span> 
    <span class="s2">&quot;white&quot;</span><span class="p">,</span> 
    <span class="n">bin_size</span><span class="p">,</span>
    <span class="n">peri_pred_stimuli</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Stimuli&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">peri_white_pred</span><span class="p">),</span>
    <span class="n">peri_pred_coupling</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Stimuli + Coupling&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">peri_white_pred_coupling</span><span class="p">)</span>
    <span class="p">)</span>

<span class="n">plot_pop_psth</span><span class="p">(</span>
    <span class="n">peri_black_test</span><span class="p">,</span> 
    <span class="s2">&quot;black&quot;</span><span class="p">,</span> 
    <span class="n">bin_size</span><span class="p">,</span>
    <span class="n">peri_pred_stimuli</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Stimuli&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">peri_black_pred</span><span class="p">),</span>
    <span class="n">peri_pred_coupling</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Stimuli + Coupling&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">peri_black_pred_coupling</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/be8ec0648702cee7fb7fb8035416f6d307ec67f363389a74934a780a3905c9cd.png" src="../_images/be8ec0648702cee7fb7fb8035416f6d307ec67f363389a74934a780a3905c9cd.png" />
<img alt="../_images/4e3e75612ee629870714c0b171a86ffcf853687efd1f65f01e6123fd6a874d00.png" src="../_images/4e3e75612ee629870714c0b171a86ffcf853687efd1f65f01e6123fd6a874d00.png" />
</div>
</div>
</section>
</section>
<section id="evaluate-model-performance-quantitatively-pseudo-r-2-mcfadden">
<h2>Evaluate model performance quantitatively: Pseudo-<span class="math notranslate nohighlight">\(R^2\)</span> McFadden<a class="headerlink" href="#evaluate-model-performance-quantitatively-pseudo-r-2-mcfadden" title="Link to this heading">#</a></h2>
<p>Comparing the two models by examining their predictions is important, but you may also want a number with which to evaluate and compare your models’ performance. As discussed earlier, the GLM optimizes log-likelihood to find the best-fitting weights, and we can calculate this number using <strong>NeMoS</strong> <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.PopulationGLM.score.html#nemos.glm.PopulationGLM.score"><code class="docutils literal notranslate"><span class="pre">score</span></code></a> method.</p>
<p>This function takes the following as required inputs:</p>
<ul class="simple">
<li><p>Predictors (in our case, our additive basis <code class="docutils literal notranslate"><span class="pre">X_coupling_test</span></code>, which includes information of our black and white predictors, as well as the subset of units counts corresponding to the test set)</p></li>
<li><p>Counts (in our case, <code class="docutils literal notranslate"><span class="pre">units_counts_test</span></code>, because we wish to evaluate how good the model is at predicting unseen data)</p></li>
</ul>
<p>By default, <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.PopulationGLM.score.html#nemos.glm.PopulationGLM.score"><code class="docutils literal notranslate"><span class="pre">score</span></code></a> computes the mean log-likelihood. However, because the log-likelihood is un-normalized, it should not be compared across datasets (because e.g., it won’t account for difference in noise levels). We provide the ability to compute the pseudo-<span class="math notranslate nohighlight">\(R^2\)</span> for this purpose. For that, you only need to pass <code class="docutils literal notranslate"><span class="pre">&quot;pseudo-r2-McFadden&quot;</span></code> as <code class="docutils literal notranslate"><span class="pre">score_type</span></code> (optional input):</p>
<div class="dropdown admonition">
<p class="admonition-title">Why are we using <code class="docutils literal notranslate"><span class="pre">pseudo-r2</span></code>? Why not just use standard <span class="math notranslate nohighlight">\(R^2\)</span> as in linear regression?</p>
<p>In standard linear regression, model performance is often evaluated using the coefficient of determination, <span class="math notranslate nohighlight">\(R^2\)</span>, which represents the proportion of variance in the data explained by the model:</p>
<div class="math notranslate nohighlight">
\[
R^2 = 1 - \frac{\sum_i (y_i - \hat{y}_i)^2}{\sum_i (y_i - \mu)^2}
\]</div>
<p>Here:</p>
<ul class="simple">
<li><p>The numerator is the residual sum of squares (variance <strong>not</strong> explained by the model),</p></li>
<li><p>The denominator is the total variance of the observations.</p></li>
</ul>
<p>For instance, if a model only predicts the mean of the data (i.e., <span class="math notranslate nohighlight">\(\hat{y}_i = \mu\)</span> for all <span class="math notranslate nohighlight">\(i\)</span>), then:</p>
<div class="math notranslate nohighlight">
\[
R^2 = 1 - \frac{\sum_i (y_i - \mu)^2}{\sum_i (y_i - \mu)^2} = 0
\]</div>
<p>This means the model explains none of the variance beyond the baseline.</p>
<p>However, for GLMs, using <span class="math notranslate nohighlight">\(R^2\)</span> is problematic for two key reasons:</p>
<ol class="arabic simple">
<li><p>Mean-variance relationship: in many GLMs, the variance is not constant but depends on the mean. For example, in a LNP model, a higher predicted firing rate implies a higher variance. This violates the assumption of <em>homoscedasticity</em> (constant variance) required for standard <span class="math notranslate nohighlight">\(R^2\)</span> to be meaningful. As a result, even a model that predicts the mean accurately might appear to perform poorly under <span class="math notranslate nohighlight">\(R^2\)</span> due to large, but expected, residuals.</p></li>
<li><p>Nonlinear link function: GLMs include a nonlinear transformation (link function) between the predictors and the mean of the observations. Because <span class="math notranslate nohighlight">\(R^2\)</span> is derived under the assumption of a linear relationship, it no longer reflects the “proportion of explained variance” in a meaningful way when this assumption is violated.</p></li>
</ol>
<p>To address these limitations, we use <code class="docutils literal notranslate"><span class="pre">pseudo-r2</span></code>, which generalizes the concept of goodness-of-fit to non-Gaussian models. One common version is McFadden’s pseudo-<span class="math notranslate nohighlight">\(R^2\)</span>, defined as:</p>
<div class="math notranslate nohighlight">
\[
R^2_{\text{McF}} = 1 - \frac{\log L_M}{\log L_0}
\]</div>
<p>Where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\log L_M\)</span> is the log-likelihood of the fitted model,</p></li>
<li><p><span class="math notranslate nohighlight">\(\log L_0\)</span> is the log-likelihood of the null model (a model with only an intercept, i.e. predicting a constant mean).</p></li>
</ul>
<p>This metric captures how much better the model is compared to simply predicting a constant mean, and can be interpreted as a <em>normalized log-likelihood</em>. Its values typically range between 0 and 1, but negative values can occur and may indicate poor fit or overfitting.</p>
<hr class="docutils" />
<p>In this tutorial, we use McFadden’s pseudo-<span class="math notranslate nohighlight">\(R^2\)</span>  to evaluate model performance, as it is more appropriate for models like the LNP model used here.</p>
<p>For more details on implementation and additional scoring metrics, see the <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.PopulationGLM.score.html#nemos.glm.PopulationGLM.score"><strong>NeMos</strong> documentation</a>.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the mean score for the Stimuli + Coupling model</span>
<span class="c1"># using pseudo-r2-McFadden</span>
<span class="n">score_coupling</span> <span class="o">=</span> <span class="n">model_coupling</span><span class="o">.</span><span class="n">score</span><span class="p">(</span>
    <span class="n">X_coupling_test</span><span class="p">,</span>
    <span class="n">units_counts_test</span><span class="p">,</span>
    <span class="n">score_type</span> <span class="o">=</span> <span class="s2">&quot;pseudo-r2-McFadden&quot;</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">score_coupling</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.20056623
</pre></div>
</div>
</div>
</div>
<p>We can also access each unit’s score by adding a <code class="docutils literal notranslate"><span class="pre">lambda</span></code> function to the optional parameter <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.PopulationGLM.score.html#nemos.glm.PopulationGLM.score"><code class="docutils literal notranslate"><span class="pre">aggregate_sample_scores</span></code></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Obtain individual units&#39; scores</span>
<span class="n">score_units</span> <span class="o">=</span> <span class="n">model_coupling</span><span class="o">.</span><span class="n">score</span><span class="p">(</span>
    <span class="n">X_coupling_test</span><span class="p">,</span> 
    <span class="n">units_counts_test</span><span class="p">,</span> 
    <span class="n">score_type</span> <span class="o">=</span> <span class="s2">&quot;pseudo-r2-McFadden&quot;</span><span class="p">,</span>
    <span class="n">aggregate_sample_scores</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> 
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">score_units</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.10131961 0.4054796  0.15242094 0.10345095 0.17804486 0.5537226
 0.23751181 0.1442216  0.09226435 0.04176563 0.15948278 0.14035589
 0.0955326  0.19902009 0.2875896  0.17398357 0.38125545 0.11390072
 0.36725706]
</pre></div>
</div>
</div>
</div>
<p>Let’s calculate the score separately for white and black flashes, and for both models (Stimuli and Stimuli + Coupling) using helper functions</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">score_type</span><span class="o">=</span><span class="s2">&quot;pseudo-r2-McFadden&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate a model&#39;s performance at the population and unit levels.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : object</span>
<span class="sd">        A model object that implements a `.score()` method with arguments `X`, `y`, and `score_type`.</span>
<span class="sd">    X : array-like or pynapple-compatible object</span>
<span class="sd">        Input features used for evaluation.</span>
<span class="sd">    y : array-like or pynapple-compatible object</span>
<span class="sd">        Target outputs corresponding to `X`.</span>
<span class="sd">    score_type : str, optional</span>
<span class="sd">        The scoring metric to use (e.g., &quot;log-likelihood&quot; or &quot;pseudo-r2-McFadden&quot;). Passed to the model&#39;s `score` method.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    score_pop : float</span>
<span class="sd">        The population-level score (aggregated across all units and samples).</span>
<span class="sd">    score_unit : np.ndarray</span>
<span class="sd">        The unit-level scores, computed by averaging over samples for each unit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">score_pop</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span> 
        <span class="n">y</span><span class="p">,</span> 
        <span class="n">score_type</span><span class="o">=</span><span class="n">score_type</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">score_unit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span> 
        <span class="n">y</span><span class="p">,</span> 
        <span class="n">aggregate_sample_scores</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> 
        <span class="n">score_type</span><span class="o">=</span><span class="n">score_type</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">score_pop</span><span class="p">,</span> <span class="n">score_unit</span>

<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_models_by_color</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">X_sets</span><span class="p">,</span> <span class="n">y_sets</span><span class="p">,</span> <span class="n">flashes_color</span><span class="p">,</span> <span class="n">score_type</span><span class="o">=</span><span class="s2">&quot;log-likelihood&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate multiple models on a dataset filtered by flash color.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    models : dict of str -&gt; model</span>
<span class="sd">        Dictionary of model names and model objects to evaluate. Each model must implement `.score()`.</span>
<span class="sd">    X_sets : dict of str -&gt; array-like or pynapple-compatible object</span>
<span class="sd">        Dictionary mapping model names to their corresponding input features.</span>
<span class="sd">    y_sets : array-like or pynapple-compatible object</span>
<span class="sd">        The target outputs to be used with all models.</span>
<span class="sd">    flashes_color : str</span>
<span class="sd">        The flash color condition used to restrict the data (e.g., &quot;black&quot; or &quot;white&quot;).</span>
<span class="sd">    score_type : str, optional</span>
<span class="sd">        The scoring metric to use (e.g., &quot;log-likelihood&quot;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model_base_pop : float</span>
<span class="sd">        Population-level score of the first model in `models`.</span>
<span class="sd">    model_base_unit : np.ndarray</span>
<span class="sd">        Unit-level scores of the first model in `models`.</span>
<span class="sd">    model_hist_pop : float</span>
<span class="sd">        Population-level score of the second model in `models`.</span>
<span class="sd">    model_hist_unit : np.ndarray</span>
<span class="sd">        Unit-level scores of the second model in `models`.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function assumes exactly two models in the `models` dictionary, </span>
<span class="sd">    and returns their scores in fixed order based on insertion into the dictionary,</span>
<span class="sd">    first returning the population score, then the unit scores for each.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">models_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X_sets</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_color</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y_sets</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_color</span><span class="p">)</span>
        <span class="n">models_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evaluate_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">score_type</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">models_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">models_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">models_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">models_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define model dictionary</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;stimuli&quot;</span><span class="p">:</span> <span class="n">model_stimuli</span><span class="p">,</span>
    <span class="s2">&quot;coupling&quot;</span><span class="p">:</span> <span class="n">model_coupling</span>
<span class="p">}</span>

<span class="c1"># Calculate scores when predicting during white flashes</span>
<span class="p">(</span><span class="n">score_white_stimuli_pop</span><span class="p">,</span> 
 <span class="n">score_white_stimuli_unit</span><span class="p">,</span> 
 <span class="n">score_white_coupling_pop</span><span class="p">,</span>
 <span class="n">score_white_coupling_unit</span><span class="p">)</span> <span class="o">=</span> <span class="n">evaluate_models_by_color</span><span class="p">(</span>
    <span class="n">models</span><span class="p">,</span>
    <span class="p">{</span><span class="s2">&quot;stimuli&quot;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">,</span> 
    <span class="s2">&quot;coupling&quot;</span><span class="p">:</span> <span class="n">X_coupling_test</span><span class="p">},</span>
    <span class="n">units_counts_test</span><span class="p">,</span>
    <span class="n">flashes_test_white</span><span class="p">,</span>
    <span class="s2">&quot;pseudo-r2-McFadden&quot;</span>
<span class="p">)</span>

<span class="c1"># Calculate scores when predicting during black flashes</span>
<span class="p">(</span><span class="n">score_black_stimuli_pop</span><span class="p">,</span> 
 <span class="n">score_black_stimuli_unit</span><span class="p">,</span> 
 <span class="n">score_black_coupling_pop</span><span class="p">,</span>
 <span class="n">score_black_coupling_unit</span><span class="p">)</span> <span class="o">=</span> <span class="n">evaluate_models_by_color</span><span class="p">(</span>
    <span class="n">models</span><span class="p">,</span>
    <span class="p">{</span><span class="s2">&quot;stimuli&quot;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">,</span> 
    <span class="s2">&quot;coupling&quot;</span><span class="p">:</span> <span class="n">X_coupling_test</span><span class="p">},</span>
    <span class="n">units_counts_test</span><span class="p">,</span>
    <span class="n">flashes_test_black</span><span class="p">,</span>
    <span class="s2">&quot;pseudo-r2-McFadden&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can also see the individual scores for each unit!</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">half_violin</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Draw a half violin on a matplotlib Axes.&quot;&quot;&quot;</span>
    <span class="n">kde</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">kde</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="n">width</span>  <span class="c1"># normalize</span>

    <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">center</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">side</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">center</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_half_violin_scores</span><span class="p">():</span>
    <span class="c1"># Data</span>
    <span class="n">stim_white</span> <span class="o">=</span> <span class="n">score_white_stimuli_unit</span>
    <span class="n">coupling_white</span> <span class="o">=</span> <span class="n">score_white_coupling_unit</span>
    <span class="n">stim_black</span> <span class="o">=</span> <span class="n">score_black_stimuli_unit</span>
    <span class="n">coupling_black</span> <span class="o">=</span> <span class="n">score_black_coupling_unit</span>

    <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;White&quot;</span><span class="p">,</span> <span class="s2">&quot;Black&quot;</span><span class="p">]</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="n">num_units</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_white</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="c1"># Plot violins</span>
    <span class="n">half_violin</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">stim_white</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#1f77b4&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
    <span class="n">half_violin</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">coupling_white</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#ff7f0e&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
    <span class="n">half_violin</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">stim_black</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#1f77b4&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
    <span class="n">half_violin</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">coupling_black</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#ff7f0e&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>

    <span class="c1"># Plot individual data points and connect within-color models</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_units</span><span class="p">):</span>
        <span class="n">jitter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

        <span class="c1"># White</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.05</span><span class="o">+</span><span class="n">jitter</span><span class="p">,</span> <span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.05</span><span class="o">+</span><span class="n">jitter</span><span class="p">],</span>
                <span class="p">[</span><span class="n">stim_white</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">coupling_white</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.05</span><span class="o">+</span><span class="n">jitter</span><span class="p">,</span> <span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.05</span><span class="o">+</span><span class="n">jitter</span><span class="p">],</span>
                   <span class="p">[</span><span class="n">stim_white</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">coupling_white</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
                   <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>

        <span class="c1"># Black</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">0.05</span><span class="o">+</span><span class="n">jitter</span><span class="p">,</span> <span class="n">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.05</span><span class="o">+</span><span class="n">jitter</span><span class="p">],</span>
                <span class="p">[</span><span class="n">stim_black</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">coupling_black</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">0.05</span><span class="o">+</span><span class="n">jitter</span><span class="p">,</span> <span class="n">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.05</span><span class="o">+</span><span class="n">jitter</span><span class="p">],</span>
                   <span class="p">[</span><span class="n">stim_black</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">coupling_black</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
                   <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>

    <span class="c1"># Plot mean markers and annotate with values</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.07</span>
    <span class="n">mean_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">annotate_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">mean_kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">0.005</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

    <span class="n">annotate_mean</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stim_white</span><span class="p">))</span>
    <span class="n">annotate_mean</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coupling_white</span><span class="p">))</span>
    <span class="n">annotate_mean</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stim_black</span><span class="p">))</span>
    <span class="n">annotate_mean</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coupling_black</span><span class="p">))</span>

    <span class="c1"># Axes formatting</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Pseudo-$R^2$ McFadden&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Unit Scores per Flash Color and Model Type&quot;</span><span class="p">)</span>

    <span class="c1"># Legend</span>
    <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;#1f77b4&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Stimuli&quot;</span><span class="p">),</span>
        <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;#ff7f0e&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Stimuli + Coupling&quot;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
        <span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Model&quot;</span><span class="p">,</span>
        <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
        <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">.8</span><span class="p">,</span> <span class="mf">.2</span><span class="p">),</span>
        <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.</span>
    <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_half_violin_scores</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/600e1c7a76e268d56e2d83dbe65da66973431e34d8dbc227cd43fb4733161186.png" src="../_images/600e1c7a76e268d56e2d83dbe65da66973431e34d8dbc227cd43fb4733161186.png" />
</div>
</div>
<p>Although there is some variability between neurons, in general, the Stimuli + Coupling model is better at predicting spike trains than the model which only includes Stimuli filters. This makes a lot of sense! Noise is shared across neurons, and the information of a single cell response is also encoded in the population activity, beyond the information provided by stimuli alone  <span id="cite1"></span> Pillow et al. (2008) <a href="#ref1">[1]</a>.</p>
</section>
<section id="food-for-thought">
<h2>Food for thought<a class="headerlink" href="#food-for-thought" title="Link to this heading">#</a></h2>
<p>We intentionally left out many details in this tutorial, as including everything would have resulted in a longer and more complex notebook. Our main goal was to introduce the key components of GLMs, walk through a real-data example, and demonstrate how using <strong>NeMoS</strong> and <strong>Pynapple</strong> can greatly simplify the modeling process. While going into every detail of model fitting was beyond the scope of this tutorial, it should not be beyond the scope of your own work. When applying GLMs to your own research questions, it’s crucial to be rigorous and intentional in your modeling choices.</p>
<p>In particular:</p>
<ul class="simple">
<li><p>Explore different ways to split your data. Here, we used train and test data, but you could also try train, validate and test - specially if you will be trying different models and tweaking parameters before finally assessing the performance. Furthermore, different splitting strategies may be needed for different input statistics. For example, picking samples in a random uniform manner may be ideal for independent samples, but not recommended for time series (for which samples close in time are likely highly correlated).</p></li>
<li><p>Cross-validate the regularizer strength for each neuron individually, as using a fixed value across the population may lead to suboptimal fits. For example, the regularizer we used here does a reasonable job at capturing the activity of neurons that are strongly modulated by the flash (see units 1 and 5 in the PSTH of the Stimuli model). However, for neurons with weaker modulation (i.e., smaller changes in firing rate), the model tends to produce flattened predictions, possibly due to over-regularization (see units 4 or 3 in the PSTH of the Stimuli model).</p></li>
<li><p>Think carefully about and cross-validate the basis functions parameters, including the type of basis and the number of components. These choices can greatly influence the model’s performance, and it is important to remember that the basis of choice will force assumptions in your data, so it is key to be aware of those. For example, the raised cosine log stretched basis assumes that the precision of the basis decreases with the distance from the event. This makes the basis great to model rapid changes of the firing rate just after an event, and slow decay back to baseline. This may or may not be the case depending on the dynamics of the neuron you want to fit. There is a helpful <a class="reference external" href="https://nemos.readthedocs.io/en/latest/how_to_guide/plot_06_sklearn_pipeline_cv_demo.html"><strong>NeMoS</strong> notebook on the topic</a> dedicated to tuning basis functions — we encourage you to check it out.</p></li>
<li><p>We made one specific improvement to our model, i.e. adding coupling filters - what do you think would be another reasonable improvement to add? (hint: <span id="id7">Pillow <em>et al.</em> [<a class="reference internal" href="../bibliography.html#id5" title="Jonathan W. Pillow, Jonathon Shlens, Liam Paninski, Alexander Sher, Alan M. Litke, E. J. Chichilnisky, and Eero P. Simoncelli. Spatio-temporal correlations and visual signalling in a complete neuronal population. Nature, 454(7207):995–999, 2008. doi:10.1038/nature07140.">2008</a>]</span> <span id="cite1d"></span><a href="#ref1">[1d]</a>)</p></li>
</ul>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h2>
<p><a id="ref1"></a><a href="#cite1a">[1a]</a> <a href="#cite1b">[1b]</a> <a href="#cite1c">[1c]</a> <a href="#cite1d">[1d]</a> Pillow, J. W., Shlens, J., Paninski, L., Sher, A., Litke, A. M., Chichilnisky, E. J., &amp; Simoncelli, E. P. (2008). Spatio-temporal correlations and visual signalling in a complete neuronal population. Nature, 454(7207), 995-999. <a class="reference external" href="https://doi.org/10.1038/nature07140">https://doi.org/10.1038/nature07140</a></p>
<p><a id="ref2"></a><a href="#cite2">[2]</a> Allen Institute for Brain Science. <a class="reference external" href="https://brainmapportal-live-4cc80a57cd6e400d854-f7fdcae.divio-media.net/filer_public/80/75/8075a100-ca64-429a-b39a-569121b612b2/neuropixels_visual_coding_-_white_paper_v10.pdf.">Allen Brain Observatory - Neuropixels Visual Coding - Technical White paper</a>. Technical Report, Allen Institute for Brain Science, October 2019.</p>
<p><a id="ref3"></a><a href="#cite3">[3]</a> Pillow, J. [Cosyne Talks]. (2018, March 1-4) Jonathan Pillow - Tutorial: Statistical models for neural data - Part 1 (Cosyne 2018) [Video]. <a class="reference external" href="https://www.youtube.com/watch?v=NFeGW5ljUoI">Youtube</a></p>
<p><a id="ref4"></a><a href="#cite4">[4]</a>  Pillow, J. W., Paninski, L., Uzzell, V. J., Simoncelli, E. P., &amp; Chichilnisky, E. J. (2005). Prediction and decoding of retinal ganglion cell responses with a probabilistic spiking model. The Journal of neuroscience : the official journal of the Society for Neuroscience, 25(47), 11003–11013. <a class="reference external" href="https://doi.org/10.1523/JNEUROSCI.3305-05.2005">https://doi.org/10.1523/JNEUROSCI.3305-05.2005</a></p>
</section>
<section id="data-citation">
<h2>Data citation<a class="headerlink" href="#data-citation" title="Link to this heading">#</a></h2>
<p>The data used in this tutorial is from the Allen Brain Map, with the <a class="reference external" href="https://knowledge.brain-map.org/data/4YYLRZZGK82FQ85NIH8">following citation</a>:</p>
<p>Dataset: Allen Institute MindScope Program (2019). Allen Brain Observatory – Neuropixels Visual Coding [Dataset]. Available from <a class="reference external" href="http://brain-map.org/explore/circuits">brain-map.org/explore/circuits</a></p>
<p>Primary publication: Siegle, J. H., Jia, X., Durand, S., et al. (2021). Survey of spiking in the mouse visual system reveals functional hierarchy. Nature, 592(7612), 86-92. <a class="reference external" href="https://doi.org/10.1038/s41586-020-03171-x">https://doi.org/10.1038/s41586-020-03171-x</a></p>
</section>
<section id="resources">
<h2>Resources<a class="headerlink" href="#resources" title="Link to this heading">#</a></h2>
<p>We have left some resources here and there throughout the notebook. Here is a complete list of all of them:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://NeMoS.readthedocs.io/en/latest/background/plot_00_conceptual_intro.html">NeMoS GLM tutorial</a>: for a bit more detailed explanation of all the components of a GLM within the <strong>NeMoS</strong> framework, as well as some nice visualizations of all the steps of the input transformation!</p></li>
<li><p><a class="reference external" href="https://flatironinstitute.github.io/neurorse-workshops/workshops/jan-2025/branch/main/full/day2/current_injection.html">Introduction to GLM - CCN software workshop by the Flatiron Institute</a>: for a step by step example of using GLMs to fit the activity of a single neuron in VISp under current injection.</p></li>
<li><p><a class="reference external" href="https://compneuro.neuromatch.io/tutorials/W1D3_GeneralizedLinearModels/student/W1D3_Tutorial1.html">Neuromatch Academy GLM tutorial</a>: for a bit  more detailed explanation of the components of a GLM, slides and some coding exercises to ensure comprehension.</p></li>
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=NFeGW5ljUoI&amp;amp;t=4230s">Jonathan Pillow’s COSYNE tutorial</a>: for a longer tutorial of all of the components of a GLM, as well as different types of GLM besides LNP</p></li>
<li><p><a class="reference external" href="https://nemos.readthedocs.io/en/latest/how_to_guide/raw_history_feature.html#raw-spike-history-as-a-feature"><strong>NeMoS</strong> Fit GLMs for neural coupling tutorial</a>: for a guide on how to build a design matrix using raw history as a predictor, in the context of setting up a fully coupled GLM to capture pairwise interaction between neurons.</p></li>
<li><p><a class="reference external" href="https://nemos.readthedocs.io/en/latest/tutorials/plot_02_head_direction.html"><strong>NeMoS</strong> fit head-direction population tutorial</a>: for a step by step explanation of how to build the design matrix first as a result of convolving the features with the identity matrix, and then by using basis functions, alongside nice visualizations.</p></li>
<li><p><a class="reference external" href="https://flatironinstitute.github.io/neurorse-workshops/workshops/jan-2025/branch/main/full/day2/current_injection.html#fitting-the-model">Flatiron Institute Introduction to GLMs tutorial</a>: for a detailed explanation, step by step, on how predictors look with and without basis functions, with nice visualizations as well.</p></li>
<li><p><a class="reference external" href="https://nemos.readthedocs.io/en/latest/background/basis/plot_02_ND_basis_function.html"><strong>NeMoS</strong> notebook on composition of basis functions</a>: for a detailed explanation of the different operations that can be carried out using basis functions in 2 and more dimensions.</p></li>
<li><p><a class="reference external" href="https://www.microsoft.com/en-us/research/wp-content/uploads/2006/01/Bishop-Pattern-Recognition-and-Machine-Learning-2006.pdf">Bishop, 2009</a>: Section 3.1 for a formal description of what basis functions are and some examples of them.</p></li>
<li><p><a class="reference external" href="https://nemos.readthedocs.io/en/latest/background/plot_03_1D_convolution.html#causal-anti-causal-and-acausal-filters"><strong>NeMoS</strong> notebook on causal, anti-causal and acausal filters</a>: for more information on the convolution occurring with basis functions, and how you can tailor that to your needs.</p></li>
<li><p><a class="reference external" href="https://nemos.readthedocs.io/en/latest/how_to_guide/plot_06_sklearn_pipeline_cv_demo.html"><strong>NeMoS</strong> notebook on conducting cross validation for bases</a>: for a detailed explanation of how to combine <strong>NeMos</strong> objects within a <strong>scikit-learn</strong> pipeline to select the number of bases and bases type using cross validation.</p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "AllenInstitute/openscope_databook",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./higher-order"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="tca.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Tensor Decomposition of Spiking Activity Through Trials</p>
      </div>
    </a>
    <a class="right-next"
       href="glm.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Generalized Linear Models</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background-on-glms">Background on GLMs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup-and-library-imports">Environment setup and library imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-data">Download data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extraction-preprocessing-and-stimuli-revision">Extraction, preprocessing and stimuli revision</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-spiking-data">Extracting spiking data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-trial-structure">Extracting trial structure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing-spiking-data">Preprocessing spiking data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#revision-of-stimuli-and-spiking-data">Revision of stimuli and spiking data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#splitting-the-dataset-in-train-and-test">Splitting the dataset in train and test</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fitting-a-glm">Fitting a GLM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-the-data-for-nemos">Preparing the data for <strong>NeMoS</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#constructing-the-design-matrix-using-basis-functions">Constructing the design matrix using basis functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#initialize-and-fit-a-glm-single-unit">Initialize and fit a GLM: single unit</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assess-glm-performance-predict-and-psth">Assess GLM performance: predict and PSTH</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#initialize-and-fit-a-glm-populationglm">Initialize and fit a GLM: <code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assess-populationglm-performance-psth">Assess <code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code> performance: PSTH</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-coupling-as-a-new-predictor">Adding coupling as a new predictor</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assess-coupling-populationglm-performance-heatmap">Assess coupling <code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code> performance: heatmap</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-model-performance-quantitatively-pseudo-r-2-mcfadden">Evaluate model performance quantitatively: Pseudo-<span class="math notranslate nohighlight">\(R^2\)</span> McFadden</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#food-for-thought">Food for thought</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-citation">Data citation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#resources">Resources</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Carter Peene
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>