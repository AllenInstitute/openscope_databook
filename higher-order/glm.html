
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Generalized Linear Models &#8212; OpenScope Databook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-TJPN1M4PDX"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-TJPN1M4PDX');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-TJPN1M4PDX');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'higher-order/glm';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Behavioral State from Trial Outcomes" href="behavioral_state.html" />
    <link rel="prev" title="Tensor Decomposition of Spiking Activity Through Trials" href="tca.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="OpenScope Databook - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="OpenScope Databook - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    OpenScope Databook
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../basics/background.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/download_nwb.html">Downloading an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/stream_nwb.html">Streaming an NWB File with remfile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/read_nwb.html">Reading an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/use_nwbwidgets.html">Exploring an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/get_dandiset_metadata.html">Getting Experimental Metadata from DANDI</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Visualizing NWB Files</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_2p_raw.html">Visualizing Raw 2-Photon Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_metrics.html">Visualizing Unit Quality Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_lfp_responses.html">Visualizing LFP Responses to Stimuli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_responses.html">Visualizing Neuronal Unit Responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_2p_responses.html">Visualizing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_spikes.html">Visualizing Neuronal Unit Spikes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_neuropixels_probes.html">Visualizing Neuropixels Probe Locations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_templates.html">Visualizing Stimulus Templates</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">First-Order Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../first-order/receptive_fields.html">Showing Receptive Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/optotagging.html">Identifying Optotagged Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/current_source_density.html">Current Source Density Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/classify_waveforms.html">Classifying Fast-Spiking and Regular-Spiking Neurons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/test_2p_responses.html">Statistically Testing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/test_unit_responses.html">Statistically Testing Spike Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/suite2p.html">Identifying Regions of Interest with Segmentation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Higher-Order Analysis</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="cebra_time.html">Using CEBRA-Time to Identify Latent Embeddings</a></li>
<li class="toctree-l1"><a class="reference internal" href="tca.html">Tensor Decomposition of Spiking Activity Through Trials</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Generalized Linear Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="behavioral_state.html">Behavioral State from Trial Outcomes</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Openscope Experimental Projects</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../projects/cred_assign_figures.html">Replicating OpenScope Credit Assignment project figures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects/glo.html">OpenScope’s Global/Local Oddball Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects/illusion.html">OpenScope’s Illusion Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects/dendritic_coupling.html">OpenScope’s Dendritic Coupling Dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Embargoed Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../embargoed/modality_alignment.html">Aligning Data across Modalities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/visualize_behavior.html">Visualizing Behavioral Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/test_2p_responses_embargoed.html">Statistically Testing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/cell_matching.html">Cell Matching Across Days</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Methods</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../methods/jupyter_book.html">Jupyter/Jupyter Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods/github.html">Git/GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods/environments.html">Managing Environments on Multiple Platforms</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../contribution.html">Contributing to the Databook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors_index.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html">FAQ</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/AllenInstitute/openscope_databook/main?urlpath=lab/tree/docs/higher-order/glm.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://hub.dandiarchive.org/hub/user-redirect/git-pull?repo=https%3A//github.com/AllenInstitute/openscope_databook&urlpath=lab/tree/openscope_databook/docs/higher-order/glm.ipynb&branch=main" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on JupyterHub"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="JupyterHub logo" src="../_static/images/logo_jupyterhub.svg">
  </span>
<span class="btn__text-container">JupyterHub</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/AllenInstitute/openscope_databook/blob/main/docs/higher-order/glm.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/AllenInstitute/openscope_databook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/AllenInstitute/openscope_databook/issues/new?title=Issue%20on%20page%20%2Fhigher-order/glm.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/higher-order/glm.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Generalized Linear Models</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">Environment Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-file">Downloading File</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-glm">The GLM</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synthetic-data">Synthetic Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design-matrix">Design Matrix</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-on-synthetic-data">Running on Synthetic Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-model">Testing Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#real-data-allen-institute-visual-coding-dataset">Real Data - Allen Institute Visual Coding dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-spike-data">Extracting Spike Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-real-flashes-data">Extracting Real Flashes Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-filters">Generating Filters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#predict-activity">Predict Activity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#showing-predictions">Showing Predictions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-to-z-scores">Comparing to Z-Scores</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-most-responsive-units">Selecting Most Responsive Units</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-z-scores-with-glm-filters">Comparing Z-Scores with GLM Filters</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="generalized-linear-models">
<h1>Generalized Linear Models<a class="headerlink" href="#generalized-linear-models" title="Link to this heading">#</a></h1>
<p>A <a class="reference external" href="https://en.wikipedia.org/wiki/Generalized_linear_model">Generalized Linear Model</a> (GLM), not to be confused with a <a class="reference external" href="https://en.wikipedia.org/wiki/General_linear_model">General Linear Model</a>, is a regression model that trains a filter to model single neuron activity as it relates to some other variable. For example, to predict the spike counts produced by a single neuron (Y) in response to licking events (X). The GLM model can be represented by the following equation:
<span class="math notranslate nohighlight">\(y(t) = Poiss(f(k * X_{t}))\)</span>, where <code class="docutils literal notranslate"><span class="pre">Poiss</span></code> is a poisson process and <code class="docutils literal notranslate"><span class="pre">f</span></code> is a non-linearity function, in this case <span class="math notranslate nohighlight">\(f(x) = e^x\)</span></p>
<p>To train a GLM, we start by creating a <em>design matrix</em> from the visual stimulus. The design matrix is the input, X_train, provided to the GLM for training along with known spike counts in each trial, Y_train. The GLM uses <a class="reference external" href="https://en.wikipedia.org/wiki/Maximum_likelihood_estimation">Maximum Likelihood Estimation</a> to train the filter vector that maximizes the likelihood of producing a given spike train from the inputted design matrix. To predict the spike activity of a neuron, the filter is first convolved with the stimulus vector. Next, the GLM employs a non-linearity step (exponential in this case), followed by poisson generation to generate specific spike counts as shown in the figure below.</p>
<p>This notebook demonstrates the usage of a Poisson GLM to model and reproduce the spiking activity of single neurons in response to a visual stimulus. GLMs are trained using synthetic data, as well as real data from the Allen Institute <strong>Visual Coding - Neuropixels</strong> dataset.</p>
<p>For more information on applying GLMs for predicting spiking activity, see the Pillow Lab’s <a class="reference external" href="https://github.com/pillowlab/GLMspiketraintutorial/tree/master/slides">GLM Slides</a> and Neuromatch Academy’s <a class="reference external" href="https://compneuro.neuromatch.io/tutorials/W1D3_GeneralizedLinearModels/student/W1D3_Tutorial1.html">GLM tutorial</a>.</p>
<p><img alt="glm.png" src="../_images/glm.png" /></p>
<p>Modified from Slide 6, <em><a class="reference external" href="https://pillowlab.princeton.edu/pubs/pillow_TutorialSlides_Cosyne2018.pdf">Generalized linear models for cracking the neural code</a></em>, Pillow Lab</p>
<section id="environment-setup">
<h2>Environment Setup<a class="headerlink" href="#environment-setup" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">databook_utils.dandi_utils</span> <span class="kn">import</span> <span class="n">dandi_download_open</span>
<span class="k">except</span><span class="p">:</span>
    <span class="o">!</span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/AllenInstitute/openscope_databook.git
    <span class="o">%</span><span class="k">cd</span> openscope_databook
    <span class="o">%</span><span class="k">pip</span> install -e .
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>

<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
</section>
<section id="downloading-file">
<h2>Downloading File<a class="headerlink" href="#downloading-file" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dandiset_id</span> <span class="o">=</span> <span class="s2">&quot;000021&quot;</span>
<span class="n">dandi_filepath</span> <span class="o">=</span> <span class="s2">&quot;sub-726298249/sub-726298249_ses-754829445.nwb&quot;</span>
<span class="n">download_loc</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">io</span> <span class="o">=</span> <span class="n">dandi_download_open</span><span class="p">(</span><span class="n">dandiset_id</span><span class="p">,</span> <span class="n">dandi_filepath</span><span class="p">,</span> <span class="n">download_loc</span><span class="p">)</span>
<span class="n">nwb</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>A newer version (0.62.2) of dandi/dandi-cli is available. You are using 0.61.2
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>File already exists
Opening file
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>c:\Users\carter.peene\Desktop\Projects\openscope_databook\databook_env\lib\site-packages\hdmf\utils.py:668: UserWarning: Ignoring cached namespace &#39;hdmf-common&#39; version 1.1.3 because version 1.8.0 is already loaded.
  return func(args[0], **pargs)
c:\Users\carter.peene\Desktop\Projects\openscope_databook\databook_env\lib\site-packages\hdmf\utils.py:668: UserWarning: Ignoring cached namespace &#39;core&#39; version 2.2.2 because version 2.6.0-alpha is already loaded.
  return func(args[0], **pargs)
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-glm">
<h2>The GLM<a class="headerlink" href="#the-glm" title="Link to this heading">#</a></h2>
<p>The functions below are used in training the GLM.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">fit_lnp</span></code> takes in the <em>design_matrix</em> ~as~, <code class="docutils literal notranslate"><span class="pre">X</span></code>, produced from the stimulus and the observed spike counts, <code class="docutils literal notranslate"><span class="pre">y</span></code>. It also takes the length of the filter to train, <code class="docutils literal notranslate"><span class="pre">d</span></code>, and the regularization coefficient, <code class="docutils literal notranslate"><span class="pre">lam</span></code>,. First, the function initializes a random filter of length <code class="docutils literal notranslate"><span class="pre">d</span></code> and then uses the <code class="docutils literal notranslate"><span class="pre">neg_log_like_lnp</span></code> function to perform Maximum Likelihood Estimation to train the filter.</p>
<p><code class="docutils literal notranslate"><span class="pre">neg_log_lik_lnp</span></code> computes the negative log likelihood for a vector of filter weights <code class="docutils literal notranslate"><span class="pre">theta</span></code>, the design matrix <code class="docutils literal notranslate"><span class="pre">X</span></code>, and the observed spike counts, <code class="docutils literal notranslate"><span class="pre">y</span></code>. The <code class="docutils literal notranslate"><span class="pre">Cinv</span></code> matrix, a diagonal matrix with the regularization coefficient, is applied for regularization. It would also help to explain each function by its inputs and outputs.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">predict</span></code> function perform the inverse operation, applying a trained filter <code class="docutils literal notranslate"><span class="pre">weights</span></code> to the <em>design matrix</em> <code class="docutils literal notranslate"><span class="pre">X</span></code>, and adding a constant, yielding the spike probability over time.</p>
<p><code class="docutils literal notranslate"><span class="pre">predict_spikes</span></code> takes the spike rate prediction and runs it through Poisson generation, adding noise and producing a set of predicted spike counts. Because the poisson generation is non-deterministic, it will produce different results every time.</p>
<p>This code was adapted from <a class="reference external" href="https://github.com/pillowlab/GLMspiketraintutorial/tree/master">this code</a> from the Pillow Lab, with the regularization code from <a class="reference external" href="https://compneuro.neuromatch.io/tutorials/W1D3_GeneralizedLinearModels/student/W1D3_Tutorial1.html">this tutorial</a> from Neuromatch Academy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">neg_log_lik_lnp</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Cinv</span><span class="p">):</span>
  <span class="c1"># Compute the Poisson log likelihood</span>
  <span class="n">rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">theta</span><span class="p">)</span>
  <span class="n">log_lik</span> <span class="o">=</span> <span class="n">y</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="o">-</span> <span class="n">rate</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
  <span class="n">log_lik</span> <span class="o">-=</span> <span class="n">theta</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Cinv</span> <span class="o">@</span> <span class="n">theta</span>

  <span class="k">return</span> <span class="o">-</span><span class="n">log_lik</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fit_lnp</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="n">filt_len</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">Imat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">filt_len</span><span class="p">)</span> <span class="c1"># identity matrix of size of filter + const</span>
  <span class="n">Imat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">Cinv</span> <span class="o">=</span> <span class="n">lam</span><span class="o">*</span><span class="n">Imat</span>

  <span class="c1"># Use a random vector of weights to start (mean 0, sd .2)</span>
  <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">.2</span><span class="p">,</span> <span class="n">filt_len</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;y:&quot;</span><span class="p">,</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="s2">&quot;X:&quot;</span><span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="s2">&quot;x0:&quot;</span><span class="p">,</span><span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

  <span class="c1"># Find parameters that minimize the negative log likelihood function</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">neg_log_lik_lnp</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Cinv</span><span class="p">))</span>

  <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">constant</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">weights</span> <span class="o">+</span> <span class="n">constant</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>

<span class="k">def</span> <span class="nf">predict_spikes</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">constant</span><span class="p">):</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span>
    <span class="n">spks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">rate</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">spks</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="synthetic-data">
<h2>Synthetic Data<a class="headerlink" href="#synthetic-data" title="Link to this heading">#</a></h2>
<p>The cells below prepare the synthetic data (stimulus and spiking data), and show how to train a GLM.</p>
<p><code class="docutils literal notranslate"><span class="pre">make_flashes</span></code> produces boxcar stimulus that imitate binary flashes.</p>
<p><code class="docutils literal notranslate"><span class="pre">make_spikes</span></code> utilizes the same mathematics as the GLM’s prediction and generates spikes that have a direct relationship with the brightness of the synthetic stimulus. It simply multiplies the stimulus by a given coefficient <code class="docutils literal notranslate"><span class="pre">coeff</span></code>, and adds a given constant, <code class="docutils literal notranslate"><span class="pre">baseline_rate</span></code>. It runs the resulting rate through exponentiation and then generates Poission distributed spike counts with this as the spiking probability.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_flashes</span><span class="p">(</span><span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">n_repeats</span><span class="p">):</span>
    <span class="n">flashes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">n_repeats</span><span class="p">)</span>
    <span class="n">time_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">flashes</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">time_axis</span><span class="p">,</span> <span class="n">flashes</span>

<span class="n">syn_time_axis</span><span class="p">,</span> <span class="n">syn_flashes</span> <span class="o">=</span> <span class="n">make_flashes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">20</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">syn_time_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">syn_time_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">syn_flashes</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">syn_time_axis</span><span class="p">[:</span><span class="mi">1000</span><span class="p">],</span> <span class="n">syn_flashes</span><span class="p">[:</span><span class="mi">1000</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;First 10 Seconds of Synthetic Flashes Stimulus&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;&#39;Brightness&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0 300.0
30000
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &quot;&#39;Brightness&#39;&quot;)
</pre></div>
</div>
<img alt="../_images/e3c70c9b264a805cad2cf1fb4357daf1cb2b4277fbbbaab5a927a956f405b1fb.png" src="../_images/e3c70c9b264a805cad2cf1fb4357daf1cb2b4277fbbbaab5a927a956f405b1fb.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_spikes</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">baseline_rate</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">return_exp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">weighted_stim</span> <span class="o">=</span> <span class="p">(</span><span class="n">stim</span><span class="o">*</span><span class="n">coeff</span><span class="p">)</span> <span class="o">+</span> <span class="n">baseline_rate</span>
    <span class="n">exp_stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">weighted_stim</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">exp_stim</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">exp_stim</span><span class="p">))</span>
    <span class="n">spikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">exp_stim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_exp</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spikes</span><span class="p">,</span> <span class="n">weighted_stim</span><span class="p">,</span> <span class="n">exp_stim</span>
    <span class="k">return</span> <span class="n">spikes</span>

<span class="c1"># set with parameters -2.5 and 0.5, the GLM should learn these parameters</span>
<span class="n">syn_spikes</span><span class="p">,</span> <span class="n">syn_weight</span><span class="p">,</span> <span class="n">syn_exp</span> <span class="o">=</span> <span class="n">make_spikes</span><span class="p">(</span><span class="n">syn_flashes</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">return_exp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">syn_spikes</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">syn_time_axis</span><span class="p">[:</span><span class="mi">1000</span><span class="p">],</span> <span class="n">syn_spikes</span><span class="p">[:</span><span class="mi">1000</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;First 10 seconds of Synthetic Spikes&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;# Spikes&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.1353352832366127 0.0820849986238988
30000
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;# Spikes&#39;)
</pre></div>
</div>
<img alt="../_images/cbe27edb39701a53a7fc8f2ca68d342a7919defcbba48044923ff3eda0003dba.png" src="../_images/cbe27edb39701a53a7fc8f2ca68d342a7919defcbba48044923ff3eda0003dba.png" />
</div>
</div>
</section>
<section id="design-matrix">
<h2>Design Matrix<a class="headerlink" href="#design-matrix" title="Link to this heading">#</a></h2>
<p>The GLM takes in the following <em>design matrix</em> to conduct Maximum Likelihood Estimation. The design matrix must have dimensions <code class="docutils literal notranslate"><span class="pre">time</span></code> * <code class="docutils literal notranslate"><span class="pre">d</span></code>, where time is the length of the stimulus, and d is the length of the filter to be trained. It can be seen below that it is simply slices of the <code class="docutils literal notranslate"><span class="pre">d</span></code> most recent stimulus values for each timepoint in the stimulus. Importantly, a GLM also yields a <code class="docutils literal notranslate"><span class="pre">constant</span></code> value with each filter. This constant term is the bias term that captures the spike count variance unexplained by the input variables. For this, we simply add a 1 to each row in the design matrix. The resulting column of 1s produces the bias term from the MLE.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">build_design_matrix</span></code> returns such a design_matrix from a given <code class="docutils literal notranslate"><span class="pre">stim</span></code> array and a filter length <code class="docutils literal notranslate"><span class="pre">d</span></code>. It can be seen below that the bins of the second dimension of the design matrix represent the stimulus values preceding the stimulus event, so the time axis is time prior the ‘current time’. The column of ones to product the GLM constant does not have a temporal relationship to the latest stimulus time, so its x value in the matrix undefined.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_design_mat</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">include_const</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
  <span class="c1"># Create version of stimulus vector with zeros before onset</span>
  <span class="n">padded_stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">stim</span><span class="p">])</span>

  <span class="c1"># Construct a matrix where each row has the d frames of</span>
  <span class="c1"># the stimulus preceding and including timepoint t</span>
  <span class="n">T</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>  <span class="c1"># Total number of timepoints (hint: number of stimulus frames)</span>
  <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
  <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
      <span class="n">X</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">padded_stim</span><span class="p">[</span><span class="n">t</span><span class="p">:</span><span class="n">t</span> <span class="o">+</span> <span class="n">d</span><span class="p">]</span>

  <span class="k">if</span> <span class="n">include_const</span><span class="p">:</span>
    <span class="n">constant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">constant</span><span class="p">,</span> <span class="n">X</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">X</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syn_design_mat</span> <span class="o">=</span> <span class="n">build_design_mat</span><span class="p">(</span><span class="n">syn_flashes</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">syn_design_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">syn_design_mat</span><span class="p">[:</span><span class="mi">1000</span><span class="p">],</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (bins prior to current)&quot;</span><span class="p">)</span>
<span class="n">xaxis_step</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">xpositions</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">syn_design_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])[::</span><span class="n">xaxis_step</span><span class="p">]</span>
<span class="n">time_offset_axis</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">syn_design_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="p">([</span><span class="s2">&quot;und&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">time_offset_axis</span><span class="p">))[::</span><span class="n">xaxis_step</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xpositions</span><span class="p">,</span> <span class="n">xticks</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Time (bins through session)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Synthetic Stimulus Design Matrix with Constant Column&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(30000, 26)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Synthetic Stimulus Design Matrix with Constant Column&#39;)
</pre></div>
</div>
<img alt="../_images/29942e6d8cff41759137722e5d81890972a1b254f2f948b52e94c89e967da9fa.png" src="../_images/29942e6d8cff41759137722e5d81890972a1b254f2f948b52e94c89e967da9fa.png" />
</div>
</div>
</section>
<section id="running-on-synthetic-data">
<h2>Running on Synthetic Data<a class="headerlink" href="#running-on-synthetic-data" title="Link to this heading">#</a></h2>
<p>Below is an example of a trained GLM filter trained using a filter length of 25 and a regularization coefficient of <span class="math notranslate nohighlight">\(2^{10}\)</span>. During prediction, this filter would be convolved with the design matrix before undergoing the expontential non-linearity step to produce spike rate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">fit_lnp</span><span class="p">(</span><span class="n">syn_design_mat</span><span class="p">,</span> <span class="n">syn_spikes</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">10</span><span class="p">)</span>
<span class="n">constant</span><span class="p">,</span> <span class="nb">filter</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">constant</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="nb">filter</span><span class="p">),</span><span class="mi">0</span><span class="p">),</span> <span class="nb">filter</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Trained Filter for Synthetic Data&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time Bins Relative to Stimulus Event&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Unitless&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>y: (30000,) X: (30000, 26) x0: (26,)
-2.4325110136550547
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Unitless&#39;)
</pre></div>
</div>
<img alt="../_images/fa97c0a0604b7babaa1729f1091fc25a08b1d10ea7bd2bf243a1d0e52db56915.png" src="../_images/fa97c0a0604b7babaa1729f1091fc25a08b1d10ea7bd2bf243a1d0e52db56915.png" />
</div>
</div>
</section>
<section id="testing-model">
<h2>Testing Model<a class="headerlink" href="#testing-model" title="Link to this heading">#</a></h2>
<p>To get a sense of how the GLM performs on synthetic data, the function <code class="docutils literal notranslate"><span class="pre">test_synthetic_glm</span></code> is used to yield a constant and a filter of length 1. Since the synthetic spikes were produced with a constant <code class="docutils literal notranslate"><span class="pre">baseline_rate</span></code> and a coefficient <code class="docutils literal notranslate"><span class="pre">coeff</span></code>, we should expect the GLM to effectively reproduce these values in the constant and length 1 filter. The GLM performance is tested by iterating over successive values of regularization coefficient <code class="docutils literal notranslate"><span class="pre">lam</span></code> and the number of repeats of stimulus flashes, <code class="docutils literal notranslate"><span class="pre">n_repeats</span></code>, both ranging between 1 and <span class="math notranslate nohighlight">\(2^9\)</span>. The optimal values for these variables are obtained by maximixing the <a class="reference external" href="https://en.wikipedia.org/wiki/Coefficient_of_determination">Coefficient of Determination</a> <span class="math notranslate nohighlight">\(R^2\)</span>. The results below indicate that as the regularization coefficient increases, the GLM performance starts to suffer. This is because higher regularization values promote a stronger tendency for trained filter values to stay closer to 0, limiting the MLE’s ability to fit a model effectively. They also indicate that the GLM performance converges toward the real constant and coefficient values as the number of repeats of the stimulus increases because there is more data to train with.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_synthetic_glm</span><span class="p">(</span><span class="n">constant_in</span><span class="p">,</span> <span class="n">coeff_in</span><span class="p">,</span> <span class="n">flashes</span><span class="p">,</span> <span class="n">constants</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">r2s</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">filt_len</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">design_mat</span> <span class="o">=</span> <span class="n">build_design_mat</span><span class="p">(</span><span class="n">flashes</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">filt_len</span><span class="p">)</span>
    <span class="n">syn_spikes</span><span class="p">,</span> <span class="n">syn_weights</span><span class="p">,</span> <span class="n">syn_prob</span> <span class="o">=</span> <span class="n">make_spikes</span><span class="p">(</span><span class="n">flashes</span><span class="p">,</span> <span class="n">constant_in</span><span class="p">,</span> <span class="n">coeff_in</span><span class="p">,</span> <span class="n">return_exp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">fit_lnp</span><span class="p">(</span><span class="n">design_mat</span><span class="p">,</span> <span class="n">syn_spikes</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="n">lam</span><span class="p">)</span>
    <span class="n">const</span><span class="p">,</span> <span class="n">filt</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">prob_predicted</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">design_mat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">filt</span><span class="p">,</span> <span class="n">const</span><span class="p">)</span>
    <span class="n">spikes_predicted</span> <span class="o">=</span> <span class="n">predict_spikes</span><span class="p">(</span><span class="n">design_mat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">filt</span><span class="p">,</span> <span class="n">const</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">syn_spikes</span><span class="p">,</span> <span class="n">prob_predicted</span><span class="p">)</span>

    <span class="n">constants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>
    <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>
    <span class="n">r2s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">repeats_vals</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">r_coeffs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">r_constants</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">r_r2s</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">n_repeats</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span>
    <span class="n">time_axis</span><span class="p">,</span> <span class="n">syn_flashes</span> <span class="o">=</span> <span class="n">make_flashes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_repeats</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">20</span><span class="p">,</span> <span class="n">n_repeats</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">test_synthetic_glm</span><span class="p">(</span><span class="o">-</span><span class="mf">2.3</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">,</span> <span class="n">syn_flashes</span><span class="p">,</span> <span class="n">r_constants</span><span class="p">,</span> <span class="n">r_coeffs</span><span class="p">,</span> <span class="n">r_r2s</span><span class="p">)</span>
        <span class="n">repeats_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_repeats</span><span class="p">)</span>

<span class="n">lambda_vals</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">l_coeffs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">l_constants</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">l_r2s</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">time_axis</span><span class="p">,</span> <span class="n">syn_flashes</span> <span class="o">=</span> <span class="n">make_flashes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">8</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">8</span><span class="p">)</span>
<span class="n">design_mat</span> <span class="o">=</span> <span class="n">build_design_mat</span><span class="p">(</span><span class="n">syn_flashes</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">lam</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">test_synthetic_glm</span><span class="p">(</span><span class="o">-</span><span class="mf">2.3</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">,</span> <span class="n">syn_flashes</span><span class="p">,</span> <span class="n">l_constants</span><span class="p">,</span> <span class="n">l_coeffs</span><span class="p">,</span> <span class="n">l_r2s</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="n">lam</span><span class="p">)</span>
        <span class="n">lambda_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;GLM Performance as Hyperparameters Change&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.92</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[:</span><span class="mi">6</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">repeats_vals</span><span class="p">,</span> <span class="n">r_constants</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;# Flash Repeats&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Trained Constant&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">repeats_vals</span><span class="p">,</span> <span class="n">r_coeffs</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;# Flash Repeats&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Trained Coefficient&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">repeats_vals</span><span class="p">,</span> <span class="n">r_r2s</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;# Flash Repeats&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$R^2$&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lambda_vals</span><span class="p">,</span> <span class="n">l_constants</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Regularization Lambda&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Trained Constant&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lambda_vals</span><span class="p">,</span> <span class="n">l_coeffs</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Regularization Lambda&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Trained Coefficient&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lambda_vals</span><span class="p">,</span> <span class="n">l_r2s</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Regularization Lambda&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$R^2$&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$R^2$&#39;)
</pre></div>
</div>
<img alt="../_images/6fafccca76d43d1b2aad6e80cdfaa802d5d00fea35f382368c66874c1d418c43.png" src="../_images/6fafccca76d43d1b2aad6e80cdfaa802d5d00fea35f382368c66874c1d418c43.png" />
</div>
</div>
</section>
<section id="real-data-allen-institute-visual-coding-dataset">
<h2>Real Data - Allen Institute Visual Coding dataset<a class="headerlink" href="#real-data-allen-institute-visual-coding-dataset" title="Link to this heading">#</a></h2>
<section id="extracting-spike-data">
<h3>Extracting Spike Data<a class="headerlink" href="#extracting-spike-data" title="Link to this heading">#</a></h3>
<p>After examining the GLM on synthetic data to empirically evaluate hyperparameters, we test GLM performance on real data. First, desirable units are selected from the NWB File. Here, neurons are chosen from the primary visual cortex <code class="docutils literal notranslate"><span class="pre">VISp</span></code>. For convenience, the list of regions in this NWB file are displayed below. <code class="docutils literal notranslate"><span class="pre">brain_regions</span></code> can be altered to suit your preferences. Only units of “good” quality and a firing rate greater than 2 are selected. More information on unit quality metrics can be found in <a class="reference internal" href="../visualization/visualize_unit_metrics.html"><span class="std std-doc">Visualizing Unit Quality Metrics </span></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">units</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">units</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### use the electrodes table to devise a function which maps units to their brain regions</span>

<span class="c1"># select electrodes</span>
<span class="n">channel_probes</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">electrodes</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">electrodes</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">electrodes</span><span class="p">)):</span>
    <span class="n">channel_id</span> <span class="o">=</span> <span class="n">electrodes</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">electrodes</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="n">channel_probes</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">location</span>

<span class="c1"># function aligns location information from electrodes table with channel id from the units table</span>
<span class="k">def</span> <span class="nf">get_unit_location</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">channel_probes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">peak_channel_id</span><span class="p">)]</span>

<span class="n">all_regions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_unit_location</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">units</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">all_regions</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&#39;, &#39;CA1&#39;, &#39;Eth&#39;, &#39;CA2&#39;, &#39;TH&#39;, &#39;APN&#39;, &#39;VISpm&#39;, &#39;VPM&#39;, &#39;LGd&#39;, &#39;DG&#39;, &#39;CA3&#39;, &#39;LP&#39;, &#39;PO&#39;, &#39;POL&#39;, &#39;VISam&#39;, &#39;VISp&#39;, &#39;PoT&#39;, &#39;VISrl&#39;}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### selecting units spike times</span>

<span class="n">brain_regions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;VISp&quot;</span><span class="p">]</span>

<span class="c1"># select units based if they have &#39;good&#39; quality and exists in one of the specified brain_regions</span>
<span class="n">units_spike_times</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">brain_regions</span><span class="p">:</span>
    <span class="n">location_units_spike_times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">get_unit_location</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="n">location</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">quality</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;good&quot;</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">firing_rate</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">2.0</span><span class="p">:</span>
            <span class="n">location_units_spike_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">spike_times</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">units_spike_times</span> <span class="o">+=</span> <span class="n">location_units_spike_times</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>124
</pre></div>
</div>
</div>
</div>
</section>
<section id="extracting-real-flashes-data">
<h3>Extracting Real Flashes Data<a class="headerlink" href="#extracting-real-flashes-data" title="Link to this heading">#</a></h3>
<p>Next, we retrieve the stimulus information (full-field flashes) from the dataset.
To ensure they have a regular timescale, they are interpolated. Set <code class="docutils literal notranslate"><span class="pre">bin_sz</span></code> to be the bin size used for the interpolation below. Since <code class="docutils literal notranslate"><span class="pre">bin_sz</span></code> affects the temporal resolution of spikes and stimulus, <code class="docutils literal notranslate"><span class="pre">bin_sz</span></code> might have a large impact on the runtime and the performance of the model. This is because given a filer length in seconds, the bin size determines how many weights the filter consists of. More weights might may improve the performance of the GLM but will increase the runtime.</p>
<p>The stimulus information are stored in a series of tables, one of which is the flashes presentations table. In this table, the black and white flash intervals are listed with their respective start times and stop times, where -1.0 (black) and 1.0 (white) encode the color. Between these intervals, the screen was grey. The code below extracts these flash intervals and generates the interpolated flashes array.</p>
<p>There are several types of stimulus from this experimental session, but for the purposes of this analysis only the (approx.) 300 seconds of flashes stimulus are used.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bin_sz</span> <span class="o">=</span> <span class="mf">0.050</span> <span class="c1"># important for performance of GLM, be careful! </span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flashes_table</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;flashes_presentations&quot;</span><span class="p">]</span>
<span class="n">flashes_table</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>start_time</th>
      <th>stop_time</th>
      <th>stimulus_name</th>
      <th>stimulus_block</th>
      <th>color</th>
      <th>mask</th>
      <th>opacity</th>
      <th>phase</th>
      <th>size</th>
      <th>units</th>
      <th>stimulus_index</th>
      <th>orientation</th>
      <th>spatial_frequency</th>
      <th>contrast</th>
      <th>tags</th>
      <th>timeseries</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1285.60087</td>
      <td>1285.851080</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>-1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3647, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1287.60256</td>
      <td>1287.852768</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>-1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3648, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1289.60423</td>
      <td>1289.854435</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>-1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3649, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1291.60589</td>
      <td>1291.856100</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>-1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3650, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1293.60761</td>
      <td>1293.857808</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3651, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1295.60925</td>
      <td>1295.859455</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>-1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3652, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1297.61096</td>
      <td>1297.861155</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3653, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1299.61265</td>
      <td>1299.862843</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3654, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1301.61429</td>
      <td>1301.864488</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3655, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>9</th>
      <td>1303.61592</td>
      <td>1303.866128</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>-1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3656, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">flashes_table</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flashes_table</span><span class="o">.</span><span class="n">stop_time</span><span class="p">)</span>
<span class="n">time_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="o">//</span><span class="n">bin_sz</span><span class="p">),</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start:&quot;</span><span class="p">,</span><span class="n">start_time</span><span class="p">,</span><span class="s2">&quot;end:&quot;</span><span class="p">,</span><span class="n">end_time</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time_axis</span><span class="p">))</span>

<span class="n">white_flashes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time_axis</span><span class="p">))</span>
<span class="n">black_flashes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time_axis</span><span class="p">))</span>
<span class="n">table_idx</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_axis</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="n">flashes_table</span><span class="o">.</span><span class="n">start_time</span><span class="p">[</span><span class="n">table_idx</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="n">flashes_table</span><span class="o">.</span><span class="n">stop_time</span><span class="p">[</span><span class="n">table_idx</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">flashes_table</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="n">table_idx</span><span class="p">])</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">white_flashes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">flashes_table</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="n">table_idx</span><span class="p">])</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">:</span>
            <span class="n">black_flashes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">elif</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="n">flashes_table</span><span class="o">.</span><span class="n">start_time</span><span class="p">[</span><span class="n">table_idx</span><span class="p">]:</span>
        <span class="k">continue</span>
    <span class="k">while</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="n">flashes_table</span><span class="o">.</span><span class="n">stop_time</span><span class="p">[</span><span class="n">table_idx</span><span class="p">]:</span>
        <span class="n">table_idx</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">,</span> <span class="n">white_flashes</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;silver&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;White Flashes from Session&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Presence of Flash&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">,</span> <span class="n">black_flashes</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Black Flashes from Session&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Presence of Flash&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start: 1285.6008699215513 end: 1584.1002475386938
5969
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Presence of Flash&#39;)
</pre></div>
</div>
<img alt="../_images/16a0736e5d200c14b4d34ba59056a63b6b7df44d6e99ec058c78902c982ddd8a.png" src="../_images/16a0736e5d200c14b4d34ba59056a63b6b7df44d6e99ec058c78902c982ddd8a.png" />
</div>
</div>
</section>
<section id="generating-filters">
<h3>Generating Filters<a class="headerlink" href="#generating-filters" title="Link to this heading">#</a></h3>
<p>As with the synthetic data above, the design matrix is generated from the stimulus flashes. The filter length is set to 250 ms. Then, we train a GLM filter for each unit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filter_duration</span> <span class="o">=</span> <span class="mf">0.250</span> <span class="c1"># we want a 200 ms window,</span>
<span class="n">filter_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">filter_duration</span> <span class="o">/</span> <span class="n">bin_sz</span><span class="p">)</span> <span class="c1"># divide by bin size to yield length of filter</span>
<span class="n">filter_time_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">filter_duration</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">filter_length</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">white_design_mat</span> <span class="o">=</span> <span class="n">build_design_mat</span><span class="p">(</span><span class="n">white_flashes</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">filter_length</span><span class="p">)</span>
<span class="n">black_design_mat</span> <span class="o">=</span> <span class="n">build_design_mat</span><span class="p">(</span><span class="n">black_flashes</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">filter_length</span><span class="p">,</span> <span class="n">include_const</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">comb_design_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">white_design_mat</span><span class="p">,</span> <span class="n">black_design_mat</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">white_design_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">black_design_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">comb_design_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># plt.imshow(comb_design_mat[:1000], extent=[-comb_design_mat.shape[1], 0, 1000, 0], aspect=&quot;auto&quot;, interpolation=&quot;none&quot;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">comb_design_mat</span><span class="p">[:</span><span class="mi">1000</span><span class="p">],</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="n">xaxis_step</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">xpositions</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">comb_design_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])[::</span><span class="n">xaxis_step</span><span class="p">]</span>
<span class="n">time_offset_axis</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">comb_design_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="p">(</span> <span class="p">[</span><span class="s2">&quot;und&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">time_offset_axis</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">time_offset_axis</span><span class="p">))[::</span><span class="n">xaxis_step</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">xpositions</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xpositions</span><span class="p">,</span> <span class="n">xticks</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (bins prior to current)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Current Time (bins through session)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Stimulus Design Matrix with Constant Column&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5969, 6)
(5969, 5)
(5969, 11)
range(0, 11)
[&#39;und&#39;, 0, -1, -2, -3, -4, 0, -1, -2, -3, -4]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Stimulus Design Matrix with Constant Column&#39;)
</pre></div>
</div>
<img alt="../_images/195322962bcb05e26a430f7ab59c466ba5ea232bf7a7dbe1f3b29f5b6e88e942.png" src="../_images/195322962bcb05e26a430f7ab59c466ba5ea232bf7a7dbe1f3b29f5b6e88e942.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">training_outputs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spike_times</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">):</span>
    <span class="c1"># bin spikes where bins line up with the interpolated flashes timestamps</span>
    <span class="n">these_spikes_binned</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">time_axis</span><span class="p">),</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span><span class="n">end_time</span><span class="p">))</span>
    <span class="c1"># try:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">fit_lnp</span><span class="p">(</span><span class="n">comb_design_mat</span><span class="p">,</span> <span class="n">these_spikes_binned</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">midpoint</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># assumes the design mat has odd length</span>
    <span class="n">const</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">white_filt</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">midpoint</span><span class="p">]</span>
    <span class="n">black_filt</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">midpoint</span><span class="p">:]</span>
    <span class="n">training_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">these_spikes_binned</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">white_filt</span><span class="p">,</span> <span class="n">black_filt</span><span class="p">))</span>
    <span class="c1"># except:</span>
    <span class="c1">#     training_outputs.append((these_spikes_binned, np.nan, [], np.nan, []))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_cols</span><span class="o">=</span><span class="mi">5</span>

<span class="n">n_rows</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">training_outputs</span><span class="p">)</span><span class="o">/</span><span class="n">n_cols</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">n_rows</span><span class="p">))</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">training_outputs</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">continue</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">white_filt</span><span class="p">,</span> <span class="n">black_filt</span> <span class="o">=</span> <span class="n">training_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filter_time_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">white_filt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;silver&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filter_time_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">black_filt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unit </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/855aa08f48d703192c9114f5c7fd3d999d2b1ab1495d8b9a3090ec91732743b9.png" src="../_images/855aa08f48d703192c9114f5c7fd3d999d2b1ab1495d8b9a3090ec91732743b9.png" />
</div>
</div>
</section>
<section id="predict-activity">
<h3>Predict Activity<a class="headerlink" href="#predict-activity" title="Link to this heading">#</a></h3>
<p>Finally, these trained filters can be applied to the stimulus to generate predicted spiking probability and predicted spike counts. In a real use case, one could provide some hypothetical stimulus values to predict how the units of interest may respond. Note that since the Poisson generation is non-deterministic, the predicted spikes will differ with each run. To evaluate the GLM’s performance, the <span class="math notranslate nohighlight">\(R^2\)</span> values are calculated between the observed spikes and the predicted spike probability. Note that in the <span class="math notranslate nohighlight">\(R^2\)</span> distributions below, performance is higher for predicting black flashes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prediction_outputs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">spikes_binned</span><span class="p">,</span> <span class="n">constant</span><span class="p">,</span> <span class="n">white_filter</span><span class="p">,</span> <span class="n">black_filter</span> <span class="ow">in</span> <span class="n">training_outputs</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">white_filter</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">white_predicted_rate</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">white_design_mat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">white_filter</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span>
    <span class="n">white_spikes_predicted</span> <span class="o">=</span> <span class="n">predict_spikes</span><span class="p">(</span><span class="n">white_design_mat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">white_filter</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span>
    <span class="n">white_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">spikes_binned</span><span class="p">,</span> <span class="n">white_predicted_rate</span><span class="p">)</span>

    <span class="n">black_predicted_rate</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">black_design_mat</span><span class="p">,</span> <span class="n">black_filter</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span>
    <span class="n">black_spikes_predicted</span> <span class="o">=</span> <span class="n">predict_spikes</span><span class="p">(</span><span class="n">black_design_mat</span><span class="p">,</span> <span class="n">black_filter</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span>
    <span class="n">black_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">spikes_binned</span><span class="p">,</span> <span class="n">black_predicted_rate</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;white observed mean rate:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spikes_binned</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spikes_binned</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;white predicted mean rate:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">white_spikes_predicted</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">white_spikes_predicted</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;white loss:&quot;</span><span class="p">,</span><span class="n">white_r2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;black observed mean rate:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spikes_binned</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spikes_binned</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;black predicted mean rate:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">black_spikes_predicted</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">black_spikes_predicted</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;black loss:&quot;</span><span class="p">,</span><span class="n">black_r2</span><span class="p">)</span>

    <span class="n">prediction_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">white_predicted_rate</span><span class="p">,</span> <span class="n">white_spikes_predicted</span><span class="p">,</span> <span class="n">white_r2</span><span class="p">,</span> <span class="n">black_predicted_rate</span><span class="p">,</span> <span class="n">black_spikes_predicted</span><span class="p">,</span> <span class="n">black_r2</span><span class="p">])</span>

<span class="n">white_r2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">output</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">prediction_outputs</span><span class="p">])</span>
<span class="n">black_r2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">output</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">prediction_outputs</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==================&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;average white loss:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">white_r2s</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;average black loss:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">black_r2s</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5,)
===
white observed mean rate: 0.1216284134695929
white predicted mean rate: 0.11626738147093316
white loss: 0.0003848557093315552
black observed mean rate: 0.1216284134695929
black predicted mean rate: 0.12196347796950913
black loss: 0.0011426315366189765
(5,)
===
white observed mean rate: 0.10571284972357178
white predicted mean rate: 0.1018596079745351
white loss: 0.0009655136229619332
black observed mean rate: 0.10571284972357178
black predicted mean rate: 0.1038699949740325
black loss: 0.0017283559296648043
(5,)
===
white observed mean rate: 1.139051767465237
white predicted mean rate: 1.1470933154632266
white loss: 0.0003733266939996982
black observed mean rate: 1.139051767465237
black predicted mean rate: 1.140392025464902
black loss: 0.0003282379855058526
(5,)
===
white observed mean rate: 0.2186295861953426
white predicted mean rate: 0.18311274920422183
white loss: 0.017914792592427897
black observed mean rate: 0.2186295861953426
black predicted mean rate: 0.19467247445133187
black loss: 0.07174470984217507
(5,)
===
white observed mean rate: 0.1256491874685877
white predicted mean rate: 0.12799463896800134
white loss: 0.0014413843598259923
black observed mean rate: 0.1256491874685877
black predicted mean rate: 0.1127492042218127
black loss: 0.00028849785661355654
(5,)
===
white observed mean rate: 0.14977383146255654
white predicted mean rate: 0.1573127827106718
white loss: 0.0002254654068708506
black observed mean rate: 0.14977383146255654
black predicted mean rate: 0.1542972022114257
black loss: 0.0018114592982365618
(5,)
===
white observed mean rate: 0.0
white predicted mean rate: 0.0
white loss: 0.0
black observed mean rate: 0.0
black predicted mean rate: 0.0
black loss: 0.0
(5,)
===
white observed mean rate: 0.007538951248115262
white predicted mean rate: 0.008376612497905847
white loss: 1.9006137864652217e-05
black observed mean rate: 0.007538951248115262
black predicted mean rate: 0.007371418998157145
black loss: 3.559776082862065e-05
(5,)
===
white observed mean rate: 0.09951415647512146
white predicted mean rate: 0.10051934997487016
white loss: 0.00012236392701803211
black observed mean rate: 0.09951415647512146
black predicted mean rate: 0.10437259172390685
black loss: 0.0012923085627645214
(5,)
===
white observed mean rate: 1.5391187803652202
white predicted mean rate: 1.5056123303735969
white loss: 0.019236524868015192
black observed mean rate: 1.5391187803652202
black predicted mean rate: 1.501591556374602
black loss: 0.028437051031692584
(5,)
===
white observed mean rate: 0.005696096498575976
white predicted mean rate: 0.005193499748701625
white loss: 4.3188527518500663e-05
black observed mean rate: 0.005696096498575976
black predicted mean rate: 0.005696096498575976
black loss: 5.690326573304372e-05
(5,)
===
white observed mean rate: 0.19852571620036857
white predicted mean rate: 0.1732283464566929
white loss: 0.008166714076554227
black observed mean rate: 0.19852571620036857
black predicted mean rate: 0.18529066845367734
black loss: 0.034702631204931
(5,)
===
white observed mean rate: 0.4265371083933657
white predicted mean rate: 0.44446305913888423
white loss: 0.004227828472543882
black observed mean rate: 0.4265371083933657
black predicted mean rate: 0.43893449489026637
black loss: 0.01875042856890119
(5,)
===
white observed mean rate: 0.508460378622885
white predicted mean rate: 0.4563578488859105
white loss: 0.004596785173297535
black observed mean rate: 0.508460378622885
black predicted mean rate: 0.4922097503769476
black loss: 0.051307099358714026
(5,)
===
white observed mean rate: 0.446976042888256
white predicted mean rate: 0.40107220639973196
white loss: -0.004926347130385089
black observed mean rate: 0.446976042888256
black predicted mean rate: 0.4657396548835651
black loss: 0.10049793706306276
(5,)
===
white observed mean rate: 0.37510470765622383
white predicted mean rate: 0.3590216116602446
white loss: 0.007595478119929999
black observed mean rate: 0.37510470765622383
black predicted mean rate: 0.3576813536605797
black loss: 0.017200694801386862
(5,)
===
white observed mean rate: 0.40593064164851733
white predicted mean rate: 0.37778522365555367
white loss: -5.138595963272152e-05
black observed mean rate: 0.40593064164851733
black predicted mean rate: 0.4106215446473446
black loss: 0.00612070655196062
(5,)
===
white observed mean rate: 0.09951415647512146
white predicted mean rate: 0.10303233372424192
white loss: 0.00039091941474289627
black observed mean rate: 0.09951415647512146
black predicted mean rate: 0.09700117272574971
black loss: 0.0008338045089394397
(5,)
===
white observed mean rate: 0.2888255989277936
white predicted mean rate: 0.2896632601775842
white loss: 0.0008306778729324504
black observed mean rate: 0.2888255989277936
black predicted mean rate: 0.2958619534260345
black loss: 0.00269197876065308
(5,)
===
white observed mean rate: 0.11341933322164517
white predicted mean rate: 0.10906349472273412
white loss: 0.0007623255694491071
black observed mean rate: 0.11341933322164517
black predicted mean rate: 0.12045568771988607
black loss: 5.151272924341921e-05
(5,)
===
white observed mean rate: 1.2373931981906516
white predicted mean rate: 1.1871335232032165
white loss: 0.008035544574526932
black observed mean rate: 1.2373931981906516
black predicted mean rate: 1.236388004690903
black loss: 0.05996413104523912
(5,)
===
white observed mean rate: 0.026972692243256827
white predicted mean rate: 0.02730775674317306
white loss: 8.655361853615595e-05
black observed mean rate: 0.026972692243256827
black predicted mean rate: 0.028648014742837995
black loss: 2.1777117094501364e-05
(5,)
===
white observed mean rate: 1.187636119953091
white predicted mean rate: 1.2432568269391857
white loss: 0.006454214102642908
black observed mean rate: 1.187636119953091
black predicted mean rate: 1.1769140559557716
black loss: 0.019201846553171587
(5,)
===
white observed mean rate: 0.0063662254984084435
white predicted mean rate: 0.006868822248282795
white loss: 2.168089848897381e-05
black observed mean rate: 0.0063662254984084435
black predicted mean rate: 0.005696096498575976
black loss: 0.000321451051522037
(5,)
===
white observed mean rate: 0.3387502094153124
white predicted mean rate: 0.34159825766460045
white loss: 0.002320225293207301
black observed mean rate: 0.3387502094153124
black predicted mean rate: 0.3384151449153962
black loss: 0.0005628944396857127
(5,)
===
white observed mean rate: 0.0036857094990785724
white predicted mean rate: 0.0041883062489529235
white loss: 8.387496791883997e-06
black observed mean rate: 0.0036857094990785724
black predicted mean rate: 0.00217791924945552
black loss: 3.3283996927480075e-06
(5,)
===
white observed mean rate: 0.06868822248282794
white predicted mean rate: 0.05830122298542469
white loss: 0.016620134991759072
black observed mean rate: 0.06868822248282794
black predicted mean rate: 0.061149271234712685
black loss: 0.036149389630828366
(5,)
===
white observed mean rate: 0.7626068018093483
white predicted mean rate: 0.6766627575808343
white loss: 0.007194643423468872
black observed mean rate: 0.7626068018093483
black predicted mean rate: 0.7257497068185625
black loss: 0.046566331382891235
(5,)
===
white observed mean rate: 0.005528564248617859
white predicted mean rate: 0.00603116099849221
white loss: 7.900903933755199e-05
black observed mean rate: 0.005528564248617859
black predicted mean rate: 0.005361031998659742
black loss: 0.00025421727454244536
(5,)
===
white observed mean rate: 0.2275087954431228
white predicted mean rate: 0.23521527894119618
white loss: 0.00011571588748582329
black observed mean rate: 0.2275087954431228
black predicted mean rate: 0.23286982744178256
black loss: 0.004185549026593627
(5,)
===
white observed mean rate: 0.4357513821410621
white predicted mean rate: 0.4392695593901826
white loss: 0.005071780398373749
black observed mean rate: 0.4357513821410621
black predicted mean rate: 0.4523370748869157
black loss: 0.003937504405343906
(5,)
===
white observed mean rate: 0.029653208242586698
white predicted mean rate: 0.028312950242921762
white loss: -6.458462948844002e-05
black observed mean rate: 0.029653208242586698
black predicted mean rate: 0.03350644999162339
black loss: 0.0036879960668028122
(5,)
===
white observed mean rate: 0.009716870497570782
white predicted mean rate: 0.010554531747361368
white loss: 2.7724438046106137e-05
black observed mean rate: 0.009716870497570782
black predicted mean rate: 0.009884402747528899
black loss: 3.949293473026749e-05
(5,)
===
white observed mean rate: 0.6974367565756409
white predicted mean rate: 0.6731445803317139
white loss: 0.008859155883803704
black observed mean rate: 0.6974367565756409
black predicted mean rate: 0.6687887418328028
black loss: 0.01563537368842216
(5,)
===
white observed mean rate: 0.7331211258167197
white predicted mean rate: 0.7493717540626571
white loss: 0.0005195540380142916
black observed mean rate: 0.7331211258167197
black predicted mean rate: 0.7369743675657564
black loss: 0.006908389128369441
(5,)
===
white observed mean rate: 0.8116937510470765
white predicted mean rate: 0.7399899480650025
white loss: 0.03600261224027024
black observed mean rate: 0.8116937510470765
black predicted mean rate: 0.7788574300552856
black loss: 0.035600931425925464
(5,)
===
white observed mean rate: 0.37577483665605627
white predicted mean rate: 0.3916904004020774
white loss: 0.00013269112177083375
black observed mean rate: 0.37577483665605627
black predicted mean rate: 0.3690735466577316
black loss: 0.0074715385571892945
(5,)
===
white observed mean rate: 0.2663762774334059
white predicted mean rate: 0.2596749874350813
white loss: 0.00393518111512392
black observed mean rate: 0.2663762774334059
black predicted mean rate: 0.2802814541799296
black loss: 0.001082962858229508
(5,)
===
white observed mean rate: 0.09314793097671302
white predicted mean rate: 0.09029988272742503
white loss: 0.0007904312238266042
black observed mean rate: 0.09314793097671302
black predicted mean rate: 0.08946222147763444
black loss: 0.004349019904693829
(5,)
===
white observed mean rate: 0.31864633942033843
white predicted mean rate: 0.306584017423354
white loss: 0.007530997023826869
black observed mean rate: 0.31864633942033843
black predicted mean rate: 0.32266711341933324
black loss: 0.014221172855047537
(5,)
===
white observed mean rate: 0.2667113419333222
white predicted mean rate: 0.2717373094320657
white loss: 0.0009270823265001837
black observed mean rate: 0.2667113419333222
black predicted mean rate: 0.26922432568269394
black loss: 0.00018613974805381517
(5,)
===
white observed mean rate: 0.21326855419668286
white predicted mean rate: 0.19819065170045233
white loss: 0.0016485908703034458
black observed mean rate: 0.21326855419668286
black predicted mean rate: 0.21192829619701792
black loss: 0.00724375773585928
(5,)
===
white observed mean rate: 0.032501256491874686
white predicted mean rate: 0.0326687887418328
white loss: 0.002561330929999661
black observed mean rate: 0.032501256491874686
black predicted mean rate: 0.03015580499246105
black loss: 0.020399737262718043
(5,)
===
white observed mean rate: 0.005025967498743508
white predicted mean rate: 0.007538951248115262
white loss: 2.2711039360689966e-05
black observed mean rate: 0.005025967498743508
black predicted mean rate: 0.004858435248785391
black loss: 0.0007943845878219946
(5,)
===
white observed mean rate: 0.00217791924945552
white predicted mean rate: 0.0011727257497068187
white loss: 1.340942709371351e-05
black observed mean rate: 0.00217791924945552
black predicted mean rate: 0.003015580499246105
black loss: 1.6160863511638368e-05
(5,)
===
white observed mean rate: 0.27910872843022283
white predicted mean rate: 0.24091137543977215
white loss: -0.0005299131067735274
black observed mean rate: 0.27910872843022283
black predicted mean rate: 0.27575808343106045
black loss: 0.038992589644905595
(5,)
===
white observed mean rate: 0.0
white predicted mean rate: 0.0
white loss: 0.0
black observed mean rate: 0.0
black predicted mean rate: 0.0
black loss: 0.0
(5,)
===
white observed mean rate: 0.33757748366560564
white predicted mean rate: 0.24945552018763612
white loss: -0.013224882349350375
black observed mean rate: 0.33757748366560564
black predicted mean rate: 0.3302060646674485
black loss: 0.26487208568094
(5,)
===
white observed mean rate: 1.2727425029318145
white predicted mean rate: 1.3112749204221812
white loss: 0.009631569902985637
black observed mean rate: 1.2727425029318145
black predicted mean rate: 1.2858100184285475
black loss: 0.01916969131860391
(5,)
===
white observed mean rate: 0.111744010722064
white predicted mean rate: 0.11258167197185458
white loss: 0.002918174604072954
black observed mean rate: 0.111744010722064
black predicted mean rate: 0.10923102697269224
black loss: 0.006983091930748975
(5,)
===
white observed mean rate: 0.712012062321997
white predicted mean rate: 0.7354665773161334
white loss: 0.001770086281769112
black observed mean rate: 0.712012062321997
black predicted mean rate: 0.7155302395711174
black loss: 0.010483056914401767
(5,)
===
white observed mean rate: 0.4292176243926956
white predicted mean rate: 0.3541631764114592
white loss: -0.008391718616928445
black observed mean rate: 0.4292176243926956
black predicted mean rate: 0.43591891439102026
black loss: 0.18986787495173962
(5,)
===
white observed mean rate: 1.1960127324509968
white predicted mean rate: 1.138716702965321
white loss: 0.003139719226269322
black observed mean rate: 1.1960127324509968
black predicted mean rate: 1.189311442452672
black loss: 0.052245840083565254
(5,)
===
white observed mean rate: 0.0909700117272575
white predicted mean rate: 0.08041547997989613
white loss: -0.002808738133622146
black observed mean rate: 0.0909700117272575
black predicted mean rate: 0.08795443122801139
black loss: 0.07340013913830312
(5,)
===
white observed mean rate: 0.10537778522365555
white predicted mean rate: 0.10856089797285978
white loss: 0.0008422770834660698
black observed mean rate: 0.10537778522365555
black predicted mean rate: 0.10705310772323673
black loss: 0.0015322509397520667
(5,)
===
white observed mean rate: 0.38968001340258
white predicted mean rate: 0.35165019266208747
white loss: 0.011151250336941754
black observed mean rate: 0.38968001340258
black predicted mean rate: 0.36924107890768976
black loss: 0.051190540321267686
(5,)
===
white observed mean rate: 0.2412464399396884
white predicted mean rate: 0.236388004690903
white loss: 0.011764365499912999
black observed mean rate: 0.2412464399396884
black predicted mean rate: 0.23270229519182442
black loss: 0.004697187935071234
(5,)
===
white observed mean rate: 0.022784385994303904
white predicted mean rate: 0.025799966493550007
white loss: 0.002484279361625874
black observed mean rate: 0.022784385994303904
black predicted mean rate: 0.022784385994303904
black loss: 0.00031485311797696536
(5,)
===
white observed mean rate: 0.12280113921929972
white predicted mean rate: 0.10755570447311108
white loss: 0.0014719862613212786
black observed mean rate: 0.12280113921929972
black predicted mean rate: 0.12347126821913218
black loss: 0.058630585406477476
(5,)
===
white observed mean rate: 0.11124141397218965
white predicted mean rate: 0.09716870497570783
white loss: -0.0004295403760308236
black observed mean rate: 0.11124141397218965
black predicted mean rate: 0.10454012397386497
black loss: 0.010373524034677062
(5,)
===
white observed mean rate: 0.22482827944379294
white predicted mean rate: 0.11107388172223152
white loss: -0.020726940986139697
black observed mean rate: 0.22482827944379294
black predicted mean rate: 0.23421008544144747
black loss: 0.5274035051768187
(5,)
===
white observed mean rate: 0.6138381638465404
white predicted mean rate: 0.5950745518512314
white loss: 0.0038072560698744207
black observed mean rate: 0.6138381638465404
black predicted mean rate: 0.6161836153459541
black loss: 0.017373712868559044
(5,)
===
white observed mean rate: 0.15479979896130006
white predicted mean rate: 0.1325180097168705
white loss: 0.028725009902258125
black observed mean rate: 0.15479979896130006
black predicted mean rate: 0.15412966996146757
black loss: 0.10951727486789076
(5,)
===
white observed mean rate: 0.13318813871670296
white predicted mean rate: 0.13419333221645166
white loss: 0.0032526677027278073
black observed mean rate: 0.13318813871670296
black predicted mean rate: 0.14876863796280784
black loss: 0.0014937904135995383
(5,)
===
white observed mean rate: 0.2038867481990283
white predicted mean rate: 0.19551013570112247
white loss: -6.204172880952541e-05
black observed mean rate: 0.2038867481990283
black predicted mean rate: 0.20087116769978222
black loss: 0.023569761078984897
(5,)
===
white observed mean rate: 0.3628748534092813
white predicted mean rate: 0.3482995476629251
white loss: 0.008453908205621308
black observed mean rate: 0.3628748534092813
black predicted mean rate: 0.3613670631596582
black loss: 0.015485288268646369
(5,)
===
white observed mean rate: 0.30139051767465236
white predicted mean rate: 0.2925113084268722
white loss: 0.0020439999508167217
black observed mean rate: 0.30139051767465236
black predicted mean rate: 0.30541129167364717
black loss: 0.007643610458605288
(5,)
===
white observed mean rate: 0.07388172223152957
white predicted mean rate: 0.06047914223488021
white loss: 0.0020788155869526648
black observed mean rate: 0.07388172223152957
black predicted mean rate: 0.07136873848215781
black loss: 0.020099392222687973
(5,)
===
white observed mean rate: 0.042720723739319816
white predicted mean rate: 0.04020773998994807
white loss: 0.001247608968091396
black observed mean rate: 0.042720723739319816
black predicted mean rate: 0.04523370748869157
black loss: 0.00016570890840528207
(5,)
===
white observed mean rate: 0.3613670631596582
white predicted mean rate: 0.33372424191656896
white loss: -0.00048115737569398576
black observed mean rate: 0.3613670631596582
black predicted mean rate: 0.34980733791254814
black loss: 0.06249341928624785
(5,)
===
white observed mean rate: 0.26252303568436924
white predicted mean rate: 0.23622047244094488
white loss: -0.0028752364128576957
black observed mean rate: 0.26252303568436924
black predicted mean rate: 0.2579996649355001
black loss: 0.06313366049042235
(5,)
===
white observed mean rate: 0.28916066342770985
white predicted mean rate: 0.26721393868319654
white loss: -0.0013935124271227117
black observed mean rate: 0.28916066342770985
black predicted mean rate: 0.28949572792762607
black loss: 0.046019911569354144
(5,)
===
white observed mean rate: 0.021109063494722736
white predicted mean rate: 0.019433740995141564
white loss: 0.00022443187578335966
black observed mean rate: 0.021109063494722736
black predicted mean rate: 0.0217791924945552
black loss: 0.002958126869226807
(5,)
===
white observed mean rate: 0.005696096498575976
white predicted mean rate: 0.005025967498743508
white loss: -1.7133527077106692e-06
black observed mean rate: 0.005696096498575976
black predicted mean rate: 0.0031831127492042218
black loss: 0.006002598532940384
(5,)
===
white observed mean rate: 0.35583849891104036
white predicted mean rate: 0.3648852404087787
white loss: 0.00030375955412242917
black observed mean rate: 0.35583849891104036
black predicted mean rate: 0.3603618696599095
black loss: 0.018020993600989077
(5,)
===
white observed mean rate: 0.10772323672306919
white predicted mean rate: 0.09984922097503769
white loss: -7.948466588914016e-06
black observed mean rate: 0.10772323672306919
black predicted mean rate: 0.10671804322332049
black loss: 0.005971261495489433
(5,)
===
white observed mean rate: 0.009549338247612666
white predicted mean rate: 0.007036354498240911
white loss: 9.971134382613656e-07
black observed mean rate: 0.009549338247612666
black predicted mean rate: 0.013235047746691238
black loss: 0.01141134341316874
(5,)
===
white observed mean rate: 0.10738817222315296
white predicted mean rate: 0.07706483498073378
white loss: -0.00842491822652125
black observed mean rate: 0.10738817222315296
black predicted mean rate: 0.09834143072541464
black loss: 0.17831098868701056
(5,)
===
white observed mean rate: 0.0681856257329536
white predicted mean rate: 0.07103367398224159
white loss: 0.00039056734230424883
black observed mean rate: 0.0681856257329536
black predicted mean rate: 0.05863628748534093
black loss: 0.01146695862813174
(5,)
===
white observed mean rate: 1.946724744513319
white predicted mean rate: 1.8520690232869828
white loss: -0.004332975104232917
black observed mean rate: 1.946724744513319
black predicted mean rate: 1.8793767800301557
black loss: 0.11411576076738605
(5,)
===
white observed mean rate: 0.020941531244764618
white predicted mean rate: 0.018931144245267213
white loss: -0.00035844682468222366
black observed mean rate: 0.020941531244764618
black predicted mean rate: 0.0207739989948065
black loss: 0.0345472538917142
(5,)
===
white observed mean rate: 0.5979226001005193
white predicted mean rate: 0.6501926620874519
white loss: 0.022654840973459822
black observed mean rate: 0.5979226001005193
black predicted mean rate: 0.6393030658401743
black loss: 0.036152384220748846
(5,)
===
white observed mean rate: 0.25079577818730103
white predicted mean rate: 0.2422516334394371
white loss: 0.007698330657577079
black observed mean rate: 0.25079577818730103
black predicted mean rate: 0.26453342268386665
black loss: 0.02964700407652221
(5,)
===
white observed mean rate: 0.08761936672809516
white predicted mean rate: 0.04707656223823086
white loss: 0.03912638050163242
black observed mean rate: 0.08761936672809516
black predicted mean rate: 0.08343106047914224
black loss: 0.41661023549371845
(5,)
===
white observed mean rate: 0.15546992796113251
white predicted mean rate: 0.1553023957111744
white loss: 0.24071110804163243
black observed mean rate: 0.15546992796113251
black predicted mean rate: 0.1147595912213101
black loss: -0.003544069869673372
(5,)
===
white observed mean rate: 0.13938683196515328
white predicted mean rate: 0.11224660747193835
white loss: 0.0013094460554390341
black observed mean rate: 0.13938683196515328
black predicted mean rate: 0.13519852571620036
black loss: 0.0525031573351169
(5,)
===
white observed mean rate: 0.08577651197855587
white predicted mean rate: 0.05562070698609482
white loss: -0.0029877539877321
black observed mean rate: 0.08577651197855587
black predicted mean rate: 0.08376612497905847
black loss: 0.29527689638455723
(5,)
===
white observed mean rate: 0.38934494890266375
white predicted mean rate: 0.39001507790249623
white loss: 0.002426687535275418
black observed mean rate: 0.38934494890266375
black predicted mean rate: 0.40107220639973196
black loss: 0.01301334602588411
(5,)
===
white observed mean rate: 0.9991623387502094
white predicted mean rate: 1.0018428547495393
white loss: 0.037411280011980796
black observed mean rate: 0.9991623387502094
black predicted mean rate: 0.984251968503937
black loss: 0.18023503931300244
(5,)
===
white observed mean rate: 0.016753224995811694
white predicted mean rate: 0.014407773496398057
white loss: 0.0009836851823887827
black observed mean rate: 0.016753224995811694
black predicted mean rate: 0.01474283799631429
black loss: 0.0004074757637352322
(5,)
===
white observed mean rate: 1.5660914726084771
white predicted mean rate: 1.6195342603451164
white loss: 0.005582469816833413
black observed mean rate: 1.5660914726084771
black predicted mean rate: 1.5535265538616183
black loss: 0.03995618295001979
(5,)
===
white observed mean rate: 0.5719551013570112
white predicted mean rate: 0.6069693415982577
white loss: 0.004594055485344972
black observed mean rate: 0.5719551013570112
black predicted mean rate: 0.5910537778522366
black loss: 0.03570782522818294
(5,)
===
white observed mean rate: 0.4566929133858268
white predicted mean rate: 0.4726084771318479
white loss: 0.0050918068977100495
black observed mean rate: 0.4566929133858268
black predicted mean rate: 0.4439604623890099
black loss: 0.003264670411580739
(5,)
===
white observed mean rate: 0.017088289495727927
white predicted mean rate: 0.016920757245769812
white loss: 0.00012482945702541048
black observed mean rate: 0.017088289495727927
black predicted mean rate: 0.015412966996146759
black loss: 0.0010144683492098183
(5,)
===
white observed mean rate: 0.5575473278606131
white predicted mean rate: 0.531412296867147
white loss: -0.0002526171154308976
black observed mean rate: 0.5575473278606131
black predicted mean rate: 0.5397889093650527
black loss: 0.03682371257986805
(5,)
===
white observed mean rate: 0.5454850058636288
white predicted mean rate: 0.5267213938683196
white loss: 0.004374109598986542
black observed mean rate: 0.5454850058636288
black predicted mean rate: 0.5394538448651366
black loss: 0.05856601626317448
(5,)
===
white observed mean rate: 0.25950745518512314
white predicted mean rate: 0.23622047244094488
white loss: -0.0033081448092007193
black observed mean rate: 0.25950745518512314
black predicted mean rate: 0.25548668118612833
black loss: 0.07120280741004126
(5,)
===
white observed mean rate: 0.651867984587033
white predicted mean rate: 0.6238900988440275
white loss: 0.005406319718767927
black observed mean rate: 0.651867984587033
black predicted mean rate: 0.6394705980901324
black loss: 0.01753802380690017
(5,)
===
white observed mean rate: 0.36455017590886246
white predicted mean rate: 0.3858267716535433
white loss: 0.00284219726603685
black observed mean rate: 0.36455017590886246
black predicted mean rate: 0.3560060311609985
black loss: 0.008543525574980504
(5,)
===
white observed mean rate: 0.2636957614340761
white predicted mean rate: 0.2600100519349975
white loss: 0.005098600537176479
black observed mean rate: 0.2636957614340761
black predicted mean rate: 0.24476461718880885
black loss: 0.017924502576857182
(5,)
===
white observed mean rate: 0.07639470598090133
white predicted mean rate: 0.07354665773161334
white loss: -0.00029732467387688644
black observed mean rate: 0.07639470598090133
black predicted mean rate: 0.08091807672977049
black loss: 0.010869539238476
(5,)
===
white observed mean rate: 0.01641816049589546
white predicted mean rate: 0.016083095995979225
white loss: 0.00027707162775403305
black observed mean rate: 0.01641816049589546
black predicted mean rate: 0.019266208745183446
black loss: 0.002454003406159977
(5,)
===
white observed mean rate: 0.3407605964148098
white predicted mean rate: 0.21008544144747865
white loss: -0.010041782738266836
black observed mean rate: 0.3407605964148098
black predicted mean rate: 0.31093985592226503
black loss: 0.3267876990113304
(5,)
===
white observed mean rate: 0.7043055788239236
white predicted mean rate: 0.6883900150779025
white loss: 0.011774855836110487
black observed mean rate: 0.7043055788239236
black predicted mean rate: 0.67616016083096
black loss: 0.006270160914384704
(5,)
===
white observed mean rate: 0.04104540123973865
white predicted mean rate: 0.04640643323839839
white loss: 3.368799417646784e-05
black observed mean rate: 0.04104540123973865
black predicted mean rate: 0.04372591723906852
black loss: 0.00023014749457739292
(5,)
===
white observed mean rate: 0.06265706148433574
white predicted mean rate: 0.057966158485508464
white loss: 0.0001540282344231203
black observed mean rate: 0.06265706148433574
black predicted mean rate: 0.05428044898642989
black loss: 0.011985768878747805
(5,)
===
white observed mean rate: 0.049422013737644495
white predicted mean rate: 0.04824928798793768
white loss: 0.0004179848013005083
black observed mean rate: 0.049422013737644495
black predicted mean rate: 0.04875188473781203
black loss: 0.0001908145468917377
(5,)
===
white observed mean rate: 0.6736471770815882
white predicted mean rate: 0.6463394203384152
white loss: 0.0061140655907607755
black observed mean rate: 0.6736471770815882
black predicted mean rate: 0.6987770145753057
black loss: 0.011359336055889457
(5,)
===
white observed mean rate: 0.1521192829619702
white predicted mean rate: 0.10755570447311108
white loss: -0.008313439416093527
black observed mean rate: 0.1521192829619702
black predicted mean rate: 0.13804657396548836
black loss: 0.172227165391444
(5,)
===
white observed mean rate: 0.18210755570447312
white predicted mean rate: 0.15647512146088122
white loss: 0.0009569106488862555
black observed mean rate: 0.18210755570447312
black predicted mean rate: 0.1849556039537611
black loss: 0.10988971973614292
(5,)
===
white observed mean rate: 0.06785056123303736
white predicted mean rate: 0.07103367398224159
white loss: 0.00014871859627829664
black observed mean rate: 0.06785056123303736
black predicted mean rate: 0.06952588373261853
black loss: 9.119497109888464e-05
(5,)
===
white observed mean rate: 0.18931144245267215
white predicted mean rate: 0.189143910202714
white loss: 0.0023364392394086275
black observed mean rate: 0.18931144245267215
black predicted mean rate: 0.20723739319819065
black loss: 0.006056428710098816
(5,)
===
white observed mean rate: 0.04791422348802144
white predicted mean rate: 0.04339085273915229
white loss: 0.01064306978484253
black observed mean rate: 0.04791422348802144
black predicted mean rate: 0.04473111073881722
black loss: 0.006224699349372975
(5,)
===
white observed mean rate: 0.18261015245434747
white predicted mean rate: 0.16853744345786564
white loss: 0.006019444900695947
black observed mean rate: 0.18261015245434747
black predicted mean rate: 0.16853744345786564
black loss: 0.015814799955819137
(5,)
===
white observed mean rate: 0.061986932484503265
white predicted mean rate: 0.05377785223655554
white loss: 0.0023208338444413723
black observed mean rate: 0.061986932484503265
black predicted mean rate: 0.06349472273412632
black loss: 0.001124355702116664
(5,)
===
white observed mean rate: 0.04573630423856592
white predicted mean rate: 0.03819735299045066
white loss: 0.00021551674479525218
black observed mean rate: 0.04573630423856592
black predicted mean rate: 0.04540123973864969
black loss: 0.04577495452770619
(5,)
===
white observed mean rate: 0.06935835148266041
white predicted mean rate: 0.055285642486178586
white loss: -0.0006439349986779863
black observed mean rate: 0.06935835148266041
black predicted mean rate: 0.06919081923270229
black loss: 0.024787389770898116
(5,)
===
white observed mean rate: 0.5577148601105713
white predicted mean rate: 0.5649187468587703
white loss: 0.0042630699978698505
black observed mean rate: 0.5577148601105713
black predicted mean rate: 0.5525213603618696
black loss: 0.015539429275134964
(5,)
===
white observed mean rate: 0.02412464399396884
white predicted mean rate: 0.020941531244764618
white loss: 0.00023852470514440505
black observed mean rate: 0.02412464399396884
black predicted mean rate: 0.020606466744848385
black loss: 0.00970105028987478
(5,)
===
white observed mean rate: 0.083095995979226
white predicted mean rate: 0.0603116099849221
white loss: -0.004079967160372622
black observed mean rate: 0.083095995979226
black predicted mean rate: 0.08276093147930977
black loss: 0.13927174165931966
(5,)
===
white observed mean rate: 0.15798291171050427
white predicted mean rate: 0.13720891271569777
white loss: 0.004468796457906987
black observed mean rate: 0.15798291171050427
black predicted mean rate: 0.15764784721058803
black loss: 0.05556170180422659
(5,)
===
white observed mean rate: 0.21226336069693416
white predicted mean rate: 0.1829452169542637
white loss: -0.004248195821840994
black observed mean rate: 0.21226336069693416
black predicted mean rate: 0.21393868319651532
black loss: 0.10387382200167161
(5,)
===
white observed mean rate: 0.01474283799631429
white predicted mean rate: 0.01256491874685877
white loss: -0.00010849882499841534
black observed mean rate: 0.01474283799631429
black predicted mean rate: 0.011894789747026303
black loss: 0.015097436653518703
(5,)
===
white observed mean rate: 0.03216619199195845
white predicted mean rate: 0.025464901993633774
white loss: 0.0024342311859334442
black observed mean rate: 0.03216619199195845
black predicted mean rate: 0.03501424024124644
black loss: 0.020266324724482088
==================
average white loss: 0.004894024031872066
average black loss: 0.0412103108503236
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">white_r2s</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;silver&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;White Flashes Prediction $R^2s$&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$R^2$&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;# Units&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">black_r2s</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Black Flashes Prediction $R^2s$&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$R^2$&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;# Units&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;# Units&#39;)
</pre></div>
</div>
<img alt="../_images/bc7de67cab2a632a732d31fc382844462e02519b2adbc8a0ec846d0c36b61a90.png" src="../_images/bc7de67cab2a632a732d31fc382844462e02519b2adbc8a0ec846d0c36b61a90.png" />
</div>
</div>
</section>
<section id="showing-predictions">
<h3>Showing Predictions<a class="headerlink" href="#showing-predictions" title="Link to this heading">#</a></h3>
<p>Here, each model is plotted trained filter and prediction outputs. For ease of interpretation and to save space, only the best performing GLMs are displayed. This is done by selecting the prediction outputs with an <span class="math notranslate nohighlight">\(R^2\)</span> higher than 0.05. Model fitting is useful if you are expecting neuronal activity to follow a certain behavior. In the case of our Poisson model, we impose a certain response formula and fit the data to it. It can be sometimes useful to compare this fit with a more open-ended selection of cells: for instance, selecting cells simply based on whether the cell fired above a certain threshold. The combination of both approaches can allow to select cells to which fitting a model yield meaningful insights. In some cases, a non-responsive cell could provide model parameters that are hard to interpret. So it is always judicious to combine approaches.</p>
<p>In the first plot below, it can be seen that there is only one White Flashes model with an <span class="math notranslate nohighlight">\(R^2\)</span> greater than 0.05, indicating that in these data, units are less reliably responsive to white flashes than black. For each unit, real observed spikes given are shown, along with the trained model’s filter. Then the predicted spike rate, which as a reminder is the trained filter convolved over the input flashes. Finally, there is the predicted spikes which are the result of running the predicted spike rate through poisson generation. Because poisson is non-determinstic, these may look different every run.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">white_best_fits</span> <span class="o">=</span> <span class="n">white_r2s</span> <span class="o">&gt;</span> <span class="mf">0.05</span>
<span class="n">white_best_training_outputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">training_outputs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)[</span><span class="n">white_best_fits</span><span class="p">]</span>
<span class="n">white_best_prediction_outputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prediction_outputs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)[</span><span class="n">white_best_fits</span><span class="p">]</span>

<span class="n">black_best_fits</span> <span class="o">=</span> <span class="n">black_r2s</span> <span class="o">&gt;</span> <span class="mf">0.05</span>
<span class="n">black_best_training_outputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">training_outputs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)[</span><span class="n">black_best_fits</span><span class="p">]</span>
<span class="n">black_best_prediction_outputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prediction_outputs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)[</span><span class="n">black_best_fits</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">white_best_training_outputs</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">n_cells</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">white_best_training_outputs</span><span class="p">)):</span>
    <span class="n">spikes_binned</span><span class="p">,</span> <span class="n">constant</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">white_best_training_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">predicted_rate</span><span class="p">,</span> <span class="n">spikes_predicted</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">white_best_prediction_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">time_range_start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time_range_end</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">spikes_binned</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filter_time_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">predicted_rate</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;indigo&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">spikes_predicted</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">spikes_binned</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">spikes_predicted</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Observed Spikes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Trained Filter&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted Spike Rate&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted Spikes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Observed Spikes (b) + Predicted Spikes (o)&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax_x</span><span class="p">,</span> <span class="n">ax_y</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">ax_x</span><span class="p">][</span><span class="n">ax_y</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time throughout Session&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax_x</span><span class="p">,</span> <span class="n">ax_y</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">ax_x</span><span class="p">][</span><span class="n">ax_y</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time relative to Stimulus Event&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Best White Flashes Models&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f70cce71c75ad6e38f769e2b29f2fcf32b6da5b87cc4ac1548f612c1773e4385.png" src="../_images/f70cce71c75ad6e38f769e2b29f2fcf32b6da5b87cc4ac1548f612c1773e4385.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">black_best_training_outputs</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">n_cells</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">black_best_training_outputs</span><span class="p">)):</span>
    <span class="n">spikes_binned</span><span class="p">,</span> <span class="n">constant</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="nb">filter</span> <span class="o">=</span> <span class="n">black_best_training_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">predicted_rate</span><span class="p">,</span> <span class="n">spikes_predicted</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">black_best_prediction_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">time_range_start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time_range_end</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">spikes_binned</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filter_time_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">predicted_rate</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;indigo&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">spikes_predicted</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">spikes_binned</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">spikes_predicted</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Observed Spikes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Trained Filter&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted Spike Rate&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted Spikes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Observed Spikes (b) + Predicted Spikes (o)&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax_x</span><span class="p">,</span> <span class="n">ax_y</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">ax_x</span><span class="p">][</span><span class="n">ax_y</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time throughout Session&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax_x</span><span class="p">,</span> <span class="n">ax_y</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">ax_x</span><span class="p">][</span><span class="n">ax_y</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time relative to Stimulus Event&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Best Black Flashes Models&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/235971772b985629ba0c9e5243b6bea2ea9a474568c22e6132437060ac42e152.png" src="../_images/235971772b985629ba0c9e5243b6bea2ea9a474568c22e6132437060ac42e152.png" />
</div>
</div>
</section>
<section id="comparing-to-z-scores">
<h3>Comparing to Z-Scores<a class="headerlink" href="#comparing-to-z-scores" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># start and end times (relative to the stimulus at 0 seconds) that we want to examine and align spikes to</span>
<span class="n">window_start_time</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">filter_length</span> <span class="o">*</span> <span class="n">bin_sz</span><span class="p">)</span>
<span class="n">window_end_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">filter_length</span> <span class="o">*</span> <span class="n">bin_sz</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_spike_matrix</span><span class="p">(</span><span class="n">stim_times</span><span class="p">,</span> <span class="n">units_spike_times</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">):</span>
    <span class="n">time_resolution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">))</span>
    <span class="c1"># 3D spike matrix to be populated with spike counts</span>
    <span class="n">spike_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_times</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># populate 3D spike matrix for each unit for each stimulus trial by counting spikes into bins</span>
    <span class="k">for</span> <span class="n">unit_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">)):</span>
        <span class="n">spike_times</span> <span class="o">=</span> <span class="n">units_spike_times</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">stim_idx</span><span class="p">,</span> <span class="n">stim_time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stim_times</span><span class="p">):</span>
            <span class="c1"># get spike times that fall within the bin&#39;s time range relative to the stim time        </span>
            <span class="n">first_bin_time</span> <span class="o">=</span> <span class="n">stim_time</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">last_bin_time</span> <span class="o">=</span> <span class="n">stim_time</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">first_spike_in_range</span><span class="p">,</span> <span class="n">last_spike_in_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="p">[</span><span class="n">first_bin_time</span><span class="p">,</span> <span class="n">last_bin_time</span><span class="p">])</span>
            <span class="n">spike_times_in_range</span> <span class="o">=</span> <span class="n">spike_times</span><span class="p">[</span><span class="n">first_spike_in_range</span><span class="p">:</span><span class="n">last_spike_in_range</span><span class="p">]</span>

            <span class="c1"># convert spike times into relative time bin indices</span>
            <span class="n">bin_indices</span> <span class="o">=</span> <span class="p">((</span><span class="n">spike_times_in_range</span> <span class="o">-</span> <span class="p">(</span><span class="n">first_bin_time</span><span class="p">))</span> <span class="o">/</span> <span class="n">time_resolution</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            
            <span class="c1"># mark that there is a spike at these bin times for this unit on this stim trial</span>
            <span class="k">for</span> <span class="n">bin_idx</span> <span class="ow">in</span> <span class="n">bin_indices</span><span class="p">:</span>
                <span class="n">spike_matrix</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">,</span> <span class="n">stim_idx</span><span class="p">,</span> <span class="n">bin_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">spike_matrix</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">white_flash_times</span> <span class="o">=</span> <span class="n">time_axis</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">white_flashes</span><span class="p">))</span> <span class="k">if</span> <span class="n">white_flashes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">white_flashes</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]]</span>
<span class="n">black_flash_times</span> <span class="o">=</span> <span class="n">time_axis</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">black_flashes</span><span class="p">))</span> <span class="k">if</span> <span class="n">black_flashes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">black_flashes</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]]</span>

<span class="c1"># time bins used</span>
<span class="n">n_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">window_end_time</span> <span class="o">-</span> <span class="n">window_start_time</span><span class="p">)</span> <span class="o">/</span> <span class="n">bin_sz</span><span class="p">)</span>
<span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">window_start_time</span><span class="p">,</span> <span class="n">window_end_time</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># bin_edges = np.concatenate((filter_time_bins, -filter_time_bins[:-1][::-1]))</span>

<span class="c1"># calculate baseline and stimulus interval indices for use later</span>
<span class="n">stimulus_onset_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">bin_sz</span><span class="p">)</span>

<span class="n">white_flash_responses</span> <span class="o">=</span> <span class="n">get_spike_matrix</span><span class="p">(</span><span class="n">white_flash_times</span><span class="p">,</span> <span class="n">units_spike_times</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>
<span class="n">black_flash_responses</span> <span class="o">=</span> <span class="n">get_spike_matrix</span><span class="p">(</span><span class="n">black_flash_times</span><span class="p">,</span> <span class="n">units_spike_times</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>

<span class="c1"># has shape neuro * trials * time</span>
<span class="nb">print</span><span class="p">(</span><span class="n">white_flash_responses</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">black_flash_responses</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(124, 75, 10)
(124, 75, 10)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width_ratios&quot;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.4</span><span class="p">]})</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">white_flash_responses</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">)],</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="c1"># axes[0].imshow(np.mean(white_flash_responses, axis=1), vmax=vmax, aspect=&quot;auto&quot;)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">white_flash_responses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Average Responses to White Flashes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Relative to Stimulus (s)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Unit&quot;</span><span class="p">)</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">black_flash_responses</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">)],</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="c1"># img = axes[1].imshow(np.mean(black_flash_responses, axis=1), vmax=vmax, aspect=&quot;auto&quot;)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">black_flash_responses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Average Responses to Black Flashes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Relative to Stimulus (s)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Unit&quot;</span><span class="p">)</span>

<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Avg # Spikes&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c96ec1c56deb3a2e8849628b700211cef56aabd2f2c84638b34dd0b070c0aaf9.png" src="../_images/c96ec1c56deb3a2e8849628b700211cef56aabd2f2c84638b34dd0b070c0aaf9.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_zscore_mat</span><span class="p">(</span><span class="n">spike_matrix</span><span class="p">,</span> <span class="n">stimulus_onset_idx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inputs:</span>
<span class="sd">    The 3D spike matrix with dimensions, Unit * Trial * Time, where values are the # of spikes in each bin</span>
<span class="sd">    The index of the time dimension when we expect the stimulus to be shown</span>

<span class="sd">    Outputs:</span>
<span class="sd">    A 2D matrix with dimensions Unit * Time, where values are the trial-averaged z-scores between the pre-stimulus (baseline) and post-stimulus (evoked) time periods</span>
<span class="sd">    Z-score for each bin is defined as the (bin value - baseline mean) / baseline standard deviation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">baseline_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spike_matrix</span><span class="p">[:,:,:</span><span class="n">stimulus_onset_idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">baseline_stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">spike_matrix</span><span class="p">[:,:,:</span><span class="n">stimulus_onset_idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">mean_baseline_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">baseline_rates</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mean_baseline_stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">baseline_stds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="c1"># to prevent division by 0</span>

    <span class="n">zscores</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spike_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">mean_baseline_rate</span><span class="p">)</span> <span class="o">/</span> <span class="n">mean_baseline_stds</span>
    <span class="k">return</span> <span class="n">zscores</span>

<span class="n">white_flash_zscores</span> <span class="o">=</span> <span class="n">get_zscore_mat</span><span class="p">(</span><span class="n">white_flash_responses</span><span class="p">,</span> <span class="n">stimulus_onset_idx</span><span class="p">)</span>
<span class="n">black_flash_zscores</span> <span class="o">=</span> <span class="n">get_zscore_mat</span><span class="p">(</span><span class="n">black_flash_responses</span><span class="p">,</span> <span class="n">stimulus_onset_idx</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">white_flash_zscores</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">black_flash_zscores</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(124, 10)
(124, 10)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width_ratios&quot;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.4</span><span class="p">]})</span>
<span class="n">vmax</span><span class="o">=</span><span class="mi">2</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">white_flash_zscores</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">)],</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">white_flash_zscores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Average Z-Scores for White Flashes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Relative to Stimulus (s)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Unit&quot;</span><span class="p">)</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">black_flash_zscores</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">)],</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">black_flash_zscores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Average Z-Scores for Black Flashes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Relative to Stimulus (s)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Unit&quot;</span><span class="p">)</span>

<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Avg Z-Score&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f95a60d8e95225e4c3f7c394dbd685ca53536ace50ba35aa2b4734fdc489fbae.png" src="../_images/f95a60d8e95225e4c3f7c394dbd685ca53536ace50ba35aa2b4734fdc489fbae.png" />
</div>
</div>
</section>
<section id="selecting-most-responsive-units">
<h3>Selecting Most Responsive Units<a class="headerlink" href="#selecting-most-responsive-units" title="Link to this heading">#</a></h3>
<p>Of the units whose z-scores are shown above, the most responsive ones are selected and plotted if their maximum z-score is greater than 2. It can be seen that there are many more units with high z-scores for black flashes. This is more evidence that units are more responsive to the black flash stimulus rather than white flashes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># pick top 10 most responsive units</span>
<span class="n">white_max_zscores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">white_flash_zscores</span><span class="p">[:,</span><span class="n">stimulus_onset_idx</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">top_white_units</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">white_max_zscores</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">top_white_zscores</span> <span class="o">=</span> <span class="n">white_flash_zscores</span><span class="p">[</span><span class="n">top_white_units</span><span class="p">]</span>

<span class="n">black_max_zscores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">black_flash_zscores</span><span class="p">[:,</span><span class="n">stimulus_onset_idx</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">top_black_units</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">black_max_zscores</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">top_black_zscores</span> <span class="o">=</span> <span class="n">black_flash_zscores</span><span class="p">[</span><span class="n">top_black_units</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width_ratios&quot;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.4</span><span class="p">]})</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">top_white_zscores</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_white_units</span><span class="p">)],</span> <span class="n">aspect</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_white_zscores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Most Responsive Units to White Flashes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Relative to Stimulus (s)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Selected Unit&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">top_black_zscores</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_black_units</span><span class="p">)],</span> <span class="n">aspect</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_black_zscores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Most Responsive Units to Black Flashes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Relative to Stimulus (s)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Selected Unit&quot;</span><span class="p">)</span>

<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Avg # Spikes&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0c5998ba16e82f07987e28469d485fd934ccb481a0529c41615e6f706fb1a922.png" src="../_images/0c5998ba16e82f07987e28469d485fd934ccb481a0529c41615e6f706fb1a922.png" />
</div>
</div>
</section>
<section id="comparing-z-scores-with-glm-filters">
<h3>Comparing Z-Scores with GLM Filters<a class="headerlink" href="#comparing-z-scores-with-glm-filters" title="Link to this heading">#</a></h3>
<p>As we’ve seen, both the trained GLM filter and the response Z-scores can give an interpretation of unit responsiveness. Below, the most responsive units from estimations of the strongest Z-Scores and the best fitting GLMs are plotted and compared.</p>
<p>It can be noticed that the filters may be negative. Recall that when the spiking probability is predicted by the GLM, the trained filter is convolved over the input stimulus, and then added to by a trained constant that represents the baseline firing rate. This means a negative filter indicates that a recent stimulus will decrease the predicted firing rate and a positive filter will increase predicted firing rate, relative to the trained constant’s baseline firing rate.</p>
<p>Another thing that might be noticed is that the filters sometimes appear to be a mirror image the stimulus evoked spiking over time. This is expected. Since the filters are convolved over the stimulus with each time point being negative, the resulting shape would resemble something like the forward response shown in the spiking plots.</p>
<p>It is important to note that because we are selected units that are apparently the most responsive, these filters and spike counts will be the clearest and most meaningful examples. Many of the other filters may just represent noise or be much harder to interpret.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Units most responsive to white flashes:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">top_white_units</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Units most responsive to black flashes:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">top_black_units</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Units that produced best fitting GLMs for white flashes:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">white_best_fits</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Units that produced best fitting GLMs for black flashes:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">black_best_fits</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Units most responsive to white flashes: [  3  55  62  67  83  84  86 102]
Units most responsive to black flashes: [  3  26  42  47  51  53  55  58  60  67  70  71  77  78  79  85  88  96
 102 108 109 115 119 121]
Units that produced best fitting GLMs for white flashes: [84]
Units that produced best fitting GLMs for black flashes: [  3  13  14  20  47  51  52  53  55  58  60  62  69  70  77  79  83  85
  86  88  95  96 102 108 109 119 120 121]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">units_of_interest</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">,</span> <span class="p">(</span><span class="n">top_white_units</span><span class="p">,</span> <span class="n">top_black_units</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">white_best_fits</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">black_best_fits</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">units_of_interest</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">units_of_interest</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">unit_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">units_of_interest</span><span class="p">):</span>
    <span class="n">spikes_binned</span><span class="p">,</span> <span class="n">constant</span><span class="p">,</span> <span class="n">white_filter</span><span class="p">,</span> <span class="n">black_filter</span> <span class="o">=</span> <span class="n">training_outputs</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span>
    <span class="n">mean_white_response</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">white_flash_responses</span><span class="p">[</span><span class="n">unit_id</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mean_black_response</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">black_flash_responses</span><span class="p">[</span><span class="n">unit_id</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filter_time_bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">white_filter</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;silver&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">stimulus_onset_idx</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">mean_white_response</span><span class="p">[</span><span class="n">stimulus_onset_idx</span><span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;silver&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filter_time_bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">black_filter</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">stimulus_onset_idx</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">mean_black_response</span><span class="p">[</span><span class="n">stimulus_onset_idx</span><span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

<span class="c1"># give axis labels to first and last plots</span>
<span class="k">for</span> <span class="n">ax_x</span><span class="p">,</span> <span class="n">ax_y</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">ax_x</span><span class="p">][</span><span class="n">ax_y</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Relative to Stimulus&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax_x</span><span class="p">,</span> <span class="n">ax_y</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">ax_x</span><span class="p">][</span><span class="n">ax_y</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Unitless&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax_x</span><span class="p">,</span> <span class="n">ax_y</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">ax_x</span><span class="p">][</span><span class="n">ax_y</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;# Spikes&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Trained Filter for White Flashes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Average White Flash Response&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Trained Filter for Black Flashes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Average Black Flash Response&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Comparison of Selected Units&#39; Filters and Responses&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.999</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0f792e90138df9fb24c4f6923e570b133a424c8816cfe969fcbb97e4792526a1.png" src="../_images/0f792e90138df9fb24c4f6923e570b133a424c8816cfe969fcbb97e4792526a1.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "AllenInstitute/openscope_databook",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./higher-order"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="tca.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Tensor Decomposition of Spiking Activity Through Trials</p>
      </div>
    </a>
    <a class="right-next"
       href="behavioral_state.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Behavioral State from Trial Outcomes</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">Environment Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-file">Downloading File</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-glm">The GLM</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synthetic-data">Synthetic Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design-matrix">Design Matrix</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-on-synthetic-data">Running on Synthetic Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-model">Testing Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#real-data-allen-institute-visual-coding-dataset">Real Data - Allen Institute Visual Coding dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-spike-data">Extracting Spike Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-real-flashes-data">Extracting Real Flashes Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-filters">Generating Filters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#predict-activity">Predict Activity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#showing-predictions">Showing Predictions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-to-z-scores">Comparing to Z-Scores</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-most-responsive-units">Selecting Most Responsive Units</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-z-scores-with-glm-filters">Comparing Z-Scores with GLM Filters</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Carter Peene
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>