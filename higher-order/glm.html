
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Generalized Linear Models &#8212; OpenScope Databook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-TJPN1M4PDX"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-TJPN1M4PDX');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-TJPN1M4PDX');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'higher-order/glm';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Behavioral State from Trial Outcomes" href="behavioral_state.html" />
    <link rel="prev" title="Tensor Decomposition of Spiking Activity Through Trials" href="tca.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="OpenScope Databook - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="OpenScope Databook - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    OpenScope Databook
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../basics/background.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/download_nwb.html">Downloading an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/stream_nwb.html">Streaming an NWB File with remfile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/read_nwb.html">Reading an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/use_nwbwidgets.html">Exploring an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/get_dandiset_metadata.html">Getting Experimental Metadata from DANDI</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Visualizing NWB Files</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_2p_raw.html">Visualizing Raw 2-Photon Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_metrics.html">Visualizing Unit Quality Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_lfp_responses.html">Visualizing LFP Responses to Stimuli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_responses.html">Visualizing Neuronal Unit Responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_2p_responses.html">Visualizing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_spikes.html">Visualizing Neuronal Unit Spikes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_neuropixels_probes.html">Visualizing Neuropixels Probe Locations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_templates.html">Visualizing Stimulus Templates</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">First-Order Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../first-order/receptive_fields.html">Showing Receptive Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/optotagging.html">Identifying Optotagged Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/current_source_density.html">Current Source Density Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/classify_waveforms.html">Classifying Fast-Spiking and Regular-Spiking Neurons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/test_2p_responses.html">Statistically Testing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/test_unit_responses.html">Statistically Testing Spike Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../first-order/suite2p.html">Identifying Regions of Interest with Segmentation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Higher-Order Analysis</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="cebra_time.html">Using CEBRA-Time to Identify Latent Embeddings</a></li>
<li class="toctree-l1"><a class="reference internal" href="tca.html">Tensor Decomposition of Spiking Activity Through Trials</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Generalized Linear Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="behavioral_state.html">Behavioral State from Trial Outcomes</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Openscope Experimental Projects</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../projects/cred_assign_figures.html">Replicating OpenScope Credit Assignment project figures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects/glo.html">OpenScope’s Global/Local Oddball Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects/illusion.html">OpenScope’s Illusion Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects/dendritic_coupling.html">OpenScope’s Dendritic Coupling Dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Embargoed Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../embargoed/modality_alignment.html">Aligning Data across Modalities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/visualize_behavior.html">Visualizing Behavioral Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/test_2p_responses_embargoed.html">Statistically Testing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/cell_matching.html">Cell Matching Across Days</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Methods</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../methods/jupyter_book.html">Jupyter/Jupyter Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods/github.html">Git/Github</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods/environments.html">Managing Environments on Multiple Platforms</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../contribution.html">Contributing to the Databook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors_index.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html">FAQ</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/AllenInstitute/openscope_databook/main?urlpath=tree/docs/higher-order/glm.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://hub.dandiarchive.org/hub/user-redirect/git-pull?repo=https%3A//github.com/AllenInstitute/openscope_databook&urlpath=tree/openscope_databook/docs/higher-order/glm.ipynb&branch=main" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on JupyterHub"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="JupyterHub logo" src="../_static/images/logo_jupyterhub.svg">
  </span>
<span class="btn__text-container">JupyterHub</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/AllenInstitute/openscope_databook/blob/main/docs/higher-order/glm.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/AllenInstitute/openscope_databook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/AllenInstitute/openscope_databook/issues/new?title=Issue%20on%20page%20%2Fhigher-order/glm.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/higher-order/glm.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Generalized Linear Models</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">Environment Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-file">Downloading File</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-glm">The GLM</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synthetic-data">Synthetic Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design-matrix">Design Matrix</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-on-synthetic-data">Running on Synthetic Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-model">Testing Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#real-data-allen-institute-visual-coding-dataset">Real Data - Allen Institute Visual Coding dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-spike-data">Extracting Spike Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-real-flashes-data">Extracting Real Flashes Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-filters">Generating Filters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#predict-activity">Predict Activity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#showing-predictions">Showing Predictions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-to-z-scores">Comparing to Z-Scores</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-most-responsive-units">Selecting Most Responsive Units</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-z-scores-with-glm-filters">Comparing Z-Scores with GLM Filters</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="generalized-linear-models">
<h1>Generalized Linear Models<a class="headerlink" href="#generalized-linear-models" title="Link to this heading">#</a></h1>
<p>A <a class="reference external" href="https://en.wikipedia.org/wiki/Generalized_linear_model">Generalized Linear Model</a> (GLM), not to be confused with a <a class="reference external" href="https://en.wikipedia.org/wiki/General_linear_model">General Linear Model</a>, is a regression model that trains a filter to model single neuron activity as it relates to some other variable. For example, to predict the spike counts produced by a single neuron (Y) in response to licking events (X). The GLM model can be represented by the following equation:
<span class="math notranslate nohighlight">\(y(t) = Poiss(f(k * X_{t}))\)</span>, where <code class="docutils literal notranslate"><span class="pre">Poiss</span></code> is a poisson process and <code class="docutils literal notranslate"><span class="pre">f</span></code> is a non-linearity function, in this case <span class="math notranslate nohighlight">\(f(x) = e^x\)</span></p>
<p>To train a GLM, we start by creating a <em>design matrix</em> from the visual stimulus. The design matrix is the input, X_train, provided to the GLM for training along with known spike counts in each trial, Y_train. The GLM uses <a class="reference external" href="https://en.wikipedia.org/wiki/Maximum_likelihood_estimation">Maximum Likelihood Estimation</a> to train the filter vector that maximizes the likelihood of producing a given spike train from the inputted design matrix. To predict the spike activity of a neuron, the filter is first convolved with the stimulus vector. Next, the GLM employs a non-linearity step (exponential in this case), followed by poisson generation to generate specific spike counts as shown in the figure below.</p>
<p>This notebook demonstrates the usage of a Poisson GLM to model and reproduce the spiking activity of single neurons in response to a visual stimulus. GLMs are trained using synthetic data, as well as real data from the Allen Institute <strong>Visual Coding - Neuropixels</strong> dataset.</p>
<p>For more information on applying GLMs for predicting spiking activity, see the Pillow Lab’s <a class="reference external" href="https://github.com/pillowlab/GLMspiketraintutorial/tree/master/slides">GLM Slides</a> and Neuromatch Academy’s <a class="reference external" href="https://compneuro.neuromatch.io/tutorials/W1D3_GeneralizedLinearModels/student/W1D3_Tutorial1.html">GLM tutorial</a>.</p>
<p><img alt="glm.png" src="../_images/glm.png" /></p>
<p>Modified from Slide 6, <em><a class="reference external" href="https://pillowlab.princeton.edu/pubs/pillow_TutorialSlides_Cosyne2018.pdf">Generalized linear models for cracking the neural code</a></em>, Pillow Lab</p>
<section id="environment-setup">
<h2>Environment Setup<a class="headerlink" href="#environment-setup" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">databook_utils.dandi_utils</span> <span class="kn">import</span> <span class="n">dandi_download_open</span>
<span class="k">except</span><span class="p">:</span>
    <span class="o">!</span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/AllenInstitute/openscope_databook.git
    <span class="o">%</span><span class="k">cd</span> openscope_databook
    <span class="o">%</span><span class="k">pip</span> install -e .
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>c:\Users\carter.peene\Desktop\Projects\openscope_databook\databook_env\lib\site-packages\scipy\__init__.py:169: UserWarning: A NumPy version &gt;=1.18.5 and &lt;1.26.0 is required for this version of SciPy (detected version 1.26.4
  warnings.warn(f&quot;A NumPy version &gt;={np_minversion} and &lt;{np_maxversion}&quot;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>

<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
</section>
<section id="downloading-file">
<h2>Downloading File<a class="headerlink" href="#downloading-file" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dandiset_id</span> <span class="o">=</span> <span class="s2">&quot;000021&quot;</span>
<span class="n">dandi_filepath</span> <span class="o">=</span> <span class="s2">&quot;sub-726298249/sub-726298249_ses-754829445.nwb&quot;</span>
<span class="n">download_loc</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">io</span> <span class="o">=</span> <span class="n">dandi_download_open</span><span class="p">(</span><span class="n">dandiset_id</span><span class="p">,</span> <span class="n">dandi_filepath</span><span class="p">,</span> <span class="n">download_loc</span><span class="p">)</span>
<span class="n">nwb</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>File already exists
Opening file
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>c:\Users\carter.peene\Desktop\Projects\openscope_databook\databook_env\lib\site-packages\hdmf\utils.py:668: UserWarning: Ignoring cached namespace &#39;hdmf-common&#39; version 1.1.3 because version 1.8.0 is already loaded.
  return func(args[0], **pargs)
c:\Users\carter.peene\Desktop\Projects\openscope_databook\databook_env\lib\site-packages\hdmf\utils.py:668: UserWarning: Ignoring cached namespace &#39;core&#39; version 2.2.2 because version 2.5.0 is already loaded.
  return func(args[0], **pargs)
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-glm">
<h2>The GLM<a class="headerlink" href="#the-glm" title="Link to this heading">#</a></h2>
<p>The functions below are used in training the GLM.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">fit_lnp</span></code> takes in the <em>design_matrix</em> ~as~, <code class="docutils literal notranslate"><span class="pre">X</span></code>, produced from the stimulus and the observed spike counts, <code class="docutils literal notranslate"><span class="pre">y</span></code>. It also takes the length of the filter to train, <code class="docutils literal notranslate"><span class="pre">d</span></code>, and the regularization coefficient, <code class="docutils literal notranslate"><span class="pre">lam</span></code>,. First, the function initializes a random filter of length <code class="docutils literal notranslate"><span class="pre">d</span></code> and then uses the <code class="docutils literal notranslate"><span class="pre">neg_log_like_lnp</span></code> function to perform Maximum Likelihood Estimation to train the filter.</p>
<p><code class="docutils literal notranslate"><span class="pre">neg_log_lik_lnp</span></code> computes the negative log likelihood for a vector of filter weights <code class="docutils literal notranslate"><span class="pre">theta</span></code>, the design matrix <code class="docutils literal notranslate"><span class="pre">X</span></code>, and the observed spike counts, <code class="docutils literal notranslate"><span class="pre">y</span></code>. The <code class="docutils literal notranslate"><span class="pre">Cinv</span></code> matrix, a diagonal matrix with the regularization coefficient, is applied for regularization. It would also help to explain each function by its inputs and outputs.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">predict</span></code> function perform the inverse operation, applying a trained filter <code class="docutils literal notranslate"><span class="pre">weights</span></code> to the <em>design matrix</em> <code class="docutils literal notranslate"><span class="pre">X</span></code>, and adding a constant, yielding the spike probability over time.</p>
<p><code class="docutils literal notranslate"><span class="pre">predict_spikes</span></code> takes the spike rate prediction and runs it through Poisson generation, adding noise and producing a set of predicted spike counts. Because the poisson generation is non-deterministic, it will produce different results every time.</p>
<p>This code was adapted from <a class="reference external" href="https://github.com/pillowlab/GLMspiketraintutorial/tree/master">this code</a> from the Pillow Lab, with the regularization code from <a class="reference external" href="https://compneuro.neuromatch.io/tutorials/W1D3_GeneralizedLinearModels/student/W1D3_Tutorial1.html">this tutorial</a> from Neuromatch Academy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">neg_log_lik_lnp</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Cinv</span><span class="p">):</span>
  <span class="c1"># Compute the Poisson log likelihood</span>
  <span class="n">rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">theta</span><span class="p">)</span>
  <span class="n">log_lik</span> <span class="o">=</span> <span class="n">y</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="o">-</span> <span class="n">rate</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
  <span class="n">log_lik</span> <span class="o">-=</span> <span class="n">theta</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">Cinv</span> <span class="o">@</span> <span class="n">theta</span>

  <span class="k">return</span> <span class="o">-</span><span class="n">log_lik</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fit_lnp</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="n">filt_len</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">Imat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">filt_len</span><span class="p">)</span> <span class="c1"># identity matrix of size of filter + const</span>
  <span class="n">Imat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">Cinv</span> <span class="o">=</span> <span class="n">lam</span><span class="o">*</span><span class="n">Imat</span>

  <span class="c1"># Use a random vector of weights to start (mean 0, sd .2)</span>
  <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">.2</span><span class="p">,</span> <span class="n">filt_len</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;y:&quot;</span><span class="p">,</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="s2">&quot;X:&quot;</span><span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="s2">&quot;x0:&quot;</span><span class="p">,</span><span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

  <span class="c1"># Find parameters that minimize the negative log likelihood function</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">neg_log_lik_lnp</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Cinv</span><span class="p">))</span>

  <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">constant</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="n">weights</span> <span class="o">+</span> <span class="n">constant</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>

<span class="k">def</span> <span class="nf">predict_spikes</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">constant</span><span class="p">):</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span>
    <span class="n">spks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">rate</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">spks</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="synthetic-data">
<h2>Synthetic Data<a class="headerlink" href="#synthetic-data" title="Link to this heading">#</a></h2>
<p>The cells below prepare the synthetic data (stimulus and spiking data), and show how to train a GLM.</p>
<p><code class="docutils literal notranslate"><span class="pre">make_flashes</span></code> produces boxcar stimulus that imitate binary flashes.</p>
<p><code class="docutils literal notranslate"><span class="pre">make_spikes</span></code> utilizes the same mathematics as the GLM’s prediction and generates spikes that have a direct relationship with the brightness of the synthetic stimulus. It simply multiplies the stimulus by a given coefficient <code class="docutils literal notranslate"><span class="pre">coeff</span></code>, and adds a given constant, <code class="docutils literal notranslate"><span class="pre">baseline_rate</span></code>. It runs the resulting rate through exponentiation and then generates Poission distributed spike counts with this as the spiking probability.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_flashes</span><span class="p">(</span><span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">n_repeats</span><span class="p">):</span>
    <span class="n">flashes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">n_repeats</span><span class="p">)</span>
    <span class="n">time_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">flashes</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">time_axis</span><span class="p">,</span> <span class="n">flashes</span>

<span class="n">syn_time_axis</span><span class="p">,</span> <span class="n">syn_flashes</span> <span class="o">=</span> <span class="n">make_flashes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">20</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">syn_time_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">syn_time_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">syn_flashes</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">syn_time_axis</span><span class="p">[:</span><span class="mi">1000</span><span class="p">],</span> <span class="n">syn_flashes</span><span class="p">[:</span><span class="mi">1000</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;First 10 Seconds of Synthetic Flashes Stimulus&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;&#39;Brightness&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0 300.0
30000
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &quot;&#39;Brightness&#39;&quot;)
</pre></div>
</div>
<img alt="../_images/e3c70c9b264a805cad2cf1fb4357daf1cb2b4277fbbbaab5a927a956f405b1fb.png" src="../_images/e3c70c9b264a805cad2cf1fb4357daf1cb2b4277fbbbaab5a927a956f405b1fb.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_spikes</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">baseline_rate</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">return_exp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">weighted_stim</span> <span class="o">=</span> <span class="p">(</span><span class="n">stim</span><span class="o">*</span><span class="n">coeff</span><span class="p">)</span> <span class="o">+</span> <span class="n">baseline_rate</span>
    <span class="n">exp_stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">weighted_stim</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">exp_stim</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">exp_stim</span><span class="p">))</span>
    <span class="n">spikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">exp_stim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_exp</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spikes</span><span class="p">,</span> <span class="n">weighted_stim</span><span class="p">,</span> <span class="n">exp_stim</span>
    <span class="k">return</span> <span class="n">spikes</span>

<span class="c1"># set with parameters -2.5 and 0.5, the GLM should learn these parameters</span>
<span class="n">syn_spikes</span><span class="p">,</span> <span class="n">syn_weight</span><span class="p">,</span> <span class="n">syn_exp</span> <span class="o">=</span> <span class="n">make_spikes</span><span class="p">(</span><span class="n">syn_flashes</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">return_exp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">syn_spikes</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">syn_time_axis</span><span class="p">[:</span><span class="mi">1000</span><span class="p">],</span> <span class="n">syn_spikes</span><span class="p">[:</span><span class="mi">1000</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;First 10 seconds of Synthetic Spikes&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;# Spikes&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.1353352832366127 0.0820849986238988
30000
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;# Spikes&#39;)
</pre></div>
</div>
<img alt="../_images/f04e3067b68123fb8675420afedf54a444b1ce372d3c5e3a4851faf8f11069e7.png" src="../_images/f04e3067b68123fb8675420afedf54a444b1ce372d3c5e3a4851faf8f11069e7.png" />
</div>
</div>
</section>
<section id="design-matrix">
<h2>Design Matrix<a class="headerlink" href="#design-matrix" title="Link to this heading">#</a></h2>
<p>The GLM takes in the following <em>design matrix</em> to conduct Maximum Likelihood Estimation. The design matrix must have dimensions <code class="docutils literal notranslate"><span class="pre">time</span></code> * <code class="docutils literal notranslate"><span class="pre">d</span></code>, where time is the length of the stimulus, and d is the length of the filter to be trained. It can be seen below that it is simply slices of the <code class="docutils literal notranslate"><span class="pre">d</span></code> most recent stimulus values for each timepoint in the stimulus. Importantly, a GLM also yields a <code class="docutils literal notranslate"><span class="pre">constant</span></code> value with each filter. This constant term is the bias term that captures the spike count variance unexplained by the input variables. For this, we simply add a 1 to each row in the design matrix. The resulting column of 1s produces the bias term from the MLE.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">build_design_matrix</span></code> returns such a design_matrix from a given <code class="docutils literal notranslate"><span class="pre">stim</span></code> array and a filter length <code class="docutils literal notranslate"><span class="pre">d</span></code>. It can be seen below that the bins of the second dimension of the design matrix represent the stimulus values preceding the stimulus event, so the time axis is time prior the ‘current time’. The column of ones to product the GLM constant does not have a temporal relationship to the latest stimulus time, so its x value in the matrix undefined.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_design_mat</span><span class="p">(</span><span class="n">stim</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">include_const</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
  <span class="c1"># Create version of stimulus vector with zeros before onset</span>
  <span class="n">padded_stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">stim</span><span class="p">])</span>

  <span class="c1"># Construct a matrix where each row has the d frames of</span>
  <span class="c1"># the stimulus preceding and including timepoint t</span>
  <span class="n">T</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>  <span class="c1"># Total number of timepoints (hint: number of stimulus frames)</span>
  <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">T</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
  <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
      <span class="n">X</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">padded_stim</span><span class="p">[</span><span class="n">t</span><span class="p">:</span><span class="n">t</span> <span class="o">+</span> <span class="n">d</span><span class="p">]</span>

  <span class="k">if</span> <span class="n">include_const</span><span class="p">:</span>
    <span class="n">constant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">constant</span><span class="p">,</span> <span class="n">X</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">X</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syn_design_mat</span> <span class="o">=</span> <span class="n">build_design_mat</span><span class="p">(</span><span class="n">syn_flashes</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">syn_design_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">syn_design_mat</span><span class="p">[:</span><span class="mi">1000</span><span class="p">],</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (bins prior to current)&quot;</span><span class="p">)</span>
<span class="n">xaxis_step</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">xpositions</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">syn_design_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])[::</span><span class="n">xaxis_step</span><span class="p">]</span>
<span class="n">time_offset_axis</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">syn_design_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="p">([</span><span class="s2">&quot;und&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">time_offset_axis</span><span class="p">))[::</span><span class="n">xaxis_step</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xpositions</span><span class="p">,</span> <span class="n">xticks</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Time (bins through session)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Synthetic Stimulus Design Matrix with Constant Column&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(30000, 26)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Synthetic Stimulus Design Matrix with Constant Column&#39;)
</pre></div>
</div>
<img alt="../_images/29942e6d8cff41759137722e5d81890972a1b254f2f948b52e94c89e967da9fa.png" src="../_images/29942e6d8cff41759137722e5d81890972a1b254f2f948b52e94c89e967da9fa.png" />
</div>
</div>
</section>
<section id="running-on-synthetic-data">
<h2>Running on Synthetic Data<a class="headerlink" href="#running-on-synthetic-data" title="Link to this heading">#</a></h2>
<p>Below is an example of a trained GLM filter trained using a filter length of 25 and a regularization coefficient of <span class="math notranslate nohighlight">\(2^{10}\)</span>. During prediction, this filter would be convolved with the design matrix before undergoing the expontential non-linearity step to produce spike rate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">fit_lnp</span><span class="p">(</span><span class="n">syn_design_mat</span><span class="p">,</span> <span class="n">syn_spikes</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">10</span><span class="p">)</span>
<span class="n">constant</span><span class="p">,</span> <span class="nb">filter</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">constant</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="nb">filter</span><span class="p">),</span><span class="mi">0</span><span class="p">),</span> <span class="nb">filter</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Trained Filter for Synthetic Data&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time Bins Relative to Stimulus Event&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Unitless&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>y: (30000,) X: (30000, 26) x0: (26,)
-2.4528658961595062
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Unitless&#39;)
</pre></div>
</div>
<img alt="../_images/cfeea1b088db91c05b39e2350196aa90a570a86786315d156ad9eb3a3b1a4bb7.png" src="../_images/cfeea1b088db91c05b39e2350196aa90a570a86786315d156ad9eb3a3b1a4bb7.png" />
</div>
</div>
</section>
<section id="testing-model">
<h2>Testing Model<a class="headerlink" href="#testing-model" title="Link to this heading">#</a></h2>
<p>To get a sense of how the GLM performs on synthetic data, the function <code class="docutils literal notranslate"><span class="pre">test_synthetic_glm</span></code> is used to yield a constant and a filter of length 1. Since the synthetic spikes were produced with a constant <code class="docutils literal notranslate"><span class="pre">baseline_rate</span></code> and a coefficient <code class="docutils literal notranslate"><span class="pre">coeff</span></code>, we should expect the GLM to effectively reproduce these values in the constant and length 1 filter. The GLM performance is tested by iterating over successive values of regularization coefficient <code class="docutils literal notranslate"><span class="pre">lam</span></code> and the number of repeats of stimulus flashes, <code class="docutils literal notranslate"><span class="pre">n_repeats</span></code>, both ranging between 1 and <span class="math notranslate nohighlight">\(2^9\)</span>. The optimal values for these variables are obtained by maximixing the <a class="reference external" href="https://en.wikipedia.org/wiki/Coefficient_of_determination">Coefficient of Determination</a> <span class="math notranslate nohighlight">\(R^2\)</span>. The results below indicate that as the regularization coefficient increases, the GLM performance starts to suffer. This is because higher regularization values promote a stronger tendency for trained filter values to stay closer to 0, limiting the MLE’s ability to fit a model effectively. They also indicate that the GLM performance converges toward the real constant and coefficient values as the number of repeats of the stimulus increases because there is more data to train with.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_synthetic_glm</span><span class="p">(</span><span class="n">constant_in</span><span class="p">,</span> <span class="n">coeff_in</span><span class="p">,</span> <span class="n">flashes</span><span class="p">,</span> <span class="n">constants</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">r2s</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">filt_len</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">design_mat</span> <span class="o">=</span> <span class="n">build_design_mat</span><span class="p">(</span><span class="n">flashes</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">filt_len</span><span class="p">)</span>
    <span class="n">syn_spikes</span><span class="p">,</span> <span class="n">syn_weights</span><span class="p">,</span> <span class="n">syn_prob</span> <span class="o">=</span> <span class="n">make_spikes</span><span class="p">(</span><span class="n">flashes</span><span class="p">,</span> <span class="n">constant_in</span><span class="p">,</span> <span class="n">coeff_in</span><span class="p">,</span> <span class="n">return_exp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">fit_lnp</span><span class="p">(</span><span class="n">design_mat</span><span class="p">,</span> <span class="n">syn_spikes</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="n">lam</span><span class="p">)</span>
    <span class="n">const</span><span class="p">,</span> <span class="n">filt</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">prob_predicted</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">design_mat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">filt</span><span class="p">,</span> <span class="n">const</span><span class="p">)</span>
    <span class="n">spikes_predicted</span> <span class="o">=</span> <span class="n">predict_spikes</span><span class="p">(</span><span class="n">design_mat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">filt</span><span class="p">,</span> <span class="n">const</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">syn_spikes</span><span class="p">,</span> <span class="n">prob_predicted</span><span class="p">)</span>

    <span class="n">constants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>
    <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>
    <span class="n">r2s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">repeats_vals</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">r_coeffs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">r_constants</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">r_r2s</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">n_repeats</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span>
    <span class="n">time_axis</span><span class="p">,</span> <span class="n">syn_flashes</span> <span class="o">=</span> <span class="n">make_flashes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_repeats</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">20</span><span class="p">,</span> <span class="n">n_repeats</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">test_synthetic_glm</span><span class="p">(</span><span class="o">-</span><span class="mf">2.3</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">,</span> <span class="n">syn_flashes</span><span class="p">,</span> <span class="n">r_constants</span><span class="p">,</span> <span class="n">r_coeffs</span><span class="p">,</span> <span class="n">r_r2s</span><span class="p">)</span>
        <span class="n">repeats_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_repeats</span><span class="p">)</span>

<span class="n">lambda_vals</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">l_coeffs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">l_constants</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">l_r2s</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">time_axis</span><span class="p">,</span> <span class="n">syn_flashes</span> <span class="o">=</span> <span class="n">make_flashes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">8</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">8</span><span class="p">)</span>
<span class="n">design_mat</span> <span class="o">=</span> <span class="n">build_design_mat</span><span class="p">(</span><span class="n">syn_flashes</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">lam</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">test_synthetic_glm</span><span class="p">(</span><span class="o">-</span><span class="mf">2.3</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">,</span> <span class="n">syn_flashes</span><span class="p">,</span> <span class="n">l_constants</span><span class="p">,</span> <span class="n">l_coeffs</span><span class="p">,</span> <span class="n">l_r2s</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="n">lam</span><span class="p">)</span>
        <span class="n">lambda_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (100,) X: (100, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (200,) X: (200, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (400,) X: (400, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (800,) X: (800, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (1600,) X: (1600, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (3200,) X: (3200, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (6400,) X: (6400, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (12800,) X: (12800, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (51200,) X: (51200, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
1.0 0.10025884372280375
y: (25600,) X: (25600, 2) x0: (2,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;GLM Performance as Hyperparameters Change&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.92</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[:</span><span class="mi">6</span><span class="p">]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">repeats_vals</span><span class="p">,</span> <span class="n">r_constants</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;# Flash Repeats&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Trained Constant&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">repeats_vals</span><span class="p">,</span> <span class="n">r_coeffs</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;# Flash Repeats&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Trained Coefficient&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">repeats_vals</span><span class="p">,</span> <span class="n">r_r2s</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;# Flash Repeats&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$R^2$&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lambda_vals</span><span class="p">,</span> <span class="n">l_constants</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Regularization Lambda&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Trained Constant&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lambda_vals</span><span class="p">,</span> <span class="n">l_coeffs</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Regularization Lambda&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Trained Coefficient&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lambda_vals</span><span class="p">,</span> <span class="n">l_r2s</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Regularization Lambda&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$R^2$&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;$R^2$&#39;)
</pre></div>
</div>
<img alt="../_images/171ab4e7ac832124019c35d8f4dde2ec956f0dd899e831f467a474bac900a6f4.png" src="../_images/171ab4e7ac832124019c35d8f4dde2ec956f0dd899e831f467a474bac900a6f4.png" />
</div>
</div>
</section>
<section id="real-data-allen-institute-visual-coding-dataset">
<h2>Real Data - Allen Institute Visual Coding dataset<a class="headerlink" href="#real-data-allen-institute-visual-coding-dataset" title="Link to this heading">#</a></h2>
<section id="extracting-spike-data">
<h3>Extracting Spike Data<a class="headerlink" href="#extracting-spike-data" title="Link to this heading">#</a></h3>
<p>After examining the GLM on synthetic data to empirically evaluate hyperparameters, we test GLM performance on real data. First, desirable units are selected from the NWB File. Here, neurons are chosen from the primary visual cortex <code class="docutils literal notranslate"><span class="pre">VISp</span></code>. For convenience, the list of regions in this NWB file are displayed below. <code class="docutils literal notranslate"><span class="pre">brain_regions</span></code> can be altered to suit your preferences. Only units of “good” quality and a firing rate greater than 2 are selected. More information on unit quality metrics can be found in <a class="reference internal" href="../visualization/visualize_unit_metrics.html"><span class="std std-doc">Visualizing Unit Quality Metrics </span></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">units</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">units</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### use the electrodes table to devise a function which maps units to their brain regions</span>

<span class="c1"># select electrodes</span>
<span class="n">channel_probes</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">electrodes</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">electrodes</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">electrodes</span><span class="p">)):</span>
    <span class="n">channel_id</span> <span class="o">=</span> <span class="n">electrodes</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">electrodes</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
    <span class="n">channel_probes</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">location</span>

<span class="c1"># function aligns location information from electrodes table with channel id from the units table</span>
<span class="k">def</span> <span class="nf">get_unit_location</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">channel_probes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">peak_channel_id</span><span class="p">)]</span>

<span class="n">all_regions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_unit_location</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">units</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">all_regions</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&#39;, &#39;VPM&#39;, &#39;DG&#39;, &#39;POL&#39;, &#39;LP&#39;, &#39;PO&#39;, &#39;Eth&#39;, &#39;CA3&#39;, &#39;TH&#39;, &#39;VISp&#39;, &#39;VISam&#39;, &#39;CA1&#39;, &#39;CA2&#39;, &#39;VISrl&#39;, &#39;APN&#39;, &#39;VISpm&#39;, &#39;LGd&#39;, &#39;PoT&#39;}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### selecting units spike times</span>

<span class="n">brain_regions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;VISp&quot;</span><span class="p">]</span>

<span class="c1"># select units based if they have &#39;good&#39; quality and exists in one of the specified brain_regions</span>
<span class="n">units_spike_times</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">brain_regions</span><span class="p">:</span>
    <span class="n">location_units_spike_times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">get_unit_location</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="n">location</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">quality</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;good&quot;</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">firing_rate</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">2.0</span><span class="p">:</span>
            <span class="n">location_units_spike_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">spike_times</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">units_spike_times</span> <span class="o">+=</span> <span class="n">location_units_spike_times</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>124
</pre></div>
</div>
</div>
</div>
</section>
<section id="extracting-real-flashes-data">
<h3>Extracting Real Flashes Data<a class="headerlink" href="#extracting-real-flashes-data" title="Link to this heading">#</a></h3>
<p>Next, we retrieve the stimulus information (full-field flashes) from the dataset.
To ensure they have a regular timescale, they are interpolated. Set <code class="docutils literal notranslate"><span class="pre">bin_sz</span></code> to be the bin size used for the interpolation below. Since <code class="docutils literal notranslate"><span class="pre">bin_sz</span></code> affects the temporal resolution of spikes and stimulus, <code class="docutils literal notranslate"><span class="pre">bin_sz</span></code> might have a large impact on the runtime and the performance of the model. This is because given a filer length in seconds, the bin size determines how many weights the filter consists of. More weights might may improve the performance of the GLM but will increase the runtime.</p>
<p>The stimulus information are stored in a series of tables, one of which is the flashes presentations table. In this table, the black and white flash intervals are listed with their respective start times and stop times, where -1.0 (black) and 1.0 (white) encode the color. Between these intervals, the screen was grey. The code below extracts these flash intervals and generates the interpolated flashes array.</p>
<p>There are several types of stimulus from this experimental session, but for the purposes of this analysis only the (approx.) 300 seconds of flashes stimulus are used.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bin_sz</span> <span class="o">=</span> <span class="mf">0.050</span> <span class="c1"># important for performance of GLM, be careful! </span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flashes_table</span> <span class="o">=</span> <span class="n">nwb</span><span class="o">.</span><span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;flashes_presentations&quot;</span><span class="p">]</span>
<span class="n">flashes_table</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>start_time</th>
      <th>stop_time</th>
      <th>stimulus_name</th>
      <th>stimulus_block</th>
      <th>color</th>
      <th>mask</th>
      <th>opacity</th>
      <th>phase</th>
      <th>size</th>
      <th>units</th>
      <th>stimulus_index</th>
      <th>orientation</th>
      <th>spatial_frequency</th>
      <th>contrast</th>
      <th>tags</th>
      <th>timeseries</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1285.60087</td>
      <td>1285.851080</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>-1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3647, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1287.60256</td>
      <td>1287.852768</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>-1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3648, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1289.60423</td>
      <td>1289.854435</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>-1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3649, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1291.60589</td>
      <td>1291.856100</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>-1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3650, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1293.60761</td>
      <td>1293.857808</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3651, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1295.60925</td>
      <td>1295.859455</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>-1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3652, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1297.61096</td>
      <td>1297.861155</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3653, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1299.61265</td>
      <td>1299.862843</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3654, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1301.61429</td>
      <td>1301.864488</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3655, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
    <tr>
      <th>9</th>
      <td>1303.61592</td>
      <td>1303.866128</td>
      <td>flashes</td>
      <td>1.0</td>
      <td>-1.0</td>
      <td>None</td>
      <td>1.0</td>
      <td>[0.0, 0.0]</td>
      <td>[300.0, 300.0]</td>
      <td>deg</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>[0.0, 0.0]</td>
      <td>0.8</td>
      <td>[stimulus_time_interval]</td>
      <td>[(3656, 1, timestamps pynwb.base.TimeSeries at...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">flashes_table</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flashes_table</span><span class="o">.</span><span class="n">stop_time</span><span class="p">)</span>
<span class="n">time_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="o">//</span><span class="n">bin_sz</span><span class="p">),</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start:&quot;</span><span class="p">,</span><span class="n">start_time</span><span class="p">,</span><span class="s2">&quot;end:&quot;</span><span class="p">,</span><span class="n">end_time</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time_axis</span><span class="p">))</span>

<span class="n">white_flashes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time_axis</span><span class="p">))</span>
<span class="n">black_flashes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time_axis</span><span class="p">))</span>
<span class="n">table_idx</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time_axis</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="n">flashes_table</span><span class="o">.</span><span class="n">start_time</span><span class="p">[</span><span class="n">table_idx</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="n">flashes_table</span><span class="o">.</span><span class="n">stop_time</span><span class="p">[</span><span class="n">table_idx</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">flashes_table</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="n">table_idx</span><span class="p">])</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">white_flashes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">flashes_table</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="n">table_idx</span><span class="p">])</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">:</span>
            <span class="n">black_flashes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">elif</span> <span class="n">ts</span> <span class="o">&lt;</span> <span class="n">flashes_table</span><span class="o">.</span><span class="n">start_time</span><span class="p">[</span><span class="n">table_idx</span><span class="p">]:</span>
        <span class="k">continue</span>
    <span class="k">while</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="n">flashes_table</span><span class="o">.</span><span class="n">stop_time</span><span class="p">[</span><span class="n">table_idx</span><span class="p">]:</span>
        <span class="n">table_idx</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">,</span> <span class="n">white_flashes</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;silver&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;White Flashes from Session&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Presence of Flash&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">,</span> <span class="n">black_flashes</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Black Flashes from Session&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Presence of Flash&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start: 1285.6008699215513 end: 1584.1002475386938
5969
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Presence of Flash&#39;)
</pre></div>
</div>
<img alt="../_images/16a0736e5d200c14b4d34ba59056a63b6b7df44d6e99ec058c78902c982ddd8a.png" src="../_images/16a0736e5d200c14b4d34ba59056a63b6b7df44d6e99ec058c78902c982ddd8a.png" />
</div>
</div>
</section>
<section id="generating-filters">
<h3>Generating Filters<a class="headerlink" href="#generating-filters" title="Link to this heading">#</a></h3>
<p>As with the synthetic data above, the design matrix is generated from the stimulus flashes. The filter length is set to 250 ms. Then, we train a GLM filter for each unit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filter_duration</span> <span class="o">=</span> <span class="mf">0.250</span> <span class="c1"># we want a 200 ms window,</span>
<span class="n">filter_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">filter_duration</span> <span class="o">/</span> <span class="n">bin_sz</span><span class="p">)</span> <span class="c1"># divide by bin size to yield length of filter</span>
<span class="n">filter_time_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">filter_duration</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">filter_length</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">white_design_mat</span> <span class="o">=</span> <span class="n">build_design_mat</span><span class="p">(</span><span class="n">white_flashes</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">filter_length</span><span class="p">)</span>
<span class="n">black_design_mat</span> <span class="o">=</span> <span class="n">build_design_mat</span><span class="p">(</span><span class="n">black_flashes</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">filter_length</span><span class="p">,</span> <span class="n">include_const</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">comb_design_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">white_design_mat</span><span class="p">,</span> <span class="n">black_design_mat</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">white_design_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">black_design_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">comb_design_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># plt.imshow(comb_design_mat[:1000], extent=[-comb_design_mat.shape[1], 0, 1000, 0], aspect=&quot;auto&quot;, interpolation=&quot;none&quot;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">comb_design_mat</span><span class="p">[:</span><span class="mi">1000</span><span class="p">],</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="n">xaxis_step</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">xpositions</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">comb_design_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])[::</span><span class="n">xaxis_step</span><span class="p">]</span>
<span class="n">time_offset_axis</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">comb_design_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="p">(</span> <span class="p">[</span><span class="s2">&quot;und&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">time_offset_axis</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">time_offset_axis</span><span class="p">))[::</span><span class="n">xaxis_step</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">xpositions</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xpositions</span><span class="p">,</span> <span class="n">xticks</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (bins prior to current)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Current Time (bins through session)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Stimulus Design Matrix with Constant Column&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5969, 6)
(5969, 5)
(5969, 11)
range(0, 11)
[&#39;und&#39;, 0, -1, -2, -3, -4, 0, -1, -2, -3, -4]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Stimulus Design Matrix with Constant Column&#39;)
</pre></div>
</div>
<img alt="../_images/195322962bcb05e26a430f7ab59c466ba5ea232bf7a7dbe1f3b29f5b6e88e942.png" src="../_images/195322962bcb05e26a430f7ab59c466ba5ea232bf7a7dbe1f3b29f5b6e88e942.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">training_outputs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spike_times</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">):</span>
    <span class="c1"># bin spikes where bins line up with the interpolated flashes timestamps</span>
    <span class="n">these_spikes_binned</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">time_axis</span><span class="p">),</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span><span class="n">end_time</span><span class="p">))</span>
    <span class="c1"># try:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">fit_lnp</span><span class="p">(</span><span class="n">comb_design_mat</span><span class="p">,</span> <span class="n">these_spikes_binned</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">midpoint</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># assumes the design mat has odd length</span>
    <span class="n">const</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">white_filt</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">midpoint</span><span class="p">]</span>
    <span class="n">black_filt</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">midpoint</span><span class="p">:]</span>
    <span class="n">training_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">these_spikes_binned</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">white_filt</span><span class="p">,</span> <span class="n">black_filt</span><span class="p">))</span>
    <span class="c1"># except:</span>
    <span class="c1">#     training_outputs.append((these_spikes_binned, np.nan, [], np.nan, []))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>y: (5969,) X: (5969, 11) x0: (11,)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
y: (5969,) X: (5969, 11) x0: (11,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_cols</span><span class="o">=</span><span class="mi">5</span>

<span class="n">n_rows</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">training_outputs</span><span class="p">)</span><span class="o">/</span><span class="n">n_cols</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">n_rows</span><span class="p">))</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">axes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">training_outputs</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">continue</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">white_filt</span><span class="p">,</span> <span class="n">black_filt</span> <span class="o">=</span> <span class="n">training_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filter_time_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">white_filt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;silver&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filter_time_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">black_filt</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unit </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/bb497afad7ceeee2a12fa862a89a39d1ce48535740a0012da1dbabf79411dea1.png" src="../_images/bb497afad7ceeee2a12fa862a89a39d1ce48535740a0012da1dbabf79411dea1.png" />
</div>
</div>
</section>
<section id="predict-activity">
<h3>Predict Activity<a class="headerlink" href="#predict-activity" title="Link to this heading">#</a></h3>
<p>Finally, these trained filters can be applied to the stimulus to generate predicted spiking probability and predicted spike counts. In a real use case, one could provide some hypothetical stimulus values to predict how the units of interest may respond. Note that since the Poisson generation is non-deterministic, the predicted spikes will differ with each run. To evaluate the GLM’s performance, the <span class="math notranslate nohighlight">\(R^2\)</span> values are calculated between the observed spikes and the predicted spike probability. Note that in the <span class="math notranslate nohighlight">\(R^2\)</span> distributions below, performance is higher for predicting black flashes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prediction_outputs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">spikes_binned</span><span class="p">,</span> <span class="n">constant</span><span class="p">,</span> <span class="n">white_filter</span><span class="p">,</span> <span class="n">black_filter</span> <span class="ow">in</span> <span class="n">training_outputs</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">white_filter</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">white_predicted_rate</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">white_design_mat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">white_filter</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span>
    <span class="n">white_spikes_predicted</span> <span class="o">=</span> <span class="n">predict_spikes</span><span class="p">(</span><span class="n">white_design_mat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span> <span class="n">white_filter</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span>
    <span class="n">white_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">spikes_binned</span><span class="p">,</span> <span class="n">white_predicted_rate</span><span class="p">)</span>

    <span class="n">black_predicted_rate</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">black_design_mat</span><span class="p">,</span> <span class="n">black_filter</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span>
    <span class="n">black_spikes_predicted</span> <span class="o">=</span> <span class="n">predict_spikes</span><span class="p">(</span><span class="n">black_design_mat</span><span class="p">,</span> <span class="n">black_filter</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span>
    <span class="n">black_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">spikes_binned</span><span class="p">,</span> <span class="n">black_predicted_rate</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;white observed mean rate:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spikes_binned</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spikes_binned</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;white predicted mean rate:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">white_spikes_predicted</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">white_spikes_predicted</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;white loss:&quot;</span><span class="p">,</span><span class="n">white_r2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;black observed mean rate:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spikes_binned</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spikes_binned</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;black predicted mean rate:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">black_spikes_predicted</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">black_spikes_predicted</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;black loss:&quot;</span><span class="p">,</span><span class="n">black_r2</span><span class="p">)</span>

    <span class="n">prediction_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">white_predicted_rate</span><span class="p">,</span> <span class="n">white_spikes_predicted</span><span class="p">,</span> <span class="n">white_r2</span><span class="p">,</span> <span class="n">black_predicted_rate</span><span class="p">,</span> <span class="n">black_spikes_predicted</span><span class="p">,</span> <span class="n">black_r2</span><span class="p">])</span>

<span class="n">white_r2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">output</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">prediction_outputs</span><span class="p">])</span>
<span class="n">black_r2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">output</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">prediction_outputs</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==================&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;average white loss:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">white_r2s</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;average black loss:&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">black_r2s</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5,)
===
white observed mean rate: 0.1216284134695929
white predicted mean rate: 0.12414139721896465
white loss: 0.0003848557605634628
black observed mean rate: 0.1216284134695929
black predicted mean rate: 0.12615178421846204
black loss: 0.001142631271695116
(5,)
===
white observed mean rate: 0.10571284972357178
white predicted mean rate: 0.09917909197520523
white loss: 0.0009655134117605435
black observed mean rate: 0.10571284972357178
black predicted mean rate: 0.10990115597252471
black loss: 0.001728356291834654
(5,)
===
white observed mean rate: 1.139051767465237
white predicted mean rate: 1.1150946557212262
white loss: 0.0003733266620327136
black observed mean rate: 1.139051767465237
black predicted mean rate: 1.1305076227173732
black loss: 0.0003282388963443683
(5,)
===
white observed mean rate: 0.2186295861953426
white predicted mean rate: 0.17473613670631596
white loss: 0.017914794758393082
black observed mean rate: 0.2186295861953426
black predicted mean rate: 0.19735299045066176
black loss: 0.07174471261041437
(5,)
===
white observed mean rate: 0.1256491874685877
white predicted mean rate: 0.1306751549673312
white loss: 0.001441383684271269
black observed mean rate: 0.1256491874685877
black predicted mean rate: 0.12698944546825264
black loss: 0.0002884977893453655
(5,)
===
white observed mean rate: 0.14977383146255654
white predicted mean rate: 0.15580499246104876
white loss: 0.00022546549757263001
black observed mean rate: 0.14977383146255654
black predicted mean rate: 0.14809850896297538
black loss: 0.0018114580027280835
(5,)
===
white observed mean rate: 0.0
white predicted mean rate: 0.0
white loss: 0.0
black observed mean rate: 0.0
black predicted mean rate: 0.0
black loss: 0.0
(5,)
===
white observed mean rate: 0.007538951248115262
white predicted mean rate: 0.006533757748366561
white loss: 1.9006142389366154e-05
black observed mean rate: 0.007538951248115262
black predicted mean rate: 0.007036354498240911
black loss: 3.559772418804119e-05
(5,)
===
white observed mean rate: 0.09951415647512146
white predicted mean rate: 0.09783883397554029
white loss: 0.00012236385223118873
black observed mean rate: 0.09951415647512146
black predicted mean rate: 0.09264533422683867
black loss: 0.0012923087073902773
(5,)
===
white observed mean rate: 1.5391187803652202
white predicted mean rate: 1.5091305076227173
white loss: 0.019236522381798293
black observed mean rate: 1.5391187803652202
black predicted mean rate: 1.5299045066175239
black loss: 0.028437044982103088
(5,)
===
white observed mean rate: 0.005696096498575976
white predicted mean rate: 0.006198693248450327
white loss: 4.3188469366461923e-05
black observed mean rate: 0.005696096498575976
black predicted mean rate: 0.006533757748366561
black loss: 5.690322467244435e-05
(5,)
===
white observed mean rate: 0.19852571620036857
white predicted mean rate: 0.17691405595577148
white loss: 0.008166713996407338
black observed mean rate: 0.19852571620036857
black predicted mean rate: 0.18730105545317474
black loss: 0.03470263174848298
(5,)
===
white observed mean rate: 0.4265371083933657
white predicted mean rate: 0.4357513821410621
white loss: 0.004227823638478845
black observed mean rate: 0.4265371083933657
black predicted mean rate: 0.4354163176411459
black loss: 0.018750425963966144
(5,)
===
white observed mean rate: 0.508460378622885
white predicted mean rate: 0.4587033003853242
white loss: 0.004596792160910912
black observed mean rate: 0.508460378622885
black predicted mean rate: 0.48701625062824594
black loss: 0.05130710365270208
(5,)
===
white observed mean rate: 0.446976042888256
white predicted mean rate: 0.39939688390015077
white loss: -0.004926341979468951
black observed mean rate: 0.446976042888256
black predicted mean rate: 0.4404422851398894
black loss: 0.10049793883163627
(5,)
===
white observed mean rate: 0.37510470765622383
white predicted mean rate: 0.3479644831630089
white loss: 0.0075954763862977615
black observed mean rate: 0.37510470765622383
black predicted mean rate: 0.35081253141229685
black loss: 0.01720069024621662
(5,)
===
white observed mean rate: 0.40593064164851733
white predicted mean rate: 0.3858267716535433
white loss: -5.138561004525144e-05
black observed mean rate: 0.40593064164851733
black predicted mean rate: 0.41095660914726084
black loss: 0.006120706836012402
(5,)
===
white observed mean rate: 0.09951415647512146
white predicted mean rate: 0.10504272072373932
white loss: 0.0003909195494242734
black observed mean rate: 0.09951415647512146
black predicted mean rate: 0.09984922097503769
black loss: 0.000833804307644348
(5,)
===
white observed mean rate: 0.2888255989277936
white predicted mean rate: 0.3079242754230189
white loss: 0.0008306779386890728
black observed mean rate: 0.2888255989277936
black predicted mean rate: 0.2975372759256157
black loss: 0.0026919788712840287
(5,)
===
white observed mean rate: 0.11341933322164517
white predicted mean rate: 0.10772323672306919
white loss: 0.0007623257915119197
black observed mean rate: 0.11341933322164517
black predicted mean rate: 0.1147595912213101
black loss: 5.151284351812002e-05
(5,)
===
white observed mean rate: 1.2373931981906516
white predicted mean rate: 1.1986932484503268
white loss: 0.008035540097528271
black observed mean rate: 1.2373931981906516
black predicted mean rate: 1.2214776344446305
black loss: 0.059964131876868554
(5,)
===
white observed mean rate: 0.026972692243256827
white predicted mean rate: 0.02412464399396884
white loss: 8.655357006126518e-05
black observed mean rate: 0.026972692243256827
black predicted mean rate: 0.02948567599262858
black loss: 2.1777120000732175e-05
(5,)
===
white observed mean rate: 1.187636119953091
white predicted mean rate: 1.2209750376947563
white loss: 0.006454212935497861
black observed mean rate: 1.187636119953091
black predicted mean rate: 1.1553023957111743
black loss: 0.019201848680654443
(5,)
===
white observed mean rate: 0.0063662254984084435
white predicted mean rate: 0.00603116099849221
white loss: 2.168096114030238e-05
black observed mean rate: 0.0063662254984084435
black predicted mean rate: 0.005528564248617859
black loss: 0.00032145114995019153
(5,)
===
white observed mean rate: 0.3387502094153124
white predicted mean rate: 0.3377450159155638
white loss: 0.0023202241412338953
black observed mean rate: 0.3387502094153124
black predicted mean rate: 0.32601775841849556
black loss: 0.000562892165414608
(5,)
===
white observed mean rate: 0.0036857094990785724
white predicted mean rate: 0.0041883062489529235
white loss: 8.387515631924636e-06
black observed mean rate: 0.0036857094990785724
black predicted mean rate: 0.0038532417490366897
black loss: 3.328414390102452e-06
(5,)
===
white observed mean rate: 0.06868822248282794
white predicted mean rate: 0.05846875523538281
white loss: 0.01662013454803346
black observed mean rate: 0.06868822248282794
black predicted mean rate: 0.059306416485173395
black loss: 0.03614939033174913
(5,)
===
white observed mean rate: 0.7626068018093483
white predicted mean rate: 0.7111744010722064
white loss: 0.007194642823553643
black observed mean rate: 0.7626068018093483
black predicted mean rate: 0.7237393198190651
black loss: 0.04656633287491907
(5,)
===
white observed mean rate: 0.005528564248617859
white predicted mean rate: 0.0041883062489529235
white loss: 7.900899934554229e-05
black observed mean rate: 0.005528564248617859
black predicted mean rate: 0.0041883062489529235
black loss: 0.00025421705187356203
(5,)
===
white observed mean rate: 0.2275087954431228
white predicted mean rate: 0.24677500418830625
white loss: 0.0001157159956435283
black observed mean rate: 0.2275087954431228
black predicted mean rate: 0.2214776344446306
black loss: 0.004185549491988683
(5,)
===
white observed mean rate: 0.4357513821410621
white predicted mean rate: 0.4372591723906852
white loss: 0.005071778977732699
black observed mean rate: 0.4357513821410621
black predicted mean rate: 0.4483163008879209
black loss: 0.003937503125251651
(5,)
===
white observed mean rate: 0.029653208242586698
white predicted mean rate: 0.025297369743675656
white loss: -6.458470263126515e-05
black observed mean rate: 0.029653208242586698
black predicted mean rate: 0.03015580499246105
black loss: 0.0036879963085866274
(5,)
===
white observed mean rate: 0.009716870497570782
white predicted mean rate: 0.010219467247445133
white loss: 2.7724443172782998e-05
black observed mean rate: 0.009716870497570782
black predicted mean rate: 0.009046741497738315
black loss: 3.949292965332862e-05
(5,)
===
white observed mean rate: 0.6974367565756409
white predicted mean rate: 0.6867146925783213
white loss: 0.008859155899334503
black observed mean rate: 0.6974367565756409
black predicted mean rate: 0.6971016920757246
black loss: 0.01563537314727448
(5,)
===
white observed mean rate: 0.7331211258167197
white predicted mean rate: 0.7314458033171386
white loss: 0.0005195555527230944
black observed mean rate: 0.7331211258167197
black predicted mean rate: 0.746356173563411
black loss: 0.006908391096022037
(5,)
===
white observed mean rate: 0.8116937510470765
white predicted mean rate: 0.756408108560898
white loss: 0.03600260945017297
black observed mean rate: 0.8116937510470765
black predicted mean rate: 0.7853911878036522
black loss: 0.035600930577426415
(5,)
===
white observed mean rate: 0.37577483665605627
white predicted mean rate: 0.3955436421511141
white loss: 0.00013268940494637338
black observed mean rate: 0.37577483665605627
black predicted mean rate: 0.3776176914055956
black loss: 0.0074715387812656076
(5,)
===
white observed mean rate: 0.2663762774334059
white predicted mean rate: 0.2491204556877199
white loss: 0.003935181970439738
black observed mean rate: 0.2663762774334059
black predicted mean rate: 0.2698944546825264
black loss: 0.0010829632372421072
(5,)
===
white observed mean rate: 0.09314793097671302
white predicted mean rate: 0.08728430222817893
white loss: 0.0007904307898995988
black observed mean rate: 0.09314793097671302
black predicted mean rate: 0.08996481822750879
black loss: 0.004349018958373252
(5,)
===
white observed mean rate: 0.31864633942033843
white predicted mean rate: 0.2985424694253644
white loss: 0.0075309937623114775
black observed mean rate: 0.31864633942033843
black predicted mean rate: 0.30608142067347965
black loss: 0.014221172133073723
(5,)
===
white observed mean rate: 0.2667113419333222
white predicted mean rate: 0.2687217289328196
white loss: 0.0009270825366081148
black observed mean rate: 0.2667113419333222
black predicted mean rate: 0.26453342268386665
black loss: 0.00018613984000925843
(5,)
===
white observed mean rate: 0.21326855419668286
white predicted mean rate: 0.21209582844697605
white loss: 0.001648589341138762
black observed mean rate: 0.21326855419668286
black predicted mean rate: 0.2117607639470598
black loss: 0.007243758167569503
(5,)
===
white observed mean rate: 0.032501256491874686
white predicted mean rate: 0.02462724074384319
white loss: 0.002561330534807227
black observed mean rate: 0.032501256491874686
black predicted mean rate: 0.033338917741665273
black loss: 0.020399740112882148
(5,)
===
white observed mean rate: 0.005025967498743508
white predicted mean rate: 0.0036857094990785724
white loss: 2.2711056526625306e-05
black observed mean rate: 0.005025967498743508
black predicted mean rate: 0.005025967498743508
black loss: 0.0007943837544813759
(5,)
===
white observed mean rate: 0.00217791924945552
white predicted mean rate: 0.0023454514994136373
white loss: 1.3409419443832782e-05
black observed mean rate: 0.00217791924945552
black predicted mean rate: 0.002512983749371754
black loss: 1.6160878051341143e-05
(5,)
===
white observed mean rate: 0.27910872843022283
white predicted mean rate: 0.25950745518512314
white loss: -0.000529914615373217
black observed mean rate: 0.27910872843022283
black predicted mean rate: 0.2759256156810186
black loss: 0.038992587559676606
(5,)
===
white observed mean rate: 0.0
white predicted mean rate: 0.0
white loss: 0.0
black observed mean rate: 0.0
black predicted mean rate: 0.0
black loss: 0.0
(5,)
===
white observed mean rate: 0.33757748366560564
white predicted mean rate: 0.2581671971854582
white loss: -0.01322488577399783
black observed mean rate: 0.33757748366560564
black predicted mean rate: 0.33188138716702964
black loss: 0.2648720876232027
(5,)
===
white observed mean rate: 1.2727425029318145
white predicted mean rate: 1.3106047914223489
white loss: 0.009631569345007418
black observed mean rate: 1.2727425029318145
black predicted mean rate: 1.2970346791757412
black loss: 0.01916968966943733
(5,)
===
white observed mean rate: 0.111744010722064
white predicted mean rate: 0.11057128497235717
white loss: 0.002918175215361085
black observed mean rate: 0.111744010722064
black predicted mean rate: 0.11124141397218965
black loss: 0.006983093900948201
(5,)
===
white observed mean rate: 0.712012062321997
white predicted mean rate: 0.7259172390685207
white loss: 0.0017700841449860283
black observed mean rate: 0.712012062321997
black predicted mean rate: 0.710671804322332
black loss: 0.010483057265191276
(5,)
===
white observed mean rate: 0.4292176243926956
white predicted mean rate: 0.36555536940861116
white loss: -0.008391725020940655
black observed mean rate: 0.4292176243926956
black predicted mean rate: 0.4317306081420674
black loss: 0.1898678818697822
(5,)
===
white observed mean rate: 1.1960127324509968
white predicted mean rate: 1.1358686547160328
white loss: 0.0031397198474462096
black observed mean rate: 1.1960127324509968
black predicted mean rate: 1.1573127827106717
black loss: 0.05224583959961426
(5,)
===
white observed mean rate: 0.0909700117272575
white predicted mean rate: 0.07756743173060814
white loss: -0.0028087383514361353
black observed mean rate: 0.0909700117272575
black predicted mean rate: 0.08292846372926789
black loss: 0.07340013807624113
(5,)
===
white observed mean rate: 0.10537778522365555
white predicted mean rate: 0.10504272072373932
white loss: 0.0008422772015576063
black observed mean rate: 0.10537778522365555
black predicted mean rate: 0.11744010722063997
black loss: 0.0015322513703003304
(5,)
===
white observed mean rate: 0.38968001340258
white predicted mean rate: 0.35248785391187804
white loss: 0.01115125027323205
black observed mean rate: 0.38968001340258
black predicted mean rate: 0.36639303065840173
black loss: 0.051190539477422914
(5,)
===
white observed mean rate: 0.2412464399396884
white predicted mean rate: 0.22817892444295526
white loss: 0.011764364362394475
black observed mean rate: 0.2412464399396884
black predicted mean rate: 0.2333724241916569
black loss: 0.004697188537540864
(5,)
===
white observed mean rate: 0.022784385994303904
white predicted mean rate: 0.024292176243926957
white loss: 0.0024842780542223553
black observed mean rate: 0.022784385994303904
black predicted mean rate: 0.024459708493885072
black loss: 0.0003148531804609833
(5,)
===
white observed mean rate: 0.12280113921929972
white predicted mean rate: 0.1137543977215614
white loss: 0.0014719845870951875
black observed mean rate: 0.12280113921929972
black predicted mean rate: 0.127492042218127
black loss: 0.05863059864827347
(5,)
===
white observed mean rate: 0.11124141397218965
white predicted mean rate: 0.1048751884737812
white loss: -0.00042954036526343664
black observed mean rate: 0.11124141397218965
black predicted mean rate: 0.10236220472440945
black loss: 0.010373525742778278
(5,)
===
white observed mean rate: 0.22482827944379294
white predicted mean rate: 0.10856089797285978
white loss: -0.020726938901823866
black observed mean rate: 0.22482827944379294
black predicted mean rate: 0.22315295694421175
black loss: 0.5274035060351742
(5,)
===
white observed mean rate: 0.6138381638465404
white predicted mean rate: 0.5806667783548333
white loss: 0.0038072580684369584
black observed mean rate: 0.6138381638465404
black predicted mean rate: 0.6071368738482158
black loss: 0.017373713881999486
(5,)
===
white observed mean rate: 0.15479979896130006
white predicted mean rate: 0.1333556709666611
white loss: 0.028725004268209564
black observed mean rate: 0.15479979896130006
black predicted mean rate: 0.15479979896130006
black loss: 0.10951728595372234
(5,)
===
white observed mean rate: 0.13318813871670296
white predicted mean rate: 0.14290500921427374
white loss: 0.0032526682072163693
black observed mean rate: 0.13318813871670296
black predicted mean rate: 0.13486346121628415
black loss: 0.0014937886175524495
(5,)
===
white observed mean rate: 0.2038867481990283
white predicted mean rate: 0.19165689395208577
white loss: -6.204187620229007e-05
black observed mean rate: 0.2038867481990283
black predicted mean rate: 0.19567766795108057
black loss: 0.023569762790081272
(5,)
===
white observed mean rate: 0.3628748534092813
white predicted mean rate: 0.34762941866309266
white loss: 0.008453907890353274
black observed mean rate: 0.3628748534092813
black predicted mean rate: 0.3759423689060144
black loss: 0.015485288646573059
(5,)
===
white observed mean rate: 0.30139051767465236
white predicted mean rate: 0.29720221142569947
white loss: 0.0020440004481147023
black observed mean rate: 0.30139051767465236
black predicted mean rate: 0.2945216954263696
black loss: 0.007643609791582295
(5,)
===
white observed mean rate: 0.07388172223152957
white predicted mean rate: 0.05947394873513151
white loss: 0.002078816399431749
black observed mean rate: 0.07388172223152957
black predicted mean rate: 0.07270899648182275
black loss: 0.020099392536329197
(5,)
===
white observed mean rate: 0.042720723739319816
white predicted mean rate: 0.04221812698944547
white loss: 0.001247608731450689
black observed mean rate: 0.042720723739319816
black predicted mean rate: 0.03937007874015748
black loss: 0.00016570930324910638
(5,)
===
white observed mean rate: 0.3613670631596582
white predicted mean rate: 0.3171385491707154
white loss: -0.00048115506395451924
black observed mean rate: 0.3613670631596582
black predicted mean rate: 0.36253978890936506
black loss: 0.0624934172360434
(5,)
===
white observed mean rate: 0.26252303568436924
white predicted mean rate: 0.226336069693416
white loss: -0.0028752354273569036
black observed mean rate: 0.26252303568436924
black predicted mean rate: 0.25766460043558387
black loss: 0.06313366149045463
(5,)
===
white observed mean rate: 0.28916066342770985
white predicted mean rate: 0.25649187468587703
white loss: -0.0013935129953890346
black observed mean rate: 0.28916066342770985
black predicted mean rate: 0.30206064667448485
black loss: 0.04601990884290774
(5,)
===
white observed mean rate: 0.021109063494722736
white predicted mean rate: 0.021611660244597083
white loss: 0.00022443193826104935
black observed mean rate: 0.021109063494722736
black predicted mean rate: 0.0217791924945552
black loss: 0.0029581262714136747
(5,)
===
white observed mean rate: 0.005696096498575976
white predicted mean rate: 0.00435583849891104
white loss: -1.7132577809775285e-06
black observed mean rate: 0.005696096498575976
black predicted mean rate: 0.00435583849891104
black loss: 0.006002599274603004
(5,)
===
white observed mean rate: 0.35583849891104036
white predicted mean rate: 0.3699112079075222
white loss: 0.00030376115753361077
black observed mean rate: 0.35583849891104036
black predicted mean rate: 0.3719215949070196
black loss: 0.018020994140999225
(5,)
===
white observed mean rate: 0.10772323672306919
white predicted mean rate: 0.11107388172223152
white loss: -7.948528990775472e-06
black observed mean rate: 0.10772323672306919
black predicted mean rate: 0.1058803819735299
black loss: 0.005971262662884946
(5,)
===
white observed mean rate: 0.009549338247612666
white predicted mean rate: 0.0063662254984084435
white loss: 9.969454815017542e-07
black observed mean rate: 0.009549338247612666
black predicted mean rate: 0.011057128497235717
black loss: 0.011411343499275972
(5,)
===
white observed mean rate: 0.10738817222315296
white predicted mean rate: 0.07069860948232534
white loss: -0.008424918375303347
black observed mean rate: 0.10738817222315296
black predicted mean rate: 0.09850896297537276
black loss: 0.1783109881183832
(5,)
===
white observed mean rate: 0.0681856257329536
white predicted mean rate: 0.06667783548333055
white loss: 0.0003905672265301918
black observed mean rate: 0.0681856257329536
black predicted mean rate: 0.06651030323337243
black loss: 0.011466960374183044
(5,)
===
white observed mean rate: 1.946724744513319
white predicted mean rate: 1.8234210085441447
white loss: -0.004332975022432128
black observed mean rate: 1.946724744513319
black predicted mean rate: 1.9286312615178423
black loss: 0.1141157678572412
(5,)
===
white observed mean rate: 0.020941531244764618
white predicted mean rate: 0.01424024124643994
white loss: -0.00035844712815125135
black observed mean rate: 0.020941531244764618
black predicted mean rate: 0.02194672474451332
black loss: 0.03454725078538956
(5,)
===
white observed mean rate: 0.5979226001005193
white predicted mean rate: 0.6481822750879545
white loss: 0.022654841568600093
black observed mean rate: 0.5979226001005193
black predicted mean rate: 0.6305913888423521
black loss: 0.036152381635957354
(5,)
===
white observed mean rate: 0.25079577818730103
white predicted mean rate: 0.24174903668956274
white loss: 0.007698330119106478
black observed mean rate: 0.25079577818730103
black predicted mean rate: 0.2539788909365053
black loss: 0.02964700135342968
(5,)
===
white observed mean rate: 0.08761936672809516
white predicted mean rate: 0.051767465237058136
white loss: 0.03912637837769406
black observed mean rate: 0.08761936672809516
black predicted mean rate: 0.0851063829787234
black loss: 0.4166102472540216
(5,)
===
white observed mean rate: 0.15546992796113251
white predicted mean rate: 0.15865304071033673
white loss: 0.2407111155609396
black observed mean rate: 0.15546992796113251
black predicted mean rate: 0.10671804322332049
black loss: -0.0035440669805675284
(5,)
===
white observed mean rate: 0.13938683196515328
white predicted mean rate: 0.11643491372089128
white loss: 0.0013094431591035294
black observed mean rate: 0.13938683196515328
black predicted mean rate: 0.14189981571452503
black loss: 0.05250315602158773
(5,)
===
white observed mean rate: 0.08577651197855587
white predicted mean rate: 0.05595577148601106
white loss: -0.0029877548417240885
black observed mean rate: 0.08577651197855587
black predicted mean rate: 0.09314793097671302
black loss: 0.29527689384739564
(5,)
===
white observed mean rate: 0.38934494890266375
white predicted mean rate: 0.38448651365387837
white loss: 0.0024266874513669823
black observed mean rate: 0.38934494890266375
black predicted mean rate: 0.3972189646506953
black loss: 0.013013347947212872
(5,)
===
white observed mean rate: 0.9991623387502094
white predicted mean rate: 1.0053610319986597
white loss: 0.03741127378492459
black observed mean rate: 0.9991623387502094
black predicted mean rate: 0.9874350812531413
black loss: 0.18023503135804586
(5,)
===
white observed mean rate: 0.016753224995811694
white predicted mean rate: 0.01742335399564416
white loss: 0.0009836850948579112
black observed mean rate: 0.016753224995811694
black predicted mean rate: 0.013905176746523706
black loss: 0.00040747587957423725
(5,)
===
white observed mean rate: 1.5660914726084771
white predicted mean rate: 1.6158485508460378
white loss: 0.005582465910124235
black observed mean rate: 1.5660914726084771
black predicted mean rate: 1.5835148266041212
black loss: 0.03995618104727383
(5,)
===
white observed mean rate: 0.5719551013570112
white predicted mean rate: 0.6016083095995979
white loss: 0.004594057846040278
black observed mean rate: 0.5719551013570112
black predicted mean rate: 0.5870330038532418
black loss: 0.035707825352807476
(5,)
===
white observed mean rate: 0.4566929133858268
white predicted mean rate: 0.4779695091305076
white loss: 0.0050918069180552195
black observed mean rate: 0.4566929133858268
black predicted mean rate: 0.4476461718880885
black loss: 0.0032646702636662805
(5,)
===
white observed mean rate: 0.017088289495727927
white predicted mean rate: 0.015580499246104875
white loss: 0.0001248296272641225
black observed mean rate: 0.017088289495727927
black predicted mean rate: 0.01792595074551851
black loss: 0.0010144682472817967
(5,)
===
white observed mean rate: 0.5575473278606131
white predicted mean rate: 0.5134863461216285
white loss: -0.00025262305836726284
black observed mean rate: 0.5575473278606131
black predicted mean rate: 0.5565421343608644
black loss: 0.036823711360209344
(5,)
===
white observed mean rate: 0.5454850058636288
white predicted mean rate: 0.5181772491204557
white loss: 0.004374106465522387
black observed mean rate: 0.5454850058636288
black predicted mean rate: 0.5196850393700787
black loss: 0.05856601701113129
(5,)
===
white observed mean rate: 0.25950745518512314
white predicted mean rate: 0.2315295694421176
white loss: -0.003308145237094884
black observed mean rate: 0.25950745518512314
black predicted mean rate: 0.26051264868487184
black loss: 0.07120280809889579
(5,)
===
white observed mean rate: 0.651867984587033
white predicted mean rate: 0.6185290668453677
white loss: 0.005406319027088213
black observed mean rate: 0.651867984587033
black predicted mean rate: 0.6394705980901324
black loss: 0.01753802415413286
(5,)
===
white observed mean rate: 0.36455017590886246
white predicted mean rate: 0.3620371921594907
white loss: 0.0028421996609050426
black observed mean rate: 0.36455017590886246
black predicted mean rate: 0.36388004690903
black loss: 0.008543524468448194
(5,)
===
white observed mean rate: 0.2636957614340761
white predicted mean rate: 0.2719048416820238
white loss: 0.0050985995277705864
black observed mean rate: 0.2636957614340761
black predicted mean rate: 0.27676327693080915
black loss: 0.017924502694637634
(5,)
===
white observed mean rate: 0.07639470598090133
white predicted mean rate: 0.06466744848383314
white loss: -0.00029732480229527347
black observed mean rate: 0.07639470598090133
black predicted mean rate: 0.07572457698106885
black loss: 0.01086953925657641
(5,)
===
white observed mean rate: 0.01641816049589546
white predicted mean rate: 0.016083095995979225
white loss: 0.00027707166216528467
black observed mean rate: 0.01641816049589546
black predicted mean rate: 0.018261015245434747
black loss: 0.0024540023460853932
(5,)
===
white observed mean rate: 0.3407605964148098
white predicted mean rate: 0.20924778019768805
white loss: -0.010041781896944046
black observed mean rate: 0.3407605964148098
black predicted mean rate: 0.30708661417322836
black loss: 0.32678770933560564
(5,)
===
white observed mean rate: 0.7043055788239236
white predicted mean rate: 0.7212263360696934
white loss: 0.011774854611177554
black observed mean rate: 0.7043055788239236
black predicted mean rate: 0.7051432400737142
black loss: 0.0062701600268856295
(5,)
===
white observed mean rate: 0.04104540123973865
white predicted mean rate: 0.0435583849891104
white loss: 3.368800550318518e-05
black observed mean rate: 0.04104540123973865
black predicted mean rate: 0.0435583849891104
black loss: 0.0002301470963828045
(5,)
===
white observed mean rate: 0.06265706148433574
white predicted mean rate: 0.05511811023622047
white loss: 0.0001540281955217937
black observed mean rate: 0.06265706148433574
black predicted mean rate: 0.0623219969844195
black loss: 0.011985767458289831
(5,)
===
white observed mean rate: 0.049422013737644495
white predicted mean rate: 0.04506617523873346
white loss: 0.0004179847314443874
black observed mean rate: 0.049422013737644495
black predicted mean rate: 0.047244094488188976
black loss: 0.00019081457590730544
(5,)
===
white observed mean rate: 0.6736471770815882
white predicted mean rate: 0.6669458870832635
white loss: 0.006114066596882295
black observed mean rate: 0.6736471770815882
black predicted mean rate: 0.6788406768302898
black loss: 0.0113593327663698
(5,)
===
white observed mean rate: 0.1521192829619702
white predicted mean rate: 0.10638297872340426
white loss: -0.008313439159564062
black observed mean rate: 0.1521192829619702
black predicted mean rate: 0.13670631596582342
black loss: 0.17222716804663696
(5,)
===
white observed mean rate: 0.18210755570447312
white predicted mean rate: 0.15614005696096497
white loss: 0.0009569075296578244
black observed mean rate: 0.18210755570447312
black predicted mean rate: 0.18545820070363545
black loss: 0.10988972055739454
(5,)
===
white observed mean rate: 0.06785056123303736
white predicted mean rate: 0.06751549673312113
white loss: 0.00014871851645426037
black observed mean rate: 0.06785056123303736
black predicted mean rate: 0.06852069023286983
black loss: 9.119477722607794e-05
(5,)
===
white observed mean rate: 0.18931144245267215
white predicted mean rate: 0.19031663595242085
white loss: 0.002336439015458436
black observed mean rate: 0.18931144245267215
black predicted mean rate: 0.1888088457027978
black loss: 0.006056429744169534
(5,)
===
white observed mean rate: 0.04791422348802144
white predicted mean rate: 0.04389344948902664
white loss: 0.01064307284312449
black observed mean rate: 0.04791422348802144
black predicted mean rate: 0.04322332048919417
black loss: 0.006224700604129385
(5,)
===
white observed mean rate: 0.18261015245434747
white predicted mean rate: 0.16250628245937343
white loss: 0.006019448070720412
black observed mean rate: 0.18261015245434747
black predicted mean rate: 0.17741665270564583
black loss: 0.015814800843882648
(5,)
===
white observed mean rate: 0.061986932484503265
white predicted mean rate: 0.05696096498575976
white loss: 0.0023208331726883857
black observed mean rate: 0.061986932484503265
black predicted mean rate: 0.061651867984587036
black loss: 0.0011243557315055996
(5,)
===
white observed mean rate: 0.04573630423856592
white predicted mean rate: 0.04171553023957112
white loss: 0.00021551722693269326
black observed mean rate: 0.04573630423856592
black predicted mean rate: 0.04523370748869157
black loss: 0.04577494648963243
(5,)
===
white observed mean rate: 0.06935835148266041
white predicted mean rate: 0.0603116099849221
white loss: -0.0006439334823262755
black observed mean rate: 0.06935835148266041
black predicted mean rate: 0.07756743173060814
black loss: 0.024787389341617172
(5,)
===
white observed mean rate: 0.5577148601105713
white predicted mean rate: 0.5639135533590216
white loss: 0.0042630712051363595
black observed mean rate: 0.5577148601105713
black predicted mean rate: 0.564583682358854
black loss: 0.015539429240326474
(5,)
===
white observed mean rate: 0.02412464399396884
white predicted mean rate: 0.020941531244764618
white loss: 0.0002385248843870258
black observed mean rate: 0.02412464399396884
black predicted mean rate: 0.023622047244094488
black loss: 0.009701051002685923
(5,)
===
white observed mean rate: 0.083095995979226
white predicted mean rate: 0.05327525548668119
white loss: -0.004079966126888879
black observed mean rate: 0.083095995979226
black predicted mean rate: 0.08326352822918412
black loss: 0.13927173873291787
(5,)
===
white observed mean rate: 0.15798291171050427
white predicted mean rate: 0.13285307421678674
white loss: 0.004468800195351563
black observed mean rate: 0.15798291171050427
black predicted mean rate: 0.15848550846037862
black loss: 0.055561699234867534
(5,)
===
white observed mean rate: 0.21226336069693416
white predicted mean rate: 0.17272574970681856
white loss: -0.004248192668618644
black observed mean rate: 0.21226336069693416
black predicted mean rate: 0.2216451666945887
black loss: 0.1038738183661444
(5,)
===
white observed mean rate: 0.01474283799631429
white predicted mean rate: 0.013235047746691238
white loss: -0.00010849906870213921
black observed mean rate: 0.01474283799631429
black predicted mean rate: 0.014072708996481822
black loss: 0.015097436991760915
(5,)
===
white observed mean rate: 0.03216619199195845
white predicted mean rate: 0.026302563243424358
white loss: 0.0024342311904900216
black observed mean rate: 0.03216619199195845
black predicted mean rate: 0.034679175741330205
black loss: 0.020266324351596254
==================
average white loss: 0.0048940238188285535
average black loss: 0.04121031107719196
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">white_r2s</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;silver&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;White Flashes Prediction $R^2s$&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$R^2$&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;# Units&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">black_r2s</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Black Flashes Prediction $R^2s$&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$R^2$&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;# Units&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;# Units&#39;)
</pre></div>
</div>
<img alt="../_images/bc7de67cab2a632a732d31fc382844462e02519b2adbc8a0ec846d0c36b61a90.png" src="../_images/bc7de67cab2a632a732d31fc382844462e02519b2adbc8a0ec846d0c36b61a90.png" />
</div>
</div>
</section>
<section id="showing-predictions">
<h3>Showing Predictions<a class="headerlink" href="#showing-predictions" title="Link to this heading">#</a></h3>
<p>Here, each model is plotted trained filter and prediction outputs. For ease of interpretation and to save space, only the best performing GLMs are displayed. This is done by selecting the prediction outputs with an <span class="math notranslate nohighlight">\(R^2\)</span> higher than 0.05. Model fitting is useful if you are expecting neuronal activity to follow a certain behavior. In the case of our Poisson model, we impose a certain response formula and fit the data to it. It can be sometimes useful to compare this fit with a more open-ended selection of cells: for instance, selecting cells simply based on whether the cell fired above a certain threshold. The combination of both approaches can allow to select cells to which fitting a model yield meaningful insights. In some cases, a non-responsive cell could provide model parameters that are hard to interpret. So it is always judicious to combine approaches.</p>
<p>In the first plot below, it can be seen that there is only one White Flashes model with an <span class="math notranslate nohighlight">\(R^2\)</span> greater than 0.05, indicating that in these data, units are less reliably responsive to white flashes than black. For each unit, real observed spikes given are shown, along with the trained model’s filter. Then the predicted spike rate, which as a reminder is the trained filter convolved over the input flashes. Finally, there is the predicted spikes which are the result of running the predicted spike rate through poisson generation. Because poisson is non-determinstic, these may look different every run.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">white_best_fits</span> <span class="o">=</span> <span class="n">white_r2s</span> <span class="o">&gt;</span> <span class="mf">0.05</span>
<span class="n">white_best_training_outputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">training_outputs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)[</span><span class="n">white_best_fits</span><span class="p">]</span>
<span class="n">white_best_prediction_outputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prediction_outputs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)[</span><span class="n">white_best_fits</span><span class="p">]</span>

<span class="n">black_best_fits</span> <span class="o">=</span> <span class="n">black_r2s</span> <span class="o">&gt;</span> <span class="mf">0.05</span>
<span class="n">black_best_training_outputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">training_outputs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)[</span><span class="n">black_best_fits</span><span class="p">]</span>
<span class="n">black_best_prediction_outputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prediction_outputs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)[</span><span class="n">black_best_fits</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">white_best_training_outputs</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">n_cells</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">white_best_training_outputs</span><span class="p">)):</span>
    <span class="n">spikes_binned</span><span class="p">,</span> <span class="n">constant</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">white_best_training_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">predicted_rate</span><span class="p">,</span> <span class="n">spikes_predicted</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">white_best_prediction_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">time_range_start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time_range_end</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">spikes_binned</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filter_time_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">predicted_rate</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;indigo&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">spikes_predicted</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">spikes_binned</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">spikes_predicted</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Observed Spikes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Trained Filter&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted Spike Rate&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted Spikes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Observed Spikes (b) + Predicted Spikes (o)&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax_x</span><span class="p">,</span> <span class="n">ax_y</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">ax_x</span><span class="p">][</span><span class="n">ax_y</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time throughout Session&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax_x</span><span class="p">,</span> <span class="n">ax_y</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">ax_x</span><span class="p">][</span><span class="n">ax_y</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time relative to Stimulus Event&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Best White Flashes Models&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1dc65358de0d5fa4cf4d2dbd8bec23a0750ee80ca531fd334178550cd3729645.png" src="../_images/1dc65358de0d5fa4cf4d2dbd8bec23a0750ee80ca531fd334178550cd3729645.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">black_best_training_outputs</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">n_cells</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">black_best_training_outputs</span><span class="p">)):</span>
    <span class="n">spikes_binned</span><span class="p">,</span> <span class="n">constant</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="nb">filter</span> <span class="o">=</span> <span class="n">black_best_training_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">predicted_rate</span><span class="p">,</span> <span class="n">spikes_predicted</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">black_best_prediction_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">time_range_start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">time_range_end</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">spikes_binned</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filter_time_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">predicted_rate</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;indigo&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">spikes_predicted</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">spikes_binned</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_axis</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">spikes_predicted</span><span class="p">[</span><span class="n">time_range_start</span><span class="p">:</span><span class="n">time_range_end</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Observed Spikes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Trained Filter&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted Spike Rate&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Predicted Spikes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Observed Spikes (b) + Predicted Spikes (o)&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax_x</span><span class="p">,</span> <span class="n">ax_y</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">ax_x</span><span class="p">][</span><span class="n">ax_y</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time throughout Session&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax_x</span><span class="p">,</span> <span class="n">ax_y</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">ax_x</span><span class="p">][</span><span class="n">ax_y</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time relative to Stimulus Event&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Best Black Flashes Models&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/19ab490609bc7470a75d4dd3e19726e8b9e2b38d1f78a0d819bcdcba56747168.png" src="../_images/19ab490609bc7470a75d4dd3e19726e8b9e2b38d1f78a0d819bcdcba56747168.png" />
</div>
</div>
</section>
<section id="comparing-to-z-scores">
<h3>Comparing to Z-Scores<a class="headerlink" href="#comparing-to-z-scores" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># start and end times (relative to the stimulus at 0 seconds) that we want to examine and align spikes to</span>
<span class="n">window_start_time</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">filter_length</span> <span class="o">*</span> <span class="n">bin_sz</span><span class="p">)</span>
<span class="n">window_end_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">filter_length</span> <span class="o">*</span> <span class="n">bin_sz</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_spike_matrix</span><span class="p">(</span><span class="n">stim_times</span><span class="p">,</span> <span class="n">units_spike_times</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">):</span>
    <span class="n">time_resolution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">))</span>
    <span class="c1"># 3D spike matrix to be populated with spike counts</span>
    <span class="n">spike_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_times</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># populate 3D spike matrix for each unit for each stimulus trial by counting spikes into bins</span>
    <span class="k">for</span> <span class="n">unit_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">)):</span>
        <span class="n">spike_times</span> <span class="o">=</span> <span class="n">units_spike_times</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">stim_idx</span><span class="p">,</span> <span class="n">stim_time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stim_times</span><span class="p">):</span>
            <span class="c1"># get spike times that fall within the bin&#39;s time range relative to the stim time        </span>
            <span class="n">first_bin_time</span> <span class="o">=</span> <span class="n">stim_time</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">last_bin_time</span> <span class="o">=</span> <span class="n">stim_time</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">first_spike_in_range</span><span class="p">,</span> <span class="n">last_spike_in_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="p">[</span><span class="n">first_bin_time</span><span class="p">,</span> <span class="n">last_bin_time</span><span class="p">])</span>
            <span class="n">spike_times_in_range</span> <span class="o">=</span> <span class="n">spike_times</span><span class="p">[</span><span class="n">first_spike_in_range</span><span class="p">:</span><span class="n">last_spike_in_range</span><span class="p">]</span>

            <span class="c1"># convert spike times into relative time bin indices</span>
            <span class="n">bin_indices</span> <span class="o">=</span> <span class="p">((</span><span class="n">spike_times_in_range</span> <span class="o">-</span> <span class="p">(</span><span class="n">first_bin_time</span><span class="p">))</span> <span class="o">/</span> <span class="n">time_resolution</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            
            <span class="c1"># mark that there is a spike at these bin times for this unit on this stim trial</span>
            <span class="k">for</span> <span class="n">bin_idx</span> <span class="ow">in</span> <span class="n">bin_indices</span><span class="p">:</span>
                <span class="n">spike_matrix</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">,</span> <span class="n">stim_idx</span><span class="p">,</span> <span class="n">bin_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">spike_matrix</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">white_flash_times</span> <span class="o">=</span> <span class="n">time_axis</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">white_flashes</span><span class="p">))</span> <span class="k">if</span> <span class="n">white_flashes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">white_flashes</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]]</span>
<span class="n">black_flash_times</span> <span class="o">=</span> <span class="n">time_axis</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">black_flashes</span><span class="p">))</span> <span class="k">if</span> <span class="n">black_flashes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">black_flashes</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]]</span>

<span class="c1"># time bins used</span>
<span class="n">n_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">window_end_time</span> <span class="o">-</span> <span class="n">window_start_time</span><span class="p">)</span> <span class="o">/</span> <span class="n">bin_sz</span><span class="p">)</span>
<span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">window_start_time</span><span class="p">,</span> <span class="n">window_end_time</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># bin_edges = np.concatenate((filter_time_bins, -filter_time_bins[:-1][::-1]))</span>

<span class="c1"># calculate baseline and stimulus interval indices for use later</span>
<span class="n">stimulus_onset_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">bin_sz</span><span class="p">)</span>

<span class="n">white_flash_responses</span> <span class="o">=</span> <span class="n">get_spike_matrix</span><span class="p">(</span><span class="n">white_flash_times</span><span class="p">,</span> <span class="n">units_spike_times</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>
<span class="n">black_flash_responses</span> <span class="o">=</span> <span class="n">get_spike_matrix</span><span class="p">(</span><span class="n">black_flash_times</span><span class="p">,</span> <span class="n">units_spike_times</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>

<span class="c1"># has shape neuro * trials * time</span>
<span class="nb">print</span><span class="p">(</span><span class="n">white_flash_responses</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">black_flash_responses</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(124, 75, 10)
(124, 75, 10)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width_ratios&quot;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.4</span><span class="p">]})</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">white_flash_responses</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">)],</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="c1"># axes[0].imshow(np.mean(white_flash_responses, axis=1), vmax=vmax, aspect=&quot;auto&quot;)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">white_flash_responses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Average Responses to White Flashes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Relative to Stimulus (s)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Unit&quot;</span><span class="p">)</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">black_flash_responses</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">)],</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="c1"># img = axes[1].imshow(np.mean(black_flash_responses, axis=1), vmax=vmax, aspect=&quot;auto&quot;)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">black_flash_responses</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Average Responses to Black Flashes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Relative to Stimulus (s)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Unit&quot;</span><span class="p">)</span>

<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Avg # Spikes&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c96ec1c56deb3a2e8849628b700211cef56aabd2f2c84638b34dd0b070c0aaf9.png" src="../_images/c96ec1c56deb3a2e8849628b700211cef56aabd2f2c84638b34dd0b070c0aaf9.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_zscore_mat</span><span class="p">(</span><span class="n">spike_matrix</span><span class="p">,</span> <span class="n">stimulus_onset_idx</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inputs:</span>
<span class="sd">    The 3D spike matrix with dimensions, Unit * Trial * Time, where values are the # of spikes in each bin</span>
<span class="sd">    The index of the time dimension when we expect the stimulus to be shown</span>

<span class="sd">    Outputs:</span>
<span class="sd">    A 2D matrix with dimensions Unit * Time, where values are the trial-averaged z-scores between the pre-stimulus (baseline) and post-stimulus (evoked) time periods</span>
<span class="sd">    Z-score for each bin is defined as the (bin value - baseline mean) / baseline standard deviation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">baseline_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spike_matrix</span><span class="p">[:,:,:</span><span class="n">stimulus_onset_idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">baseline_stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">spike_matrix</span><span class="p">[:,:,:</span><span class="n">stimulus_onset_idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">mean_baseline_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">baseline_rates</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mean_baseline_stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">baseline_stds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="c1"># to prevent division by 0</span>

    <span class="n">zscores</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spike_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">mean_baseline_rate</span><span class="p">)</span> <span class="o">/</span> <span class="n">mean_baseline_stds</span>
    <span class="k">return</span> <span class="n">zscores</span>

<span class="n">white_flash_zscores</span> <span class="o">=</span> <span class="n">get_zscore_mat</span><span class="p">(</span><span class="n">white_flash_responses</span><span class="p">,</span> <span class="n">stimulus_onset_idx</span><span class="p">)</span>
<span class="n">black_flash_zscores</span> <span class="o">=</span> <span class="n">get_zscore_mat</span><span class="p">(</span><span class="n">black_flash_responses</span><span class="p">,</span> <span class="n">stimulus_onset_idx</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">white_flash_zscores</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">black_flash_zscores</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(124, 10)
(124, 10)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width_ratios&quot;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.4</span><span class="p">]})</span>
<span class="n">vmax</span><span class="o">=</span><span class="mi">2</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">white_flash_zscores</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">)],</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">white_flash_zscores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Average Z-Scores for White Flashes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Relative to Stimulus (s)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Unit&quot;</span><span class="p">)</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">black_flash_zscores</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">)],</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">black_flash_zscores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Average Z-Scores for Black Flashes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Relative to Stimulus (s)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Unit&quot;</span><span class="p">)</span>

<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Avg Z-Score&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f95a60d8e95225e4c3f7c394dbd685ca53536ace50ba35aa2b4734fdc489fbae.png" src="../_images/f95a60d8e95225e4c3f7c394dbd685ca53536ace50ba35aa2b4734fdc489fbae.png" />
</div>
</div>
</section>
<section id="selecting-most-responsive-units">
<h3>Selecting Most Responsive Units<a class="headerlink" href="#selecting-most-responsive-units" title="Link to this heading">#</a></h3>
<p>Of the units whose z-scores are shown above, the most responsive ones are selected and plotted if their maximum z-score is greater than 2. It can be seen that there are many more units with high z-scores for black flashes. This is more evidence that units are more responsive to the black flash stimulus rather than white flashes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># pick top 10 most responsive units</span>
<span class="n">white_max_zscores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">white_flash_zscores</span><span class="p">[:,</span><span class="n">stimulus_onset_idx</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">top_white_units</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">white_max_zscores</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">top_white_zscores</span> <span class="o">=</span> <span class="n">white_flash_zscores</span><span class="p">[</span><span class="n">top_white_units</span><span class="p">]</span>

<span class="n">black_max_zscores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">black_flash_zscores</span><span class="p">[:,</span><span class="n">stimulus_onset_idx</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">top_black_units</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">black_max_zscores</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">top_black_zscores</span> <span class="o">=</span> <span class="n">black_flash_zscores</span><span class="p">[</span><span class="n">top_black_units</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width_ratios&quot;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.4</span><span class="p">]})</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">top_white_zscores</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_white_units</span><span class="p">)],</span> <span class="n">aspect</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_white_zscores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Most Responsive Units to White Flashes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Relative to Stimulus (s)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Selected Unit&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">top_black_zscores</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_black_units</span><span class="p">)],</span> <span class="n">aspect</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_black_zscores</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Most Responsive Units to Black Flashes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Relative to Stimulus (s)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Selected Unit&quot;</span><span class="p">)</span>

<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Avg # Spikes&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0c5998ba16e82f07987e28469d485fd934ccb481a0529c41615e6f706fb1a922.png" src="../_images/0c5998ba16e82f07987e28469d485fd934ccb481a0529c41615e6f706fb1a922.png" />
</div>
</div>
</section>
<section id="comparing-z-scores-with-glm-filters">
<h3>Comparing Z-Scores with GLM Filters<a class="headerlink" href="#comparing-z-scores-with-glm-filters" title="Link to this heading">#</a></h3>
<p>As we’ve seen, both the trained GLM filter and the response Z-scores can give an interpretation of unit responsiveness. Below, the most responsive units from estimations of the strongest Z-Scores and the best fitting GLMs are plotted and compared.</p>
<p>It can be noticed that the filters may be negative. Recall that when the spiking probability is predicted by the GLM, the trained filter is convolved over the input stimulus, and then added to by a trained constant that represents the baseline firing rate. This means a negative filter indicates that a recent stimulus will decrease the predicted firing rate and a positive filter will increase predicted firing rate, relative to the trained constant’s baseline firing rate.</p>
<p>Another thing that might be noticed is that the filters sometimes appear to be a mirror image the stimulus evoked spiking over time. This is expected. Since the filters are convolved over the stimulus with each time point being negative, the resulting shape would resemble something like the forward response shown in the spiking plots.</p>
<p>It is important to note that because we are selected units that are apparently the most responsive, these filters and spike counts will be the clearest and most meaningful examples. Many of the other filters may just represent noise or be much harder to interpret.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Units most responsive to white flashes:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">top_white_units</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Units most responsive to black flashes:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">top_black_units</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Units that produced best fitting GLMs for white flashes:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">white_best_fits</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Units that produced best fitting GLMs for black flashes:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">black_best_fits</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Units most responsive to white flashes: [  3  55  62  67  83  84  86 102]
Units most responsive to black flashes: [  3  26  42  47  51  53  55  58  60  67  70  71  77  78  79  85  88  96
 102 108 109 115 119 121]
Units that produced best fitting GLMs for white flashes: [84]
Units that produced best fitting GLMs for black flashes: [  3  13  14  20  47  51  52  53  55  58  60  62  69  70  77  79  83  85
  86  88  95  96 102 108 109 119 120 121]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">units_of_interest</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">,</span> <span class="p">(</span><span class="n">top_white_units</span><span class="p">,</span> <span class="n">top_black_units</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">white_best_fits</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">black_best_fits</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">units_of_interest</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">units_of_interest</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">unit_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">units_of_interest</span><span class="p">):</span>
    <span class="n">spikes_binned</span><span class="p">,</span> <span class="n">constant</span><span class="p">,</span> <span class="n">white_filter</span><span class="p">,</span> <span class="n">black_filter</span> <span class="o">=</span> <span class="n">training_outputs</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span>
    <span class="n">mean_white_response</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">white_flash_responses</span><span class="p">[</span><span class="n">unit_id</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mean_black_response</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">black_flash_responses</span><span class="p">[</span><span class="n">unit_id</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filter_time_bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">white_filter</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;silver&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">stimulus_onset_idx</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">mean_white_response</span><span class="p">[</span><span class="n">stimulus_onset_idx</span><span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;silver&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">filter_time_bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">black_filter</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">stimulus_onset_idx</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">mean_black_response</span><span class="p">[</span><span class="n">stimulus_onset_idx</span><span class="p">:],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

<span class="c1"># give axis labels to first and last plots</span>
<span class="k">for</span> <span class="n">ax_x</span><span class="p">,</span> <span class="n">ax_y</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">ax_x</span><span class="p">][</span><span class="n">ax_y</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Relative to Stimulus&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax_x</span><span class="p">,</span> <span class="n">ax_y</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">ax_x</span><span class="p">][</span><span class="n">ax_y</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Unitless&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax_x</span><span class="p">,</span> <span class="n">ax_y</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">ax_x</span><span class="p">][</span><span class="n">ax_y</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;# Spikes&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Trained Filter for White Flashes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Average White Flash Response&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Trained Filter for Black Flashes&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Average Black Flash Response&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Comparison of Selected Units&#39; Filters and Responses&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.999</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/bf314a481da319f13f7d6cfdfdc72ec8f709e504fff45d5b6c08c03dfe6023b3.png" src="../_images/bf314a481da319f13f7d6cfdfdc72ec8f709e504fff45d5b6c08c03dfe6023b3.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "AllenInstitute/openscope_databook",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./higher-order"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="tca.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Tensor Decomposition of Spiking Activity Through Trials</p>
      </div>
    </a>
    <a class="right-next"
       href="behavioral_state.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Behavioral State from Trial Outcomes</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">Environment Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-file">Downloading File</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-glm">The GLM</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synthetic-data">Synthetic Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design-matrix">Design Matrix</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-on-synthetic-data">Running on Synthetic Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-model">Testing Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#real-data-allen-institute-visual-coding-dataset">Real Data - Allen Institute Visual Coding dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-spike-data">Extracting Spike Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-real-flashes-data">Extracting Real Flashes Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-filters">Generating Filters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#predict-activity">Predict Activity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#showing-predictions">Showing Predictions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-to-z-scores">Comparing to Z-Scores</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-most-responsive-units">Selecting Most Responsive Units</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-z-scores-with-glm-filters">Comparing Z-Scores with GLM Filters</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Carter Peene
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>