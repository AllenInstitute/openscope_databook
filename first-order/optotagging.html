
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Identifying Optotagged Units &#8212; OpenScope Databook</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-TJPN1M4PDX"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-TJPN1M4PDX');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-TJPN1M4PDX');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'first-order/optotagging';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Current Source Density Analysis" href="current_source_density.html" />
    <link rel="prev" title="Showing Receptive Fields" href="receptive_fields.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="OpenScope Databook - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="OpenScope Databook - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    OpenScope Databook
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../basics/background.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/download_nwb.html">Downloading an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/stream_nwb.html">Streaming an NWB File with remfile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/read_nwb.html">Reading an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/use_nwbwidgets.html">Exploring an NWB File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/get_dandiset_metadata.html">Getting Experimental Metadata from DANDI</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Visualizing NWB Files</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_2p_raw.html">Visualizing Raw 2-Photon Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_neuropixel_probes.html">Visualizing Neuropixel Probe Locations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_metrics.html">Visualizing Unit Quality Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_lfp_responses.html">Visualizing LFP Responses to Stimuli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_responses.html">Visualizing Neuronal Unit Responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_2p_responses.html">Visualizing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualize_unit_spikes.html">Visualizing Neuronal Unit Spikes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">First-Order Analysis</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="receptive_fields.html">Showing Receptive Fields</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Identifying Optotagged Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="current_source_density.html">Current Source Density Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="classify_waveforms.html">Classifying Fast-Spiking and Regular-Spiking Neurons</a></li>
<li class="toctree-l1"><a class="reference internal" href="test_2p_responses.html">Statistically Testing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="suite2p.html">Identifying Regions of Interest with Segmentation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Higher-Order Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../higher-order/cebra_time.html">Using CEBRA-Time to Identify Latent Embeddings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../higher-order/tca.html">Tensor Decomposition of Spiking Activity Through Trials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../higher-order/behavioral_state.html">Behavioral state from trial outcomes</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Openscope Experimental Projects</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../projects/cred_assign_figures.html">Replicating OpenScope Credit Assignment project figures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects/glo.html">OpenScope’s Global/Local Oddball Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects/illusion.html">OpenScope’s Illusion Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../projects/dendritic_coupling.html">OpenScope’s Dendritic Coupling Dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Embargoed Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../embargoed/modality_alignment.html">Aligning Data across Modalities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/visualize_behavior.html">Visualizing Behavioral Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/test_2p_responses_embargoed.html">Statistically Testing 2P Responses to Stimulus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embargoed/cell_matching.html">Cell Matching Across Days</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Methods</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../methods/jupyter_book.html">Jupyter/Jupyter Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods/github.html">Git/Github</a></li>
<li class="toctree-l1"><a class="reference internal" href="../methods/environments.html">Managing Environments on Multiple Platforms</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../contribution.html">Contributing to the Databook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors_index.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html">FAQ</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/AllenInstitute/openscope_databook/main?urlpath=tree/docs/first-order/optotagging.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://hub.dandiarchive.org/hub/user-redirect/git-pull?repo=https%3A//github.com/AllenInstitute/openscope_databook&urlpath=tree/openscope_databook/docs/first-order/optotagging.ipynb&branch=main" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onJupyterHub"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_jupyterhub.svg">
  </span>
<span class="btn__text-container">JupyterHub</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/AllenInstitute/openscope_databook/blob/main/docs/first-order/optotagging.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/AllenInstitute/openscope_databook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/AllenInstitute/openscope_databook/issues/new?title=Issue%20on%20page%20%2Ffirst-order/optotagging.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/first-order/optotagging.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Identifying Optotagged Units</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">Environment Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-ecephys-file">Downloading Ecephys File</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-optogenetic-stimulus-data-and-units-data">Extracting Optogenetic Stimulus Data and Units Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-units-and-stimuli">Selecting Units and Stimuli</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-unit-responses">Plotting Unit Responses</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-spike-counts">Plotting Spike Counts</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Identifying Optotagged Units</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#responsive-unit-spike-counts">Responsive Unit Spike Counts</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculating-unit-optotagging-metrics">Calculating Unit Optotagging Metrics</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="identifying-optotagged-units">
<h1>Identifying Optotagged Units<a class="headerlink" href="#identifying-optotagged-units" title="Link to this heading">#</a></h1>
<p>In some transgenic mice, particular types of neurons express a trait whereby they will fire in response to direct laser stimulation. This is stored in the <code class="docutils literal notranslate"><span class="pre">optogenetic_stimulation</span></code> table of our NWB files. Identifying these cells is called <em>Optotagging</em>. Optotagging makes it possible to link the in vivo spike recordings of neuronal units to genetically defined cell classes. Doing this analysis with the optogenetic stimulus information is relatively similar to the analysis in <a class="reference internal" href="../visualization/visualize_unit_responses.html"><span class="std std-doc">Visualizing Neuronal Unit Responses</span></a>. To do this, we take all the relevant stimulation times from the stimulus table and identify which neuronal units fire within a predetermined window of time following the stimulus times. Neurons that spike more frequently and consistently after stimulus are likely to be optotagged.</p>
<section id="environment-setup">
<h2>Environment Setup<a class="headerlink" href="#environment-setup" title="Link to this heading">#</a></h2>
<p>⚠️<strong>Note: If running on a new environment, run this cell once and then restart the kernel</strong>⚠️</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">databook_utils.dandi_utils</span> <span class="kn">import</span> <span class="n">dandi_download_open</span>
<span class="k">except</span><span class="p">:</span>
    <span class="o">!</span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/AllenInstitute/openscope_databook.git
    <span class="o">%</span><span class="k">cd</span> openscope_databook
    <span class="o">%</span><span class="k">pip</span> install -e .
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">isclose</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">mannwhitneyu</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">median_abs_deviation</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">kstest</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
</section>
<section id="downloading-ecephys-file">
<h2>Downloading Ecephys File<a class="headerlink" href="#downloading-ecephys-file" title="Link to this heading">#</a></h2>
<p>The example file we use is from the Allen Institute’s <strong>Visual Coding - Neuropixels</strong> dataset. To specify your own file to use, set <code class="docutils literal notranslate"><span class="pre">dandiset_id</span></code> and <code class="docutils literal notranslate"><span class="pre">dandi_filepath</span></code> to be the respective dandiset id and dandi filepath of the file you’re interested in. When accessing an embargoed dataset, set <code class="docutils literal notranslate"><span class="pre">dandi_api_key</span></code> to be your DANDI API key. If you want to stream a file instead of downloading it, change <code class="docutils literal notranslate"><span class="pre">dandi_download_open</span></code> to <code class="docutils literal notranslate"><span class="pre">dandi_stream_open</span></code>. Checkout <a class="reference internal" href="../basics/stream_nwb.html"><span class="std std-doc">Streaming an NWB File with remfile</span></a> for more information on this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dandiset_id</span> <span class="o">=</span> <span class="s2">&quot;000022&quot;</span>
<span class="n">sst_dandi_filepath</span> <span class="o">=</span> <span class="s2">&quot;sub-774672354/sub-774672354_ses-794812542.nwb&quot;</span>
<span class="n">wt_dandi_filepath</span> <span class="o">=</span> <span class="s2">&quot;sub-753795604/sub-753795604_ses-767871931.nwb&quot;</span>
<span class="n">download_loc</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>
<span class="n">dandi_api_key</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This can sometimes take a while depending on the size of the file</span>
<span class="n">sst_io</span> <span class="o">=</span> <span class="n">dandi_download_open</span><span class="p">(</span><span class="n">dandiset_id</span><span class="p">,</span> <span class="n">sst_dandi_filepath</span><span class="p">,</span> <span class="n">download_loc</span><span class="p">,</span> <span class="n">dandi_api_key</span><span class="o">=</span><span class="n">dandi_api_key</span><span class="p">)</span>
<span class="n">sst_nwb</span> <span class="o">=</span> <span class="n">sst_io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">wt_io</span> <span class="o">=</span> <span class="n">dandi_download_open</span><span class="p">(</span><span class="n">dandiset_id</span><span class="p">,</span> <span class="n">wt_dandi_filepath</span><span class="p">,</span> <span class="n">download_loc</span><span class="p">,</span> <span class="n">dandi_api_key</span><span class="o">=</span><span class="n">dandi_api_key</span><span class="p">)</span>
<span class="n">wt_nwb</span> <span class="o">=</span> <span class="n">wt_io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>File already exists
Opening file
File already exists
Opening file
</pre></div>
</div>
</div>
</div>
</section>
<section id="extracting-optogenetic-stimulus-data-and-units-data">
<h2>Extracting Optogenetic Stimulus Data and Units Data<a class="headerlink" href="#extracting-optogenetic-stimulus-data-and-units-data" title="Link to this heading">#</a></h2>
<p>The two components needed for this analysis are the <code class="docutils literal notranslate"><span class="pre">optogenetic_stimulation</span></code> table and the <code class="docutils literal notranslate"><span class="pre">Units</span></code> table. The optogenetic stimulus table contains the intervals where lasers are fired at the brain. The primary property we will use from this is <code class="docutils literal notranslate"><span class="pre">start_time</span></code> which contains the times that stimulus is presented. From the <code class="docutils literal notranslate"><span class="pre">Units</span></code> table, we will extract the <code class="docutils literal notranslate"><span class="pre">spike_times</span></code> which will be aligned relative to a predefined window of time around each stimulus time to determine if it occurred in response to the stimulus. These tables are retrieved and printed below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wt_stim_table</span> <span class="o">=</span> <span class="n">wt_nwb</span><span class="o">.</span><span class="n">processing</span><span class="p">[</span><span class="s2">&quot;optotagging&quot;</span><span class="p">][</span><span class="s2">&quot;optogenetic_stimulation&quot;</span><span class="p">]</span>
<span class="n">sst_stim_table</span> <span class="o">=</span> <span class="n">sst_nwb</span><span class="o">.</span><span class="n">processing</span><span class="p">[</span><span class="s2">&quot;optotagging&quot;</span><span class="p">][</span><span class="s2">&quot;optogenetic_stimulation&quot;</span><span class="p">]</span>
<span class="n">sst_stim_table</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>start_time</th>
      <th>condition</th>
      <th>level</th>
      <th>stop_time</th>
      <th>stimulus_name</th>
      <th>duration</th>
      <th>tags</th>
      <th>timeseries</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>9209.13926</td>
      <td>half-period of a cosine wave</td>
      <td>1.7</td>
      <td>9210.13926</td>
      <td>raised_cosine</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(0, 1, optotagging pynwb.base.TimeSeries at 0...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9211.09935</td>
      <td>a single square pulse</td>
      <td>1.3</td>
      <td>9211.10435</td>
      <td>pulse</td>
      <td>0.005</td>
      <td>[optical_stimulation]</td>
      <td>[(1, 1, optotagging pynwb.base.TimeSeries at 0...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9212.95940</td>
      <td>a single square pulse</td>
      <td>1.7</td>
      <td>9212.96940</td>
      <td>pulse</td>
      <td>0.010</td>
      <td>[optical_stimulation]</td>
      <td>[(2, 1, optotagging pynwb.base.TimeSeries at 0...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9214.66951</td>
      <td>a single square pulse</td>
      <td>1.7</td>
      <td>9214.67951</td>
      <td>pulse</td>
      <td>0.010</td>
      <td>[optical_stimulation]</td>
      <td>[(3, 1, optotagging pynwb.base.TimeSeries at 0...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>9216.74957</td>
      <td>half-period of a cosine wave</td>
      <td>1.7</td>
      <td>9217.74957</td>
      <td>raised_cosine</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(4, 1, optotagging pynwb.base.TimeSeries at 0...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>9218.79964</td>
      <td>a single square pulse</td>
      <td>1.3</td>
      <td>9218.80464</td>
      <td>pulse</td>
      <td>0.005</td>
      <td>[optical_stimulation]</td>
      <td>[(5, 1, optotagging pynwb.base.TimeSeries at 0...</td>
    </tr>
    <tr>
      <th>6</th>
      <td>9220.54970</td>
      <td>half-period of a cosine wave</td>
      <td>1.3</td>
      <td>9221.54970</td>
      <td>raised_cosine</td>
      <td>1.000</td>
      <td>[optical_stimulation]</td>
      <td>[(6, 1, optotagging pynwb.base.TimeSeries at 0...</td>
    </tr>
    <tr>
      <th>7</th>
      <td>9222.65981</td>
      <td>a single square pulse</td>
      <td>2.0</td>
      <td>9222.66481</td>
      <td>pulse</td>
      <td>0.005</td>
      <td>[optical_stimulation]</td>
      <td>[(7, 1, optotagging pynwb.base.TimeSeries at 0...</td>
    </tr>
    <tr>
      <th>8</th>
      <td>9224.59986</td>
      <td>a single square pulse</td>
      <td>1.7</td>
      <td>9224.60486</td>
      <td>pulse</td>
      <td>0.005</td>
      <td>[optical_stimulation]</td>
      <td>[(8, 1, optotagging pynwb.base.TimeSeries at 0...</td>
    </tr>
    <tr>
      <th>9</th>
      <td>9226.68999</td>
      <td>a single square pulse</td>
      <td>1.7</td>
      <td>9226.69499</td>
      <td>pulse</td>
      <td>0.005</td>
      <td>[optical_stimulation]</td>
      <td>[(9, 1, optotagging pynwb.base.TimeSeries at 0...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="n">sst_stim_table</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{0.0049999999991996455, 0.01000000000021828, 1.0}
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wt_units_table</span> <span class="o">=</span> <span class="n">wt_nwb</span><span class="o">.</span><span class="n">units</span>
<span class="n">sst_units_table</span> <span class="o">=</span> <span class="n">sst_nwb</span><span class="o">.</span><span class="n">units</span>
<span class="n">sst_units_table</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PT_ratio</th>
      <th>spread</th>
      <th>presence_ratio</th>
      <th>recovery_slope</th>
      <th>silhouette_score</th>
      <th>waveform_halfwidth</th>
      <th>cluster_id</th>
      <th>firing_rate</th>
      <th>amplitude_cutoff</th>
      <th>waveform_duration</th>
      <th>...</th>
      <th>max_drift</th>
      <th>cumulative_drift</th>
      <th>local_index</th>
      <th>velocity_below</th>
      <th>amplitude</th>
      <th>nn_hit_rate</th>
      <th>isi_violations</th>
      <th>spike_times</th>
      <th>spike_amplitudes</th>
      <th>waveform_mean</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>951082751</th>
      <td>0.419765</td>
      <td>40.0</td>
      <td>0.99</td>
      <td>-0.122291</td>
      <td>NaN</td>
      <td>0.137353</td>
      <td>0</td>
      <td>7.104418</td>
      <td>0.237403</td>
      <td>0.206030</td>
      <td>...</td>
      <td>14.23</td>
      <td>330.92</td>
      <td>0</td>
      <td>NaN</td>
      <td>71.376630</td>
      <td>0.990667</td>
      <td>0.308011</td>
      <td>[4.404383589226281, 8.67118909163238, 11.03942...</td>
      <td>[0.00010935638773041407, 0.0001053127062613349...</td>
      <td>[[0.0, -2.834130000000002, -7.155524999999987,...</td>
    </tr>
    <tr>
      <th>951083991</th>
      <td>0.535828</td>
      <td>60.0</td>
      <td>0.99</td>
      <td>-0.074917</td>
      <td>0.047790</td>
      <td>0.109883</td>
      <td>435</td>
      <td>0.278519</td>
      <td>0.130559</td>
      <td>0.206030</td>
      <td>...</td>
      <td>32.94</td>
      <td>669.23</td>
      <td>417</td>
      <td>0.000000</td>
      <td>91.741455</td>
      <td>0.453333</td>
      <td>0.000000</td>
      <td>[8.196121812326329, 21.342438765612467, 23.426...</td>
      <td>[8.26202146584441e-05, 7.495588582432538e-05, ...</td>
      <td>[[0.0, -4.334850000000012, -0.9492600000000104...</td>
    </tr>
    <tr>
      <th>951082759</th>
      <td>0.853006</td>
      <td>50.0</td>
      <td>0.99</td>
      <td>-0.130682</td>
      <td>0.221266</td>
      <td>0.082412</td>
      <td>3</td>
      <td>8.925235</td>
      <td>0.001414</td>
      <td>0.151089</td>
      <td>...</td>
      <td>41.73</td>
      <td>376.08</td>
      <td>3</td>
      <td>0.000000</td>
      <td>107.288220</td>
      <td>0.999333</td>
      <td>0.008631</td>
      <td>[4.6698505982350795, 4.698917302385716, 4.7766...</td>
      <td>[0.00013007537754279887, 0.0001180359600428186...</td>
      <td>[[0.0, -1.106819999999991, -4.045664999999994,...</td>
    </tr>
    <tr>
      <th>951082767</th>
      <td>0.348855</td>
      <td>40.0</td>
      <td>0.99</td>
      <td>-0.120575</td>
      <td>0.179655</td>
      <td>0.068677</td>
      <td>6</td>
      <td>15.335853</td>
      <td>0.053171</td>
      <td>0.109883</td>
      <td>...</td>
      <td>23.85</td>
      <td>367.74</td>
      <td>6</td>
      <td>0.000000</td>
      <td>107.460210</td>
      <td>0.998667</td>
      <td>0.126358</td>
      <td>[4.6178505311766, 5.357818152094017, 5.5837184...</td>
      <td>[8.749199442943392e-05, 8.611238834643928e-05,...</td>
      <td>[[0.0, 1.6528199999999984, -1.7840550000000244...</td>
    </tr>
    <tr>
      <th>951082786</th>
      <td>0.579262</td>
      <td>60.0</td>
      <td>0.99</td>
      <td>-0.169156</td>
      <td>0.160511</td>
      <td>0.164824</td>
      <td>13</td>
      <td>1.111425</td>
      <td>0.002400</td>
      <td>0.274707</td>
      <td>...</td>
      <td>25.71</td>
      <td>134.04</td>
      <td>13</td>
      <td>-0.206030</td>
      <td>164.961225</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>[5.93865223446196, 9.150423042978373, 17.33643...</td>
      <td>[0.0001752243457523341, 0.00017500487733309024...</td>
      <td>[[0.0, -3.826485000000007, -1.3634400000000007...</td>
    </tr>
    <tr>
      <th>951082795</th>
      <td>0.303918</td>
      <td>60.0</td>
      <td>0.99</td>
      <td>-0.053188</td>
      <td>0.179032</td>
      <td>0.137353</td>
      <td>16</td>
      <td>11.282504</td>
      <td>0.002560</td>
      <td>0.315913</td>
      <td>...</td>
      <td>17.86</td>
      <td>101.38</td>
      <td>16</td>
      <td>-0.961474</td>
      <td>84.012630</td>
      <td>1.000000</td>
      <td>0.009002</td>
      <td>[3.84931620675334, 3.861782889496847, 3.895916...</td>
      <td>[8.129339295037826e-05, 9.441664431033754e-05,...</td>
      <td>[[0.0, 1.0198500000000168, 2.013375000000001, ...</td>
    </tr>
    <tr>
      <th>951082801</th>
      <td>0.553492</td>
      <td>80.0</td>
      <td>0.99</td>
      <td>-0.047044</td>
      <td>0.241507</td>
      <td>0.329648</td>
      <td>18</td>
      <td>0.282289</td>
      <td>0.161206</td>
      <td>0.384590</td>
      <td>...</td>
      <td>20.87</td>
      <td>272.07</td>
      <td>18</td>
      <td>-0.392438</td>
      <td>65.208390</td>
      <td>0.940171</td>
      <td>0.479336</td>
      <td>[14.247296282493597, 36.373158148994705, 37.61...</td>
      <td>[0.00010133442324299622, 8.54276743967337e-05,...</td>
      <td>[[0.0, -0.41125499999998905, -2.76431999999999...</td>
    </tr>
    <tr>
      <th>951082810</th>
      <td>0.614285</td>
      <td>50.0</td>
      <td>0.99</td>
      <td>-0.074530</td>
      <td>0.082241</td>
      <td>0.123618</td>
      <td>21</td>
      <td>5.301027</td>
      <td>0.468892</td>
      <td>0.247236</td>
      <td>...</td>
      <td>19.15</td>
      <td>180.21</td>
      <td>21</td>
      <td>-0.686767</td>
      <td>68.146260</td>
      <td>0.958667</td>
      <td>0.086994</td>
      <td>[3.8538828793091167, 4.094716523217777, 5.0348...</td>
      <td>[0.00011609751977622408, 0.0001022201410941623...</td>
      <td>[[0.0, 0.8874450000000262, 0.13923000000000307...</td>
    </tr>
    <tr>
      <th>951083999</th>
      <td>0.812881</td>
      <td>50.0</td>
      <td>0.99</td>
      <td>-0.089071</td>
      <td>0.045504</td>
      <td>0.192295</td>
      <td>437</td>
      <td>4.835504</td>
      <td>0.035226</td>
      <td>0.288442</td>
      <td>...</td>
      <td>19.72</td>
      <td>273.67</td>
      <td>419</td>
      <td>-0.686767</td>
      <td>85.016100</td>
      <td>0.852000</td>
      <td>0.148657</td>
      <td>[3.726249381381607, 3.982783045536769, 4.14044...</td>
      <td>[0.00016281725046406152, 0.0001520994002522755...</td>
      <td>[[0.0, 2.6876850000000037, 1.1136450000000053,...</td>
    </tr>
    <tr>
      <th>951082825</th>
      <td>0.994978</td>
      <td>30.0</td>
      <td>0.98</td>
      <td>-0.021974</td>
      <td>0.043475</td>
      <td>0.178559</td>
      <td>27</td>
      <td>3.632870</td>
      <td>0.006030</td>
      <td>0.315913</td>
      <td>...</td>
      <td>13.90</td>
      <td>176.07</td>
      <td>27</td>
      <td>2.060302</td>
      <td>176.386470</td>
      <td>0.781032</td>
      <td>0.040519</td>
      <td>[178.53787481573838, 287.80881572984646, 288.6...</td>
      <td>[6.999480738843559e-05, 0.00010817239921115223...</td>
      <td>[[0.0, -1.2353249999999978, -0.674895000000001...</td>
    </tr>
  </tbody>
</table>
<p>10 rows × 29 columns</p>
</div></div></div>
</div>
</section>
<section id="selecting-units-and-stimuli">
<h2>Selecting Units and Stimuli<a class="headerlink" href="#selecting-units-and-stimuli" title="Link to this heading">#</a></h2>
<p>Here subsets of the data can be selected for analysis. The important properties of the stimulus table shown above are, <code class="docutils literal notranslate"><span class="pre">condition</span></code> (type of laser pulse presented), the voltage <code class="docutils literal notranslate"><span class="pre">level</span></code>, and the <code class="docutils literal notranslate"><span class="pre">duration</span></code>. Below, you can define <code class="docutils literal notranslate"><span class="pre">stim_select</span></code> to select individual rows of the table based on these properties.</p>
<p>The same can be done for the units table by defining the function <code class="docutils literal notranslate"><span class="pre">unit_select</span></code>. For information on the properties of the <code class="docutils literal notranslate"><span class="pre">Units</span></code> table, see <a class="reference internal" href="../visualization/visualize_unit_metrics.html"><span class="std std-doc">Visualizing Unit Quality Metrics</span></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stim_duration</span> <span class="o">=</span> <span class="mf">0.01</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_stim_times</span><span class="p">(</span><span class="n">stim_table</span><span class="p">):</span>
    <span class="n">stim_select</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">isclose</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">duration</span><span class="p">),</span> <span class="n">stim_duration</span><span class="p">)</span>
    <span class="c1"># stim_select = lambda row: True</span>
    <span class="n">stim_times</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">stim_table</span> <span class="k">if</span> <span class="n">stim_select</span><span class="p">(</span><span class="n">row</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">stim_times</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wt_stim_times</span> <span class="o">=</span> <span class="n">get_stim_times</span><span class="p">(</span><span class="n">wt_stim_table</span><span class="p">)</span>
<span class="n">sst_stim_times</span> <span class="o">=</span> <span class="n">get_stim_times</span><span class="p">(</span><span class="n">sst_stim_table</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selected stim times from Wildtype file:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wt_stim_times</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selected stim times from SST file:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sst_stim_times</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Selected stim times from Wildtype file: 45
Selected stim times from SST file: 75
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_spike_times</span><span class="p">(</span><span class="n">units_table</span><span class="p">):</span>
    <span class="c1"># unit_select = lambda row: float(row.firing_rate) &gt; 4</span>
    <span class="c1"># unit_select = lambda row: True</span>
    <span class="c1"># units_spike_times = [row.spike_times.iloc[0] for row in units_table if unit_select(row)]</span>
    <span class="n">units_spike_times</span> <span class="o">=</span> <span class="n">units_table</span><span class="p">[</span><span class="s2">&quot;spike_times&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">units_spike_times</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wt_spike_times</span> <span class="o">=</span> <span class="n">get_spike_times</span><span class="p">(</span><span class="n">wt_units_table</span><span class="p">)</span>
<span class="n">sst_spike_times</span> <span class="o">=</span> <span class="n">get_spike_times</span><span class="p">(</span><span class="n">sst_units_table</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# Neurons from Wildtype file:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wt_spike_times</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# Neurons from SST file:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sst_spike_times</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span># Neurons from Wildtype file: 2685
# Neurons from SST file: 2688
</pre></div>
</div>
</div>
</div>
</section>
<section id="plotting-unit-responses">
<h2>Plotting Unit Responses<a class="headerlink" href="#plotting-unit-responses" title="Link to this heading">#</a></h2>
<p>Here, the spike times of the selected units are used along with the selected stimulus times. In this example, the spike times are aligned to a window from -0.01 to 0.025 seconds around the stimulus start times and counted into bins. The result is a 2D array of spike counts over the time window for each unit. The 3D <code class="docutils literal notranslate"><span class="pre">spike_matrix</span></code> and 2D <code class="docutils literal notranslate"><span class="pre">spike_counts</span></code> arrays will be used for further analysis later on.  Also below is the function <code class="docutils literal notranslate"><span class="pre">show_counts</span></code>. This will be used with <code class="docutils literal notranslate"><span class="pre">spike_counts</span></code> and variations of this array to display various plots. You may change the variables in the next cell to suit your analysis</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># period to exclude from analysis before and after the stimulus event </span>
<span class="n">censor_period</span> <span class="o">=</span> <span class="mf">0.002</span>

<span class="c1"># bin size for counting spikes</span>
<span class="n">time_resolution</span> <span class="o">=</span> <span class="mf">0.001</span>

<span class="c1"># start and end times (relative to the stimulus at 0 seconds) that we want to examine and align spikes to</span>
<span class="c1"># the baseline interval will be window_start_time to 0-censor_period</span>
<span class="n">window_start_time</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.01</span>
<span class="n">window_end_time</span> <span class="o">=</span> <span class="mf">0.025</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_spike_matrix</span><span class="p">(</span><span class="n">stim_times</span><span class="p">,</span> <span class="n">units_spike_times</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">):</span>
    <span class="n">time_resolution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">))</span>
    <span class="c1"># 3D spike matrix to be populated with spike counts</span>
    <span class="n">spike_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_times</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># populate 3D spike matrix for each unit for each stimulus trial by counting spikes into bins</span>
    <span class="k">for</span> <span class="n">unit_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">)):</span>
        <span class="n">spike_times</span> <span class="o">=</span> <span class="n">units_spike_times</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">stim_idx</span><span class="p">,</span> <span class="n">stim_time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stim_times</span><span class="p">):</span>
            <span class="c1"># get spike times that fall within the bin&#39;s time range relative to the stim time        </span>
            <span class="n">first_bin_time</span> <span class="o">=</span> <span class="n">stim_time</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">last_bin_time</span> <span class="o">=</span> <span class="n">stim_time</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">first_spike_in_range</span><span class="p">,</span> <span class="n">last_spike_in_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="p">[</span><span class="n">first_bin_time</span><span class="p">,</span> <span class="n">last_bin_time</span><span class="p">])</span>
            <span class="n">spike_times_in_range</span> <span class="o">=</span> <span class="n">spike_times</span><span class="p">[</span><span class="n">first_spike_in_range</span><span class="p">:</span><span class="n">last_spike_in_range</span><span class="p">]</span>

            <span class="c1"># convert spike times into relative time bin indices</span>
            <span class="n">bin_indices</span> <span class="o">=</span> <span class="p">((</span><span class="n">spike_times_in_range</span> <span class="o">-</span> <span class="p">(</span><span class="n">first_bin_time</span><span class="p">))</span> <span class="o">/</span> <span class="n">time_resolution</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            
            <span class="c1"># mark that there is a spike at these bin times for this unit on this stim trial</span>
            <span class="k">for</span> <span class="n">bin_idx</span> <span class="ow">in</span> <span class="n">bin_indices</span><span class="p">:</span>
                <span class="n">spike_matrix</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">,</span> <span class="n">stim_idx</span><span class="p">,</span> <span class="n">bin_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">spike_matrix</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_spike_counts</span><span class="p">(</span><span class="n">stim_times</span><span class="p">,</span> <span class="n">spike_times</span><span class="p">,</span> <span class="n">censor_period</span><span class="p">,</span> <span class="n">stim_duration</span><span class="p">,</span> <span class="n">time_resolution</span><span class="p">,</span> <span class="n">window_start_time</span><span class="p">,</span> <span class="n">window_end_time</span><span class="p">):</span>
    <span class="c1"># time bins used</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">window_end_time</span> <span class="o">-</span> <span class="n">window_start_time</span><span class="p">)</span> <span class="o">/</span> <span class="n">time_resolution</span><span class="p">)</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">window_start_time</span><span class="p">,</span> <span class="n">window_end_time</span><span class="p">,</span> <span class="n">n_bins</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># calculate baseline and stimulus interval indices for use later</span>
    <span class="n">stim_start_time</span> <span class="o">=</span> <span class="n">censor_period</span>
    <span class="n">stim_end_time</span> <span class="o">=</span> <span class="n">stim_duration</span> <span class="o">-</span> <span class="n">censor_period</span>
    <span class="n">stim_start_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">stim_start_time</span> <span class="o">-</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="n">time_resolution</span><span class="p">)</span>
    <span class="n">stim_end_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">stim_end_time</span> <span class="o">-</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="n">time_resolution</span><span class="p">)</span>
    <span class="n">bl_start_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">bl_end_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">0</span><span class="o">-</span><span class="n">censor_period</span><span class="o">-</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">time_resolution</span><span class="p">)</span>

    <span class="n">spike_matrix</span> <span class="o">=</span> <span class="n">get_spike_matrix</span><span class="p">(</span><span class="n">stim_times</span><span class="p">,</span> <span class="n">spike_times</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span>

    <span class="c1"># aggregate all stim trials to get total spikes by unit over time</span>
    <span class="n">spike_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spike_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">spike_counts</span><span class="p">,</span> <span class="n">spike_matrix</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">bl_start_idx</span><span class="p">,</span> <span class="n">bl_end_idx</span><span class="p">,</span> <span class="n">stim_start_idx</span><span class="p">,</span> <span class="n">stim_end_idx</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get spike counts array and related info for both SST and Wildtype files</span>
<span class="n">sst_spike_counts</span><span class="p">,</span> <span class="n">sst_spike_matrix</span><span class="p">,</span> <span class="n">sst_bin_edges</span><span class="p">,</span> <span class="n">sst_bl_start</span><span class="p">,</span> <span class="n">sst_bl_end</span><span class="p">,</span> <span class="n">sst_stim_start</span><span class="p">,</span> <span class="n">sst_stim_end</span> <span class="o">=</span> <span class="n">get_spike_counts</span><span class="p">(</span><span class="n">sst_stim_times</span><span class="p">,</span> <span class="n">sst_spike_times</span><span class="p">,</span> <span class="n">censor_period</span><span class="p">,</span> <span class="n">stim_duration</span><span class="p">,</span> <span class="n">time_resolution</span><span class="p">,</span> <span class="n">window_start_time</span><span class="p">,</span> <span class="n">window_end_time</span><span class="p">)</span>
<span class="n">wt_spike_counts</span><span class="p">,</span> <span class="n">wt_spike_matrix</span><span class="p">,</span> <span class="n">wt_bin_edges</span><span class="p">,</span> <span class="n">wt_bl_start</span><span class="p">,</span> <span class="n">wt_bl_end</span><span class="p">,</span> <span class="n">wt_stim_start</span><span class="p">,</span> <span class="n">wt_stim_end</span> <span class="o">=</span> <span class="n">get_spike_counts</span><span class="p">(</span><span class="n">wt_stim_times</span><span class="p">,</span> <span class="n">wt_spike_times</span><span class="p">,</span> <span class="n">censor_period</span><span class="p">,</span> <span class="n">stim_duration</span><span class="p">,</span> <span class="n">time_resolution</span><span class="p">,</span> <span class="n">window_start_time</span><span class="p">,</span> <span class="n">window_end_time</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">sst_spike_counts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">wt_spike_counts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2688, 34)
(2685, 34)
</pre></div>
</div>
</div>
</div>
</section>
<section id="plotting-spike-counts">
<h2>Plotting Spike Counts<a class="headerlink" href="#plotting-spike-counts" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### method to show plot of spike counts of units over time</span>

<span class="k">def</span> <span class="nf">show_counts</span><span class="p">(</span><span class="n">counts_array</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">figax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stim_bounds</span><span class="o">=</span><span class="p">[],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">c_label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">figax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span> <span class="c1"># change fig size for different plot dimensions</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">figax</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">counts_array</span><span class="p">,</span> 
                    <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">counts_array</span><span class="p">)],</span> 
                    <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                    <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
                    <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span> <span class="c1"># change vmax to get a better depiction of your data</span>

    <span class="k">for</span> <span class="n">bound</span> <span class="ow">in</span> <span class="n">stim_bounds</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">bound</span><span class="p">,</span> <span class="n">bound</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">counts_array</span><span class="p">)],</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time relative to stimulus onset (s)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Unit #&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">c_label</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">show_counts</span><span class="p">(</span><span class="n">sst_spike_counts</span><span class="p">,</span>
            <span class="n">sst_bin_edges</span><span class="p">,</span>
            <span class="n">figax</span> <span class="o">=</span> <span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">stim_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">censor_period</span><span class="p">,</span> <span class="n">stim_duration</span><span class="o">-</span><span class="n">censor_period</span><span class="p">],</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;SST Unit spike counts over time&quot;</span><span class="p">,</span>
            <span class="n">c_label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;# Spikes (per </span><span class="si">{</span><span class="n">time_resolution</span><span class="si">}</span><span class="s2"> seconds)&quot;</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">show_counts</span><span class="p">(</span><span class="n">wt_spike_counts</span><span class="p">,</span>
            <span class="n">wt_bin_edges</span><span class="p">,</span>
            <span class="n">figax</span> <span class="o">=</span> <span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">stim_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">censor_period</span><span class="p">,</span> <span class="n">stim_duration</span><span class="o">-</span><span class="n">censor_period</span><span class="p">],</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Wildtype Unit spike counts over time&quot;</span><span class="p">,</span>
            <span class="n">c_label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;# Spikes (per </span><span class="si">{</span><span class="n">time_resolution</span><span class="si">}</span><span class="s2"> seconds)&quot;</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/738beeb935a21570019401b78dc137789069711af87930711d1c94a69934af3c.png" src="../_images/738beeb935a21570019401b78dc137789069711af87930711d1c94a69934af3c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unit_response_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sst_spike_counts</span><span class="p">[:,</span> <span class="n">sst_stim_start</span><span class="p">:</span><span class="n">sst_stim_end</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sorted_respons_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">unit_response_means</span><span class="p">)</span>
<span class="n">sorted_sst_spike_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sst_spike_counts</span><span class="p">,</span> <span class="n">sorted_respons_idxs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">show_counts</span><span class="p">(</span><span class="n">sorted_sst_spike_counts</span><span class="p">,</span>
            <span class="n">sst_bin_edges</span><span class="p">,</span>
            <span class="n">stim_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">censor_period</span><span class="p">,</span> <span class="n">stim_duration</span><span class="o">-</span><span class="n">censor_period</span><span class="p">],</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;SST Unit spike counts over time&quot;</span><span class="p">,</span>
            <span class="n">c_label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;# Spikes (per </span><span class="si">{</span><span class="n">time_resolution</span><span class="si">}</span><span class="s2"> seconds)&quot;</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7486a9ce90c53a21f77720b0a2863f463241053f200e49923a7407ca1c09cd36.png" src="../_images/7486a9ce90c53a21f77720b0a2863f463241053f200e49923a7407ca1c09cd36.png" />
</div>
</div>
</section>
<section id="id1">
<h2>Identifying Optotagged Units<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<p>Now that the <code class="docutils literal notranslate"><span class="pre">spike_counts</span></code> array has been made, several other plots can be generated as well. Below, the mean and the standard deviation are taken for each unit of the baseline spiking behavior before any stimulus is presented.</p>
<p><strong>Note that there are also some units that seem to fire at the very beginning and/or very end of the light pulse. These spikes are almost certainly artifactual, as it takes at least 1 ms to generate a true light-evoked action potential. To manage this, we use the censor period to constrain the stimulus period analyzed</strong></p>
<section id="responsive-unit-spike-counts">
<h3>Responsive Unit Spike Counts<a class="headerlink" href="#responsive-unit-spike-counts" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># show activity of units with a mean response during stim period greater than 2</span>
<span class="n">show_counts</span><span class="p">(</span><span class="n">sst_spike_counts</span><span class="p">[</span><span class="n">unit_response_means</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">sst_bin_edges</span><span class="p">,</span>
            <span class="n">stim_bounds</span><span class="o">=</span><span class="p">[</span><span class="n">censor_period</span><span class="p">,</span> <span class="n">stim_duration</span><span class="o">-</span><span class="n">censor_period</span><span class="p">],</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Responsive SST Unit spike counts over time&quot;</span><span class="p">,</span>
            <span class="n">c_label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;# Spikes (per </span><span class="si">{</span><span class="n">time_resolution</span><span class="si">}</span><span class="s2"> seconds)&quot;</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ab79b3bb96e729ce07b3000fb64d15340f03f89c50c56306b14c657acd64e900.png" src="../_images/ab79b3bb96e729ce07b3000fb64d15340f03f89c50c56306b14c657acd64e900.png" />
</div>
</div>
</section>
</section>
<section id="calculating-unit-optotagging-metrics">
<h2>Calculating Unit Optotagging Metrics<a class="headerlink" href="#calculating-unit-optotagging-metrics" title="Link to this heading">#</a></h2>
<p>Here, certain metrics are calculated for each unit based on their spiking behaviors in response to stimulus. There is no single standard for what metrics to use for determining optotagged units, but the ones below may prove useful. You can adapt this code to calculate additional metrics for the units as well. Each function below calculates a metric (or two) for a given unit. As input, they use the <code class="docutils literal notranslate"><span class="pre">spike_counts</span></code>, and <code class="docutils literal notranslate"><span class="pre">spike_matrix</span></code> arrays which were already generated earlier, as well as the <code class="docutils literal notranslate"><span class="pre">stim_times</span></code> and <code class="docutils literal notranslate"><span class="pre">units_spike_times</span></code> which were produced from the NWB file. Finally, these metrics are displayed for each unit table below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># utility function used by first_spike_latencies_and_jitters and ks_salt</span>
<span class="c1"># returns an array of length &#39;start_times&#39; with the first spike time after each `start_time` (and the censor period)</span>
<span class="k">def</span> <span class="nf">get_first_spikes_after_onset</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">start_times</span><span class="p">):</span>
    <span class="n">response_start_times</span> <span class="o">=</span> <span class="n">start_times</span><span class="p">[</span><span class="n">start_times</span> <span class="o">&lt;</span> <span class="n">spike_times</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>

    <span class="n">first_spike_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">response_start_times</span><span class="p">)</span>
    <span class="n">first_spike_times</span> <span class="o">=</span> <span class="n">spike_times</span><span class="p">[</span><span class="n">first_spike_idxs</span><span class="p">]</span> <span class="o">-</span> <span class="n">response_start_times</span>
    <span class="n">first_spike_times</span> <span class="o">+=</span> <span class="n">censor_period</span>
    
    <span class="k">return</span> <span class="n">first_spike_times</span>


<span class="k">def</span> <span class="nf">first_spike_latencies_and_jitters</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">start_times</span><span class="p">):</span>
    <span class="n">first_spike_times</span> <span class="o">=</span> <span class="n">get_first_spikes_after_onset</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">start_times</span><span class="p">)</span>
    
    <span class="n">first_spike_jitter</span> <span class="o">=</span> <span class="n">median_abs_deviation</span><span class="p">(</span><span class="n">first_spike_times</span><span class="p">)</span>
    <span class="n">first_spike_latency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">first_spike_times</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">first_spike_jitter</span><span class="p">,</span> <span class="n">first_spike_latency</span>


<span class="k">def</span> <span class="nf">ks_salt</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">start_times</span><span class="p">):</span>
    <span class="n">first_spikes</span> <span class="o">=</span> <span class="n">get_first_spikes_after_onset</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">start_times</span><span class="p">)</span>
 
    <span class="c1"># get first spikes at some time sufficiently prior the stimulus times so as to be a baseline period</span>
    <span class="c1"># but not too far back, for risk of sampling time during a previous stimulus event</span>
    <span class="n">baseline_spikes</span> <span class="o">=</span> <span class="n">get_first_spikes_after_onset</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">start_times</span><span class="o">-</span><span class="mf">0.01</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">kstest</span><span class="p">(</span><span class="n">first_spikes</span><span class="p">,</span> <span class="n">baseline_spikes</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fraction_time_responsive</span><span class="p">(</span><span class="n">unit_idx</span><span class="p">,</span> <span class="n">spike_matrix</span><span class="p">,</span> <span class="n">bl_trial_counts</span><span class="p">,</span> <span class="n">stim_start_idx</span><span class="p">,</span> <span class="n">stim_end_idx</span><span class="p">):</span>
    <span class="n">bl_mean_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bl_trial_counts</span><span class="p">)</span>
    
    <span class="n">bins_pvals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bins_above_baseline</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">bin_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stim_start_idx</span><span class="p">,</span> <span class="n">stim_end_idx</span><span class="p">):</span>
        <span class="n">time_bin</span> <span class="o">=</span> <span class="n">spike_matrix</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="n">bin_idx</span><span class="p">]</span>
        <span class="n">bins_pvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">bl_trial_counts</span><span class="p">,</span> <span class="n">time_bin</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">bins_above_baseline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">time_bin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bl_mean_count</span><span class="p">)</span>

    <span class="n">num_sig_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bins_pvals</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.01</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bins_above_baseline</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">fraction_sig_bins</span> <span class="o">=</span> <span class="n">num_sig_bins</span> <span class="o">/</span> <span class="p">(</span><span class="n">stim_end_idx</span><span class="o">-</span><span class="n">stim_start_idx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fraction_sig_bins</span>


<span class="k">def</span> <span class="nf">fraction_trials_responsive</span><span class="p">(</span><span class="n">unit_idx</span><span class="p">,</span> <span class="n">spike_matrix</span><span class="p">,</span> <span class="n">bl_trial_counts</span><span class="p">,</span> <span class="n">stim_start_idx</span><span class="p">,</span> <span class="n">stim_end_idx</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">):</span>
    <span class="n">bl_mean_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bl_trial_counts</span><span class="p">)</span>
    
    <span class="n">trials_pvals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">trials_above_baseline</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">trial_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">):</span>
        <span class="n">trial</span> <span class="o">=</span> <span class="n">spike_matrix</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">,</span> <span class="n">trial_idx</span><span class="p">,</span> <span class="n">stim_start_idx</span><span class="p">:</span><span class="n">stim_end_idx</span><span class="p">]</span>
        <span class="n">trials_pvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">bl_trial_counts</span><span class="p">,</span> <span class="n">trial</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">trials_above_baseline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bl_mean_count</span><span class="p">)</span>

    <span class="n">num_sig_trials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trials_pvals</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.01</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trials_above_baseline</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">fraction_sig_trials</span> <span class="o">=</span> <span class="n">num_sig_trials</span> <span class="o">/</span> <span class="n">n_trials</span>
    <span class="k">return</span> <span class="n">fraction_sig_trials</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_opto_metrics</span><span class="p">(</span><span class="n">stim_times</span><span class="p">,</span> <span class="n">units_spike_times</span><span class="p">,</span> <span class="n">spike_counts</span><span class="p">,</span> <span class="n">spike_matrix</span><span class="p">,</span> <span class="n">censor_period</span><span class="p">,</span> <span class="n">stim_start_idx</span><span class="p">,</span> <span class="n">stim_end_idx</span><span class="p">,</span> <span class="n">bl_start_idx</span><span class="p">,</span> <span class="n">bl_end_idx</span><span class="p">):</span>
    <span class="n">n_units</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">units_spike_times</span><span class="p">)</span>
    <span class="n">n_trials</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_times</span><span class="p">)</span>
    <span class="n">start_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stim_times</span><span class="p">)</span> <span class="o">+</span> <span class="n">censor_period</span>

    <span class="c1"># get mean response spike rate for each unit</span>
    <span class="n">avg_spikes</span> <span class="o">=</span> <span class="n">spike_counts</span><span class="p">[:,</span><span class="n">stim_start_idx</span><span class="p">:</span><span class="n">stim_end_idx</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_trials</span>
    <span class="n">mean_response_spike_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">avg_spikes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># these will be populated for each unit</span>
    <span class="n">first_spike_jitters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_units</span><span class="p">))</span>
    <span class="n">first_spike_latencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_units</span><span class="p">))</span>
    <span class="n">fracs_time_responsive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_units</span><span class="p">))</span>
    <span class="n">fracs_trials_responsive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_units</span><span class="p">))</span>
    <span class="n">salts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_units</span><span class="p">))</span>

    <span class="c1"># populate each optotagging metric array for each unit</span>
    <span class="k">for</span> <span class="n">unit_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_units</span><span class="p">):</span>
        <span class="n">spike_times</span> <span class="o">=</span> <span class="n">units_spike_times</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">]</span>

        <span class="n">first_spike_jitter</span><span class="p">,</span> <span class="n">first_spike_latency</span> <span class="o">=</span> <span class="n">first_spike_latencies_and_jitters</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">start_times</span><span class="p">)</span>

        <span class="n">first_spike_jitters</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_spike_jitter</span>
        <span class="n">first_spike_latencies</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_spike_latency</span>
        <span class="n">salts</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">ks_salt</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">start_times</span><span class="p">)</span>

        <span class="c1"># use the mean baseline spike counts for each trial to determine when the unit is &#39;responsive&#39;</span>
        <span class="n">bl_trial_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spike_matrix</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="n">bl_start_idx</span><span class="p">:</span><span class="n">bl_end_idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">fracs_time_responsive</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fraction_time_responsive</span><span class="p">(</span><span class="n">unit_idx</span><span class="p">,</span> <span class="n">spike_matrix</span><span class="p">,</span> <span class="n">bl_trial_counts</span><span class="p">,</span> <span class="n">stim_start_idx</span><span class="p">,</span> <span class="n">stim_end_idx</span><span class="p">)</span>
        <span class="n">fracs_trials_responsive</span><span class="p">[</span><span class="n">unit_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fraction_trials_responsive</span><span class="p">(</span><span class="n">unit_idx</span><span class="p">,</span> <span class="n">spike_matrix</span><span class="p">,</span> <span class="n">bl_trial_counts</span><span class="p">,</span> <span class="n">stim_start_idx</span><span class="p">,</span> <span class="n">stim_end_idx</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mean_response_spike_rates</span><span class="p">,</span> <span class="n">first_spike_jitters</span><span class="p">,</span> <span class="n">first_spike_latencies</span><span class="p">,</span> <span class="n">fracs_time_responsive</span><span class="p">,</span> <span class="n">fracs_trials_responsive</span><span class="p">,</span> <span class="n">salts</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">opto_metrics</span> <span class="o">=</span> <span class="n">get_opto_metrics</span><span class="p">(</span><span class="n">sst_stim_times</span><span class="p">,</span> <span class="n">sst_spike_times</span><span class="p">,</span> <span class="n">sst_spike_counts</span><span class="p">,</span> <span class="n">sst_spike_matrix</span><span class="p">,</span> <span class="n">censor_period</span><span class="p">,</span> <span class="n">sst_stim_start</span><span class="p">,</span> <span class="n">sst_stim_end</span><span class="p">,</span> <span class="n">sst_bl_start</span><span class="p">,</span> <span class="n">sst_bl_end</span><span class="p">)</span>
<span class="n">mean_response_spike_rates</span><span class="p">,</span> <span class="n">first_spike_jitters</span><span class="p">,</span> <span class="n">first_spike_latencies</span><span class="p">,</span> <span class="n">fracs_time_responsive</span><span class="p">,</span> <span class="n">fracs_trials_responsive</span><span class="p">,</span> <span class="n">salts</span> <span class="o">=</span> <span class="n">opto_metrics</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;mean response spike rate&quot;</span><span class="p">:</span> <span class="n">mean_response_spike_rates</span><span class="p">,</span>
                   <span class="s2">&quot;first spike jitter&quot;</span><span class="p">:</span> <span class="n">first_spike_jitters</span><span class="p">,</span>
                   <span class="s2">&quot;first spike latency&quot;</span><span class="p">:</span> <span class="n">first_spike_latencies</span><span class="p">,</span>
                   <span class="s2">&quot;fraction time responsive&quot;</span><span class="p">:</span> <span class="n">fracs_time_responsive</span><span class="p">,</span>
                   <span class="s2">&quot;fraction trials responsive&quot;</span><span class="p">:</span> <span class="n">fracs_trials_responsive</span><span class="p">,</span>
                   <span class="s2">&quot;ks salt value&quot;</span><span class="p">:</span> <span class="n">salts</span>
                  <span class="p">})</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean response spike rate</th>
      <th>first spike jitter</th>
      <th>first spike latency</th>
      <th>fraction time responsive</th>
      <th>fraction trials responsive</th>
      <th>ks salt value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.002222</td>
      <td>0.096366</td>
      <td>0.127574</td>
      <td>0.166667</td>
      <td>0.0</td>
      <td>9.966899e-01</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.002222</td>
      <td>1.669213</td>
      <td>1.985956</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>1.000000e+00</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.004444</td>
      <td>0.145623</td>
      <td>0.181877</td>
      <td>0.333333</td>
      <td>0.0</td>
      <td>9.717333e-01</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.000000</td>
      <td>0.108815</td>
      <td>0.168240</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>9.999465e-01</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.000000</td>
      <td>1.579199</td>
      <td>1.937359</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>1.000000e+00</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2683</th>
      <td>0.095556</td>
      <td>0.006178</td>
      <td>0.009724</td>
      <td>0.333333</td>
      <td>0.0</td>
      <td>4.072687e-10</td>
    </tr>
    <tr>
      <th>2684</th>
      <td>0.022222</td>
      <td>1.551573</td>
      <td>1.562273</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>8.503638e-04</td>
    </tr>
    <tr>
      <th>2685</th>
      <td>0.002222</td>
      <td>3.681344</td>
      <td>4.311915</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>2.937247e-01</td>
    </tr>
    <tr>
      <th>2686</th>
      <td>0.011111</td>
      <td>1.958318</td>
      <td>2.226296</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>9.999465e-01</td>
    </tr>
    <tr>
      <th>2687</th>
      <td>0.000000</td>
      <td>0.910202</td>
      <td>0.919393</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>9.385843e-03</td>
    </tr>
  </tbody>
</table>
<p>2688 rows × 6 columns</p>
</div></div></div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "AllenInstitute/openscope_databook",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./first-order"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="receptive_fields.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Showing Receptive Fields</p>
      </div>
    </a>
    <a class="right-next"
       href="current_source_density.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Current Source Density Analysis</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">Environment Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-ecephys-file">Downloading Ecephys File</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-optogenetic-stimulus-data-and-units-data">Extracting Optogenetic Stimulus Data and Units Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-units-and-stimuli">Selecting Units and Stimuli</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-unit-responses">Plotting Unit Responses</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-spike-counts">Plotting Spike Counts</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Identifying Optotagged Units</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#responsive-unit-spike-counts">Responsive Unit Spike Counts</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculating-unit-optotagging-metrics">Calculating Unit Optotagging Metrics</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Carter Peene
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>